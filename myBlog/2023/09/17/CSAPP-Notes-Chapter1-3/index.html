<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CSAPP Notes Chapter1~3 | SJTU-XHW's blog</title><meta name="author" content="SJTU-XHW,sjtuxhw12345@sjtu.edu.cn"><meta name="copyright" content="SJTU-XHW"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="written by SJTU-XHW Reference:  CMU - 213, Computer Systems A Programmerâ€™s Perspective 3rd Edition by Randal Bryant, David Oâ€™Hallaron æœ¬äººçŸ¥è¯†æµ…è–„ï¼Œæ–‡ç« éš¾å…æœ‰é—®é¢˜æˆ–ç¼ºæ¼ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼ å†…å®¹å¾ˆé•¿ï¼Œå†™èµ·æ¥å¾ˆæ…¢ ğŸ˜³">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP Notes Chapter1~3">
<meta property="og:url" content="https://sjtuxhw.asia/2023/09/17/CSAPP-Notes-Chapter1-3/index.html">
<meta property="og:site_name" content="SJTU-XHW&#39;s blog">
<meta property="og:description" content="written by SJTU-XHW Reference:  CMU - 213, Computer Systems A Programmerâ€™s Perspective 3rd Edition by Randal Bryant, David Oâ€™Hallaron æœ¬äººçŸ¥è¯†æµ…è–„ï¼Œæ–‡ç« éš¾å…æœ‰é—®é¢˜æˆ–ç¼ºæ¼ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼ å†…å®¹å¾ˆé•¿ï¼Œå†™èµ·æ¥å¾ˆæ…¢ ğŸ˜³">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.sjtuxhw.top/cover_imgs/csapp_123.jpeg">
<meta property="article:published_time" content="2023-09-17T23:47:15.000Z">
<meta property="article:modified_time" content="2023-09-19T05:18:35.682Z">
<meta property="article:author" content="SJTU-XHW">
<meta property="article:tag" content="GNU">
<meta property="article:tag" content="CSAPP">
<meta property="article:tag" content="ICS">
<meta property="article:tag" content="Programming">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.sjtuxhw.top/cover_imgs/csapp_123.jpeg"><link rel="shortcut icon" href="/myBlog/img/favicon.ico"><link rel="canonical" href="https://sjtuxhw.asia/2023/09/17/CSAPP-Notes-Chapter1-3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/myBlog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?64dd3b0c09c8af7b916f8249d32097e2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/myBlog/',
  algolia: undefined,
  localSearch: {"path":"/myBlog/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CSAPP Notes Chapter1~3',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-19 01:18:35'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/myBlog/css/mouseConfig.css"><link rel="stylesheet" href="/myBlog/css/valineBg.css"><link rel="stylesheet" href="/myBlog/css/rightmenu.css"><link rel="stylesheet" href="/myBlog/css/custom_music.css"><link rel="stylesheet" href="/myBlog/css/addFonts.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/myBlog/atom.xml" title="SJTU-XHW's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/myBlog/img/favicon.ico" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/myBlog/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">27</div></a><a href="/myBlog/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">45</div></a><a href="/myBlog/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/myBlog/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/dailyQ/"><i class="fa-fw fa-solid fa-pen-to-square"></i><span> DailyQuestion</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa-solid fa-gamepad"></i><span> ACG-Lab</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/myBlog/ACGLab/MikuTap/"><i class="fa-fw fas fa-music"></i><span> MikuTap</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/Live2D/"><i class="fa-fw fa-solid fa-face-kiss-wink-heart"></i><span> Live2D</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/Folio-2019/"><i class="fa-fw fa-solid fa-car-side"></i><span> Folio-2019</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/Cube/"><i class="fa-fw fa-solid fa-cube"></i><span> Cube</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/TowerBlocks/"><i class="fa-fw fa-solid fa-gopuram"></i><span> TBlocks</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/myBlog/friend-links/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/gallery/"><i class="fa-fw fa fa-camera"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/update-log/v0.3.0-Beta.html"><i class="fa-fw fa fa-arrow-circle-up"></i><span> Update</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.sjtuxhw.top/cover_imgs/csapp_123.jpeg')"><nav id="nav"><span id="blog-info"><a href="/myBlog/" title="SJTU-XHW's blog"><img class="site-icon" src="/myBlog/img/head_icon.png"/><span class="site-name">SJTU-XHW's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/myBlog/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/dailyQ/"><i class="fa-fw fa-solid fa-pen-to-square"></i><span> DailyQuestion</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa-solid fa-gamepad"></i><span> ACG-Lab</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/myBlog/ACGLab/MikuTap/"><i class="fa-fw fas fa-music"></i><span> MikuTap</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/Live2D/"><i class="fa-fw fa-solid fa-face-kiss-wink-heart"></i><span> Live2D</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/Folio-2019/"><i class="fa-fw fa-solid fa-car-side"></i><span> Folio-2019</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/Cube/"><i class="fa-fw fa-solid fa-cube"></i><span> Cube</span></a></li><li><a class="site-page child" href="/myBlog/ACGLab/TowerBlocks/"><i class="fa-fw fa-solid fa-gopuram"></i><span> TBlocks</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/myBlog/friend-links/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/gallery/"><i class="fa-fw fa fa-camera"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/update-log/v0.3.0-Beta.html"><i class="fa-fw fa fa-arrow-circle-up"></i><span> Update</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CSAPP Notes Chapter1~3</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-09-17T23:47:15.000Z" title="å‘è¡¨äº 2023-09-17 19:47:15">2023-09-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-09-19T05:18:35.682Z" title="æ›´æ–°äº 2023-09-19 01:18:35">2023-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/myBlog/categories/review/">review</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">36.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>133åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/myBlog/2023/09/17/CSAPP-Notes-Chapter1-3/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><i>written by SJTU-XHW</i></p>
<p><i>Reference: </i> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.cs.cmu.edu/~213/schedule.html">CMU - 213</a>, <i>Computer Systems A Programmerâ€™s Perspective 3rd Edition</i> by Randal Bryant, David Oâ€™Hallaron</p>
<p><i>æœ¬äººçŸ¥è¯†æµ…è–„ï¼Œæ–‡ç« éš¾å…æœ‰é—®é¢˜æˆ–ç¼ºæ¼ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼</i></p>
<p><i>å†…å®¹å¾ˆé•¿ï¼Œå†™èµ·æ¥å¾ˆæ…¢</i> ğŸ˜³</p>
<hr>
<span id="more"></span>
<h2 id="Chapter-0-Intro"><a href="#Chapter-0-Intro" class="headerlink" title="Chapter 0. Intro"></a>Chapter 0. Intro</h2><h3 id="0-1-Ints-are-not-Integers-Floats-are-not-Reals"><a href="#0-1-Ints-are-not-Integers-Floats-are-not-Reals" class="headerlink" title="0.1 Ints are not Integers, Floats are not Reals"></a>0.1 Ints are not Integers, Floats are not Reals</h3><ul>
<li>$x^2\ge 0$ï¼šintï¼ˆ32-bitï¼‰may overflowï¼›</li>
<li>$a+(b+c)=(a+b)+c$ï¼šfloats may discard some â€œunsignificantâ€ digitsï¼›</li>
</ul>
<h3 id="0-2-Learn-Assembly-but-never-write-it"><a href="#0-2-Learn-Assembly-but-never-write-it" class="headerlink" title="0.2 Learn Assembly but never write it"></a>0.2 Learn Assembly but never write it</h3><h3 id="0-3-Memory-Matters-Unbounded"><a href="#0-3-Memory-Matters-Unbounded" class="headerlink" title="0.3 Memory Matters: Unbounded"></a>0.3 Memory Matters: Unbounded</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">2</span>];</span><br><span class="line">    <span class="type">double</span> d;</span><br><span class="line">&#125; <span class="type">struct_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">func</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="type">struct_t</span> t;</span><br><span class="line">    t.d = <span class="number">3.14</span>;</span><br><span class="line">    t.a[i] = <span class="number">109390032</span>;</span><br><span class="line">    <span class="keyword">return</span> t.d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// func(0)/func(1) -&gt; 3.14</span></span><br><span class="line"><span class="comment">// func(2)    -&gt; 3.13...</span></span><br><span class="line"><span class="comment">// func(6)    -&gt; segment fault</span></span><br></pre></td></tr></table></figure>
<ul>
<li>C/C++ donâ€™t provide <strong>any</strong> memory protectionï¼ˆout of bounds/invalid pointer/abuse of malloc-freeï¼‰: can lead to nasty bugs.</li>
</ul>
<h3 id="0-4-Thereâ€™s-more-to-performance-than-asymtotic-complexity"><a href="#0-4-Thereâ€™s-more-to-performance-than-asymtotic-complexity" class="headerlink" title="0.4 Thereâ€™s more to performance than asymtotic complexity"></a>0.4 Thereâ€™s more to performance than asymtotic complexity</h3><p>(æœ‰æ¯”æ¸è¿›å¤æ‚åº¦æ›´èƒ½å¤Ÿä¼˜åŒ–æ€§èƒ½çš„åšæ³•)</p>
<ul>
<li>æ¸è¿›å¤æ‚åº¦ä¸­æ²¡æœ‰ä½“ç°çš„â€œå¸¸æ•°â€ä¹Ÿå¾ˆé‡è¦ï¼›</li>
<li>åº”è¯¥åœ¨å¤šæ–¹é¢ä¼˜åŒ–æ€§èƒ½ï¼šç®—æ³•ã€æ•°æ®ç»“æ„è¡¨ç¤ºã€ä»£ç è¿‡ç¨‹ã€å¾ªç¯ç­‰ï¼›</li>
<li><strong>Understand system to optimize performance</strong>;</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">copyij</span><span class="params">(<span class="type">int</span> src[<span class="number">2048</span>][<span class="number">2048</span>], dst[<span class="number">2048</span>][<span class="number">2048</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i,j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; ++i)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">2048</span>; ++j)</span><br><span class="line">            dst[i][j] = src[i][j];        <span class="comment">// Row first.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">copyji</span><span class="params">(<span class="type">int</span> src[<span class="number">2048</span>][<span class="number">2048</span>], dst[<span class="number">2048</span>][<span class="number">2048</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i,j;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">2048</span>; ++j)</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; ++i)</span><br><span class="line">            dst[i][j] = src[i][j];        <span class="comment">// Column first.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In a particular machine it was about close to 20 times difference in performance! (4.3ms vs 81.8ms) </span></span><br><span class="line"><span class="comment">// Memory hierachy: Cache memory</span></span><br></pre></td></tr></table></figure>
<h3 id="0-5-Computers-do-more-than-execute-programs"><a href="#0-5-Computers-do-more-than-execute-programs" class="headerlink" title="0.5 Computers do more than execute programs"></a>0.5 Computers do more than execute programs</h3><ul>
<li>They need to get data in &amp; out: I/O system;</li>
<li>They communicate with each other over network;</li>
</ul>
<h2 id="Chapter-1-Bits-Bytes-and-Integers"><a href="#Chapter-1-Bits-Bytes-and-Integers" class="headerlink" title="Chapter 1. Bits, Bytes and Integers"></a>Chapter 1. Bits, Bytes and Integers</h2><h3 id="1-1-Everythings-is-bits"><a href="#1-1-Everythings-is-bits" class="headerlink" title="1.1 Everythings is bits"></a>1.1 Everythings is bits</h3><blockquote>
<p>æœ¬éƒ¨åˆ†çŸ¥è¯†é›¶ç¢ï¼Œåº”è¯¥åœ¨æ•°ç”µ + åˆçº§æ•°æ®ç»“æ„ä¸­æ¥è§¦ã€‚</p>
</blockquote>
<ul>
<li>Each bit is 0 or 1;</li>
<li>By encoding/interpreting sets of bits in various ways;</li>
<li>Why bits? - Electronic Implemetation.<ul>
<li><strong>Easy to store</strong> with bistable elements.</li>
<li><strong>Reliably transmitted</strong> on noisy and inaccurate wires.</li>
</ul>
</li>
<li><strong>Base 2 Number Representation</strong></li>
<li><p>1 Byte = 8 bitsï¼›</p>
<ul>
<li>Binaryï¼š$00000000_2$ to $11111111_2$ï¼›</li>
<li>Decimalï¼š$0_{10}$ to $255_{10}$ï¼›</li>
<li>Hexadecimalï¼š$00_{16}$ to $FF_{16}$ï¼›<ul>
<li>æŒæ¡å¿«é€Ÿ 16 è¿›åˆ¶è½¬ 2 è¿›åˆ¶ï¼š$1010=A,\space1100=C,\space1111=F$ï¼ŒB/D/E åœ¨å…¶ä¸­ï¼›</li>
</ul>
</li>
</ul>
</li>
<li><p>Data Representation in C language</p>
<table>
    <tr>
        <td>C Data Type</td>
        <td>Typical 32-bit</td>
        <td>Typical 64-bit</td>
        <td>x86-64</td>
    </tr>
    <tr>
        <td>char</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>short</td>
        <td>2</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>int</td>
        <td>4</td>
        <td>4</td>
        <td>4</td>
    </tr>
    <tr>
        <td>long</td>
        <td>4</td>
        <td>8</td>
        <td>8</td>
    </tr>
    <tr>
        <td>float</td>
        <td>4</td>
        <td>4</td>
        <td>4</td>
    </tr>
    <tr>
        <td>double</td>
        <td>8</td>
        <td>8</td>
        <td>8</td>
    </tr>
    <tr>
        <td>long double</td>
        <td>N/A</td>
        <td>N/A</td>
        <td>10 / 16</td>
    </tr>
    <tr>
        <td>pointer</td>
        <td>4</td>
        <td>8</td>
        <td>8</td>
    </tr>
</table>

<ul>
<li><strong>æ³¨ï¼šå•ä½ bytesï¼ŒCSAPP å…³æ³¨ x86-64 æ¶æ„</strong>ï¼›</li>
<li><strong>æ³¨2ï¼šIntel x86-64 å¤„ç†å™¨çš„ <code>long double</code> å®šä¸º 10 bytesï¼Œä½†æ•°æ®å¢é‡æ˜¯ 16 bytesï¼Œæ„å‘³ç€ä¼šæµªè´¹ 6 bytes çš„å­˜å‚¨ç©ºé—´</strong>ï¼›</li>
<li><strong>æ³¨3ï¼špointer å€¼å°±æ˜¯è™šæ‹Ÿç©ºé—´çš„åœ°å€ï¼Œä¸Šé¢ä¹Ÿæ­£è¯´æ˜äº† 32 ä½å’Œ 64 ä½çš„åå­—çš„æ¥æºï¼šè¿™äº›è™šæ‹Ÿå†…å­˜çš„åœ°å€æ˜¯ 32 bits / 64 bits é•¿åº¦çš„å€¼</strong>ï¼›æˆ‘ä»¬å¸¸è¯´çš„ 32 ä½æœºå™¨ã€64 ä½æœºå™¨å°±æ˜¯æŒ‡å¯¹åº”åœ°å€å€¼çš„é•¿åº¦æ˜¯ 32/64 bitsï¼›</li>
</ul>
</li>
</ul>
<h3 id="1-2-Boolean-Algebra"><a href="#1-2-Boolean-Algebra" class="headerlink" title="1.2 Boolean Algebra"></a>1.2 Boolean Algebra</h3><ul>
<li><p>Developed by George boole in 19C, â€œTrueâ€: 1, â€œFalseâ€: 0;</p>
</li>
<li><p>Operations: And(<strong>\&amp;</strong>) / Or(<strong>|</strong>) / Not(<strong>~</strong>) / Exclusive-or(<strong>Xor, ^</strong>);</p>
<ul>
<li>Exercise: Operate on Bit Vectors;</li>
</ul>
</li>
<li><p><strong>Example: Representing &amp; Manipulating Sets</strong></p>
<ul>
<li><p>Representation: <strong>Width <code>w</code> bit vector can represent subsets of <code>&#123;0,...,w-1&#125;</code></strong>;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&amp; &lt;=&gt; Intersection</span><br><span class="line">| &lt;=&gt; Union</span><br><span class="line">^ &lt;=&gt; Symmetric Difference</span><br><span class="line">~ &lt;=&gt; Complement</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Shift Operations</p>
<ul>
<li>left shiftã€right shiftï¼›</li>
<li>logic shiftï¼šFill with â€œ0â€ï¼›</li>
<li>arithmetic shiftï¼šif (negetive) Fill with â€œ1â€ï¼Œelse Fill with â€œ0â€ï¼›</li>
<li><strong>Undefined Behavior</strong>: shift amount <strong>&lt; 0</strong> or shift amount <strong>â‰¥ word size</strong>ï¼›</li>
</ul>
</li>
</ul>
<h3 id="1-3-åŸç -true-form-ã€åç -1â€™s-complement-ã€è¡¥ç -2â€™s-complement"><a href="#1-3-åŸç -true-form-ã€åç -1â€™s-complement-ã€è¡¥ç -2â€™s-complement" class="headerlink" title="1.3 åŸç (true form)ã€åç (1â€™s complement)ã€è¡¥ç (2â€™s complement)"></a>1.3 åŸç (true form)ã€åç (1â€™s complement)ã€è¡¥ç (2â€™s complement)</h3><ul>
<li><p>è¡¥ç é€Ÿè¯‘ï¼š<strong>æœ€é«˜ä½æƒé‡å˜ä¸ºè´Ÿå€¼</strong>ï¼›</p>
</li>
<li><p>Unsigned rangeï¼š$0\sim 2^w-1$ï¼›</p>
<p>Twoâ€™s complement rangeï¼š$-2^{w-1}\sim2^{w-1}-1$ï¼›</p>
</li>
<li><p><strong>æ¨¡ 8 è¿ç®—ï¼šä¿ç•™è¡¥ç åä¸‰ä½</strong>ï¼›</p>
</li>
<li><p>Exercise 1: <strong>Mapping between signed &amp; unsigned</strong></p>
<p>ï¼ˆå°†åŒä¸€ä¸ªæ•°ç çœ‹ä½œä¸åŒçš„æ•°ï¼Œä¾‹å¦‚ 11111111 å¯ä»¥è¡¨ç¤º unsigned çš„ 255ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤º signed -1ï¼Œè¿™ä¸¤è€…ç›¸åŒçš„æ•°ç è¢«ç§°ä¸º â€œ<strong>ç›¸åŒçš„ä½æ¨¡å¼ï¼ˆbit patternï¼‰</strong>â€ï¼‰</p>
<blockquote>
<p>è¿™å¯¹è®¡ç®—æœºå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒåŸæœ¬ä¸çŸ¥é“æ˜¯ signed è¿˜æ˜¯ unsignedï¼›</p>
</blockquote>
</li>
<li><p>Exercise 2: <strong>Casting Surprises</strong>ï¼ˆæ¨¡ç³Šçš„å¸¸æ•°ç»™å®šï¼Œä»€ä¹ˆæ—¶å€™ç±»å‹è½¬æ¢ï¼Ÿæ€ä¹ˆè½¬æ¢ï¼Ÿï¼‰</p>
<ul>
<li><p>ä»€ä¹ˆæ—¶å€™ï¼šC++ ä¹¦ä¸­è¯´ï¼Œåœ¨èµ‹å€¼ã€æ¯”è¾ƒæ—¶è¿›è¡Œ<strong>éšå¼ç±»å‹è½¬æ¢ï¼ˆimplicit castingï¼‰</strong>ï¼Œè¿˜å¯ä»¥è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼›</p>
</li>
<li><p>æ€ä¹ˆè½¬æ¢ï¼š</p>
<ol>
<li>å ç”¨ç©ºé—´å°çš„ç±»å‹å‘å¤§çš„ç±»å‹è½¬æ¢ï¼š<strong>åŒæ—¶æœ‰ unsigned int å’Œ intï¼Œåˆ™å‘ unsigned int è½¬æ¢</strong>ï¼ˆéšå¼ç±»å‹è½¬æ¢ï¼‰ï¼›</li>
<li>Bit patternï¼ˆä½æ¨¡å¼ï¼‰ä¿æŒä¸å˜ï¼›</li>
</ol>
</li>
<li><p>ç¼–ç¨‹çš„éº»çƒ¦ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// situation 1</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i)</span><br><span class="line">    <span class="built_in">func</span>(a[i]);</span><br><span class="line"><span class="comment">// situation 2</span></span><br><span class="line"><span class="comment">// æç¤ºï¼šsizeof çš„è¿”å›å€¼ä¼šè¢«ç¼–è¯‘å™¨è®¤ä¸ºæ˜¯ size_t (unsigned long)</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i - <span class="built_in">sizeof</span>(<span class="type">char</span>) &gt;= <span class="number">0</span>; --i)</span><br><span class="line">    <span class="built_in">func</span>(a[i]);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Exercise 3: <strong>Sign Extension</strong>ï¼ˆåœ¨ä¸æ”¹å˜å€¼çš„æƒ…å†µä¸‹ï¼Œå°† w-bit æ•°å˜ä¸º w+k-bit (kâˆˆZ) æ•°ï¼‰</p>
<ul>
<li><p><strong>Expanding Conclusion: Make k copies of MSB in signed, but fill â€œ0â€ in unsigned.</strong></p>
<blockquote>
<p>æƒ³æƒ³ä¸ºä»€ä¹ˆã€‚</p>
</blockquote>
</li>
<li><p><strong>Truncating Conclusion: mod $2^w$ in unsigned,  å¾ˆåƒ mod $2^w$ ä½†ä¸æ˜¯ in signed (negative or positive)</strong>;</p>
</li>
</ul>
</li>
</ul>
<h3 id="1-4-Operations"><a href="#1-4-Operations" class="headerlink" title="1.4 Operations"></a>1.4 Operations</h3><ul>
<li><p>Unsigned Addition: $sum=UAdd_w(u,v)=u+v\mod2^w$ï¼ˆä¸ºä»€ä¹ˆæˆç«‹ï¼Ÿ<strong>Truncating Conclusion</strong>ï¼‰ï¼›</p>
<ul>
<li>ä¸€ç§æº¢å‡ºï¼Œè¿™ç§æº¢å‡ºæ˜¯æ¨¡è¿ç®—å¯ä»¥æè¿°çš„ï¼›</li>
</ul>
<blockquote>
<p>e.g., $(unsigned)13+5=1101_2+0101_2\Rightarrow0010_2$ (<strong>Truncated</strong>)</p>
</blockquote>
</li>
<li><p>Twoâ€™s complement Addition: $sum=TAdd_w(u,v)=UAdd_w(u,v)$ï¼ˆ<strong>equal in bit pattern</strong>, <strong>Truncating Conclusion</strong>ï¼‰;</p>
<ul>
<li>ä¸¤ç§æº¢å‡ºï¼šè´Ÿæº¢å‡ºï¼ˆ$sum\le-2^{w-1}$ æ—¶ï¼‰å’Œ æ­£æº¢å‡ºï¼ˆ$sum\ge w^{w-1}$ æ—¶ï¼‰;</li>
</ul>
</li>
<li><p>Unsigned Multiplication: $multi=UMult_w(u,v)=u\cdot v\mod2^w$ï¼ˆä¸åŠ æ³•åŒç†ï¼‰;</p>
</li>
<li><p>Signed Multiplication Multiplication: $multi=TMulti_w(u,v)=UMulti_w(u,v)$ï¼ˆä¸åŠ æ³•åŒç†ï¼‰;</p>
</li>
</ul>
<blockquote>
<p>è¿™æ„å‘³ç€è®¡ç®—æœºçš„ä¹˜æ³•ã€åŠ æ³•å¯ä»¥å…±ç”¨ç¡¬ä»¶ï¼›</p>
</blockquote>
<ul>
<li><p>Shift &amp; Power-of-2 Multiply / Divide: åŸå› å¯ä»¥çœ‹ä½œæ”¹å˜æƒé‡ï¼›</p>
<ul>
<li><p>Unsigned: no problemï¼›</p>
</li>
<li><p>Signed: <strong>Use arithmetic shift. Add a biasï¼ˆåç§»é‡ 1ï¼‰to bit pattern and then shift</strong></p>
<blockquote>
<ol>
<li><p>ä¸ºä»€ä¹ˆç”¨ <strong>ç®—æ•°ç§»ä½</strong>ï¼Ÿå› ä¸º <strong>Expanding Conclusion</strong>ï¼›è‡³äºä»€ä¹ˆç§»ä½ï¼ŒC++ æ ‡å‡†æ²¡æœ‰æ˜ç¡®è¯´ï¼Œä½†ç»å¤§å¤šæ•°æœºå™¨éƒ½ä¼šç®—æœ¯ç§»ä½ï¼›</p>
</li>
<li><p>ä¸ºä»€ä¹ˆè¦åç§»é‡ï¼Ÿä½¿ç»“æœå‘å¤§æ•°èˆå…¥ï¼›</p>
</li>
</ol>
</blockquote>
</li>
</ul>
</li>
<li><p>Negativeï¼ˆå–ç›¸åæ•°ï¼Œå½“ç„¶åªæœ‰ signed åšå¾—åˆ°ï¼‰ï¼š<strong>flip all the bits and then add 1</strong>ï¼ˆâ€œ~â€ å–å + 1ï¼‰</p>
</li>
<li><p>åœ¨ä»‹ç»å®Œç§»ä½è¿ç®—åï¼Œå›å¿† 1.3 ä¸­çš„ â€œç¼–ç¨‹éº»çƒ¦â€ï¼Œèƒ½ä¸èƒ½ä¸ç”¨ unsignedï¼Œé€šé€šç”¨ signed ï¼ˆå…¨ç”¨è¡¥ç è¡¨ç¤ºï¼‰ä¸å°±ä¸ä¼šå‡ºç°è¿™äº› casting suprises äº†å—ï¼Ÿç¡®å®ï¼ŒC++ ä¸­å°½é‡åˆ«ç”¨ unsignedï¼Œå®¹æ˜“å‡ºé—®é¢˜ï¼›</p>
<blockquote>
<p>Java å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚å–æ¶ˆäº† unsigned çš„ç±»å‹ï¼Œ<strong>å¹¶ä¸”ç¦æ­¢äº†æŸäº›éšå¼ç±»å‹è½¬æ¢</strong>ã€‚ä½†å› ä¸ºæŸäº›å…¶ä»–çš„éœ€æ±‚ï¼ŒJava ä¸å¾—ä¸å¼•å…¥ç®—æ•°ç§»ä½ï¼ˆ&gt;&gt;&gt; å’Œ &lt;&lt;&lt;ï¼‰ï¼Œå°±æ˜¯ C++ ä¸­å¤„ç† signed divide çš„è¿ç®—ç¬¦;</p>
</blockquote>
<p><strong>ä½† unsigned ä¹Ÿæœ‰ç”¨å¤„</strong>ï¼š</p>
<ul>
<li>å–æ¨¡è¿ç®—ï¼šåˆ©ç”¨ unsigned åŠ æ³•æº¢å‡ºç‰¹æ€§ï¼›</li>
<li>ä½¿ç”¨ bits æ¥ä»£è¡¨é›†åˆï¼ˆ1.2ï¼‰ï¼›</li>
</ul>
</li>
</ul>
<h3 id="1-5-Miscellaneous"><a href="#1-5-Miscellaneous" class="headerlink" title="1.5 Miscellaneous"></a>1.5 Miscellaneous</h3><ul>
<li><p><strong>2 çš„å¹‚æ¬¡æ•°å¤§å°ä¼°ç®—</strong>ï¼šå› ä¸º $2^{10}\approx10^3$ï¼Œè¿™æ„å‘³ç€æ¯ 3 ä½åè¿›åˆ¶æ•°å’Œ 10 ä½äºŒè¿›åˆ¶æ•°ç›¸å½“ï¼Œæ‰€ä»¥ $2^{20}\approx10^6$ï¼›</p>
</li>
<li><p>segmentation fault çš„äº§ç”Ÿï¼š64-bits pointer è®©ç¨‹åºè®¤ä¸ºçœŸçš„æœ‰ $2^{64}$ bit çš„å†…å­˜ç©ºé—´ï¼Œä½†å®é™…ä¸Šå¹¶ä¸æ˜¯ã€‚æ‰€ä»¥å½“ç¨‹åºè®¿é—®åˆ°æ“ä½œç³»ç»Ÿæœªç»™å®ƒåˆ†é…çš„å†…å­˜æ—¶ï¼Œä¼šæŠ›å‡º segmentation faultï¼›</p>
</li>
<li><p><strong>å­—é•¿ç©¶ç«Ÿæ˜¯å¤šå¤§</strong>ï¼šä¸ç¡®å®šã€‚ä¸€èˆ¬æ˜¯ç”±ä¸€ç§è¯­è¨€ä¸­æŒ‡é’ˆè¡¨ç¤ºçš„èŒƒå›´ã€å­˜å‚¨å™¨ä¸Šæœ€å¤§å­˜å‚¨å—å¤§å°å†³å®šã€‚ä¾‹å¦‚ 64 ä½æœºå™¨å°±æ˜¯æ“…é•¿ 64-bits è®¡ç®—ã€æŒ‡é’ˆå¤§å° 64-bits çš„æœºå™¨ï¼›<strong>å› æ­¤ä¸€ä¸ªç¨‹åºçš„ä½æ•°æ˜¯ç”±ç¡¬ä»¶å’Œç¼–è¯‘å™¨å…±åŒå†³å®šçš„</strong>ï¼›</p>
<blockquote>
<p>æ‰€ä»¥ 64 ä½æœºå™¨å¯ä»¥è¿è¡Œ 32 ä½ç¨‹åºï¼ˆå‘åå…¼å®¹ï¼‰ï¼›</p>
<p>ä¸ºäº†å†…å­˜å¯¹é½ï¼Œ32-bits ä¸‹å­—é•¿ç›¸å½“äº 4 bytesï¼Œ64-bits ä¸‹å­—é•¿ç›¸å½“äº 8 bytesï¼›</p>
</blockquote>
</li>
<li><p>Byte Ordering</p>
<ul>
<li><p>Big Endianï¼ˆå¤§ç«¯åºï¼‰ï¼š<strong>ç°åœ¨å¸¸å‡ºç°çš„åœ°æ–¹å°±æ˜¯ Internetï¼Œå³å½“å‘é€ 32-bits æ•°æ®åŒ…æ—¶</strong></p>
<ul>
<li>Least significant byte has highest addressï¼ˆå‰é¢çš„ bits æ’åœ¨åœ°å€é å‰çš„ä½ç½®ï¼Œç¬¦åˆäººç±»ä¹ æƒ¯ï¼‰ï¼›</li>
</ul>
</li>
<li><p>Little Endianï¼ˆå°ç«¯åºï¼‰ï¼š<strong>ç›®å‰æ”¯æŒä¸»æµæ“ä½œç³»ç»Ÿçš„å¤„ç†å™¨éƒ½èƒ½ç”¨å°ç«¯åº</strong></p>
<ul>
<li>Least significant byte has lowest addressï¼ˆå‰é¢çš„ bits æ’åœ¨åœ°å€é åçš„ä½ç½®ï¼‰</li>
</ul>
</li>
<li><p>Representing of integers</p>
<ul>
<li><p>Example of <code>01234567</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">address: 0x100 0x101 0x102 0x103</span><br><span class="line">big       :  01	23	  45	67</span><br><span class="line">little :  67    45	  23	01</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Representing of pointers</p>
</li>
<li><p>Representing of strings: Every machine is <strong>the same</strong>; (ended by â€˜\\0â€™);</p>
</li>
</ul>
</li>
</ul>
<h3 id="1-6-Puzzles"><a href="#1-6-Puzzles" class="headerlink" title="1.6 Puzzles"></a>1.6 Puzzles</h3><p>Initialization:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="built_in">foo</span>();</span><br><span class="line"><span class="type">int</span> y = <span class="built_in">bar</span>();</span><br><span class="line"><span class="type">unsigned</span> ux = x;</span><br><span class="line"><span class="type">unsigned</span> uy = y;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>$x\lt0\Rightarrow(x*2\lt0)$ ? </p>
<blockquote>
<p>False, $x=TMin$ (negative overflow) ?</p>
</blockquote>
</li>
<li><p>$ux\ge0$ ?</p>
<blockquote>
<p>True;</p>
</blockquote>
</li>
<li><p>$x\space\And\space7==7\Rightarrow(x&lt;&lt;30)\lt0$ ?</p>
<blockquote>
<p>True, $(x&lt;&lt;30)==-2^{31}+2^{30}\lt0$;</p>
</blockquote>
</li>
<li><p>$ux\gt-1$ ?</p>
<blockquote>
<p>Always False, implicit castingï¼š$(unsigned)(-1)=(\sum\limits_{k=0}^{31}2^k)_{10}\Longrightarrow\forall x((unsigned)x\le(unsigned)(-1))$;</p>
</blockquote>
</li>
<li><p>$x\gt y\Rightarrow-x\lt-y$ ?</p>
<blockquote>
<p>False, $y==TMin\Rightarrow-y==TMin$.</p>
<p>So: $\forall x(y==TMin\rightarrow -x\ge-y)$</p>
</blockquote>
</li>
<li><p>$x*x\ge0$ ?</p>
<blockquote>
<p>False. Positive overflow.</p>
</blockquote>
</li>
<li><p>$x\gt0\space\And\And\space y\gt0\Rightarrow x+y\gt0$ ?</p>
<blockquote>
<p>False. Positive overflow.</p>
</blockquote>
</li>
<li><p>$x\ge0\Rightarrow-x\le0$ ?</p>
<blockquote>
<p>True.</p>
</blockquote>
</li>
<li><p>$x\le0\Rightarrow-x\ge0$ ?</p>
<blockquote>
<p>False, $x==TMin\Rightarrow-x==TMin$.</p>
</blockquote>
</li>
<li><p>$(x|-x)&gt;&gt;31==-1$ ?</p>
<blockquote>
<p>False. $x==0$ ?</p>
</blockquote>
</li>
</ul>
<h2 id="Chapter-2-Floating-Point"><a href="#Chapter-2-Floating-Point" class="headerlink" title="Chapter 2. Floating Point"></a>Chapter 2. Floating Point</h2><h3 id="2-1-Fractional-Binary-Numbers"><a href="#2-1-Fractional-Binary-Numbers" class="headerlink" title="2.1 Fractional Binary Numbers"></a>2.1 Fractional Binary Numbers</h3><ul>
<li><p>Limitations: Can only exactly represent numbers of the form $x/2^k$; Other rational number have repeating bit representations.</p>
</li>
<li><p>IEEE Floating Point</p>
<ul>
<li><p>Numerical form: $(-1)^s\cdot M\cdot2^E$;</p>
<blockquote>
<ul>
<li>Sign bit $s$ determines whether number is positive or negative;</li>
<li>Significandï¼ˆå°¾æ•°ï¼ŒMantissaï¼‰ M normally a fractional value in $[1.0,2.0)$;</li>
<li>Exponent E weights value by power of 2;</li>
</ul>
</blockquote>
</li>
<li><p>Single precision: 32-bits</p>
<p>$s$: 1-bit; $exp$: 8-bits; $frac$: 23-bits;ï¼ˆ$s$ã€$exp$ã€$frac$ ä»£è¡¨å¯¹åº”çš„æ•°æ®åŸŸè€Œå·²ï¼Œä¸‹ç•¥ï¼‰</p>
</li>
<li><p>Double precision: 64-bits</p>
<p>$s$: 1-bit; $exp$: 11-bits; $frac$: 52-bits;</p>
</li>
<li><p><strong>Normalized values</strong>:</p>
<ul>
<li><p>$exp$ ä¸å…¨ä¸º 0ï¼Œä¹Ÿä¸å…¨ä¸º 1ï¼›</p>
</li>
<li><p>$exp$ coded as a biased value: $E=Exp-Bias$;</p>
<p>$Exp$: <strong>unsigned</strong> value of exp field.</p>
<p>$Bias=2^{k-1}-1$, where <strong>$k$ is number of exponent bits</strong>ï¼ˆå½“å‰ $exp$ å­—æ®µçš„ bit é•¿åº¦ï¼Œéå¸¸å·§å¦™ï¼‰</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾å®š Biasï¼Ÿ</p>
<p>Single precisionâ€™s bias: 127ï¼ˆExp: 1â€¦254, E: -126â€¦127ï¼‰</p>
<p>Double precisionâ€™s bias: 1023ï¼ˆExp: 1â€¦2046, E: -1022â€¦1023ï¼‰</p>
</blockquote>
<p><strong>è€ƒè™‘ä¸ºä»€ä¹ˆ $E$ è¦è¿™ä¹ˆè¡¨è¾¾ï¼Ÿå› ä¸ºè¿™ä¹ˆåšæ¯”è¾ƒèµ·æ¥éå¸¸æ–¹ä¾¿</strong>ï¼ˆ$Exp$ 0000â€¦ æœ€å°ï¼Œ1111â€¦æœ€å¤§ï¼‰ï¼›</p>
</li>
<li><p>Significand $M$ coded with implied leading 1: $M = (1.xxxxâ€¦x)_2$</p>
<p>$xxxxâ€¦x$: bits of $frac$ fieldï¼ˆ0000â€¦0æœ€å°ï¼Œæ­¤æ—¶ M = 1ï¼›1111â€¦1æœ€å¤§ï¼Œæ­¤æ—¶ $M=2-\varepsilon$ï¼‰</p>
<blockquote>
<p><strong>ç”±äºå‰å¯¼ 1ï¼Œnormalized value åªèƒ½è¡¨ç¤ºç»å¯¹å€¼ $[2^{1-Bias},(2-2^{-bitsOfFrac})\cdot2^{Bias})$ èŒƒå›´çš„ floating point</strong>ï¼›</p>
</blockquote>
</li>
<li><p>ç†è§£ï¼šåƒç§‘å­¦è®¡æ•°æ³•ï¼Œ$2^E$ ç›¸å½“äºåè¿›åˆ¶ä¸­çš„ $10^E$ï¼Œç”¨äºç§»ä½ï¼Œå‰é¢çš„ $M$ è§„å®šå…·ä½“æ•°å€¼ï¼›</p>
</li>
</ul>
</li>
<li><p><strong>Denormalized values</strong>:</p>
<ul>
<li><p>$exp$ å…¨ä¸º 0ï¼›</p>
</li>
<li><p>$exp$ coded as: $E=1-Bias$;ï¼ˆ<strong>å¯ä»¥ç†è§£ä¸ºæ­¤æ—¶ $exp$ å­—æ®µå…¨ 0 æœ¬èº«æ²¡æ„ä¹‰ï¼Œå®ƒä»¬çš„ä¸ªæ•°æ¥è¡¨ç¤º $Bias$ è¿›è€Œè¡¨ç¤º $E$</strong>ï¼‰</p>
</li>
<li><p>Significand $M$ coded with implied leading 0: $M=(0.xxxâ€¦x)_2$;</p>
<p>$xxxâ€¦x$: bits of $frac$ field;</p>
<blockquote>
<p>æ³¨æ„ï¼Œè¿™é‡Œä¼šå‘ç°å¯ä»¥è¡¨ç¤º â€œ+0â€ å’Œ â€œ-0â€ï¼›</p>
<p><strong>denormalized value åªèƒ½è¡¨ç¤ºç»å¯¹å€¼ $[0,2^{1-Bias})$ èŒƒå›´çš„ floating point</strong>ï¼›</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>Special values</strong>:</p>
<ul>
<li>$exp$ å…¨ä¸º 1ï¼›</li>
<li>è¿™ç§ç¼–ç <strong>åªæœ‰ä¸¤ç§æƒ…å†µ</strong>ï¼š<ol>
<li>$frac$ åŸŸå…¨ä¸º 0ï¼šä»£è¡¨ $\infty$;</li>
<li>$frac$ åŸŸä¸å…¨ä¸º 0ï¼šä»£è¡¨ $NaN$ï¼ˆnot a numberï¼‰ï¼Œä¾‹å¦‚ $\sqrt{-1}$ã€$\infty-\infty$ã€$\infty\times0$ ç­‰ï¼›</li>
</ol>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>è¿™æ ·è§„å®šå°±ä¼šå‘ç°ï¼Œæµ®ç‚¹æ•°<strong>æ°å¥½å¯ä»¥æº¢å‡ºåˆ° $\pm\infty$</strong>ï¼Œè€Œä¸”é”™è¯¯æ•°æ°ä¸º $NaN$ï¼›</p>
<p>Visualizationï¼š <img src="imgs/float_visualization.png"></p>
<p>æƒ³è¦ç†è§£ä¸Šé¢è§„å®šçš„åŸå› è¿˜å¯ä»¥ç”¨å°‘é‡çš„æ•°ä½æ¥æ¨¡æ‹Ÿï¼Œ<strong>ä½ ä¼šå‘ç°ä¹‹å‰çš„è®¾å®šéå¸¸å·§å¦™</strong>ï¼š</p>
<p>ï¼ˆè¿™é‡Œä»¥ $s$: 1-bitï¼Œ$exp$: 4-bitsï¼Œ$frac$: 3-bits ä¸ºä¾‹ï¼‰</p>
<p><img src="imgs/float_range.png" height="350"></p>
</blockquote>
</li>
<li><p>Special Properties of IEEE Encoding</p>
<ul>
<li>FPï¼ˆFloating Pointï¼‰zero same as Integer zeroï¼ˆ<strong>All bits = 0</strong>ï¼‰ï¼›</li>
<li>Can <strong>almostï¼ˆexcept NaNï¼‰</strong> use <strong>unsigned integer comparison</strong>ï¼›<ul>
<li>Must first compare sign bitsï¼›</li>
<li>Must consider <strong>-0 = +0</strong>ï¼›</li>
<li>What should comparison with NaN yieldï¼Ÿ</li>
<li><strong>Otherwise OK ($+\infty$ å’Œ $-\infty$ éƒ½èƒ½ä¸æ•°æ¯”è¾ƒ)</strong>ï¼›</li>
</ul>
</li>
</ul>
</li>
<li><p>Exercise: <strong>write float pointing in bit-level representation</strong>;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> F = <span class="number">15213.0</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>$15213_{10}=11101101101101_2=1.1101101101101_2\times2^{13}$</li>
<li>$M=1.1101101101101_2$, $frac=11011011011010000000000_2$</li>
<li>$E=13$, $Bias=127$, $Exp=E+Bias=140_{10}=10001100_2$;</li>
<li>$Normalized\space value=01000110011011011011010000000000$</li>
</ul>
</li>
</ul>
<h3 id="2-2-The-Operations-for-Floating-Point"><a href="#2-2-The-Operations-for-Floating-Point" class="headerlink" title="2.2 The Operations for Floating Point"></a>2.2 The Operations for Floating Point</h3><ul>
<li><p>Basic idea</p>
<ol>
<li>First compute exact result;</li>
<li>Make it fit into desired precision<ul>
<li>possibly overflow if exponent too large;</li>
<li>possibly <strong>round</strong> to fit into $frac$;</li>
</ul>
</li>
</ol>
</li>
<li><p>Rounding for base 10 numbers</p>
<ul>
<li><p>Towards zeroï¼ˆå‘ 0 èˆå…¥ï¼‰ï¼›</p>
</li>
<li><p>Round downï¼ˆå‘ä¸‹èˆå…¥ï¼‰ï¼›</p>
</li>
<li><p>Round upï¼ˆå‘ä¸Šèˆå…¥ï¼‰ï¼›</p>
</li>
<li><p>Nearest Evenï¼ˆdefaultï¼‰</p>
<blockquote>
<p>å³ <strong>å››èˆå…­å…¥äº”æˆåŒ</strong>ï¼Œè§æ¦‚ç‡ç»Ÿè®¡ï¼›</p>
<p>è¶…è¿‡ä¸€åŠéƒ½æ˜¯ â€œå…­â€ çš„æƒ…å†µï¼Œå°‘äºä¸€åŠéƒ½æ˜¯ â€œå››â€ çš„æƒ…å†µï¼Œæ­£å¥½ä¸€åŠçœ‹æœ€åä¿ç•™ä½çš„å¥‡å¶ï¼›</p>
</blockquote>
</li>
</ul>
</li>
<li><p>Rounding Binary number: Nearest Even ä¸ æ™®é€šåè¿›åˆ¶æ•°æ€è·¯ç›¸åŒï¼›</p>
<blockquote>
<p>ä¸¾ä¾‹ï¼šRound to nearest 1/4ï¼ˆ2 bits right of binary pointï¼‰ï¼š</p>
<p>$10.00011_2\Rightarrow 10.00_2$ï¼Œ$10.00110_2\Rightarrow10.01_2$ï¼Œ</p>
<p>$10.11100_2\Rightarrow11.00_2$ï¼Œ$10.10100_2\Rightarrow10.10_2$ï¼›</p>
</blockquote>
</li>
<li><p>FP Multiplication: $multi=(-1)^s\cdot M\cdot2^E=(-1)^{s1}\cdot M_1\cdot 2^{E1}\cdot(-1)^{s2}\cdot M_2\cdot2^{E2}$</p>
<ul>
<li>Sign $s=s_1\space^\wedge\space s_2$;</li>
<li>Significand $M=M_1\times M_2$;</li>
<li>Exponent $E=E_1+E_2$;</li>
<li><strong>Fixing</strong><ol>
<li>If $M\ge2$ï¼Œshift $M$ right, increment $E$; (<strong>Thatâ€™s why  $M\lt 2$</strong>) </li>
<li>If $E$ out of range ($Exp$ out of range), overflow;</li>
<li>Round $M$ to fit $frac$ precision;</li>
</ol>
</li>
</ul>
</li>
<li><p>FP Addition: $sum=(-1)^s\cdot M\cdot2^E=(-1)^{s_1}\cdot M_1\cdot2^{E_1}+(-1)^{s_2}\cdot M_2\cdot2^{E_2}$. (assume $E_1\gt E_2$)</p>
<ul>
<li>Sign $s$, Significand $M$: <strong>Result of signed align &amp; add</strong>;</li>
<li>Exponent $E$: <strong>the same as $E_1$, which means $E_2$ will be ignored if $E_1\gt\gt E_2$</strong>;</li>
<li><strong>Fixing</strong><ol>
<li>If $M\ge2$, shift $M$ right, increment $E$;</li>
<li>If $M\lt1$, shift $M$ left $k$ positions, decrement $E$ by $k$; (<strong>The difference between multiplication</strong>)</li>
<li>If $E$ out of range, overflow;</li>
<li>Round $M$ to fit $frac$ precision;</li>
</ol>
</li>
</ul>
</li>
<li><p><strong>Mathematical Properties of FP addition / multiplication</strong>:</p>
<ul>
<li>å…·å¤‡äº¤æ¢å¾‹ (commutative)ï¼Œä¸å…·å¤‡ç»“åˆæ€§ (associative)ï¼šèˆå…¥çš„ä¸å‡†ç¡®æ€§å’Œæº¢å‡ºã€å¤§æ•°å’Œå°æ•°ä¹‹å’Œä¼šä¸¢å¤±å°æ•°ã€å¤§æ•°å’Œå¤§æ•°ä¹˜ç§¯ä¼šå˜ä¸º $\infty$ï¼›</li>
<li>Every element has additive inverse (ç›¸åæ•°) <strong>except for infinites \&amp; NaNs</strong>ï¼›</li>
<li>å‡ ä¹å…·å¤‡å•è°ƒæ€§ (Monotonicity): $a\ge b\Rightarrow a+x\ge b+c$ <strong>except for infinites \&amp; NaNs</strong>;</li>
</ul>
<blockquote>
<p><strong>æ€»è€Œè¨€ä¹‹ï¼Œåœ¨è€ƒè¯•æ—¶ï¼Œå¿˜è®°è¿™äº›é—®é¢˜ä¸å¤§ï¼Œæƒ³è¦å¿«é€Ÿåˆ¤æ–­æ˜¯å¦æ»¡è¶³æŸä¸ªå®šå¾‹ï¼Œåªéœ€æ‰¾ç‰¹æ®Šï¼š$\infty$ã€$NaN$ã€overflowã€0ï¼Œè¿™å››è€…æ˜¯å¤§å¤šæ•°ç‰¹ä¾‹çš„æ¥æº</strong>ï¼›</p>
</blockquote>
</li>
</ul>
<h3 id="2-3-Floating-Point-in-C"><a href="#2-3-Floating-Point-in-C" class="headerlink" title="2.3 Floating Point in C"></a>2.3 Floating Point in C</h3><ul>
<li><p><code>float</code>ï¼ˆsingle precisionï¼‰ï¼Œ<code>double</code>ï¼ˆdouble precisionï¼‰ï¼›</p>
</li>
<li><p>Conversions / Casting:</p>
<ul>
<li><p><strong><code>int</code>ã€<code>double</code>ã€<code>float</code> é—´çš„è½¬æ¢ä¼šæ”¹å˜ bit representation</strong>ï¼›</p>
<blockquote>
<p>å›å¿† signed å’Œ unsigned é—´çš„è½¬æ¢ï¼Œä¸æ”¹å˜ bit patternï¼Œåªæ˜¯æ”¹å˜æŸäº›ä½ç½®çš„è§£é‡Šæ–¹å¼ï¼›</p>
</blockquote>
</li>
<li><p>implicit casting å‘ç”Ÿåœ¨å ç”¨å°ç©ºé—´çš„ç±»å‹ï¼ˆintï¼‰å‘å ç”¨å¤§ç©ºé—´ç±»å‹ï¼ˆdoubleï¼‰è½¬æ¢ï¼Œä¹Ÿå¯æ˜¾å¼å£°æ˜ï¼›</p>
<ul>
<li><code>int -&gt; double</code>: <strong>å‡†ç¡®è½¬æ¢ã€‚å› ä¸º <code>int</code> å¤§å°å°äº 53-bits</strong>ï¼›</li>
<li><code>int -&gt; float</code>: <strong>Will rounding according to rounding mode</strong>ï¼›</li>
</ul>
</li>
<li><p>æ˜¾å¼ç±»å‹è½¬æ¢ <code>double/float -&gt; int</code></p>
<ul>
<li>Truncates (æˆªæ–­) fractional part;</li>
<li>Like rounding toward 0 (<strong>å¯ä»¥çœ‹ä½œå‘ 0 èˆå…¥</strong>);</li>
<li>Not defined when out of range / NaN: <strong>Generally sets to <code>TMin</code></strong>;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-4-Puzzles"><a href="#2-4-Puzzles" class="headerlink" title="2.4 Puzzles"></a>2.4 Puzzles</h3><p>initialization:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x = ...;</span><br><span class="line"><span class="type">float</span> f = ...;</span><br><span class="line"><span class="type">double</span> d = ...;</span><br><span class="line"><span class="comment">// Assume neither d nor f is NaN;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>$x==(int)(float)x$ ?</p>
<blockquote>
<p>False; (int)x -&gt; (float)x (rounded)</p>
</blockquote>
</li>
<li><p>$x==(int)(double)x$ ?</p>
<blockquote>
<p>True;</p>
</blockquote>
</li>
<li><p>$f==(float)(double)f$ ?</p>
<blockquote>
<p>True;</p>
</blockquote>
</li>
<li><p>$d==(double)(float)d$ ?</p>
<blockquote>
<p>False; (double)d -&gt; (float)d (rounded)</p>
</blockquote>
</li>
<li><p>$f==-(-f)$ ?</p>
<blockquote>
<p><strong>True. Even $f==\pm\infty$ is true.</strong></p>
</blockquote>
</li>
<li><p>$2/3==2/3.0$ ?</p>
<blockquote>
<p>False; $(int)2/3=0$, $(double)2/3.0=0.666â€¦67$;</p>
</blockquote>
</li>
<li><p>$d\lt0.0\Rightarrow(d*2\lt0.0)$ ?</p>
<blockquote>
<p><strong>True; Even $d*2==-\infty$ is true.</strong></p>
</blockquote>
</li>
<li><p>$d\gt f\Rightarrow-f\gt-d$ ?</p>
<blockquote>
<p>False; $d==+\infty$ or $f==-\infty$ ?</p>
</blockquote>
</li>
<li><p>$d*d\ge0.0$ ?</p>
<blockquote>
<p><strong>True. Even $d==\pm\infty\Rightarrow d*d==+\infty$ is true.</strong></p>
</blockquote>
</li>
<li><p>$(d+f)-d==f$ ?</p>
<blockquote>
<p>False; $d&gt;&gt;f\Rightarrow(d+f)\approx d$;</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>C1 &amp; C2 ç»“æŸï¼Œè¯·å®Œæˆ Data Labï¼</p>
</blockquote>
<h2 id="Chapter-3-Machine-Level-Programming-â… -Basics"><a href="#Chapter-3-Machine-Level-Programming-â… -Basics" class="headerlink" title="Chapter 3. Machine-Level Programming â… - Basics"></a>Chapter 3. Machine-Level Programming â… - Basics</h2><blockquote>
<p>å’Œå‰é¢è¯´çš„ä¸€æ ·ï¼Œæœ¬ç« ä¸ä¼šæ•™å­¦ä¸€æ®µæ®µå†™æ±‡ç¼–ï¼Œåªè¦æ±‚çœ‹æ‡‚ GCC è¾“å‡ºçš„æ±‡ç¼–ä»£ç å³å®Œæˆä»»åŠ¡ï¼›</p>
<p><strong>æœ¬ç« æ¶‰åŠçš„æœºå™¨è¯­è¨€è¿è¡Œåœ¨ Intel x86-64 æœºå™¨ä¸Š</strong>ï¼›</p>
</blockquote>
<ul>
<li><p>ä¸¤ç§æœºå™¨ä»£ç </p>
<ul>
<li>è®¡ç®—æœºå®é™…è¿è¡Œçš„ç›®æ ‡ä»£ç ï¼ˆä¸€ä¸²å­—èŠ‚ç¼–ç å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œéš¾ä»¥é˜…è¯»ï¼‰ï¼›</li>
<li>æ±‡ç¼–ä»£ç ï¼šè¿‡å»ç”¨äºç›´æ¥å¯¹æœºå™¨è¿›è¡Œç¼–ç¨‹ï¼Œç°åœ¨æ˜¯ç¼–è¯‘å™¨è¾“å‡ºçš„ç›®æ ‡ã€‚</li>
</ul>
<blockquote>
<p>ä»¥åè¯´ â€œæœºå™¨ä»£ç â€ï¼Œæœ‰æ—¶æŒ‡ç¬¬ä¸€ç§ï¼ˆç›®æ ‡ä»£ç ï¼‰ï¼Œæœ‰æ—¶æŒ‡ç¬¬äºŒç§ï¼ˆæ–‡æœ¬æ ¼å¼çš„æ±‡ç¼–ä»£ç ï¼‰ï¼Œå®ƒä»¬ä¸¤è€…æ¦‚å¿µå‡ ä¹ç›¸åŒï¼Œå¯æ›¿æ¢ã€‚ä¸è¿‡ä¸ºäº†é˜²æ­¢æ··æ·†ä»¥åå¯¹ç¬¬äºŒç§ä¼šè¯´ â€œæ±‡ç¼–ä»£ç â€ã€‚</p>
</blockquote>
</li>
</ul>
<h3 id="3-1-History-of-Intel-processors-and-architectures"><a href="#3-1-History-of-Intel-processors-and-architectures" class="headerlink" title="3.1 History of Intel processors and architectures"></a>3.1 History of Intel processors and architectures</h3><ul>
<li><p>ä»€ä¹ˆæ˜¯ Intel çš„ x86-64ï¼Ÿ</p>
<blockquote>
<p>x86 æ˜¯æŒ‡ Intel è‡ªå·±çš„ x86 processorsï¼Œå› ä¸º Intel è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€å¼ å¤„ç†å™¨èŠ¯ç‰‡çš„ä»£å·æ˜¯ 8086ï¼ˆäº§äº 1978ï¼‰ã€‚</p>
<p>éšç€æ—¶é—´æ¨ç§»ï¼Œè¿™ä¸ªç³»åˆ—çš„èŠ¯ç‰‡ä¸æ–­æ·»åŠ ç‰¹æ€§ã€å‡çº§æ¼”è¿›ï¼›Intel è‡ªå·±è·³è¿‡äº† 81 ç³»åˆ—ï¼Œæ¨å‡ºè¿‡ 8286ã€8386ç³»åˆ—ç­‰ï¼Œéƒ½æ˜¯ä»¥ 86 ç»“å°¾ï¼Œæ‰€ä»¥è¢«ç§°ä¸º x86ã€‚</p>
<p>åé¢çš„ 64 è¡¨ç¤ºè¿™æ˜¯ 64-bits çš„æœºå™¨ï¼›</p>
</blockquote>
</li>
<li><p>ä»€ä¹ˆæ˜¯ <code>CISC</code> å’Œ <code>RISC</code>ï¼Ÿ</p>
<ul>
<li>Reduced Instruction Set Computerï¼ˆ<code>RISC</code>ï¼Œç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœºï¼‰ï¼šä¸€ç±»è£…å¤‡æ”¹è‰¯çš„æœºå™¨æŒ‡ä»¤é›†çš„è®¡ç®—æœºï¼Œæ€æƒ³è¾ƒæ–°ï¼›</li>
<li>Complex Instruction Set Computerï¼ˆ<code>CISC</code>ï¼Œå¤æ‚æŒ‡ä»¤é›†è®¡ç®—æœºï¼‰ï¼šåœ¨ <code>RISC</code> å‡ºç°åï¼Œ<code>RISC</code> å¼€å‘è€…æŠŠä¹‹å‰çš„ä½¿ç”¨æ—§æŒ‡ä»¤é›†çš„è®¡ç®—æœºç»Ÿç§°ä¸º <code>CISC</code>ï¼Œæ‰€ä»¥è¿™ä¸ªæ¦‚å¿µå‡ºç°åœ¨æœ¬ä½“ä¹‹åï¼Œå¸¦æœ‰è´¬ä¹‰ï¼›</li>
</ul>
<blockquote>
<p>Intel é‡‡ç”¨çš„æ˜¯ <code>CISC</code>ï¼ŒCSAPP ä¸­ä»‹ç»çš„è¿™æ–¹é¢çš„çŸ¥è¯†è¿˜æ˜¯ä¸å…¨é¢ï¼Œæƒ³è¦è¿›ä¸€æ­¥äº†è§£ <code>CISC</code> éœ€è¦è‡ªå·±é˜…è¯» <code>CISC</code> æ‰‹å†Œï¼›</p>
</blockquote>
</li>
<li><p>Intel èŠ¯ç‰‡çš„è¿›åŒ–</p>
<ul>
<li><p>8086: 1978, 5-10 MHz;</p>
<blockquote>
<p>First 16-bit Intel processor.</p>
<p>1 MB Address space.</p>
</blockquote>
</li>
<li><p>386: 1985, 16-33 MHz</p>
<blockquote>
<p>First 32-bit Intel processor, referred to as IA32ï¼ˆIntel Architecture 32ï¼‰ï¼Œå æ®äº†æå¤§å¸‚åœºä»½é¢ï¼›<strong>ç°åœ¨ä¸æ•™å®ƒäº†ï¼Œå› ä¸ºæœ‰æ›´æ–°çš„ x86-64</strong>;</p>
<p>Added â€œflat addressingâ€ï¼Œcapable of running <strong>UNIX</strong>ï¼›</p>
</blockquote>
</li>
<li><p>Pentium 4Eï¼ˆå¥”è…¾ 4Eï¼‰: 2004, 2800-3800 MHz</p>
<blockquote>
<p>First 64-bit Intel x86 processor, referred to as x86-64;</p>
<p><strong>æ”¶åˆ°äº†äº§å“åé¦ˆï¼šæ€§èƒ½åŠŸè€—é—®é¢˜ï¼Œå‘çƒ­ä¸¥é‡ï¼Œä¸èƒ½æ— é™åˆ¶å¢åŠ å¤„ç†å™¨æ—¶é’Ÿé¢‘ç‡</strong>ï¼Œå¼€å§‹ç€æ‰‹å¤šæ ¸å¤„ç†å™¨ï¼ˆä¸€ä¸ªèŠ¯ç‰‡ä¸Šæ”¾å¤šä¸ªç‹¬ç«‹å¤„ç†å™¨ï¼‰ï¼›</p>
</blockquote>
</li>
<li><p>Core 2: 2006, 1060-3500 MHz</p>
<blockquote>
<p>First multi-core Intel processor;</p>
</blockquote>
</li>
<li><p>Core i7: 2008, 1700-3900 MHz</p>
<blockquote>
<p>Four cores processor;ï¼ˆè‡³ä»Šæ€§èƒ½ä¹Ÿä¸é”™ï¼‰</p>
</blockquote>
</li>
</ul>
</li>
<li><p>ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ<strong>å¤§è‡´å®šä¹‰æ˜¯ a temporary memory used to hold the most recently accessed data</strong>;</p>
</li>
<li><p>2015 å¹´çš„ Intel èŠ¯ç‰‡æ¶æ„</p>
<p><img src="imgs/chip_in_2015.png" height="400"></p>
<ul>
<li><code>DDR</code> æ¥å£æ˜¯è¿æ¥åˆ°ä¸»å­˜å‚¨å™¨ï¼ˆDRAMï¼ŒDynamic Random Access Memoryï¼‰çš„é€šé“ï¼›</li>
<li><code>PCI</code> æ¥å£æ˜¯ä¸å¤–å›´è®¾å¤‡ï¼ˆperipheral devicesï¼‰çš„è¿æ¥é€šé“ï¼›</li>
<li><code>SATA</code> æ¥å£æ˜¯ä¸ä¸åŒç±»å‹ç¡¬ç›˜çš„è¿æ¥é€šé“ï¼›</li>
<li><code>Ethernet</code> æ¥å£æ˜¯ç½‘ç»œæ¥å£ï¼›</li>
</ul>
<blockquote>
<p>ç»“è®ºï¼šé›†æˆåˆ°å•ä¸ªèŠ¯ç‰‡ä¸Šçš„ä¸ä»…ä»…æ˜¯å¤„ç†å™¨æœ¬èº«ï¼Œè¿˜æœ‰å¾ˆå¤šé€»è¾‘å•å…ƒæ‰€ç»„åˆèµ·çš„æœ‰æœºæ•´ä½“ï¼›</p>
</blockquote>
</li>
<li><p>Intel çš„ç«äº‰å¯¹æ‰‹ï¼šAMDï¼ˆAdvanced Micro Devicesï¼‰</p>
<ul>
<li>æ€»æ˜¯è·Ÿåœ¨ Intel åé¢å‘å±•ï¼ŒåŒçº§åˆ«çš„èŠ¯ç‰‡ç¨å¾®æœ‰ç‚¹æ…¢ï¼Œä½†ä¾¿å®œçš„å¤šï¼›</li>
</ul>
</li>
<li>ä»€ä¹ˆæ˜¯ ARMï¼Ÿ<ul>
<li>é™¤äº† Intel å…¬å¸çš„ x86 ç±»å‹çš„å¤„ç†å™¨ï¼Œå½“å‰å¸¸ç”¨çš„ã€æ¯”è¾ƒä¸»æµçš„å¦ä¸€ç±»å¤„ç†å™¨æ˜¯ ARMï¼ˆAcron RISC Machineï¼‰ï¼ŒCSAPP ä¸ä¼šæ·±å…¥æ¶‰åŠï¼›</li>
<li>åˆ›é€ è¿™ç§å¤„ç†å™¨åŠå…¶å¯¹åº”æŒ‡ä»¤é›†ï¼ˆRISCï¼‰çš„åŸå…¬å¸å·²ç»ç ´äº§ï¼Œä½†æŒ‡ä»¤é›†å†™çš„å¾ˆæ£’ï¼Œèƒ½è‡ªå®šä¹‰ï¼ŒåŠŸè€—æ¯”åŒæ°´å‡†çš„ x86 å¤„ç†å™¨æ›´ä½ã€‚</li>
<li>æ‰€ä»¥åç»§è€…å»ºç«‹äº†ä¸€ä¸ªå…¬å¸ï¼Œä½†è¿™ä¸ªå…¬å¸ä¸é”€å”®å¤„ç†å™¨ï¼Œåªå‘ä¼—å¤šå…¬å¸é”€å”® ARM çš„è®¾è®¡è®¸å¯æƒã€‚å› æ­¤ï¼ŒARM å¤„ç†å™¨æ˜¯å¾ˆå¤šèŠ¯ç‰‡å‚å•†ï¼ˆå°¤å…¶ Intelï¼‰ç”Ÿäº§çš„èŠ¯ç‰‡çš„<strong>ä¸€éƒ¨åˆ†</strong>ï¼Œå› ä¸º ARM çš„ä¼˜åŠ¿è€Œè¢«ç”¨åœ¨æ–¹æ–¹é¢é¢ï¼›</li>
</ul>
</li>
</ul>
<h3 id="3-2-C-Assembly-Machine-code"><a href="#3-2-C-Assembly-Machine-code" class="headerlink" title="3.2 C, Assembly, Machine code"></a>3.2 C, Assembly, Machine code</h3><blockquote>
<p>æœ¬èŠ‚åªæ˜¯æ¦‚è¿°ä¸€ä¸‹æ•´ä¸ª Cã€æ±‡ç¼–è¯­è¨€ã€æœºå™¨è¯­è¨€çš„<strong>äº§ç”Ÿè¿‡ç¨‹</strong> å’Œ <strong>å®è§‚æ ·è²Œ</strong>ã€‚</p>
<p>å…·ä½“å¯¹æ±‡ç¼–ä»£ç çš„å­¦ä¹ å†…å®¹åœ¨ä¸‹ä¸€èŠ‚ã€‚</p>
</blockquote>
<h4 id="3-2-1-Definitions"><a href="#3-2-1-Definitions" class="headerlink" title="3.2.1 Definitions"></a>3.2.1 Definitions</h4><ul>
<li><strong>Architecture (also ISA: Instruction Set Architecture)</strong>: The <strong>parts</strong> of a processor design that  one needs to understand or write assembly/machine code.<ul>
<li>æ¶æ„æ˜¯å¤„ç†å™¨è®¾è®¡çš„ä¸€éƒ¨åˆ†ã€‚å¼€å‘ç¡¬ä»¶çš„äººå‘˜åœ¨è€ƒè™‘è®¾è®¡æœºå™¨å’Œå¯¹åº”æœºå™¨è¯­è¨€çš„æ—¶å€™ï¼Œæƒ³åˆ°äº†å°† â€œæŒ‡ä»¤é›†æ¶æ„â€ è¿™å±‚æŠ½è±¡å‡ºæ¥ã€‚<strong>ä¾‹å¦‚é’ˆå¯¹æŸä¸ªå¯„å­˜å™¨ï¼Œç‰¹å®šçš„æŒ‡ä»¤é›†ç­‰</strong>ï¼Œç›¸å½“äºé©±åŠ¨ç¡¬ä»¶çš„æ¥å£ï¼Œå°†<strong>å¾®æ¶æ„</strong>å’Œæœºå™¨ç éš”ç¦»å¼€ã€‚è¿™æ ·ï¼Œç¡¬ä»¶è®¾è®¡è€…åªéœ€è¦å…³å¿ƒå¾®æ¶æ„ï¼Œä¸Šå±‚çš„è®¾è®¡è€…éœ€è¦å…³æ³¨æœºå™¨è¯­è¨€ä»¥åŠæ›´æŠ½è±¡çš„è¯­è¨€å°±è¡Œã€‚</li>
<li>å¼€å‘äººå‘˜éœ€è¦äº†è§£ï¼Œä»¥æ­¤æ¥ç¼–å†™å¯¹åº”çš„æ±‡ç¼–ç ã€æœºå™¨è¯­è¨€ï¼Œä»¥è‡³å¯¹åº”å¹³å°çš„ç¼–è¯‘å™¨ï¼›</li>
<li>examples:<ul>
<li>Intel: x86, IA32, Itanium, x86-64;</li>
<li>ARM: (Name is itself) Used in almost all mobile phones.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Microarchitecture: Implementation of the architecture.</strong><ul>
<li>ä¾‹å¦‚ï¼šç¼“å­˜å¤§å°è®¾è®¡ã€å†…æ ¸é¢‘ç‡è®¾è®¡ã€‚CSAPP ä¸­ä¹Ÿæ¶‰åŠçš„å¾ˆå°‘ï¼›</li>
</ul>
</li>
<li>Code Form<ul>
<li>Machine Code: The byte-level programs that a processor executes;</li>
<li>Assembly Code: A text representation of machine code.</li>
</ul>
</li>
</ul>
<h4 id="3-2-2-Assembly-Machine-Code-View"><a href="#3-2-2-Assembly-Machine-Code-View" class="headerlink" title="3.2.2 Assembly/Machine Code View"></a>3.2.2 Assembly/Machine Code View</h4><ul>
<li><p>Programmer-Visible Stateï¼ˆåœ¨æœºå™¨è¯­è¨€ä¸­éœ€è¦å¼€å‘è€…äº†è§£ã€æ“ä½œçš„ä¸€äº›é‡ï¼Œå«æœ‰ä¸çœŸå®ç¡¬ä»¶ç›¸å…³çš„ç»†èŠ‚ï¼‰ï¼š</p>
<ul>
<li><p>PC (Program Counter, ç¨‹åºè®¡æ•°å™¨)</p>
<ol>
<li>Get the address of next instruction;</li>
<li>Called â€œRIPâ€ (in x86-64);</li>
</ol>
</li>
<li><p>Register file: <strong>Heavily used program data</strong>ï¼ˆæ±‡ç¼–ç¨‹åºä¸­ç»å¤§å¤šæ•°æ•°æ®å­˜æ”¾çš„ä½ç½®ï¼‰;</p>
</li>
<li><p>Condition Codesï¼ˆçŠ¶æ€ä»£ç ï¼Œå­˜æ”¾äº<strong>çŠ¶æ€å¯„å­˜å™¨</strong>ï¼‰</p>
<ol>
<li>å­˜å‚¨ç»å¤§å¤šæ•°å½“å‰æœ€è¿‘çš„ç®—æ•°/é€»è¾‘è¿ç®—çš„çŠ¶æ€ä¿¡æ¯ï¼›</li>
<li>æ•°æ®ç”¨æ¥åˆ¤æ–­çŠ¶æ€åˆ†æ”¯ï¼›</li>
</ol>
</li>
<li><p>Memory</p>
<ol>
<li>ç”±åœ°å€ç»„ç»‡çš„ byte æ•°ç»„ï¼Œ<strong>å®é™…ä¸Šæ˜¯ç”¨ä¸€ç§ä¸åŒæ–¹å¼ï¼ˆè¿™ä¸ªå®ç°çš„æ–¹å¼ä»¥åçš„ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»ï¼‰å®ç°çš„è™šæ„å¯¹è±¡ï¼Œå®Œæˆæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶é—´çš„åä½œï¼Œå› æ­¤ç§°ä¸ºè™šæ‹Ÿå†…å­˜ï¼ˆVirtual Memoryï¼‰</strong>ï¼Œæ‰€ä»¥è¿™ä½¿å¾—è™½ç„¶å†…å­˜ï¼ˆç¡¬ä»¶ä¸Šå®é™…çš„å†…å­˜åˆç§°ä¸º<strong>ç‰©ç†å†…å­˜ï¼ŒPhysical Memory</strong>ï¼‰åœ¨ç¡¬ä»¶ä¸Šå¯èƒ½æ˜¯é›¶ç¢çš„ï¼Œä½†æ±‡ç¼–å¼€å‘è€…çœ‹èµ·æ¥çš„å´æ˜¯ä¸€å¤§å—å¯ä»¥æŒ‰åœ°å€æˆå—ä½¿ç”¨çš„ã€‚æ¯ä¸ªç¨‹åºéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å­—èŠ‚æ•°ç»„æ¥è®¿é—®æ•°æ®ã€‚</li>
<li>å­˜æ”¾ä»£ç ã€ç”¨æˆ·ä¿¡æ¯ï¼›</li>
<li>ä½¿ç”¨å †æ ˆæ•°æ®ç»“æ„æ¥æ”¯æŒæ­¥éª¤ï¼›</li>
</ol>
<blockquote>
<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ç»å¸¸æåˆ°çš„<strong>ç¼“å­˜ï¼ˆCacheï¼‰</strong>ï¼Œç¼“å­˜æ˜¯æŒ‡ä¸€ä¸ªåŠ¨ä½œï¼Œå°±æ˜¯å°†æœ€è¿‘è®¿é—®çš„æ•°æ®å­˜å‚¨åˆ°<strong>é«˜é€Ÿç¼“å­˜å™¨</strong>ï¼ˆI/O è¿œå¿«äºæ™®é€šå¯„å­˜å™¨å’Œå¤–å­˜å‚¨å™¨ï¼Œä½†é€ ä»·é«˜ï¼Œæ‰€ä»¥å®¹é‡å°ï¼‰ä¸­ã€‚ä¸‹ä¸€æ¬¡è®¿é—®<strong>ç›¸åŒ</strong>æ•°æ®æ—¶ï¼Œä¼šç›´æ¥è¿›å…¥é«˜é€Ÿç¼“å­˜å™¨ä¸­ï¼Œé€Ÿåº¦ä¼šæ›´å¿«ã€‚</p>
<p>ä½†æ˜¯<strong>â€œç¼“å­˜â€</strong>è¿™ä¸ªåŠ¨ä½œå¯¹æ±‡ç¼–å¼€å‘è€…è€Œè¨€<strong>ä¹Ÿæ˜¯ä¸å¯è§ï¼ˆinvisibleï¼‰çš„</strong>ï¼Œè¿™æ˜¯å†™åœ¨ç¡¬ä»¶ä¸­çš„åŠ¨ä½œï¼ˆå‰é¢è¯´çš„ microarchitectureï¼‰ï¼Œå³ä½¿åœ¨æ±‡ç¼–å±‚é¢ä¹Ÿæ²¡æœ‰ä¸“é—¨çš„æŒ‡ä»¤ï¼Œæ— æ³•æ“ä½œã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li><p>C ä»£ç å¦‚ä½•è½¬å˜ä¸º <code>Object Code</code></p>
<ul>
<li>åœ¨ GNU Tutor ä¸­æ›¾ç»ä»‹ç»è¿‡ä»æºæ–‡ä»¶åˆ°ç›®æ ‡æ–‡ä»¶çš„è¿‡ç¨‹ï¼›</li>
<li><strong>C æºæ–‡ä»¶ï¼ˆ*.c, textï¼‰</strong> <u>ç¼–è¯‘å™¨ï¼ˆcompiler, C ä¸€èˆ¬ç”¨ gccï¼‰</u>ç¼–è¯‘ä¸º <strong>ASM æºæ–‡ä»¶ï¼ˆ*.s, textï¼‰</strong>ï¼Œå†äº¤ç»™<u>æ±‡ç¼–å™¨ï¼ˆassemblerï¼Œä¸€èˆ¬ç”¨ gcc/asï¼‰</u> æ±‡ç¼–ä¸º <strong>ç›®æ ‡æ–‡ä»¶ï¼ˆ*.o, binaryï¼‰</strong>ï¼Œæœ€åäº¤ç»™<u>é“¾æ¥å™¨ï¼ˆlinkerï¼Œä¸€èˆ¬ç”¨ gcc/ldï¼‰</u> é“¾æ¥ç”¨åˆ°çš„ç¬¬ä¸‰æ–¹é™æ€åº“ï¼Œæœ€ç»ˆå˜ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼›</li>
<li>å‰©ä½™è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯åŠ¨æ€é“¾æ¥åº“ï¼Œè¦ä¹ˆè‡ªå·±å†™å¹¶ä¸”ç¼–è¯‘ï¼Œæ”¾ç½®åœ¨æŒ‡å®šä½ç½®ï¼Œè¦ä¹ˆç”¨çš„æ˜¯ç³»ç»Ÿç¯å¢ƒä¸­çš„åº“ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ã€‚</li>
</ul>
</li>
<li><p>ä¸¾ä¾‹è¯´æ˜ï¼šä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„ C ç¨‹åºä¸ºä¾‹ï¼Œæ¼”ç¤ºå…¶æ±‡ç¼–ä»£ç åŠå«ä¹‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: sum.c</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">plus</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sumstore</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span>* dest)</span> &#123;</span><br><span class="line">    <span class="type">long</span> t = plus(x, y);</span><br><span class="line">    *dest = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="type">long</span> x = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">long</span> y = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">long</span> z;</span><br><span class="line">    sumstore(x, y, &amp;z);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%ld + %ld --&gt; %ld\n&quot;</span>, x, y, z);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨è¿è¡Œ <code>gcc -Og -S sum.c</code>ã€‚</p>
<ul>
<li><code>-Og</code> å‚æ•°æ˜¯è¾ƒæ–°çš„å‚æ•°ï¼Œä¸ <code>-On</code>ï¼ˆn=0ï¼Œ1ï¼Œ2ï¼Œ3ï¼‰ ä¼˜åŒ–ä¸ä¸€æ ·ï¼Œä¸ºå¼€å‘äººå‘˜æä¾›äº†æ˜“è¯»çš„ä¸­é—´æ±‡ç¼–ç ï¼›å¦å¤–ï¼Œå¦‚æœä¸åŠ  <code>-O</code> å‚æ•°ï¼Œå°±ä»€ä¹ˆéƒ½ä¸ä¼˜åŒ–ï¼Œé‚£ä¹ˆä»£ç åŒæ ·éš¾ä»¥é˜…è¯»ï¼›</li>
<li><code>-S</code> å‚æ•°æ„å‘³ç€ <code>gcc</code> å¥—ä»¶å°†ä»…è¿è¡Œåˆ°äº§ç”Ÿæ±‡ç¼–ä»£ç ï¼ˆ<code>*.s</code>ï¼‰å°±åœæ­¢ï¼›</li>
</ul>
<p>æ‰¾åˆ°ä»£è¡¨ <code>sumstore</code> å‡½æ•°çš„ asm ä»£ç ï¼Œä»¥å‡½æ•°å + å†’å·å¼€å¤´ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sumstore:</span><br><span class="line">    pushq	%rbx</span><br><span class="line">    .seh_pushreg	%rbx</span><br><span class="line">    subq	$32, %rsp</span><br><span class="line">    .seh_stackalloc	32</span><br><span class="line">    .seh_endprologue</span><br><span class="line">    movq	%r8, %rbx</span><br><span class="line">    call	plus</span><br><span class="line">    movl	%eax, (%rbx)</span><br><span class="line">    addq	$32, %rsp</span><br><span class="line">    popq	%rbx</span><br><span class="line">    ret</span><br><span class="line">    .seh_endproc</span><br><span class="line">    .def	__main;	.scl	2;	.type	32;	.endef</span><br><span class="line">    .section .rdata,&quot;dr&quot;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ³¨æ„å¼€å¤´å«æœ‰ <code>.</code> çš„æ“ä½œ<strong>å®é™…ä¸æ˜¯åŸå…ˆä»£ç çš„éƒ¨åˆ†ï¼Œå®ƒä»¬ä¸ä¸€äº›å…¶ä»–ä¿¡æ¯æœ‰å…³</strong>ã€‚ä¾‹å¦‚ä¸ºè°ƒè¯•å™¨æä¾›è¡Œå·çš„ã€ä¸ºé“¾æ¥å™¨æä¾›ä¿¡æ¯è¡¨ç¤ºå…¨å±€å‡½æ•°çš„ç­‰ç­‰ã€‚ä¸€å¼€å§‹å¯ä»¥ä¸ç”¨å¤ªè¿‡äºåœ¨æ„è¿™äº›ï¼Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥åˆ æ‰è¯´æ˜ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sumstore:</span><br><span class="line">    pushq	%rbx	; %rbx è¡¨ç¤ºè®¿é—®åä¸º rbx çš„å¯„å­˜å™¨ï¼Œpushd è¡¨ç¤ºæ•°æ®å‹å…¥memoryæ ˆ</span><br><span class="line">    subq	$32, %rsp	</span><br><span class="line">    movq	%r8, %rbx</span><br><span class="line">    call	plus	; è°ƒç”¨å‡½æ•°åä¸º plus çš„å‡½æ•°</span><br><span class="line">    movl	%eax, (%rbx)	; ç§»åŠ¨å€¼</span><br><span class="line">    addq	$32, %rsp</span><br><span class="line">    popq	%rbx	; å°†æ ˆä¸­å€¼å¼¹å‡ºåˆ° åä¸º rbx çš„å¯„å­˜å™¨ä¸­</span><br><span class="line">    ret				; å½“å‰å‡½æ•°ç»“æŸï¼Œè¿”å›</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-2-3-Assembly-Characteristics-Data-Types"><a href="#3-2-3-Assembly-Characteristics-Data-Types" class="headerlink" title="3.2.3 Assembly Characteristics: Data Types"></a>3.2.3 Assembly Characteristics: Data Types</h4><ul>
<li>â€œIntegerâ€ data of 1,2,4, or 8 bytesï¼ˆä¸åŒçš„æ•´å‹æ•°æ®ç±»å‹ï¼Œä¸åŒºåˆ†ç¬¦å·ï¼‰<ul>
<li>Data types / Addressï¼ˆuntyped pointersï¼‰</li>
</ul>
</li>
<li>Floating point data of 4,8, or 10 bytesï¼ˆæµ®ç‚¹æ•°å¤„ç†æ–¹å¼ä¸åŒï¼Œä½¿ç”¨ä¸åŒçš„å¯„å­˜å™¨ç»„ï¼Œä¹‹åè¯¦ç»†æï¼‰</li>
<li><strong>åœ¨æ±‡ç¼–å±‚é¢ä¸å­˜åœ¨èšåˆç»“æ„ï¼ˆaggregate typesï¼‰</strong>ï¼Œä¾‹å¦‚æ•°ç»„ã€ç»“æ„ä½“ï¼Œå› ä¸ºå®ƒä»¬æ˜¯åœ¨ç¼–è¯‘å™¨å±‚é¢äººå·¥è®¾è®¡çš„ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è¿ç»­çš„ä¸€æ®µå†…å­˜ï¼Œä»¥åä¹Ÿä¼šå®ç°ï¼›</li>
</ul>
<h4 id="3-2-4-Assembly-Characteristics-Operations"><a href="#3-2-4-Assembly-Characteristics-Operations" class="headerlink" title="3.2.4 Assembly Characteristics: Operations"></a>3.2.4 Assembly Characteristics: Operations</h4><ul>
<li>Perform arithmetic function on register or memory dataï¼ˆ<strong>ç®—æœ¯è¿ç®—</strong>åœ¨å­˜å‚¨å™¨ä¸Šçš„æ•°æ®ï¼‰</li>
<li>Transfer data between memory and registerï¼ˆåœ¨å†…å­˜å’Œå¯„å­˜å™¨é—´<strong>è½¬ç§»æ•°æ®</strong>ï¼‰<ul>
<li>load data from memory to register</li>
<li>store register data into memory</li>
</ul>
</li>
<li>Transfer controlï¼ˆæ±‡ç¼–ä»£ç <strong>æµç¨‹æ§åˆ¶</strong>ï¼‰<ul>
<li>Unconditional jumps to/from procedures</li>
<li>Conditional branches</li>
</ul>
</li>
</ul>
<h4 id="3-2-5-Assembling-amp-Disassembling-Object-Code-At-first-glance"><a href="#3-2-5-Assembling-amp-Disassembling-Object-Code-At-first-glance" class="headerlink" title="3.2.5 Assembling &amp; Disassembling Object Code: At first glance"></a>3.2.5 Assembling &amp; Disassembling Object Code: At first glance</h4><p><strong>å…ˆæ¥çœ‹ C code åˆ° æ±‡ç¼–è¯­è¨€/æœºå™¨è¯­è¨€çš„è¿‡ç¨‹</strong>ã€‚</p>
<p>å½“æ±‡ç¼–ä»£ç è¢« assemblerï¼ˆæ±‡ç¼–å™¨ï¼‰æ±‡ç¼–ä¸ºç›®æ ‡ä»£ç æ—¶ï¼Œè¿™æ—¶æ‰€èƒ½çœ‹åˆ°çš„å°±åªæœ‰äºŒè¿›åˆ¶åºåˆ—äº†ã€‚æ¥ä¸‹æ¥è¿˜ä»¥ä¹‹å‰çš„ <code>sum.c</code> ä¸­çš„ <code>sumstore</code> å‡½æ•°ä¸ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0x0400595:    # è¡¨ç¤ºæœ¬å‡½æ•°æ®µä» 0x0400595 å¤„å¼€å§‹</span><br><span class="line">    0x53	# æ¯ä¸€æ¡æŒ‡ä»¤é•¿ä¸º 1/3/5 bytesï¼Œæ•´æ®µå‡½æ•°çš„é•¿åº¦ä¸º 14 bytes</span><br><span class="line">    0x48</span><br><span class="line">    0x89</span><br><span class="line">    0xd3</span><br><span class="line">    0xe8</span><br><span class="line">    0xf2</span><br><span class="line">    0xff</span><br><span class="line">    0xff</span><br><span class="line">    0xff</span><br><span class="line">    0x48</span><br><span class="line">    0x89</span><br><span class="line">    0x03</span><br><span class="line">    0x5b</span><br><span class="line">    0xc3</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¯æ¡æŒ‡ä»¤åªåšä¸€ä»¶äº‹ã€‚ä»¥ <code>sumstore</code> å‡½æ•°ä¸­çš„ä¸€ä¸ªè¯­å¥ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*dest = t;    <span class="comment">/* Store value t where designated by dest. */</span></span><br><span class="line">            <span class="comment">/* è¿™é‡ŒåŠ ä¿¡å·çš„å«ä¹‰æ˜¯å– dest æ‰€æŒ‡å‘çš„åœ°å€ */</span></span><br></pre></td></tr></table></figure>
<p>å¯¹åº”è¿™æ¡æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movq %rax, (%rbx)</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”è¿™æ¡ç›®æ ‡ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x40059e:    48 89 03</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ <code>t</code> æˆ–æŸäº› local variables ä¼šå­˜å‚¨äºå¯„å­˜å™¨ä¸­ï¼ˆä¾‹å¦‚ä¸Šé¢è¡¨ç¤ºå®ƒåœ¨å¯„å­˜å™¨ <code>%rax</code> ä¸­ï¼‰ï¼Œè€Œ <code>dest</code> æŒ‡é’ˆå€¼è‡ªå·±ä¹Ÿè¢«å­˜å‚¨äºå¯„å­˜å™¨ä¸­ï¼ˆä¸Šé¢è¡¨ç¤º <code>dest</code> è‡ªèº«çš„å€¼å­˜äº <code>%rbx</code> ä¸­ï¼‰ï¼›</p>
<p>è¿™é‡Œçš„ <code>(%rbx)</code> è¡¨ç¤º <code>Memory[%rbx]</code>ï¼Œå³ <code>%rbx</code> å€¼æ‰€ä»£è¡¨çš„åœ°å€åœ¨ <code>Memory</code> ä¸­çš„ä½ç½®ï¼›</p>
<p><code>mov A, B</code> æŒ‡ä»¤å°±æ˜¯å°†å€¼ä» A å¤„ç§»åŠ¨åˆ° B å¤„ã€‚ä¸Šé¢çš„æ±‡ç¼–è¯­å¥è¿èµ·æ¥å°±æ˜¯ï¼š<strong>å°†å­˜æ”¾äº <code>%rax</code> ä¸­çš„å€¼ç§»åŠ¨åˆ° <code>%rbx</code> æ‰€ä»£è¡¨ Memory åœ°å€çš„ä½ç½®ä¸Š</strong>ï¼›</p>
<p>æ ¹æ®æ±‡ç¼–å™¨ç¿»è¯‘ï¼Œè¿™æ¡æŒ‡ä»¤åªç”¨äº† 3 bytes æ¥ç¼–ç ï¼š<code>48 89 03</code>ï¼›</p>
<hr>
<p><strong>å†æ¥çœ‹æœºå™¨è¯­è¨€åˆ°æ±‡ç¼–è¯­è¨€çš„åæ±‡ç¼–è¿‡ç¨‹ï¼ˆdisassemblingï¼‰</strong>ã€‚</p>
<p>åæ±‡ç¼–çš„å®ç°å’Œæ±‡ç¼–ä¸€æ ·ï¼Œåè€…æ˜¯å°†æ–‡æœ¬ç‰ˆæœ¬ï¼ˆæ±‡ç¼–ä»£ç ï¼‰è½¬æ¢ä¸ºå­—èŠ‚ç ï¼ˆæœºå™¨ä»£ç ï¼‰çš„å½¢å¼è¡¨ç¤ºï¼Œå‰è€…å°†å­—èŠ‚ç å¯¹åº”è§£é‡Šæˆæ˜“è¯»çš„æ–‡æœ¬å³å¯ã€‚</p>
<p>å¦‚æœå½“å‰æ²¡æœ‰æºæ–‡ä»¶ï¼Œç”šè‡³æ²¡æœ‰æ±‡ç¼–ä»£ç ï¼Œé‚£ä¹ˆå¯ä»¥ç”±<strong>åæ±‡ç¼–å™¨ï¼ˆdisassemblerï¼‰</strong>æ¥å°†ç›®æ ‡ä»£ç ï¼ˆ*.oï¼‰<strong>æˆ–è€…</strong>å¯æ‰§è¡Œç¨‹åºï¼ˆå·²é“¾æ¥åº“çš„ç›®æ ‡ä»£ç ï¼‰è½¬æ¢æˆæ±‡ç¼–ä»£ç ï¼ˆ*.sï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d <span class="built_in">sum</span> &gt; sum.d <span class="comment"># åç¼–è¯‘ä¹‹å‰çš„ sum ç¨‹åºï¼Œ-d å°†å¯æ‰§è¡Œéƒ¨åˆ†åæ±‡ç¼–æ˜¾ç¤ºåˆ° stdout</span></span><br></pre></td></tr></table></figure>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ±‡ç¼–ä»£ç çš„å±‚æ¬¡ä¸‹ï¼Œ<strong>æ— æ³•</strong>å†å‘ä¸Šè¿˜åŸåˆ°æºæ–‡ä»¶ï¼ˆ*.cï¼‰ï¼Œå› ä¸ºå…¶ä¸­çš„å‡½æ•°/å˜é‡åã€éƒ½åœ¨æ±‡ç¼–è¿‡ç¨‹ä¸¢å¤±äº†ï¼Œåªå‰©ä¸‹ä¸€äº›å¯„å­˜å™¨çš„åç§°å’Œ Memory åœ°å€ã€‚</p>
<p>ä¸Šé¢ä½¿ç”¨ <code>objdump</code> å¯ä»¥å¾—åˆ°çœŸæ­£æ„ä¹‰ä¸Šçš„æ±‡ç¼–ä»£ç ï¼ˆä»æœºå™¨ä»£ç è½¬æ¢è€Œæ¥ï¼‰ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼šä½¿ç”¨ <code>gdb</code>ã€‚</p>
<p>å¦‚æœä½¿ç”¨ <code>gdb</code> æ‰“å¼€ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿è¡Œ <code>disassemble &lt;funcName&gt;</code> å°±å¯ä»¥å¯¹å¯æ‰§è¡Œæ–‡ä»¶ä¸­å¯¹åº”çš„å‡½æ•°åŒºåŸŸè¿›è¡Œåæ±‡ç¼–ã€‚ä½†åªæ˜¾ç¤ºè¿™äº›æŒ‡ä»¤çš„åœ°å€ + ç¿»è¯‘æŒ‡ä»¤ï¼Œä¸æ˜¾ç¤ºå­—èŠ‚çº§çš„ç¼–ç ã€‚</p>
<h3 id="3-3-Assembly-Basics"><a href="#3-3-Assembly-Basics" class="headerlink" title="3.3 Assembly Basics"></a>3.3 Assembly Basics</h3><h4 id="3-3-1-The-names-for-integer-registers"><a href="#3-3-1-The-names-for-integer-registers" class="headerlink" title="3.3.1 The names for integer registers"></a>3.3.1 The names for integer registers</h4><p>ä¸‹é¢åˆ—ä¸¾ x86-64 architecture çš„ <strong>æ•´æ•°å‹å¯„å­˜å™¨ï¼ˆInteger Registerï¼‰</strong>ã€‚</p>
<p><img src="imgs/registers_in_x86_64.png" height="400px"></p>
<p>å¦‚å›¾ï¼Œè¿™äº›å¯„å­˜å™¨å…±æœ‰ 16 ä¸ªï¼Œåå­—å¤§è‡´åˆ†ä¸º 2 ç±»ï¼Œä¸€ç±»æ˜¯å­—æ¯è¡¨ç¤ºçš„ï¼ˆax/bx/â€¦ï¼‰ï¼Œå¦ä¸€ç±»æ˜¯æ•°å­—è¡¨ç¤ºçš„ï¼ˆ8/9/â€¦ï¼‰ã€‚</p>
<p>ç›®å‰ä¸€ä¸ª x86-64 æ¶æ„çš„ integer register æ€»å¤§å°æœ‰ 64-bitã€‚é‰´äºå¯¹ä»¥å‰ 32-bit æœºå™¨å’Œç¨‹åºçš„å‘å‰å…¼å®¹ï¼ˆbackwards compatibilityï¼‰ï¼Œæ±‡ç¼–è¯­è¨€å…è®¸ä½¿ç”¨ä¸€ä¸ªå¯„å­˜å™¨çš„<strong>ä¸åŒéƒ¨åˆ†</strong>ï¼Œæ€ä¹ˆç”¨å–å†³äºæŒ‡ä»¤ã€‚</p>
<p>å¯¹äºå­—æ¯ç±»åç§°çš„å¯„å­˜å™¨ï¼ˆå¦‚ä¸Šå›¾å·¦ï¼‰ï¼Œå¦‚æœä½¿ç”¨<strong>å‰ç¼€ <code>%r</code></strong>ï¼ˆä¾‹å¦‚ <code>%rax</code>ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•´å‹å¯„å­˜å™¨å°†ä¿å­˜ <strong>64-bit</strong> å¤§å°çš„æ•´å‹æ•°æ®ï¼ˆå³ä½¿ç”¨å…¨éƒ¨ç©ºé—´ï¼‰ï¼›å¦‚æœä½¿ç”¨<strong>å‰ç¼€ <code>%e</code></strong>ï¼ˆä¾‹å¦‚ <code>%eax</code>ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•´å‹å¯„å­˜å™¨å°†ä¿å­˜ <strong>32-bit</strong> å¤§å°çš„æ•´å‹æ•°æ®ï¼ˆå³ä»ä½ä½å¼€å§‹ä½¿ç”¨ 32 bitsï¼Œåˆç§°ä¸º <strong>low-order 32-bit</strong>ï¼‰ã€‚</p>
<p>å¯¹äºæ•°å­—ç±»åç§°çš„å¯„å­˜å™¨ï¼ˆå¦‚ä¸Šå›¾å³ï¼‰ï¼Œå‰ç¼€å¿…é¡»æ˜¯ <code>%r</code>ã€‚å¦‚æœä¸åŠ åç¼€ï¼Œè¡¨ç¤ºä¿å­˜ <strong>64-bit</strong> å¤§å°çš„æ•´å‹ï¼›å¦‚æœä½¿ç”¨<strong>åç¼€ <code>d</code></strong>ï¼Œé‚£ä¹ˆå°†ä¿å­˜ <strong>32-bit</strong> å¤§å°çš„æ•´å‹ã€‚</p>
<p>åœ¨è¿™äº›å¯„å­˜å™¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æŒ‡ä»¤å­˜å–æ•°æ®ï¼Œ<strong>è€Œä¸”è¿™äº›æ˜¯æœºå™¨çº§ç¼–ç¨‹ï¼Œå’Œå…·ä½“æœºå™¨çš„å‹å·å¯†åˆ‡ç›¸å…³ï¼Œæ¯æ­¥å³å¿…é¡»æ¸…æ¥šæŒ‡å‡ºä»å“ªä¸ªå¯„å­˜å™¨åˆ°å“ªä¸ªå¯„å­˜å™¨</strong>ã€‚</p>
<p>åœ¨ x86-64 æ¶æ„ä¸‹ï¼Œæœ€å¸¸è§çš„æ˜¯ 64-bit register çš„ä½¿ç”¨ï¼Œå…¶æ¬¡æ˜¯ low-order 8-bit çš„ä½¿ç”¨ï¼ˆç”¨åœ¨æ¡ä»¶æ§åˆ¶ä¸­ï¼Œè¿™ä¸ªä¼šåœ¨ä¸‹ä¸€ç« ä»‹ç»ï¼‰ã€‚å› æ­¤ï¼Œé™¤éæåŠï¼Œä¸‹é¢é»˜è®¤çš„ register å…¨éƒ¨æ˜¯ä»¥ <code>%r</code> ä¸ºå‰ç¼€çš„ 16 ä¸ªå¯„å­˜å™¨ã€‚</p>
<hr>
<p>ä¸‹é¢è¡¥å……ä¸€äº›å†å²ä¿¡æ¯ï¼Œå¸®åŠ©ç†è§£è¿™äº›å¯„å­˜å™¨å¥‡æ€ªçš„ï¼ˆquirkyï¼‰åå­—ï¼š</p>
<p>åœ¨æ—©æœŸ IA32 æ¶æ„ä¸‹ 32-bit å¤„ç†å™¨åªç”¨åˆ°äº† 8 ä¸ªå¯„å­˜å™¨ï¼Œå®ƒä»¬çš„åå­—åˆ†åˆ«æ˜¯ï¼š</p>
<p><code>%eax</code>ã€<code>%ecx</code>ã€<code>%edx</code>ã€<code>%ebx</code>ã€<code>%esi</code>ã€<code>%edi</code>ã€<code>%esp</code>ã€<code>%ebp</code>ï¼ˆéƒ½æ˜¯ <code>%e</code> å‰ç¼€,æ„å‘³ç€å­˜ 32-bit æ•´å‹ï¼‰</p>
<p>æ­¤ä½ï¼Œè¿™äº›å¯„å­˜å™¨è¿˜èƒ½å¼•ç”¨ <strong>low-order 16-bits</strong>ï¼ˆå®ƒä»¬æ˜¯æœ€å¼€å§‹å‡ºç°çš„ 16-bit å¯„å­˜å™¨ï¼Œæ²¡æœ‰ <code>e/r</code> å‰ç¼€ï¼Œå¼•ç”¨çš„åç§°ä¸º <code>%ax</code>ã€<code>%cx</code>ã€<code>%bx</code>â€¦â€¦ï¼‰ï¼Œç”šè‡³æ˜¯ <strong>low-order 8-bits å’Œ high-order 8-bits</strong>ï¼ˆåˆ†åˆ«æ˜¯ <code>%al</code> å’Œ <code>%ah</code> ç­‰ï¼Œå¦‚ä¸‹å›¾ï¼‰ã€‚è¿™é‡Œä¸è®²è¿°è¿™äº›æ—§ç‰ˆæœ¬æœºå™¨çš„ä½ä½å¯„å­˜å™¨ä½ç½®çš„æ“ä½œæŒ‡ä»¤ï¼Œä¸è¿‡åœ¨ä¸‹ä¸€ç« ä¼šæåˆ°æ“ä½œ <strong>low-order 8-bits</strong> çš„æ“ä½œæŒ‡ä»¤ï¼Œå› ä¸ºä¼šæ¶‰åŠæ±‡ç¼–æ¡ä»¶æ§åˆ¶ã€‚</p>
<p><img src="imgs/IA32_registers.png" height="350px"></p>
<p>å¾ˆæ—©ä»¥å‰ï¼Œå„ä¸ªå¯„å­˜å™¨çš„åå­—æœ‰ç‰¹å®šå«ä¹‰ï¼Œä»£è¡¨å®ƒä»¬çš„ç›®çš„ã€‚ä¾‹å¦‚ <code>a</code> ä»£è¡¨ accumulateï¼Œ<code>c</code> ä»£è¡¨ counterï¼Œ<code>d</code> ä»£è¡¨ dataï¼Œ<code>b</code> ä»£è¡¨ baseï¼Œ<code>si</code> ä»£è¡¨ source indexï¼Œ<code>di</code> ä»£è¡¨ destination indexï¼Œ<code>sp</code> ä»£è¡¨ stack pointerï¼Œ<code>bp</code> ä»£è¡¨ base pointerã€‚</p>
<p>ç°åœ¨è¿™äº›å¯„å­˜å™¨å°±æ˜¯æ™®é€šçš„å­˜å–æ•°æ®çš„ç»“æ„ï¼Œåå­—ä¹Ÿå°±æ²¡æœ‰ç‰¹å®šçš„å«ä¹‰äº†â€”â€”<strong>é™¤äº†åå­—æ˜¯ <code>sp</code> çš„å¯„å­˜å™¨</strong>ã€‚å®ƒåœ¨ç›®å‰çš„ x86-64 æ¶æ„ä¸­ä¹Ÿæœ‰ä¸€ä¸ªéå¸¸å…·ä½“çš„ç›®çš„ï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ï¼Œstack pointerï¼Œ<strong>æ ˆæŒ‡é’ˆ</strong>ã€‚</p>
<p>è‡³äºåé¢æ•°å­—è¡¨ç¤ºçš„å¯„å­˜å™¨ï¼Œ<strong>æ˜¯åæ¥ä» IA32 æ¶æ„å‡çº§åˆ° 64 ä½ï¼ˆx86-64ï¼‰æ—¶ï¼ŒèŠ¯ç‰‡å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå¤„ç† 64-bit çš„æ•°æ®äº†ï¼Œæ—§çš„å¯„å­˜å™¨è®¾è®¡ä¸å¤Ÿç”¨äº†ï¼Œæ‰€ä»¥æ–°æ·»åŠ ä¸Šå»çš„ï¼Œå› ä¸ºæ²¡æœ‰ç‰¹å®šç”¨é€”ï¼Œå°±ä»¥æ•°å­—è¿›è¡Œå‘½å</strong>ã€‚</p>
<p>âš  è¯´æ˜¯æ²¡ä»€ä¹ˆâ€œç‰¹æ®Šç”¨é€”â€ï¼Œä½†è¿˜æ˜¯æœ‰çº¦å®šä¿—æˆçš„ä½¿ç”¨æ–¹æ³•çš„ï¼</p>
<p>ä¾‹å¦‚ï¼Œè¿™äº›å¯„å­˜å™¨åˆ†ä¸º â€œ<strong>Callee-Saved Register</strong>â€ å’Œ â€œ<strong>Caller-Saved Register</strong>â€ã€‚</p>
<p>å…¶ä¸­ï¼ŒCallee-Saved Register æ˜¯<strong>è¢«è°ƒç”¨æ–¹ç®¡ä½¿ç”¨çš„</strong>å¯„å­˜å™¨ï¼Œæ•°æ®å†…å®¹åªä¼šåœ¨è¢«è°ƒæ–¹çš„å‡½æ•°å†…æœ‰æ•ˆã€æœ‰æ„ä¹‰ã€‚å±äºè¿™ç±»çš„å¯„å­˜å™¨æœ‰ï¼š<code>%rbx</code>ã€<code>%r12-14</code>ã€<code>%rbp</code> å’Œ <code>%rsp</code>ï¼Œåä¸¤è€…æ˜¯æœ‰ç‰¹æ®Šå«ä¹‰çš„ï¼Œå‰é¢çš„å¯„å­˜å™¨æ˜¯ä¾›è¢«è°ƒæ–¹å­˜å‚¨ä¸´æ—¶æ•°æ®ï¼ˆTemporariesï¼‰ï¼›</p>
<p>Caller-Saved Register æ˜¯<strong>è°ƒç”¨æ–¹ä¿ç®¡ä½¿ç”¨çš„</strong>å¯„å­˜å™¨ï¼Œå®ƒçš„ä½œç”¨å¤§å¤šæ•°æ˜¯æ²Ÿé€šè°ƒç”¨æ–¹å’Œè¢«è°ƒæ–¹çš„æ•°æ®ä¿¡æ¯ã€‚ä¾‹å¦‚ <code>%rax</code> ä¸€èˆ¬å­˜æ”¾è¿”å›å€¼ï¼Œ<code>%rdi</code>ã€<code>%rsi</code>ã€<code>%rdx</code>ã€<code>%rcx</code>ã€<code>%r8</code>ã€<code>%r9</code> ä¾æ­¤å­˜æ”¾è°ƒç”¨å‡½æ•°çš„ç¬¬ 1 ~ ç¬¬ 6 å‚æ•°ï¼›<code>%r10</code>ã€<code>%r11</code> ä¾›å­˜å‚¨è°ƒç”¨æ–¹ä¸´æ—¶æ•°æ®ã€‚</p>
<p>åœ¨ä¸‹é¢çš„éƒ¨åˆ†ä¸­ï¼Œä½ ä¼šä¸€ééåŠ æ·±å¯¹è¿™ä¸ªè¯´æ³•çš„å°è±¡çš„ã€‚ä¸Šé¢çš„å†…å®¹åœ¨ç¬¬äº”ç« ä¼šè¿›ä¸€æ­¥æåŠã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆè¦æœ‰ Callee-Saved å’Œ Caller-Saved Registerï¼Œè¿™ä¹Ÿä¼šåœ¨ 5.4 ä¸­è¯¦ç»†è¯´æ˜ã€‚</p>
<hr>
<h4 id="3-3-2-Move-Operands-and-usage"><a href="#3-3-2-Move-Operands-and-usage" class="headerlink" title="3.3.2 Move, Operands, and usage"></a>3.3.2 Move, Operands, and usage</h4><p>æ¥ä¸‹æ¥ä»‹ç»æ•´å‹å¯„å­˜å™¨åœ¨æ±‡ç¼–ä»£ç ä¸­çš„ä½¿ç”¨ã€‚</p>
<h5 id="Moving-Data-Command-movq-lt-SrcR-gt-lt-DstR-gt"><a href="#Moving-Data-Command-movq-lt-SrcR-gt-lt-DstR-gt" class="headerlink" title="Moving Data Command: movq &lt;SrcR&gt;, &lt;DstR&gt;"></a>Moving Data Command: <code>movq &lt;SrcR&gt;, &lt;DstR&gt;</code></h5><blockquote>
<p>ä¸ºä»€ä¹ˆå‘½ä»¤åä¸­æœ‰ â€œqâ€ ï¼Ÿå› ä¸ºåœ¨ Intel å…¬å¸è®¾å®šä¸­ï¼Œq ä»£è¡¨ quadï¼Œæ˜¯ 4 ä¸ªå­—ï¼Œè€Œåœ¨ 8086 ç³»åˆ—ä¸­ï¼Œ1 ä¸ªå­—è¢«çº¦å®šä¸º 16 bitsï¼ˆ2 bytesï¼‰ï¼Œæ‰€ä»¥ <strong><code>movq</code> æŒ‡ä»¤æ“ä½œçš„å¿…é¡»æ˜¯ 64 bits çš„å¯„å­˜å™¨</strong>ï¼›</p>
<p>âš  <strong>å¦å¤–è¯·æ ¼å¤–æ³¨æ„ï¼ŒIntel å’Œ Microsoft ä½¿ç”¨çš„ x86-64 æ¶æ„çš„æ±‡ç¼–è¯­è¨€çš„è¿™äº›å‚æ•°å’Œ Linux ä½¿ç”¨çš„ x86-64 æ¶æ„çš„å‚æ•°é¡ºåºä¸ä¸€æ ·ï¼CSAPP æ•™æˆçš„æŒ‡ä»¤è¯­æ³•æŒ‰ç…§ Linux æ¥ï¼Œè¯·ä¸è¦å¼„é”™ï¼ä¸è¦åœ¨ Windows ç¯å¢ƒä¸‹å°è¯•è¿™äº›æŒ‡ä»¤ï¼</strong></p>
</blockquote>
<h5 id="Operands"><a href="#Operands" class="headerlink" title="Operands"></a>Operands</h5><ul>
<li><p>Immediateï¼ˆæ•°æ®ç›´æ¥é‡ï¼Œä¾‹å¦‚å¸¸é‡æ•´å‹ï¼‰: <strong>å®šä¹‰å’Œ C è¯­è¨€ä¸€æ ·ï¼Œä½†æ˜¯éœ€è¦åŠ ä¸Šå‰ç¼€ <code>$</code></strong>;</p>
<blockquote>
<p>ä¾‹å¦‚ï¼š<code>$0x400</code>ã€<code>$-523</code> ç­‰ç­‰ï¼›</p>
</blockquote>
</li>
<li><p>Register Name: 16 ä¸ªä¸­ä»»æ„ä¸€ä¸ªæ•´å‹å¯„å­˜å™¨çš„åç§°ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼šä¿ç•™ä½œå…¶ä»–ç”¨é€”çš„å¯„å­˜å™¨ä¹Ÿä¸åº”è¯¥è¢«æ‰‹åŠ¨ä½¿ç”¨ã€‚å‰é¢è¯´äº†ï¼Œä¾‹å¦‚åœ¨ x86-64 æ¶æ„ä¸­ï¼Œ<code>%rsp</code> ä¿ç•™åšç‰¹æ®Šç”¨é€”</strong>ï¼Œå› ä¸ºæ ˆä¸­ä¿å­˜å…¶ä»–é‡è¦çš„çŠ¶æ€ä¿¡æ¯ï¼Œåªèƒ½ç”±æœºå™¨å†…éƒ¨è¿›è¡Œä¿®æ”¹ã€‚</p>
</blockquote>
</li>
<li><p>Memory: <strong>8 consecutive bytes</strong> of memory <strong>at address</strong> given by registers.</p>
</li>
<li><p><strong>æ±‡ç¼–ä»£ç ç®€å•è®¿é—® Memory çš„æ–¹æ³•</strong>ï¼š</p>
<ul>
<li><p>æ³• 1: Normal <code>(%&lt;registerName&gt;)</code></p>
<p>å³ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­çš„ã€8 bytes è¿ç»­çš„åœ°å€æ•°æ®å¯¹åº”çš„ memory ä½ç½®ã€‚</p>
<p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æŠŠå¯„å­˜å™¨åç§°æ”¾åœ¨æ‹¬å·é‡Œæ—¶ï¼Œå°±æ˜¯è¡¨ç¤ºæŠŠå¯„å­˜å™¨ä¸­æ•°æ®çœ‹ä½œ memory åœ°å€ï¼ˆæ— è®ºæ˜¯ä»€ä¹ˆï¼‰ï¼Œå¹¶ç”¨è¿™ä¸ªåœ°å€æ¥å¼•ç”¨å¯¹åº”çš„å†…å­˜ä½ç½®</strong>ã€‚</p>
<p>ä¾‹å¦‚ï¼š<code>(%rax)</code> å°±æ˜¯ä»£è¡¨å–å­˜æ”¾åœ¨ <code>%rax</code> å¯„å­˜å™¨ä¸­çš„æ•°æ®å¯¹åº” memory ä½ç½®çš„å¼•ç”¨ï¼›</p>
<p><u>è¯·ç‰¢ç‰¢è®°ä½</u>ï¼Œè¿™ç§åœ¨æ‹¬å·å†…æ‰¾åœ°å€çš„å½¢å¼è¢«ç§°ä¸º <strong>Simple Memory Addressing Modes</strong>ï¼ˆç®€å•å†…å­˜å¯»å€æ¨¡å¼ï¼‰ï¼Œè¡¨ç¤ºè¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œå¯„å­˜å™¨è¢«çœ‹ä½œæŒ‡é’ˆï¼Œæ‹¬å·ç›¸å½“äºå–åœ°å€å¹¶æ‰¾åˆ° memory å¯¹åº”çš„å¼•ç”¨ã€‚</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>æ³• 2: Displacement <code>&lt;D&gt;(%&lt;registerName&gt;)</code></p>
<p>å³ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­çš„ã€8 bytes è¿ç»­çš„åœ°å€å¯¹åº” memory çš„æŸä¸ªä½ç½®ï¼Œä»¥è¿™ä¸ªä½ç½®ä¸ºåŸºå‡†ï¼Œå‘ååç§» <code>D</code> ä¸ª bytes æ‰€å¯¹åº”çš„å†…å­˜ä½ç½®çš„å¼•ç”¨ã€‚<strong>å› æ­¤ï¼Œ<code>D</code> ä¸€èˆ¬åªå– 1ï¼Œ2ï¼Œ4</strong>ï¼›</p>
<p>ä¾‹å¦‚ï¼š<code>8(%rbp)</code> å°±æ˜¯ä»£è¡¨å–å­˜æ”¾åœ¨ <code>%rbp</code> å¯„å­˜å™¨ä¸­çš„æ•°æ®å‘ååç§» <code>D</code> ä¸ª bytes çš„ä½ç½®å¯¹åº” memory çš„å¼•ç”¨ï¼›</p>
</li>
</ul>
<ul>
<li><p><strong>æ³• 3: Most General Form <code>D(&lt;Rbase&gt;, &lt;Rindex&gt;, &lt;Scale&gt;)</code></strong></p>
<p>ç­‰ä»·äº <code>Memory[Reg[Rb] + S * Reg[Ri] + D]</code>ï¼ŒæŒ‡ä½¿ç”¨å¯„å­˜å™¨ <code>Rb</code> ä¸­çš„æ•°æ®ä¸ºåŸºï¼ŒåŠ ä¸Š <code>S</code> å€ç‡çš„å¯„å­˜å™¨ <code>Ri</code> ä¸­çš„æ•°æ®ï¼ˆ<strong>å› æ­¤ <code>S</code> åªå– 1ï¼Œ2ï¼Œ4ï¼Œ8 è¿™å‡ ä¸ªä¹‹ä¸€</strong>ï¼‰ï¼Œæœ€åæ€»ä½“åç§» <code>D</code> bytesï¼›</p>
<p><strong>æ³¨æ„ï¼Œ<code>Ri</code> ä¸å»ºè®®ä¸ºå¯„å­˜å™¨ <code>%rsp</code></strong>;</p>
<p><strong>æ³• 3 å°±æ˜¯åŸå§‹æ„ä¹‰ä¸Šçš„æ•°ç»„è‡ªç„¶å¼•ç”¨çš„æ–¹å¼</strong>ï¼›</p>
<p>å¯ä»¥æ€è€ƒä¸ºä»€ä¹ˆ <code>S</code> åªå– 1ã€2ã€4ã€8 ä¸­çš„ä¸€ä¸ªã€‚åŸå› å¾ˆç®€å•ï¼Œè¿™å’Œå®ƒå­˜åœ¨çš„æ„ä¹‰æœ‰å…³ã€‚æˆ‘ä»¬æƒ³åœ¨å¼•ç”¨æ•°ç»„æ—¶ï¼Œ<strong>ä¸€å®šå¸Œæœ›æ ¹æ®æ•°æ®ç±»å‹æ¥ç¼©æ”¾ç´¢å¼•å€¼</strong>ï¼Œä¾‹å¦‚ <code>int</code> éœ€è¦ç¼©æ”¾ 4 å€ï¼ˆ4 bytesï¼‰ï¼Œ<code>long</code> éœ€è¦ç¼©æ”¾ 8 å€ï¼›å°äºè¿™äº›æ•°ï¼Œåˆ™ä¼šå¯¼è‡´æ•°æ®é”™è¯¯ï¼Œå¤§äºè¿™äº›æ•°æ®ä¼šå¯¼è‡´ç©ºé—´æµªè´¹ã€‚</p>
</li>
</ul>
<ul>
<li><p>Rulesï¼šä»¥ä¸Šæœ‰äº› operand çš„ç»„åˆæ˜¯ä¸å…è®¸çš„ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>ç›´æ¥é‡ä½œä¸º destinationï¼Œæ²¡æœ‰æ„ä¹‰ï¼›</li>
<li>ä¸ºäº†æ–¹ä¾¿ç¡¬ä»¶è®¾è®¡ï¼Œä¸å…è®¸ç›´æ¥ä»ä¸€ä¸ªå†…å­˜ä½ç½®å¤åˆ¶åˆ°å¦ä¸€ä¸ªå†…å­˜ä½ç½®ï¼Œå¿…é¡» 2 æ­¥ï¼šä»å†…å­˜å­˜å…¥æŒ‡å®šå¯„å­˜å™¨ï¼Œå†ç”±æŒ‡å®šå¯„å­˜å™¨å­˜å…¥å¦ä¸€å—å†…å­˜ï¼ˆ<strong>å†…å­˜åˆ°å†…å­˜å¿…é¡»ç»è¿‡å¯„å­˜å™¨</strong>ï¼‰ï¼›</li>
</ul>
</li>
<li><p>Examplesï¼š</p>
<ul>
<li><p>ä¾‹å¦‚ <code>movq $0x4,%rax</code> å¯èƒ½å¯¹åº”çš„å°±æ˜¯ <code>tmp = 0x4;</code></p>
</li>
<li><p>ä¾‹å¦‚ <code>movq $-147,(%rax)</code>å¯èƒ½å¯¹åº” <code>*p = -147;</code></p>
</li>
<li><p>ä¾‹å¦‚ <code>movq %raw,%rdx</code> å¯èƒ½å¯¹åº” <code>tmp2 = tmp1;</code></p>
</li>
<li><p>ä¾‹å¦‚ <code>movq $rax,(%rdx)</code> å¯èƒ½å¯¹åº” <code>*p = tmp;</code></p>
</li>
<li><p>ä¾‹å¦‚ <code>movq (%rax),%rdx</code> å¯èƒ½å¯¹åº” <code>tmp = *p;</code></p>
</li>
<li><p>ä¾‹å¦‚å‡è®¾ä¸‹é¢è¿™æ®µç¨‹åºå¯èƒ½çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">long</span> *xp, <span class="type">long</span> *yp)</span> &#123;</span><br><span class="line">    <span class="type">long</span> t0 = *xp;</span><br><span class="line">    <span class="type">long</span> t1 = *yp;</span><br><span class="line">    *xp = t1;</span><br><span class="line">    *yp = t0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swap:</span><br><span class="line">    movq	(%rdi), %rax</span><br><span class="line">    movq	(%rsi), %rdx</span><br><span class="line">    movq	%rdx, (%rdi)</span><br><span class="line">    movq	%rax, (%rsi)</span><br><span class="line">    ret						; å›åˆ°ä¹‹å‰è°ƒç”¨ swap å‡½æ•°çš„ä½ç½®ï¼Œç»“æŸå½“å‰å‡½æ•°æ‰§è¡Œ</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨ä¸Šé¢è¿™ä¸ªå‡½æ•°ä½“ä¸­ï¼Œ<code>%rdi</code> æ˜¯ä¿å­˜ç¬¬ä¸€ä¸ªå‚æ•°çš„å¯„å­˜å™¨ï¼Œ<code>%rsi</code> æ˜¯ç¬¬äºŒä¸ªå‚æ•°å¯„å­˜å™¨ï¼Œæœ€å¤šç”¨ 6 ä¸ª</strong>ï¼Œè¿™æ˜¯åœ¨æ‰§è¡Œæ­¤å‡½æ•°å‰å°±è®¾ç½®å¥½çš„ã€‚å‰©ä¸‹å¯„å­˜å™¨çš„é€‰æ‹©æ˜¯ç”±ç¼–è¯‘å™¨è‡ªå·±å†³å®šçš„ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½å¯èƒ½ä¸å¤ªä¸€æ ·ï¼›</p>
</li>
</ul>
</li>
<li><p>Exercises: Address Computation Examplesï¼ˆæ ¹æ®ä¿¡æ¯å¡«å†™ä¸‹è¡¨ï¼‰</p>
<p>å·²çŸ¥å¯„å­˜å™¨ <code>%rdx</code> å­˜æ”¾æ•°æ® 0xf000ï¼Œå¯„å­˜å™¨ <code>%rcx</code> å­˜æ”¾æ•°æ® 0x0100ã€‚</p>
<table>
    <tr style="text-align: center;">
        <th>Expression</th>
        <th>Address Computation</th>
        <th>Address</th>
    </tr>
    <tr>
        <td>0x8(%rdx)</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>(%rdx,%rcx)</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>(%rdx,%rcx,4)</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>0x80(,%rdx,2)</td>
        <td></td>
        <td></td>
    </tr>
</table>

<p>ç¬¬ä¸€è¡Œï¼Œå°±æ˜¯æ™®é€š displacementï¼Œ<code>0xF000 + 0x8 = 0xF008</code>;</p>
<p>ç¬¬äºŒè¡Œï¼Œçœç•¥çš„ general displacementï¼Œ<code>0xF000 + 0x0100 = 0xF100</code>;</p>
<p>ç¬¬ä¸‰è¡Œï¼Œçœç•¥çš„ general displacementï¼Œ<code>0xF000 + 4 * 0x0100 = 0xF400</code>;</p>
<p>ç¬¬å››è¡Œï¼Œçœç•¥çš„ general displacementï¼Œ<code>0 + 2 * 0xF000 + 0x80 = 0x1E080</code>;</p>
</li>
</ul>
<h4 id="3-3-3-Arithmetic-amp-logical-operations"><a href="#3-3-3-Arithmetic-amp-logical-operations" class="headerlink" title="3.3.3 Arithmetic &amp; logical operations"></a>3.3.3 Arithmetic &amp; logical operations</h4><h5 id="Address-Computation-Instruction-leaq-lt-Src-gt-lt-Dst-gt"><a href="#Address-Computation-Instruction-leaq-lt-Src-gt-lt-Dst-gt" class="headerlink" title="Address Computation Instruction: leaq &lt;Src&gt;, &lt;Dst&gt;"></a>Address Computation Instruction: <code>leaq &lt;Src&gt;, &lt;Dst&gt;</code></h5><blockquote>
<p>æŒ‡ä»¤å«ä¹‰ï¼šload effective addressï¼ˆåŠ è½½æœ‰æ•ˆåœ°å€ï¼‰ï¼›</p>
<p>æŒ‡ä»¤ç›®æ ‡ï¼ˆå¾ˆæŠ½è±¡ï¼Œç­‰ä¼šæ…¢æ…¢è§£é‡Šï¼‰ï¼š<strong>ç›¸å½“äº C çš„ <code>&amp;</code>ï¼ˆampersandï¼‰ç¬¦å·æ¥è®¡ç®—åœ°å€</strong>ï¼ŒåŸºäºæƒ³è¦è®¡ç®—çš„åœ°å€çš„ä¸€äº›å†…å®¹ï¼ˆä¸€èˆ¬æ˜¯æŒ‡å®šå†…å­˜å¼•ç”¨ï¼‰ã€‚<strong>åŒæ—¶ä¹Ÿä½œä¸ºä¸€ç§éå¸¸æ–¹ä¾¿çš„ç®—æœ¯è¿ç®—æ–¹å¼</strong>ã€‚</p>
<p>æŒ‡ä»¤çš„å¤§è‡´è¿‡ç¨‹ï¼šé€šä¿—æ¥è¯´å°±æ˜¯<strong>ä¼ å…¥çš„å†…å­˜å¼•ç”¨ <code>Src</code>ï¼Œ<code>leaq</code> ä¼šæ‰¾åˆ°è¿™ä¸ªå¼•ç”¨çš„åœ°å€å€¼ï¼Œå¹¶æŠŠè¿™ä¸ªåœ°å€ä¼ ç»™ <code>Dst</code></strong>ï¼Œæœ€å <code>Dst</code> çš„å€¼æ˜¯ <code>Src</code> å¼•ç”¨çš„åœ°å€ï¼Œç›¸å½“äº <code>Dst</code> å˜æˆäº†æŒ‡é’ˆï¼ŒæŒ‡å‘äº† <code>Src</code>ï¼›</p>
<p><code>Dst</code> å‚æ•°<strong>å¿…é¡»æ˜¯å¯„å­˜å™¨åç§°</strong>ï¼Œä¸èƒ½æ˜¯ç›´æ¥é‡ã€å†…å­˜å¼•ç”¨ï¼›</p>
<p><code>Src</code> å‚æ•°<strong>å¿…é¡»æ˜¯å†…å­˜å¼•ç”¨</strong>ï¼Œ<strong>å…è®¸ä½¿ç”¨ä¹‹å‰çš„ Simple Memory Addressing Mode</strong>ï¼Œä¸èƒ½æ˜¯ç›´æ¥é‡ã€å¯„å­˜å™¨åç§°ï¼›</p>
</blockquote>
<p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">m12</span><span class="params">(<span class="type">long</span> x)</span> &#123; <span class="keyword">return</span> x * <span class="number">12</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å‡½æ•°å¯¹åº”çš„æ±‡ç¼–ä»£ç å¯ä»¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m21:</span><br><span class="line">    leaq (%rdi,%rdi,2), %rax</span><br><span class="line">    salq $2, $rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè§£é‡Š <code>(%rdi,%rdi,2)</code>ï¼Œè¿™æ˜¯ä¸Šé¢è¦æ±‚è®°ä½çš„ <strong>Simple Memory Addressing Mode</strong>ï¼Œå®ƒä»£è¡¨ï¼ŒæŠŠ <code>%rdi</code>ï¼ˆå³è¿™é‡Œå­˜æ”¾å‡½æ•°ç¬¬ä¸€å‚æ•° <code>x</code> çš„å¯„å­˜å™¨ï¼‰ä¸­çš„å†…å®¹çœ‹æˆåœ°å€ï¼Œè¿›è¡Œä¸€ä¸ª general displacementï¼š<code>%rdi çš„å€¼ + 2 * %rdi çš„å€¼</code>ï¼Œè¿™é‡Œ<strong>å·§å¦™åœ°å®Œæˆäº†æ‰¾åˆ° 3 å€çš„ <code>%rdi</code> çš„å€¼ï¼ŒæŠŠå®ƒä½œä¸ºç´¢å¼•ï¼Œå…¶å¯¹åº”çš„ memory åœ°å€å¼•ç”¨</strong>ï¼ˆæ³¨ï¼šè¿™ä¸ªåœ°å€å¾ˆå¯èƒ½<strong>ä¸èƒ½</strong>è¢«ç¨‹åºä½¿ç”¨ï¼Œè¿™é‡Œåªæ˜¯å€ŸåŠ©å®ƒè¿›è¡Œç®—æœ¯è®¡ç®—ï¼‰ï¼›</p>
<p>ç„¶å <code>leaq</code> å°†ç¬¬ä¸€å‚æ•°ï¼ˆ3 å€ <code>%rdi</code> å€¼ç´¢å¼•æ‰€å¯¹åº” memory çš„å¼•ç”¨ä½ç½®ï¼‰<strong>å¯¹åº”çš„åœ°å€</strong>èµ‹ç»™äº† <code>%rax</code> å¯„å­˜å™¨ã€‚<strong>åˆ°æ­¤ä¸ºæ­¢ï¼Œ<code>%rax</code> ä¸­æˆåŠŸè·å¾—äº† <code>%rdi</code> ä¸­çš„ 3 å€å€¼ï¼Œä¸­é—´çš„æ–¹æ³•è™½ç„¶ç”¨åˆ°äº†æŒ‡é’ˆçš„æ¦‚å¿µï¼Œä½†æœ¬è´¨ä¸æ˜¯æŒ‡é’ˆæ“ä½œï¼Œæ˜¯ç®—æ•°æ“ä½œ</strong>ï¼ˆæ…¢æ…¢é¢†æ‚Ÿå§ï¼‰ã€‚</p>
<p>æœ€åä½¿ç”¨çš„ <code>salq</code> æŒ‡ä»¤å¾ˆç®€å•ï¼Œå°±æ˜¯åº•å±‚çš„ç§»ä½æŒ‡ä»¤ï¼ˆåœ¨åé¢ä»‹ç»ï¼‰ï¼Œå°† <code>%rax</code> çš„äºŒè¿›åˆ¶å€¼å‘å·¦ç§»åŠ¨ 2 ä½ï¼Œç›¸å½“äº Ã— 4ï¼Œæ€»çš„æ¥è¯´ <code>%rax</code> çš„å€¼å°±ç›¸å½“äºåŸæ¥ <code>%rdi</code> çš„å€¼ Ã— 12ï¼Œå®Œæˆäº† Ã— 12 çš„æ“ä½œã€‚</p>
<blockquote>
<p>æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸å…¨éƒ½ç»™ <code>leaq</code> æ¥è®¡ç®— Ã— 12 å‘¢ï¼Ÿå…¶å®ç§»ä½åœ¨æ•ˆç‡ä¸Šä¼šæ›´å¿«ä¸€äº›ã€‚ä¸€èˆ¬ C/C++ ç¨‹åºåœ¨ä¹˜å¸¸æ•°æ“ä½œæ—¶ï¼Œä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œåˆ†è§£å‡º $2^k$ çš„å› å­ï¼Œä¸€éƒ¨åˆ†ç”¨ <code>leaq</code> è®¡ç®—ï¼Œå¦ä¸€éƒ¨åˆ†ç”¨ <code>salq</code> ç§»ä½ã€‚</p>
</blockquote>
<h5 id="Some-Arithmetic-Operations"><a href="#Some-Arithmetic-Operations" class="headerlink" title="Some Arithmetic Operations"></a>Some Arithmetic Operations</h5><ul>
<li><code>addq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst + Src</code></li>
<li><code>subq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst - Src</code></li>
<li><code>imulq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst * Src</code></li>
<li><code>salq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst &lt;&lt; Src</code></li>
<li><code>sarq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst &gt;&gt; Src</code>ï¼ˆ<strong>ç®—æœ¯å³ç§»ï¼Œarithmetic right shift</strong>ï¼‰</li>
<li><p><code>shrq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst &gt;&gt; Src</code>ï¼ˆ<strong>é€»è¾‘å³ç§»ï¼Œlogical right shift</strong>ï¼‰</p>
</li>
<li><p><code>xorq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst ^ Src</code></p>
</li>
<li><code>andq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst &amp; Src</code></li>
<li><code>orq &lt;Src&gt;, &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst | Src</code></li>
</ul>
<p><strong>åˆ‡è®°ï¼Œåˆ«æé”™ operands çš„é¡ºåºï¼<code>Src</code> åœ¨å‰ï¼Œ<code>Dst</code> åœ¨å</strong>ï¼›</p>
<ul>
<li><code>incq &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst + 1</code></li>
<li><code>decq &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = Dst - 1</code></li>
<li><code>negq &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = -Dst</code></li>
<li><code>notq &lt;Dst&gt;</code>ï¼šç›¸å½“äº <code>Dst = ~Dst</code>ï¼ˆæ³¨æ„æ˜¯<strong>æŒ‰ä½å¦</strong>ï¼‰</li>
</ul>
<p>æ›´å¤šæŒ‡ä»¤è¯·å‚é˜… x86-64 æŒ‡ä»¤æ‰‹å†Œã€‚</p>
<hr>
<p>ä¸‹é¢æ˜¯ä¸ª <strong>example</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">arith</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">    <span class="type">long</span> t1 = x + y;</span><br><span class="line">    <span class="type">long</span> t2 = z + t1;</span><br><span class="line">    <span class="type">long</span> t3 = x + <span class="number">4</span>;</span><br><span class="line">    <span class="type">long</span> t4 = y * <span class="number">48</span>;</span><br><span class="line">    <span class="type">long</span> t5 = t3 + t4;</span><br><span class="line">    <span class="type">long</span> rval = t2 * t5;</span><br><span class="line">    <span class="keyword">return</span> rval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">arith:</span><br><span class="line">    leaq	(%rdi,%rsi), %rax</span><br><span class="line">    addq	%rdx, %rax</span><br><span class="line">    leaq	(%rsi,%rsi,2), %rdx</span><br><span class="line">    salq	$4, %rdx</span><br><span class="line">    leaq	4(%rdi,%rdx), %rcx</span><br><span class="line">    imulq	%rcx, %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ <code>%rdi</code> å­˜æ”¾äº†å‡½æ•°ç¬¬ä¸€å‚æ•° xï¼Œ<code>%rsi</code> å­˜æ”¾äº†å‡½æ•°ç¬¬äºŒå‚æ•° <code>y</code>ï¼Œ<code>%rdx</code> å­˜æ”¾äº†å‡½æ•°ç¬¬ä¸‰å‚æ•° <code>z</code>ï¼›</p>
<p>ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥ç†è§£ä¸ºå°† <code>%rdi</code> å’Œ <code>%rsi</code> å€¼çœ‹ä½œåœ°å€ï¼Œæ‰¾åˆ° <code>%rdi å€¼ + %rsi å€¼</code> å¯¹åº”çš„ memory å¼•ç”¨ï¼Œå¹¶åˆ©ç”¨ <code>leaq</code> å°†å¼•ç”¨ä»£è¡¨çš„åœ°å€èµ‹ç»™ <code>%rax</code>ï¼Œä½¿å¾— <code>%rax</code> è·å¾—äº† <code>%rdi</code> å’Œ <code>%rsi</code> å€¼ä¹‹å’Œçš„å€¼ï¼Œ<strong>ä¹‹æ‰€ä»¥ä¸ç”¨ <code>addq</code>ï¼Œæ˜¯å› ä¸º <code>addq</code>  ä¼šæŠŠç»“æœåŠ åˆ° <code>Dst</code> ä¸Šï¼Œä½†è¿™é‡Œæ˜¾ç„¶ä¸æƒ³ä¿®æ”¹ä»»ä½•å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œåªæ˜¯æƒ³æŠŠå€¼ç»™åˆ°æ–°çš„å¯„å­˜å™¨</strong>ï¼ˆæ­¤æ­¥å¯¹åº” <code>long t1 = x + y;</code>ï¼Œç›¸å½“äºè¿™é‡Œ <code>%rax</code> å­˜çš„æ˜¯ <code>t1</code>ï¼‰ï¼›</p>
<p>ç¬¬äºŒæ­¥ï¼ŒæŠŠ <code>%rdx</code> çš„å€¼ï¼ˆxï¼‰åŠ åˆ° <code>%rax</code> ä¸Šï¼Œè¿™æ—¶çš„ <code>%rax</code> å­˜çš„æ˜¯ <code>t2</code>ï¼ˆ<code>t1</code> ä»¥åä¸ä¼šç”¨äº†ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨æŠ›å¼ƒäº†ï¼Œç›´æ¥ç”¨ <code>addq</code> æ“ä½œ <code>%rax</code>ï¼Œè¿™ä¹ˆåšå¯ä»¥æå‡æ•ˆç‡ï¼Œå¯¹åº” <code>long t2 = z + t1;</code>ï¼‰ï¼›</p>
<p>ç¬¬ä¸‰æ­¥ã€ç¬¬å››æ­¥ï¼Œå‰é¢è¯´äº†å¥½å‡ éï¼Œè¿™é‡Œè¯´ç®€å•ä¸€ç‚¹ï¼Œå°±æ˜¯æŠŠ <code>%rdx</code> ï¼ˆåŸå…ˆå­˜ <code>z</code> çš„å¯„å­˜å™¨ï¼ŒæŠ›å¼ƒ <code>z</code> ä¹Ÿæ˜¯å› ä¸ºä¹‹åä¸ç”¨ <code>z</code> å˜é‡äº†ï¼Œç¼–è¯‘å™¨è¿›è¡Œäº†ä¼˜åŒ–ï¼‰èµ‹ä»¥ 3 å€çš„ <code>%rsi</code> å€¼ï¼Œå¹¶ä¸”æŠŠ <code>%rdx</code> çš„å€¼ä¹˜ä»¥ $2^4=16$ï¼Œæ€»çš„æ¥è¯´ï¼Œ<code>%rdx</code> è¢«èµ‹ä»¥ 48 å€çš„ <code>%rsi</code>ï¼ˆyï¼‰çš„å€¼ï¼Œå¯¹åº” <code>long t4 = y * 48;</code>ï¼Œè¿™æ—¶ <code>%rdx</code> å­˜æ”¾çš„å°±æ˜¯ <code>t4</code> äº†ï¼›</p>
<p>ç¬¬äº”æ­¥ï¼Œç®€å•è¯´å°±æ˜¯ <code>%rcx</code> è¢«èµ‹ä»¥ <code>%rdi çš„å€¼ï¼ˆxï¼‰ + %rdx çš„å€¼ï¼ˆt4ï¼‰ + 4</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œç¼–è¯‘å™¨æƒ³å°½ä¸€åˆ‡åŠæ³•ï¼ŒæŠŠ <code>long t3 = x + 4;</code> å’Œ <code>long t5 = t3 + t4;</code> è¿™æ­¥åˆèµ·æ¥äº†ï¼Œæ•´æ•´çœä¸‹æ¥äº†ä¸€ä¸ª <code>t3</code> çš„æ“ä½œï¼Œå¯è°“ä¼˜åŒ–åˆ°æè‡´ã€‚æ‰€ä»¥ï¼Œ<code>%rcx</code> å­˜çš„æ˜¯ <code>t5</code>ï¼›</p>
<p>æœ€åä¸€æ­¥ï¼Œç¼–è¯‘å™¨å®åœ¨æƒ³ä¸åˆ°æ›´å¥½çš„ä¼˜åŒ–æ–¹æ³•ï¼Œåªèƒ½å‹‰ä¸ºå…¶éš¾åœ°è°ƒç”¨äº†å”¯ä¸€ä¸€æ¬¡ <code>imulq</code>ï¼ŒæŠŠ <code>%rcx</code> çš„å€¼ï¼ˆ<code>t5</code>ï¼‰ä¹˜åˆ° <code>%rax</code> ä¸Šï¼Œå¯¹åº” <code>long rval = t2 * t5;</code>ï¼Œå‡½æ•°ç»“æŸï¼Œæœ€åå­˜æ”¾ <code>rval</code> çš„å¯„å­˜å™¨æ˜¯ <code>%rax</code>ã€‚</p>
<hr>
<h2 id="Chapter-4-Machine-Level-Programming-â…¡-Control"><a href="#Chapter-4-Machine-Level-Programming-â…¡-Control" class="headerlink" title="Chapter 4. Machine Level Programming â…¡ - Control"></a>Chapter 4. Machine Level Programming â…¡ - Control</h2><h3 id="4-1-Introduction-to-Condition-Codes"><a href="#4-1-Introduction-to-Condition-Codes" class="headerlink" title="4.1 Introduction to Condition Codes"></a>4.1 Introduction to Condition Codes</h3><h4 id="4-1-1-Processor-State-of-x86-64-partial"><a href="#4-1-1-Processor-State-of-x86-64-partial" class="headerlink" title="4.1.1 Processor State of x86-64, partial"></a>4.1.1 Processor State of x86-64, partial</h4><p>å‰é¢ä»‹ç»è¿‡ï¼Œx86-64 æ¶æ„å…·æœ‰ 16 ä¸ªå¯„å­˜å™¨ï¼Œå…¶ä¸­ 8 ä¸ªæ²¿ç”¨æ—§ x86 æ¶æ„çš„åç§°ï¼Œå¦å¤– 8 ä¸ªä» 8 ~ 15 å‘½åã€‚å¯ä»¥æ€»ç»“ä¸€ä¸‹ï¼Œä»è¿™äº›å¯„å­˜å™¨ / flags å¯ä»¥çœ‹å‡ºå¤„ç†å™¨å½“å‰çš„çŠ¶æ€ï¼š</p>
<ul>
<li><p>Temporary dataï¼šé™¤å» <code>%rsp</code> çš„æ‰€æœ‰ 15 ä¸ªå¯„å­˜å™¨éƒ½æ˜¯å¤„ç†å™¨è¿ç®—æ—¶å­˜å‚¨ä¸´æ—¶æ•°æ®çš„ä½ç½®ï¼›</p>
</li>
<li><p>Location of runtime stackï¼š<code>%rsp</code>;ï¼ˆåœ¨ä»¥åçš„ç« èŠ‚ä¼šæ¶‰åŠè¿è¡Œæ—¶æ ˆï¼‰</p>
</li>
<li><p><strong>Location of current code control point</strong>ï¼š<code>%rip</code></p>
<blockquote>
<p>ä¹‹å‰æ²¡æœ‰è§è¿‡çš„å¯„å­˜å™¨ï¼Œinstruction pointï¼Œå’Œ <code>%rsp</code> ä¸€æ ·æœ‰ç‰¹æ®Šç”¨é€”ã€‚</p>
<p><strong>å®ƒåŒ…å«äº†å½“å‰æ­£åœ¨æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€</strong>ï¼Œä¹Ÿä¸èƒ½æ‰‹åŠ¨ä¿®æ”¹ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡è·å–å®ƒçš„å€¼æ¥è¿›è¡Œä¸€äº›æ“ä½œï¼›</p>
<p><strong>å®ƒä¸€èˆ¬ç”± <code>call</code> æŒ‡ä»¤ å’Œ <code>ret</code> æŒ‡ä»¤ç­‰ä¿®æ”¹</strong>ï¼›</p>
</blockquote>
</li>
<li><p>Status of recent tests: <strong>Condition Code</strong></p>
<ul>
<li>ä¸€å…± 8 ç§ï¼Œ ç°åœ¨åªè¯´å››ç§ï¼Œå…¶ä»–çš„ç”¨åˆ°å†è¯´ï¼š<code>CF</code>ã€<code>ZF</code>ã€<code>SF</code>ã€<code>OF</code>;</li>
<li>å®ƒä»¬éƒ½æ˜¯ 1-bit flagï¼Œä¸æ˜¯è¢«ç›´æ¥æ‰‹åŠ¨è®¾ç½®ï¼Œè€Œæ˜¯æ ¹æ®å…¶ä»–æŒ‡ä»¤æ“ä½œåçš„ç»“æœè¿›è¡Œè®¾ç½®ï¼ˆ<strong>implicit setting</strong>ï¼‰ï¼›</li>
<li>æ˜¯æ±‡ç¼–æ¡ä»¶æ“ä½œçš„åŸºç¡€ï¼›</li>
</ul>
</li>
</ul>
<h4 id="4-1-2-The-meanings-for-Condition-Codes"><a href="#4-1-2-The-meanings-for-Condition-Codes" class="headerlink" title="4.1.2 The meanings for Condition Codes"></a>4.1.2 The meanings for Condition Codes</h4><ul>
<li>Single bit register: è¿™ç§å¯„å­˜å™¨ä¸æ˜¯ä¹‹å‰ä»‹ç»çš„æ•´å‹å¯„å­˜å™¨ï¼Œå®ƒä»…å­˜å‚¨ 1-bit æ•°æ®ï¼Œä¸“é—¨ç”¨äºå­˜æ”¾ condition codesï¼Œå®ƒä»¬çš„åç§°å°±æ˜¯å¯¹åº”çš„ flag çš„åç§°ã€‚å…ˆä»‹ç»å…¶ä¸­ 4 ç§çš„å«ä¹‰ï¼š<ul>
<li><code>CF</code>: Carry Flag (for unsigned, å°†ä¸¤ä¸ª unsigned ç›¸åŠ ï¼ŒMSB çš„è¿›ä½)ï¼›</li>
<li><code>SF</code>: Sign Flag (for signed, å½“ signed è¿ç®—ç»“æœçš„ MSB = 1ï¼Œè¯´æ˜ç»“æœæ˜¯è´Ÿå€¼ï¼Œæ­¤ä½ä¼šè¢«ç½® 1);</li>
<li><code>ZF</code>: Zero Flag (ä¸Šä¸€ä¸ªè®¡ç®—ç»“æœä¸º 0 æ—¶ï¼Œæ­¤ä½ä¼šè¢«ç½® 1ã€‚ä¾é ç®—æœ¯æŒ‡ä»¤å†…éƒ¨å®ç°);</li>
<li><code>OF</code>: Overflow Flag (signed è¿ç®—æº¢å‡ºçš„ä½ã€‚<strong>å› æ­¤å¯ä»¥å°† <code>CF</code> ç†è§£ä¸ºâ€œunsigned è¿ç®—æº¢å‡ºçš„ä½</strong>â€);</li>
</ul>
</li>
<li><strong>æ³¨æ„ï¼šä¹‹å‰è¯´çš„ <code>leaq</code> ä¸ä¼šè®¾ç½®è¿™äº› flags</strong>ï¼›ä½†ä¹‹å‰ä»‹ç»çš„ç®—æœ¯è¿ç®—æŒ‡ä»¤ä¼šã€‚</li>
<li><strong>æ³¨æ„2ï¼šä¹Ÿæœ‰ä¸“é—¨åˆ©ç”¨è®¡ç®—ç»“æœå€¼æ¥è®¾ç½® flags çš„æŒ‡ä»¤ï¼š<code>compare å’Œ test</code></strong> (explicit setting)</li>
</ul>
<h4 id="4-1-3-Condition-Codes-Explicit-Setting"><a href="#4-1-3-Condition-Codes-Explicit-Setting" class="headerlink" title="4.1.3 Condition Codes: Explicit Setting"></a>4.1.3 Condition Codes: Explicit Setting</h4><h5 id="Compare-cmpq-lt-Src2-Src1-gt"><a href="#Compare-cmpq-lt-Src2-Src1-gt" class="headerlink" title="Compare: cmpq &lt;Src2, Src1&gt;"></a>Compare: <code>cmpq &lt;Src2, Src1&gt;</code></h5><ul>
<li>ä½œç”¨ï¼šå‡ ä¹å’Œ <code>subq</code> ä¸€æ ·ï¼Œä½†ä¸ä¿®æ”¹ç»“æœå€¼ï¼Œå› ä¸ºå®ƒè®¡ç®— <code>Src1 - Src2</code> å¹¶ä¸”ä¸ä¼šå¯¹ <code>Src1/2</code> è¿›è¡Œä»»ä½•æ“ä½œï¼Œä½†ä¼šç”±æ­¤è®¾ç½®ä¸Šé¢ 4 ä¸ªä»‹ç»åˆ°çš„ condition codesï¼›</li>
<li>å†…éƒ¨å¦‚ä½•è®¾ç½® condition codesï¼šä¸»è¦ä¾æ® <code>Src1 - Src2</code> å‡æ³•æ“ä½œã€‚<ul>
<li><code>CF</code> set if carry out from MSB (used for unsigned comparisons);</li>
<li><code>ZF</code> set if <code>Src1 == Src2</code>ï¼ˆå³ <code>Src1 - Src2</code> è¿ç®—ç»“æœç»“æœæ˜¯å¦ä¸º 0ï¼‰;</li>
<li><code>SF</code> set if <code>(Src1 - Src2) &lt; 0</code>ï¼ˆå³ <code>Src1 - Src2</code> è¿ç®—ç»“æœçš„ sign ä½æ˜¯å¦ä¸º 1ï¼‰;</li>
<li><code>OF</code> set if <code>(Src1 - Src2)</code> in twoâ€™s complement (signed) overflowï¼ˆå³ <code>(Src1 &gt; 0 &amp;&amp; Src2 &lt; 0 &amp;&amp; (Src1 - Src2) &lt; 0) || (Src1 &lt; 0 &amp;&amp; Src2 &gt; 0 &amp;&amp; (Src1 - Src2) &gt; 0)</code>ï¼Œç”¨çš„å°±æ˜¯åˆ¤æ–­ signed æº¢å‡ºçš„æ¡ä»¶ï¼šä¸¤ä¸ªåŒå· signed ç›¸åŠ ä¸ºå¼‚å·ï¼Œè¯´æ˜æ­£/è´Ÿæº¢å‡ºï¼‰;</li>
</ul>
</li>
</ul>
<h5 id="Test-testq-lt-Src2-Src1-gt"><a href="#Test-testq-lt-Src2-Src1-gt" class="headerlink" title="Test: testq &lt;Src2, Src1&gt;"></a>Test: <code>testq &lt;Src2, Src1&gt;</code></h5><ul>
<li>ä½œç”¨ï¼šå‡ ä¹å’Œ <code>andq</code> ä¸€æ ·ï¼Œä½†ä¸ä¿®æ”¹ç»“æœå€¼ï¼Œåªè®¡ç®— <code>Src1 &amp; Src2</code>ï¼Œå¹¶ç”±æ­¤è®¾ç½® condition codesï¼›</li>
<li>å†…éƒ¨å¦‚ä½•è®¾ç½® condition codesï¼š<ul>
<li><code>ZF</code> set when <code>Src1 &amp; Src2 == 0</code>;</li>
<li><code>SF</code> set when <code>Src1 &amp; Src2 &lt; 0</code>;</li>
<li>å› ä¸ºæŒ‰ä½ä¸”ä¸ä¼šå¯¼è‡´ä»»ä½•çš„è¿›ä½ï¼Œæ‰€ä»¥ä¸è®¾ç½® <code>CF/OF</code>;</li>
</ul>
</li>
<li>å’Œä¸Šé¢çš„ Compare ç›¸æ¯”ï¼ŒTest æŒ‡ä»¤å¯ä»¥è¿›è¡Œä¸€ä¸ªå‚æ•°çš„åˆ¤æ–­ï¼Œä¾‹å¦‚ <code>testq %rax, %rax</code>ï¼Œä¹ŸæŠŠä¸€ä¸ªå‚æ•°å†™æˆ maskï¼Œä¾‹å¦‚ <code>testq $0x22, %rax</code>;</li>
</ul>
<h4 id="4-1-4-Condition-Codes-Reading"><a href="#4-1-4-Condition-Codes-Reading" class="headerlink" title="4.1.4 Condition Codes: Reading"></a>4.1.4 Condition Codes: Reading</h4><p>å‰é¢è¯´å®Œå¦‚ä½•è®¾ç½®ï¼Œç°åœ¨ç§°è¿°ä¸€ä¸‹å¦‚ä½•è¯»å–ä½¿ç”¨ã€‚è¿™é‡Œä¸€èˆ¬ä¸å…è®¸ç›´æ¥è®¿é—® flags å¯¹åº”çš„å¯„å­˜å™¨ï¼Œè€Œæ˜¯ç”¨ä¸€ç³»åˆ—çš„ <code>SetX</code> instructions æ¥è¯»å–å¹¶æ“ä½œã€‚</p>
<p><code>SetX</code> Instructions çš„ä½œç”¨å°±æ˜¯<strong>æŒ‰ç…§å½“å‰çš„ condition codesï¼Œæ¥å°†æŒ‡å®šçš„å•ä¸ªå¯„å­˜å™¨çš„å•ä¸ª byte è®¾ç½®ä¸º 1 æˆ– 0</strong>ï¼›</p>
<p><code>SetX</code> Instructions å…·ä½“çš„ç±»å‹å¦‚ä¸‹ï¼š</p>
<table>
    <tr style="text-align: center;">
        <th>SetX</th>
        <th>Condition</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>sete</td>
        <td>ZF</td>
        <td>Equal/Zero</td>
    </tr>
    <tr>
        <td>setne</td>
        <td>~ZF</td>
        <td>Not Equal/Not Zero</td>
    </tr>
    <tr>
        <td>sets</td>
        <td>SF</td>
        <td>Negative</td>
    </tr>
    <tr>
        <td>setns</td>
        <td>~SF</td>
        <td>Nonegative</td>
    </tr>
    <tr>
        <td>setg</td>
        <td>~(SF^OF)&amp;~ZF</td>
        <td>Greater (signed)</td>
    </tr>
    <tr>
        <td>setge</td>
        <td>~(SF^OF)</td>
        <td>Greater or Equal (signed)</td>
    </tr>
    <tr>
        <td>setl</td>
        <td>(SF^OF)</td>
        <td>Less (signed)</td>
    </tr>
    <tr>
        <td>setle</td>
        <td>(SF^OF) | ZF</td>
        <td>Less or Equal (signed)</td>
    </tr>
    <tr>
        <td>seta</td>
        <td>~CF &amp; ~ZF</td>
        <td>Above (unsigned)</td>
    </tr>
    <tr>
        <td>setb</td>
        <td>CF</td>
        <td>Below (unsigned)</td>
    </tr>
</table>

<blockquote>
<p><code>SetX</code> Instructions éƒ½æœ‰å”¯ä¸€å‚æ•°ï¼ˆ<strong>è¯­æ³• <code>setX &lt;Dst&gt;</code></strong>ï¼‰ï¼Œè¦æ±‚æ˜¯å•ä¸ªå¯„å­˜å™¨çš„ low-order 8-bit çš„å¼•ç”¨åç§°ï¼Œè¿™æ˜¯ç”±è¿™æ¡æŒ‡ä»¤çš„ä½œç”¨å†³å®šçš„ã€‚</p>
</blockquote>
<p>çœ‹ä¸Šé¢çš„è¡¨ï¼Œå°±è§£é‡Šä¸€ä¸ªã€‚ä»¥ <code>setl</code> ä¸ºä¾‹ï¼Œå› ä¸ºå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ <code>cmpq</code> å¯¹ condition codes è¿›è¡Œè®¾ç½®ï¼Œæ‰€ä»¥å½“ <code>SF</code> ä¸º 1 æ—¶ï¼Œå¾ˆå¯èƒ½æ˜¯ <code>Src1 - Src2 &lt; 0</code> çš„æƒ…å†µã€‚ä½†æ˜¯éœ€è¦æ’é™¤ <code>Src1 - Src2</code> æ­£æº¢å‡ºçš„æƒ…å†µâ€”â€”æ­£æº¢å‡ºä¹Ÿå¯èƒ½å¯¼è‡´ç»“æœä¸ºè´Ÿï¼Œå› æ­¤æ˜¯ <code>SF ^ OF</code>ï¼›</p>
<p>æœ€åè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚<code>setX</code> æ˜¯ä¸ºå•ä¸ªå¯„å­˜å™¨çš„<strong>å•ä¸ª low-order 8-bit è®¾ç½® 0/1</strong>ï¼Œä½†ä¹‹å‰<strong>åœ¨ 3.3.1 ä¸­æ˜ç¡®è¯´è¿‡</strong>ï¼Œæˆ‘ä»¬åœ¨ x86-64 æ¶æ„ä¸‹ä¸€èˆ¬éƒ½è®¨è®º 64-bit register çš„ä½¿ç”¨ï¼Œè€Œé‚£äº›è®¿é—®å¯„å­˜å™¨çš„ low-order 32-bitï¼ˆä¾‹å¦‚ <code>%eax</code>ï¼‰ã€low-order 16-bit çš„æ–¹æ³•ç”¨çš„æ¯”è¾ƒå°‘ï¼ˆåœ¨ 32 ä½æ¶æ„ä¸‹ä¼šå¤šä¸€ç‚¹ï¼‰ã€‚</p>
<p>è€Œè¿™é‡Œï¼Œä¸ºäº†æ¡ä»¶æ§åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»è®¿é—® 64-bit register çš„ low-order 8-bit çš„ä½ç½®ï¼Œè¿™äº›ä½ç½®å¯ä»¥ç”±ä»¥ä¸‹åç§°ç»™å‡ºï¼š</p>
<ul>
<li>å­—æ¯ç±»å‹å‘½åçš„ registerï¼Œä¸ä½¿ç”¨å‰ç¼€ <code>r</code>ï¼Œè€Œä½¿ç”¨åç¼€ <code>l</code> å°±èƒ½ä»£è¡¨å¯¹åº”çš„ low-order 8-bit ä½ç½®ï¼›ä¾‹å¦‚ï¼š<code>%rax</code> çš„ low-order 1-bit ä½ç½®æ˜¯ <code>%al</code>ã€<code>%rbx</code> æ˜¯ <code>%bl</code>ã€<code>%rcx</code> æ˜¯ <code>%cl</code>ã€<code>%rdx</code>æ˜¯ <code>%dl</code>ã€<code>%rsi</code> æ˜¯ <code>%sil</code>ã€<code>%rdi</code> æ˜¯ <code>%dil</code>ã€<code>%rsp</code> æ˜¯ <code>%spl</code>ã€<code>%rbp</code> æ˜¯ <code>%bpl</code>ï¼›</li>
<li>æ•°å­—ç±»å‹å‘½åçš„ registerï¼Œä½¿ç”¨åç¼€ <code>b</code> å°±ä»£è¡¨å¯¹åº”çš„ low-order 8-bit ä½ç½®ï¼›ä¾‹å¦‚ <code>%r8b</code>ã€<code>%r15b</code> ç­‰ï¼›</li>
</ul>
<p>è¿™æ ·æ“ä½œ 64-bit integer register çš„ low-order 8-bitï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–ä½çš„ä¿¡æ¯ï¼›</p>
<hr>
<p>ä¸‹é¢æ˜¯ <strong>example</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gt</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span> &#123; <span class="keyword">return</span> x &gt; y; &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gt:</span><br><span class="line">    cmpq	%rsi, %rdi</span><br><span class="line">    setg	%al</span><br><span class="line">    movzbl	%al, %eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å·²çŸ¥ <code>%rdi</code> å­˜æ”¾äº†å‡½æ•°çš„ç¬¬ä¸€å‚æ•° x çš„å€¼ï¼Œ<code>%rsi</code> å­˜æ”¾äº†å‡½æ•°ç¬¬äºŒå‚æ•° y çš„å€¼ï¼Œå‡½æ•°è¿”å›çš„ç»“æœå°±æ”¾åœ¨ <code>%rax</code> ä¸­ã€‚ä¸‹é¢é€æ­¥åˆ†æï¼š</p>
<p>ç¬¬ä¸€æ­¥ä½¿ç”¨äº† <code>cmpq</code> å°† <code>%rdi å€¼ - %rsi å€¼</code>ï¼ˆå³ <code>x - y</code>ï¼‰è®¡ç®—ï¼Œå¹¶ä¸º 4 ä¸ª condition codes è¿›è¡Œä¿®æ”¹ï¼›</p>
<p>ç¬¬äºŒæ­¥ï¼Œ<code>setg</code> å¯¹ <code>%al</code> æ“ä½œï¼Œè¿™æ˜¯ <code>%rax</code>  çš„ low-order 8-bit çš„ä½ç½®ï¼Œè¡¨æ˜å¦‚æœ <code>~(SF ^ OF) &amp; ~ZF</code> æˆç«‹ï¼Œå³ <code>x &gt; y</code> æˆç«‹ï¼Œé‚£ä¹ˆä¸º <code>%rax</code> çš„ low-order 8-bit ä½ç½®ç½®ä¸º 1ï¼Œå¦åˆ™ç½®ä¸º 0ï¼›<strong>æ˜¾ç„¶ï¼Œè¿™é‡Œçš„ <code>%rax</code> è¿˜éœ€è¦æŠŠå‰é¢ 7 bytes å…¨éƒ¨ç½®ä¸º 0ï¼Œæ‰èƒ½æˆä¸ºæˆ‘è¦è¿”å›çš„å€¼ï¼ˆ(int)0/1ï¼‰</strong>ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>ç¬¬ä¸‰æ­¥ç”¨åˆ°äº†æ–°çš„æŒ‡ä»¤ <code>movzbl</code>ï¼ˆ<strong>move with zero extension byte to long</strong>ï¼‰</p>
<blockquote>
<p>è¯­æ³•ï¼š<code>movzbl &lt;Src&gt;, &lt;Dst&gt;</code>;</p>
<p>ä½œç”¨ï¼šæŠŠä¸€ä¸ª <code>Src</code> æ•°æ®å¼•ç”¨å¤§å°çš„ <strong>0 æ•°æ®</strong> æ‰©å±•åˆ° <code>Dst</code> ä¸­ï¼ˆä¼šæ”¹å˜ <code>Dst</code>ï¼Œä½†ä¸ä¼šæ”¹å˜ <code>Src</code>ï¼‰;</p>
</blockquote>
<p>é‚£ä¹ˆå¥½ï¼Œé—®é¢˜åˆæ¥äº†ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æ˜æ˜è¦æŠŠ <code>%rax</code> å‰©ä¸‹çš„æ‰€æœ‰ 7 bytes å…¨éƒ¨ç½® 0ï¼Œä½†æ˜¯æ±‡ç¼–ä¸­å†™çš„å´æ˜¯å¯¹ <code>%eax</code>ï¼ˆä¹‹å‰æåˆ°çš„ï¼Œregister çš„ low-order 32-bit ä½ç½®ï¼‰ç½® 0ï¼Œå‰©ä¸‹çš„ high-order 32-bit ä¸ç®¡äº†å—ï¼Ÿ</p>
<p>âš  å®é™…ä¸Šï¼Œè¿™æ˜¯ x86-64 æ¶æ„å†…éƒ¨ä»¤äººè¿·æƒ‘çš„ç‰¹æ€§ã€‚å½“ä¸€ä¸ª 64-bit register ä» low-order åªè¢«ä¿®æ”¹ 32-bit æ•°æ®æ—¶ï¼Œ<strong>ä¼šè‡ªåŠ¨å°†å‰©ä¸‹çš„ high-order 32-bit å…¨éƒ¨ç½® 0</strong>ã€‚ï¼ˆä½†æ˜¯å¦‚æœåªæ˜¯ä¿®æ”¹ low-order 16-bitã€low-order 8-bit æ—¶ï¼Œå´<strong>ä¸ä¼š</strong>ä¸ºå‰é¢çš„éƒ¨åˆ†ç½® 0ï¼‰</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œ<code>%rax</code> ä¸­çš„æ•°æ®åº”è¯¥é•¿è¿™æ ·ï¼š<code>0x000000000000000?</code>ï¼ˆæœ€åä¸€ä½å–å†³äº <code>setg</code> åˆ°åº• set äº†ä»€ä¹ˆï¼‰ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›çš„ <code>x &gt; y</code> è¡¨è¾¾å¼çš„å€¼ï¼Œæ‰€ä»¥å‡½æ•°ç»“æŸã€‚</p>
<hr>
<h3 id="4-2-Conditional-Branches"><a href="#4-2-Conditional-Branches" class="headerlink" title="4.2 Conditional Branches"></a>4.2 Conditional Branches</h3><p>å‰ä¸€èŠ‚çš„ä¾‹å­æè¿°äº†å¦‚ä½•ä¾é  condition codes æ¥ä¿®æ”¹æŸä¸ªå¯„å­˜å™¨çš„ low-order 8-bit çš„å€¼ï¼Œè¿™æ˜¯å®ç°æ¡ä»¶åˆ†æ”¯çš„åŸºç¡€ã€‚</p>
<p>è¿™ä¸€èŠ‚å°†åˆ©ç”¨ condition code æ¥ç»„ç»‡æ¡ä»¶åˆ†æ”¯ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ reading condition codesï¼›</p>
<h4 id="4-2-1-JX-Instructions-ã€Oldã€‘"><a href="#4-2-1-JX-Instructions-ã€Oldã€‘" class="headerlink" title="4.2.1 JX Instructions ã€Oldã€‘"></a>4.2.1 JX Instructions ã€Oldã€‘</h4><ul>
<li><p>è¯­æ³•ï¼š<code>jX &lt;LABEL&gt;</code>ï¼Œè¿™é‡Œçš„ <code>&lt;LABEL&gt;</code> æ˜¯æ±‡ç¼–ç¨‹åºä¸­çš„ä¸€ä¸ª<strong>æ®µè½æ ‡ç­¾</strong>ï¼Œåœ¨å…·ä½“ä¾‹å­ä¸­ä¼šå±•ç¤ºã€‚</p>
<blockquote>
<p>è¿˜æœ‰ä¸€ç§è¯­æ³•ï¼Œä¼šåœ¨ 4.4 ä¸­ä»‹ç»ã€‚</p>
</blockquote>
</li>
<li><p>ä½œç”¨ï¼šæœ‰æ¡ä»¶ï¼ˆæ ¹æ® condition codesï¼‰/ æ— æ¡ä»¶è·³è½¬åˆ°æŒ‡å®šéƒ¨åˆ†çš„æ±‡ç¼–ä»£ç ç»§ç»­æ‰§è¡Œï¼›</p>
</li>
<li><p>å…·ä½“ç±»å‹ï¼ˆå’Œ <code>SetX</code> Instructions ä½¿ç”¨åç§°ç±»ä¼¼ï¼‰ï¼š</p>
<table>
    <tr style="text-align: center;">
        <th>jX</th>
        <th>Condition</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>jmp</td>
        <td>1</td>
        <td>Unconditional</td>
    </tr>
    <tr>
        <td>je</td>
        <td>ZF</td>
        <td>Equal/Zero</td>
    </tr>
    <tr>
        <td>jne</td>
        <td>~ZF</td>
        <td>Not Equal/Not Zero</td>
    </tr>
    <tr>
        <td>js</td>
        <td>SF</td>
        <td>Negative</td>
    </tr>
    <tr>
        <td>jns</td>
        <td>~SF</td>
        <td>Nonegative</td>
    </tr>
    <tr>
        <td>jg</td>
        <td>~(SF^OF)&amp;~ZF</td>
        <td>Greater (signed)</td>
    </tr>
    <tr>
        <td>jge</td>
        <td>~(SF^OF)</td>
        <td>Greater or Equal (signed)</td>
    </tr>
    <tr>
        <td>jl</td>
        <td>(SF^OF)</td>
        <td>Less (signed)</td>
    </tr>
    <tr>
        <td>jle</td>
        <td>(SF^OF) | ZF</td>
        <td>Less or Equal (signed)</td>
    </tr>
    <tr>
        <td>ja</td>
        <td>~CF &amp; ~ZF</td>
        <td>Above (unsigned)</td>
    </tr>
    <tr>
        <td>jb</td>
        <td>CF</td>
        <td>Below (unsigned)</td>
    </tr>
</table>
</li>
<li><p>Exampleï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">absdiff</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span> &#123;</span><br><span class="line">    <span class="type">long</span> result;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; y) result = x - y;</span><br><span class="line">    <span class="keyword">else</span> result = y - x;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">absdiff:</span><br><span class="line">    cmpq	%rsi, %rdi</span><br><span class="line">    jle		.L4</span><br><span class="line">    movq	%rdi, %rax</span><br><span class="line">    subq	%rsi, %rax</span><br><span class="line">    ret</span><br><span class="line">.L4:</span><br><span class="line">    movq	%rsi, %rax</span><br><span class="line">    subq	%rdi, %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å·²çŸ¥ <code>%rdi</code> ä¿å­˜çš„æ˜¯å‡½æ•°ç¬¬ä¸€å‚æ•° xï¼Œ<code>%rsi</code> ä¿å­˜çš„æ˜¯å‡½æ•°ç¬¬äºŒå‚æ•° yï¼Œ<code>%rax</code> ä¿å­˜å‡½æ•°è¿”å›å€¼ã€‚</p>
<blockquote>
<p>å†æ¬¡è¯´ä¸€ä¸‹ï¼Œ<strong>æ±‡ç¼–å‡½æ•°è¿”å›å‰åªéœ€è¦æŠŠè¿”å›å€¼æ”¾åœ¨ç‰¹å®šçš„å¯„å­˜å™¨ä¸­å°±è¡Œ</strong>ï¼Œåªè¦è°ƒç”¨æ–¹æ¸…é™¤ä½ æ”¾åœ¨å“ªå°±è¡Œã€‚æ¯”å¦‚è¿™é‡Œæ”¾åœ¨ <code>%rax</code>ï¼Œé‚£ä¹ˆå‡½æ•°ç»“æŸåï¼Œè°ƒç”¨æ–¹ä¼šå» <code>%rax</code> è®¿é—®ç»“æœã€‚</p>
</blockquote>
<p>ç¬¬ä¸€æ­¥ <code>cmpq</code> æ ¹æ® <code>%rdi å€¼ - %rsi å€¼</code> æ¥è®¾ç½® condition codesï¼›</p>
<p>ç¬¬äºŒæ­¥çš„ <code>jle</code> å¯¹åº”çš„æ¡ä»¶æ˜¯ <code>(SF ^ OF) | ZF</code>ï¼Œç»“åˆä¸Šä¸€æ­¥ä¹Ÿå°±æ˜¯ <code>x â‰¤ y</code> æ—¶ï¼Œè·³è‡³ <code>.L4</code> æ ‡ç­¾æ ‡è®°çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚</p>
<p>è¿™é‡Œ <code>.L4</code> æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼Œ<code>.</code> å¼€å¤´è¡¨ç¤ºå®ƒæ˜¯<strong>å†…éƒ¨çš„</strong>æ“ä½œæˆ–æ ‡ç­¾ï¼Œåªä¼šå‡ºç°åœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œä¸ä¼šå‡ºç°åœ¨ç›®æ ‡ä»£ç ï¼ˆæœºå™¨ä»£ç ï¼‰ä¸­ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å½“ä½œç‹¬ç«‹çš„å‡½æ•°ã€‚</p>
<blockquote>
<p>æœ‰åŒå­¦ä¼šè¯´ï¼Œä¸æ˜¯è¯´æ±‡ç¼–ä»£ç å°±æ˜¯æœºå™¨ä»£ç çš„æ–‡æœ¬è¡¨ç¤ºå—ï¼Ÿä¸ºå•¥è¿˜æœ‰å·®åˆ«ï¼Ÿ</p>
<p>å…¶å®æ˜¯è¿™æ ·çš„ï¼Œæ±‡ç¼–ä»£ç ç›¸å¯¹äºæœºå™¨ä»£ç ï¼Œåœ¨è½¬æ¢ä¸ºæ˜“è¯»çš„æ–‡æœ¬åŒæ—¶ï¼Œä¼šæŠŠä¸€äº›<strong>æŒ‡ä»¤åœ°å€</strong>è®¾ç½®æˆå†…éƒ¨æ ‡ç­¾ã€‚åœ¨æ±‡ç¼–è½¬æœºå™¨ä»£ç æ—¶ï¼Œä¼šå†è®¡ç®—ä»£å…¥å›å»ã€‚ä¸ç„¶ä½ è¯» <code>jle 0x0F0E2310</code> è‚¯å®šæ²¡æœ‰ <code>jle .L4</code> å¥½è¯»ã€‚</p>
</blockquote>
<p>åä¸¤æ­¥çš„å«ä¹‰å·²ç»æ¯”è¾ƒç®€å•äº†ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p>ä¸Šé¢çš„å†…å®¹<strong>ç±»ä¼¼ C/C++ ä¸­çš„ goto è¯­å¥ï¼Œä¸å»ºè®®åœ¨ C/C++ ä¸­ä½¿ç”¨</strong>ï¼›</p>
</li>
</ul>
<h4 id="4-2-2-General-Conditional-Expression-Translation-amp-Conditional-Moves"><a href="#4-2-2-General-Conditional-Expression-Translation-amp-Conditional-Moves" class="headerlink" title="4.2.2 General Conditional Expression Translation &amp; Conditional Moves"></a>4.2.2 General Conditional Expression Translation &amp; Conditional Moves</h4><blockquote>
<p>æœ¬å°èŠ‚ä»‹ç»äº† â€œæ¡ä»¶ç§»åŠ¨â€ è¿™ç§ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ–¹å¼ï¼Œå‘Šè¯‰æˆ‘ä»¬åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å°†æ¡ä»¶æ§åˆ¶ä¸€å‘³åœ°ç¿»è¯‘æˆ <code>JX</code> Instructions ä¸è§å¾—æ˜¯æœ€å¥½çš„ï¼›åŒæ—¶ä¹ŸæŒ‡æ˜äº†ä¸åº”è¯¥ä½¿ç”¨ â€œæ¡ä»¶ç§»åŠ¨â€ ä¼˜åŒ–çš„æƒ…å½¢ã€‚</p>
</blockquote>
<p>ä¸Šé¢ä»‹ç»çš„ <code>JX</code> Instructions çœŸçš„é€‚åˆç¼–è¯‘å™¨ä½¿ç”¨å—ï¼Ÿæ•ˆç‡æ˜¯æœ€é«˜çš„å—ï¼Ÿå¦‚æœä»”ç»†çœ‹ä¸Šä¸€èŠ‚æ ‡é¢˜ä¼šå‘ç°æœ‰ä¸€ä¸ª â€œã€Oldã€‘â€ çš„æ ‡å¿—ï¼Œè¿™è¯´æ˜ç°åœ¨ä¸ç»å¸¸ç”¨åˆ°å®ƒäº†ã€‚å¦‚æœæ•ˆç‡ä¸ä½³ï¼Œé‚£ä¹ˆæœ‰å“ªäº›æ–¹æ³•å¯ä»¥è€ƒè™‘å‘¢ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å¦‚æœç¼–è¯‘å™¨å°† C++ ä»£ç ç¿»è¯‘ä¸ºä¸Šé¢çš„ <code>JX</code> Instructionsï¼Œé‚£ä¹ˆè¿™ç§ç¿»è¯‘è¢«ç§°ä¸º <strong>General Conditional Expression Translation</strong>ï¼Œè¿™ä¹Ÿæ˜¯æœ€è‡ªç„¶çš„æ–¹æ³•ï¼šå¦‚æœæ»¡è¶³æŸä¸ªæ¡ä»¶å°±è·³è½¬åˆ°å“ªé‡Œæ‰§è¡Œï¼Œå¦åˆ™å¦‚ä½•å¦‚ä½•ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§æ–¹æ³•è¢«ç§°ä¸º <strong>æ¡ä»¶ç§»åŠ¨ï¼ˆConditional Movesï¼‰</strong>ï¼Œæ˜¯å°† C/C++ ä»£ç ä¸­çš„æ¡ä»¶åˆ†æ”¯ï¼ˆif-elseï¼‰çš„ â€œthenâ€ åˆ†æ”¯å’Œ â€œelseâ€ åˆ†æ”¯<strong>å…¨éƒ¨æ‰§è¡Œ</strong>ï¼Œæœ€åæŒ‰ç…§æ¡ä»¶å†å†³å®šå°†è°ç§»åŠ¨åˆ°ç»“æœå¯„å­˜å™¨ä¸­ã€‚</p>
<p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result    = the value of Then_Expr</span><br><span class="line">eval    = the value of Else_Expr</span><br><span class="line">cond    = !(the value of Test)</span><br><span class="line">if (cond) result = eval</span><br><span class="line"></span><br><span class="line">return result</span><br></pre></td></tr></table></figure>
<p>æœ‰äººè¯´ï¼Œè¿™æŠŠ then å­å¥å’Œ else å­å¥éƒ½è¿è¡Œäº†ï¼Œå¹³å‡çš„æ—¶é—´å¤æ‚åº¦ä¸Šä¸æ˜¯ä¼šæ¯”ä¹‹å‰çš„ General Condition Expression æ›´æµªè´¹æ—¶é—´å—ï¼Ÿå…¶å®ä¸ç„¶ï¼Œè¿™é‡Œçš„çŸ¥è¯†å’Œåé¢ç« èŠ‚çš„ â€œæµæ°´çº¿â€ æœ‰å…³ã€‚</p>
<p>å› ä¸ºç°ä»£å¤„ç†å™¨é‡‡ç”¨ â€œæµæ°´çº¿ï¼ˆpipelineï¼‰â€ çš„è¿è¡Œæ–¹å¼ï¼Œåœ¨åˆ°è¾¾ä¸€è¡Œä»£ç æ—¶ä¼šå…³è”ç”šè‡³è¿è¡Œä¸‹é¢å‡ è¡Œçš„ä»£ç ã€‚ç°ä»£å¤„ç†å™¨å¤§æ¦‚å¯ä»¥åŒæ—¶å¤„ç† 20 è¡Œå·¦å³çš„æŒ‡ä»¤æ·±åº¦ï¼ˆä¸»è¦å–å†³äºäº‹å…ˆè¯»å…¥çš„æŒ‡ä»¤æ¡æ•°ï¼‰ã€‚å½“è¿è¡Œåˆ°å«æœ‰åˆ†æ”¯çš„éƒ¨åˆ†æ—¶ï¼Œå¤„ç†å™¨ä¼šé‡‡å– â€œ<strong>åˆ†æ”¯é¢„æµ‹æŠ€æœ¯</strong>â€ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡çŒœæµ‹ä¼šè¿è¡Œåˆ°å“ªä¸ªåˆ†æ”¯ï¼Œå¹¶å°†çŒœæµ‹çš„åˆ†æ”¯äº‹å…ˆè¯»å…¥æµæ°´çº¿ã€‚</p>
<p>å¦‚æœçŒœå¯¹ï¼Œé‚£ä¹ˆæ‰§è¡Œéå¸¸è¿…é€Ÿï¼Œç›´æ¥è¯»å–æµæ°´çº¿ä¸Šçš„ä¿¡æ¯ï¼Œå¹¶ç¦»å¼€è¿™ä¸ªåˆ†æ”¯ï¼›ä½†æ˜¯å¦‚æœçŒœé”™ï¼Œé‚£ä¹ˆå°†åœæ­¢æ‰§è¡Œå½“å‰æµæ°´çº¿ä¸Šçš„ä»£ç ï¼Œå¹¶é‡æ–°è¯»å…¥å¦ä¸€æ®µåˆ†æ”¯ã€‚è¿™æ˜¯ä¸ªè€—æ—¶æ“ä½œï¼Œè¾ƒå·®æƒ…å†µä¸‹ä¼šèŠ±è´¹ 40 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆ40 æ­¥æ™®é€šæŒ‡ä»¤æ‰§è¡Œæ—¶é—´ï¼‰ã€‚</p>
<p>å› æ­¤ï¼Œ<strong>åœ¨æŸäº›æƒ…å†µä¸‹</strong>ï¼Œä½¿ç”¨ Conditional Moves çš„æ¡ä»¶åˆ¤æ–­æ–¹æ³•å¯èƒ½ä¼šæ¯” General Conditional Expression æ›´é«˜æ•ˆã€‚</p>
<p><strong>æ­£å› å¦‚æ­¤ï¼Œå¤§å¤šæ•°ç¼–è¯‘å™¨åœ¨<u>æŸäº›æƒ…å†µä¸‹</u>éƒ½é€‰æ‹© Conditional Movesï¼Œè€Œä¸æ˜¯ä¸Šé¢çš„ <code>JX</code> æŒ‡ä»¤ï¼ˆä»£è¡¨ General Condition Expressionï¼‰ï¼Œæ‰€ä»¥ä½ å‡ ä¹çœ‹ä¸åˆ° 4.2.1 ä¸­çš„æ±‡ç¼–ä»£ç ã€‚</strong>å¦‚æœå®åœ¨æƒ³çœ‹åˆ°ï¼Œé‚£ä¹ˆåœ¨ç”¨ gcc ç¼–è¯‘æ—¶ï¼Œç»™å®šå‚æ•° <code>-fno-if-conversion</code>ï¼Œè¿™æ ·ä¸å…è®¸ç¼–è¯‘å™¨ä½¿ç”¨æ¡ä»¶ç§»åŠ¨ã€‚</p>
<hr>
<p>æ‰€ä»¥åœ¨ 4.2.1 ä¸­å¤§å¤šæ•°æƒ…å†µä¸‹çš„æ±‡ç¼–ä»£ç åº”è¯¥é•¿è¿™æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">absdiff:</span><br><span class="line">    movq	%rdi, %rax</span><br><span class="line">    subq	%rsi, %rax</span><br><span class="line">    movq	%rsi, %rdx</span><br><span class="line">    subq	%rdi, %rdx</span><br><span class="line">    cmpq	%rsi, %rdi</span><br><span class="line">    cmovle	%rdx, %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å†ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼Œç¬¬ä¸€æ­¥æ˜¯å°† <code>%rdi</code> çš„å€¼ï¼ˆå³å‡½æ•°ç¬¬ä¸€å‚æ•° xï¼‰èµ‹ç»™ <code>%rax</code>ï¼›</p>
<p>ä»ç¬¬äºŒæ­¥å¼€å§‹å°±æ˜¯æ¡ä»¶ç§»åŠ¨çš„æ–¹æ³•äº†ï¼šç¬¬äºŒæ­¥å…ˆæŠŠ <code>%rax</code> çš„å€¼ï¼ˆxï¼‰å‡å» <code>%rsi</code>ï¼ˆyï¼‰ï¼Œç›¸å½“äºå…ˆåšäº† then åˆ†æ”¯çš„å†…å®¹ï¼›</p>
<p>ç¬¬ä¸‰æ­¥æ˜¯å°† <code>%rsi</code> çš„å€¼ï¼ˆyï¼‰ç§»åŠ¨åˆ° <code>%rdx</code> ä¸­ï¼Œå¹¶å†ç¬¬å››æ­¥æŠŠ <code>%rdx</code> çš„å€¼å‡å» <code>%rdi</code>ï¼ˆxï¼‰ï¼Œç›¸å½“äºå®Œæˆäº† else åˆ†æ”¯çš„å†…å®¹ï¼›</p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ<code>%rax</code> ä¸­å­˜æ”¾ <code>x - y</code> çš„å€¼ï¼Œ<code>%rdx</code> ä¸­å­˜æ”¾ <code>y - x</code> çš„å€¼ï¼›</p>
<p>ç¬¬äº”æ­¥æ‰æ˜¯æŒ‰ç…§ xã€y çš„å€¼æ¥è®¾ç½® condition codesï¼›</p>
<p>æœ€åä¸€æ­¥æ˜¯ä¸€ä¸ª<strong>æ–°æŒ‡ä»¤ï¼š<code>cmovle</code></strong>;</p>
<ul>
<li>è¯­æ³•ï¼š<code>cmovle &lt;Src&gt;, &lt;Dst&gt;</code>ï¼›</li>
<li>ä½œç”¨ï¼šæ¡ä»¶ç§»åŠ¨ï¼ŒæŒ‰ç…§å½“å‰ condition codes çš„çŠ¶æ€è¿›è¡Œç§»åŠ¨ã€‚å…¶ä¸­ <code>cmove</code> å°±æ˜¯ conditional movesï¼Œ<code>le</code> å°±æ˜¯ä¹‹å‰çš„ <code>X</code> æƒ…å†µï¼ˆå°äºç­‰äºæƒ…å†µï¼‰ï¼Œæ‰€ä»¥çŒœæµ‹è¿˜æœ‰ <code>cmovel</code>ã€<code>cmovege</code>ã€<code>cmoveg</code>â€¦â€¦</li>
</ul>
<hr>
<p>ä½†æ˜¯ï¼Œä¸Šé¢è¯´ <strong>Conditional Moves æ›´å¿«æ˜¯åœ¨â€œæŸäº›æƒ…å†µä¸‹â€</strong>ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ â€œå¦å¤–çš„æƒ…å†µâ€ï¼Ÿ</p>
<p>ç°åœ¨ä»‹ç»åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œæ±‡ç¼–çš„ç¿»è¯‘ä¸åº”è¯¥ç”¨ Conditional Movesï¼š</p>
<p><strong>Situation 1: Expensive Computations</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val = Test(x) ? Hard1(x) : Hard2(x);</span><br></pre></td></tr></table></figure>
<p>è¿™ç§ then å­å¥å’Œ else å­å¥éƒ½éå¸¸éš¾ä»¥è®¡ç®—çš„æ—¶å€™ï¼Œä¸åº”è¯¥ç”¨æ¡ä»¶ç§»åŠ¨ã€‚å› ä¸ºé‡æ–°è¯»å…¥æµæ°´çº¿çš„æ—¶é—´å¾ˆå¯èƒ½ä¼šå°‘äºæŠŠä¸¤ä¸ªå­å¥éƒ½è®¡ç®—ä¸€éçš„æ—¶é—´ï¼›</p>
<p><strong>Situation 2: Risky Computations</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val = p ? *p : <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„åˆ¤æ–­è¯­å¥å¿…é¡»å…ˆåˆ¤æ–­å†è¿›è¡Œæ‰§è¡Œï¼Œå¦åˆ™ä¼šå‡ºç°ç¨‹åºé”™è¯¯ï¼Œå°¤å…¶æ˜¯åœ¨æŒ‡é’ˆçš„åˆ¤æ–­ä¸Šï¼›</p>
<p><strong>Situation 3: Computations with side effects</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val = x &gt; <span class="number">0</span> ? x*=<span class="number">7</span> : x+=<span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ then å’Œ else å­å¥ä¸€æ—¦æ‰§è¡Œï¼Œä¼šç ´åç¨‹åºçš„åŸä¹‰ï¼Œé€ æˆæ„æƒ³ä¸åˆ°çš„åæœã€‚</p>
<h3 id="4-3-Loops"><a href="#4-3-Loops" class="headerlink" title="4.3 Loops"></a>4.3 Loops</h3><h4 id="4-3-1-Do-While-Loop"><a href="#4-3-1-Do-While-Loop" class="headerlink" title="4.3.1 Do-While Loop"></a>4.3.1 Do-While Loop</h4><p>å¯¹äºä¸€ä¸ªè®¡ç®— x ä»£è¡¨çš„äºŒè¿›åˆ¶ä»£ç ä¸­çš„ 1 çš„ä¸ªæ•°çš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">pcount_do</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        result += x &amp; <span class="number">0x1</span>;</span><br><span class="line">        x &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (x);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„æ±‡ç¼–ä»£ç éå¸¸ç®€å•ï¼Œ<strong>å°±å¯ä»¥ç”¨ General Conditional Expression çš„æ–¹æ³•ï¼Œç»“åˆ <code>JX</code> Instructions å®ç°</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pcount_do:</span><br><span class="line">    movl	$0, %eax</span><br><span class="line">.L2:</span><br><span class="line">    movq	%rdi, %rdx</span><br><span class="line">    andl	$1, %edx</span><br><span class="line">    addq	%rdx, %rax</span><br><span class="line">    shrq	%rdi</span><br><span class="line">    jne		.L2</span><br><span class="line">    rep; ret</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ä¼ªä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    preparations</span><br><span class="line">loop:</span><br><span class="line">    Body</span><br><span class="line">    if (Test)</span><br><span class="line">        goto loop</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œ<code>movl</code> å’Œ <code>andl</code> éƒ½ä¸ç®—æ–°çš„æŒ‡ä»¤â€”â€”ä¹‹å‰è¯´è¿‡ <code>q</code> çš„å«ä¹‰ä»£è¡¨æ“ä½œæ•°çš„ä½æ•°ï¼Œquad æŒ‡ 4 å­—ï¼ˆ4 Ã— 16 bitsï¼‰ï¼Œ<code>l</code> å°±æŒ‡ 2 å­—ï¼Œ2 Ã— 16 bitsï¼›</p>
<h4 id="4-3-2-General-While-Loop-Translation-1-â€œJump-to-Middleâ€-Translation"><a href="#4-3-2-General-While-Loop-Translation-1-â€œJump-to-Middleâ€-Translation" class="headerlink" title="4.3.2 General While Loop Translation #1 - â€œJump to Middleâ€ Translation"></a>4.3.2 General While Loop Translation #1 - â€œJump to Middleâ€ Translation</h4><p>ä» do-while åˆ° while åªéœ€è¦æ›´æ”¹ä¸€ä¸‹æµ‹è¯•æ¡ä»¶çš„é¡ºåºå°±è¡Œã€‚ä¾‹å¦‚ä¸Šä¸€èŠ‚çš„ä»£ç æ”¹æˆ while å¾ªç¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">pcount_do</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (x) &#123;</span><br><span class="line">        result += x &amp; <span class="number">0x1</span>;</span><br><span class="line">        x &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¯¹åº”çš„æ±‡ç¼–ä¼ªä»£ç <strong>å¯ä»¥æ˜¯</strong>ï¼ˆä¸€èˆ¬åœ¨ç¼–è¯‘å™¨ä¼˜åŒ–ç­‰çº§ <code>-Og</code> æ—¶å‡ºç°ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    goto test;		// å…ˆæµ‹è¯•</span><br><span class="line">loop:</span><br><span class="line">    Body</span><br><span class="line">test:</span><br><span class="line">    if (Test)</span><br><span class="line">        goto loop;	// é€šè¿‡å†è¿›å¾ªç¯ä½“</span><br><span class="line">done:</span><br><span class="line">    // ...</span><br></pre></td></tr></table></figure>
<h4 id="4-3-3-General-While-Loop-Translation-2-â€œDo-whileâ€-Conversion"><a href="#4-3-3-General-While-Loop-Translation-2-â€œDo-whileâ€-Conversion" class="headerlink" title="4.3.3 General While Loop Translation #2 - â€œDo-whileâ€ Conversion"></a>4.3.3 General While Loop Translation #2 - â€œDo-whileâ€ Conversion</h4><p>å¦‚æœæŠŠç¼–è¯‘å™¨çš„ä¼˜åŒ–ç­‰çº§è°ƒè‡³ <code>-O1</code>ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨åœ¨å¤„ç† while å¾ªç¯æ—¶ä¸ä¼šé‡‡ç”¨ä¸Šé¢çš„ â€Jump to Middleâ€œ çš„ç¿»è¯‘ç­–ç•¥ï¼Œè€Œæ˜¯é‡‡ç”¨ <strong>è½¬æ¢ä¸º do-while å¾ªç¯</strong> çš„ç­–ç•¥ï¼Œè¿™æ ·ä¼šæ›´åŠ é«˜æ•ˆã€‚</p>
<p>è¿™ç›¸å½“äºæŠŠ C/C++ ä»£ç ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (Test) &#123;</span><br><span class="line">    Body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¢æˆäº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!Test)</span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    Body</span><br><span class="line">&#125; <span class="keyword">while</span> (Test);</span><br><span class="line">done:</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„æ±‡ç¼–ä¼ªä»£ç ä¼šå˜æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    if (!Test)		// ä»…è¿›å…¥å‰åˆ¤æ–­ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥å°±å˜æˆ do-while</span><br><span class="line">        goto done;</span><br><span class="line">loop:</span><br><span class="line">    Body</span><br><span class="line">    if (Test)</span><br><span class="line">        goto loop;</span><br><span class="line">done:</span><br><span class="line">    // ...</span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªä¼˜åŒ–ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå…¶å® do-while å¾ªç¯ä¼šæ¯” while å¾ªç¯æ›´é«˜æ•ˆï¼Œä½†ç°åœ¨çš„ç¼–è¯‘å™¨æ¯”è¾ƒæ™ºèƒ½ï¼Œåªè¦ä¼˜åŒ–ç­‰çº§ä¸ä½ï¼Œè¿™ä¸ªæ–¹é¢ä¼šå¸®ä½ ä¼˜åŒ–æ‰çš„ã€‚</p>
<h4 id="4-3-4-For-Loop"><a href="#4-3-4-For-Loop" class="headerlink" title="4.3.4 For Loop"></a>4.3.4 For Loop</h4><p>for loop çš„æ±‡ç¼–å®ç°æ²¡é‚£ä¹ˆç®€å•ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å‘ while æˆ– do-while ä¸Šçœ‹é½ã€‚æ¯”å¦‚å¯¹å¦‚ä¸‹ for å¾ªç¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Init; Test; Update) &#123;</span><br><span class="line">    Body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨å¯ä»¥è½¬æ¢æˆ while å¾ªç¯ï¼Œå¦‚æœä½¿ç”¨äº† <code>-O1</code> ä¼˜åŒ–ï¼Œä¼šä¼˜åŒ–åˆ° do-whileï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Init;</span><br><span class="line"><span class="keyword">while</span> (Test) &#123;</span><br><span class="line">    Body</span><br><span class="line">    Update;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------</span></span><br><span class="line"></span><br><span class="line">Init;</span><br><span class="line"><span class="keyword">if</span> (!Test) &#123;    <span class="comment">// do-while å‰çš„æµ‹è¯•å—ï¼ˆInitial Testï¼‰</span></span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    Body</span><br><span class="line">    Update;</span><br><span class="line">&#125; <span class="keyword">while</span> (Test);</span><br><span class="line">done:</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>å¾ˆå¤šæ—¶å€™ï¼Œ<code>-O1</code> ä¸‹çš„ç¼–è¯‘å™¨ç”šè‡³å¯ä»¥è¯†åˆ« <code>Init</code> å— å’Œ do-while å‰çš„æµ‹è¯•å—çš„å…³è”ï¼Œå¹¶ä¸”åˆç†èˆå¼ƒå‰ç½®çš„æµ‹è¯•å—ã€‚</p>
<h3 id="4-4-Switch-Statements"><a href="#4-4-Switch-Statements" class="headerlink" title="4.4 Switch Statements"></a>4.4 Switch Statements</h3><p>å°† C/C++ çš„ switch è¯­å¥ç¿»è¯‘ä¸ºæ±‡ç¼–æ˜¯ç›¸å½“æœ‰éš¾åº¦çš„ã€‚é¦–å…ˆåº”è¯¥å¼„æ¸…æ¥š switch è¯­å¥åœ¨ C/C++ ä¸­çš„ä¸€ç³»åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li><p>Match integer valuesï¼›</p>
</li>
<li><p>Fall through casesï¼šå½“ case ä¸­ä¸å­˜åœ¨ break æ—¶ï¼Œä¼šä¸€ç›´å‘ä¸‹è¿è¡Œï¼›</p>
</li>
<li>Merge casesï¼šå½“ä¸€ä¸ª case ä¸­æ²¡æœ‰ä»»ä½•å†…å®¹æ—¶ï¼Œç›¸å½“äºå¹¶å…¥ä¸‹ä¸€ä¸ª caseï¼ˆä¸Šä¸€ç‚¹çš„ç‰¹ä¾‹ï¼‰ï¼›</li>
<li>Default caseï¼šå¯¹äºæ²¡æœ‰åŒ¹é…çš„ casesï¼Œä¼šè¿›å…¥æœ€åçš„ default caseï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼›</li>
</ul>
<p>å½“ç„¶ï¼Œç°ä»£çš„ç¼–è¯‘å™¨å¯¹äº switch è¯­å¥çš„ç¿»è¯‘ç»ä¸æ˜¯ä¸€ç³»åˆ—çš„ if-else è¯­å¥çš„ç¿»è¯‘ï¼Œè€Œæ˜¯åˆ©ç”¨äº†ä¸€ä¸ªæ•°æ®ç»“æ„ï¼š<strong>è·³è¡¨ï¼ˆJump Table Structureï¼‰</strong>ï¼›</p>
<p>å¦‚ä¸‹å›¾ï¼Œswitch-case è¯­å¥å°±åƒä¸€ä¸²ä»£ç å—ï¼Œæ¯ä¸ª case å°±æ˜¯ä¸€ä¸ªå—ã€‚ç¼–è¯‘æ—¶ï¼Œswitch-case å—ä¼šæ•´ä½“ä¸€èµ·ç¼–è¯‘ï¼ˆå¦‚ä¸‹å›¾ Jump Targetsï¼‰ï¼Œè½¬ä¸ºæ±‡ç¼–æŒ‡ä»¤åï¼Œæ¯ä¸ªå—çš„æ±‡ç¼–æŒ‡ä»¤æ‰€å¯¹åº”çš„<strong>åœ°å€</strong>ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªè·³è¡¨ä¸­ï¼ˆå¦‚ä¸‹å›¾ Jump Tableï¼‰ã€‚è¿™æ ·åœ¨æ ¹æ®æ¡ä»¶è°ƒç”¨ç›¸åº”ä»£ç å—æ—¶ï¼Œåªéœ€è¦ goto è·³è¡¨ä¸­çš„å¯¹åº”åœ°å€ï¼ˆray indexingï¼‰å°±èƒ½å®Œæˆä»»åŠ¡ï¼Œæ— éœ€ä¸€ä¸ªä¸ªæ¯”å¯¹æ¡ä»¶ã€‚</p>
<p><img src="imgs/jump_table.png" height="300px"></p>
<p>é‚£ä¹ˆï¼Œæ±‡ç¼–ä»£ç æ˜¯å¦‚ä½•åœ¨è·³è¡¨ä¸­æ‰¾åˆ°åˆé€‚çš„åœ°å€çš„å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">switch_eg</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">    <span class="type">long</span> w = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">switch</span> (x) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        w = y * z;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        w = y / z;</span><br><span class="line">        <span class="comment">/* Fall Through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        w += z;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        w -= z;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        w = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä¾‹å­å¯¹åº”çš„æ±‡ç¼–ä»£ç å¯ä»¥æ˜¯ï¼ˆä¸€éƒ¨åˆ†ä»£ç ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">switch_eg:</span><br><span class="line">    movq	%rdx, %rcx</span><br><span class="line">    cmpq	$6, %rdi</span><br><span class="line">    ja		.L8</span><br><span class="line">    jmp		*.L4(,%rdi,8)</span><br></pre></td></tr></table></figure>
<p>é€æ­¥è§£é‡Šï¼š</p>
<p>ç¬¬ä¸€æ­¥å°† <code>%rdx</code>ï¼ˆç¬¬ä¸‰å‚æ•° zï¼‰èµ‹å€¼åˆ° <code>%rcx</code> å¯„å­˜å™¨ä¸­ï¼›</p>
<p>ç¬¬äºŒæ­¥å°±å°† <code>%rdi</code>ï¼ˆç¬¬ä¸€å‚æ•° xï¼‰ä¸å¸¸æ•° 6 è¿›è¡Œåšå·®æ¯”è¾ƒï¼ˆä¸ºä»€ä¹ˆæ˜¯ 6ï¼Ÿå› ä¸ºåœ¨æºç ä¸­ 6 æ˜¯æœ€å¤§çš„ caseï¼‰ï¼Œä»¥æ­¤ä¿®æ”¹ condition codesï¼›</p>
<p>ç¬¬ä¸‰æ­¥ <code>ja</code> è¡¨ç¤ºåªè¦ <code>%rdi</code>ï¼ˆxï¼‰çš„å€¼ï¼ˆ<strong>çœ‹ä½œ unsigned</strong>ï¼‰åœ¨ 6 ä¹‹ä¸Šï¼Œé‚£ä¹ˆå°±è·³è‡³ <code>.L8</code>ï¼ˆçœ‹æ¥æ˜¯ default ç‰‡æ®µï¼‰ï¼Œå¦åˆ™ç¬¬å››æ­¥ä¼šæ— æ¡ä»¶è·³è‡³æŸä¸ªä½ç½®ï¼›</p>
<blockquote>
<p>è¿™é‡Œç¼–è¯‘å™¨å¤„ç†çš„éå¸¸å·§å¦™ï¼šä½¿ç”¨ <code>ja</code>ï¼ˆunsigned aboveï¼‰è€Œä¸æ˜¯ <code>jg</code>ï¼ˆsigned greaterï¼‰ï¼Œè¿™æ ·åŒæ—¶æŠŠ <code>x &gt; 6</code> å’Œ <code>x &lt; 0</code> çš„æƒ…å†µéƒ½ç®—å…¥ <code>ja</code> çš„æ¡ä»¶ä¸­ï¼Œè¿›ä¸€æ­¥æé«˜äº†æ•ˆç‡ï¼›</p>
</blockquote>
<p>è¿™é‡Œè¿˜éœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œä¹‹å‰æ²¡æœ‰æåˆ°çš„ <code>JX</code> Instructions çš„ä½¿ç”¨è¯­æ³•ã€‚é™¤äº† <code>jX &lt;LABEL&gt;</code> ç›´æ¥è·³è½¬è‡³å¯¹åº”æ ‡ç­¾ï¼ˆdirect jumpï¼‰ï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯<strong>é—´æ¥è·³è½¬ï¼ˆindirect jumpï¼‰ï¼š<code>jX &lt;effectiveAddress&gt;</code></strong>ï¼›</p>
<p>å‚æ•°æ˜¯æœ‰æ•ˆåœ°å€ï¼Œå¯ä»¥æ˜¯å¯„å­˜å™¨åç§°ï¼Œä¹Ÿå¯ä»¥æ˜¯å³å€¼ï¼Œä¾‹å¦‚è¿™ä¸ªä¾‹å­ä¸­ <code>jmp *.L4(,%rdi,8)</code>ï¼Œåé¢çš„éƒ¨åˆ† <code>.L4(,%rdi,8)</code> åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼šå› ä¸ºæ ‡ç­¾ä¼šè¢«æ±‡ç¼–å™¨ç¿»è¯‘ä¸ºä»£ç æ®µçš„åœ°å€ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯ <code>.L4åœ°å€ + 8 * x</code>ï¼ˆ<code>%rdi</code> çš„å€¼æ˜¯ xï¼‰ï¼Œå¹¶æŠŠè¿™ä¸ªå€¼çœ‹ä½œ memory çš„åœ°å€ã€‚å‰é¢çš„ <code>*</code> æ˜Ÿå·å°±æ˜¯ç›´æ¥å–åœ°å€ä¸Šå†…å®¹çš„æ„æ€ï¼ˆå’Œ C/C++ çš„ç›¸åŒï¼‰ï¼Œå¯ä»¥ç†è§£ä¸º <code>leaq</code> ç›¸åçš„è¿‡ç¨‹ï¼›<strong>è¿™ä¸ª memory åœ°å€ä¸­çš„å€¼å°±æ˜¯è·³è¡¨ä¸­çš„ä¸€ä¸ªä»£ç æ®µçš„åœ°å€</strong>ï¼Œæ‰€ä»¥å–å‡ºæ¥çš„ä¹Ÿæ˜¯åœ°å€ï¼›</p>
<p>ç¬¬å››æ­¥è·³è½¬çš„ä½ç½®å¦‚ä½•ï¼Œæˆ‘ä»¬éœ€è¦çœ‹çœ‹å‰©ä¸‹æ¥çš„æ±‡ç¼–ä»£ç ï¼ˆè·³è¡¨éƒ¨åˆ†ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">            ; read only data</span><br><span class="line">.section    .rodata	; è¿™è¡Œå’Œä¸‹ä¸€è¡Œæ˜¯ä¸ºäº†æ„é€ è·³è¡¨çš„åŸºæœ¬ç»“æ„</span><br><span class="line">    .align	8		; ä¼ªå¯¹é½æŒ‡ä»¤ï¼ŒæŒ‡æ˜ä¸‹é¢çš„å˜é‡å¿…é¡»ä»ä¸‹ä¸€ä¸ªèƒ½è¢« 8 æ•´é™¤çš„åœ°å€å¼€å§‹</span><br><span class="line">.L4:                ; ä»£ç å—æŒ‰ç…§ x çš„å€¼çš„é¡ºåºè¿›è¡Œæ’åˆ—</span><br><span class="line">    .quad	.L8		; x = 0 çš„æƒ…å†µ</span><br><span class="line">    .quad	.L3		; x = 1</span><br><span class="line">    .quad	.L5		; x = 2</span><br><span class="line">    .quad	.L9		; x = 3</span><br><span class="line">    .quad	.L8		; x = 4</span><br><span class="line">    .quad	.L7		; x = 5</span><br><span class="line">    .quad	.L7		; x = 6</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè·³è¡¨çš„ç»“æ„æ˜¯ç”±æ±‡ç¼–ä»£ç æŒ‡å®šçš„ï¼Œå¦‚ä½•å¡«è¿™ä¸ªè¡¨æ˜¯<strong>æ±‡ç¼–å™¨çš„å·¥ä½œ</strong>ï¼Œä¸æ˜¯ç¼–è¯‘å™¨çš„å·¥ä½œï¼›</p>
<p>åœ¨ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­ï¼Œ<code>.quad</code> åªæ˜¯ä¸ªå£°æ˜ï¼Œæ ‡è®°è¡¨ç¤ºè¿™é‡Œæ˜¯ä¸€ä¸ª 4 å­—ï¼ˆ4 Ã— 16 bitsï¼‰çš„æ•°æ®ï¼Œä»¥åæ±‡ç¼–å™¨éœ€è¦å¡«ä¸Šåé¢æŒ‡å®šæ ‡ç­¾æŒ‡ä»¤æ®µçš„åœ°å€ï¼›</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>x &lt; 0</code> å’Œ <code>x &gt; 6</code> çš„æƒ…å†µåœ¨ä¹‹å‰çš„ä»£ç ä¸­è¢« <code>ja</code> å¤„ç†ï¼Œè·³è‡³ <code>.L8</code>ï¼ˆdefault ä»£ç æ®µï¼‰ï¼Œå‰©ä½™åœ¨ switch ä¸­æ•´æ•°ç¼ºçœçš„æƒ…å†µï¼ˆ<code>x = 4</code> å’Œ <code>x = 0</code>ï¼‰ä¹Ÿä¼šè‡ªåŠ¨è½¬è‡³ <code>.L8</code>;</p>
<p>ä¸»å¹²çœ‹å®Œäº†ï¼Œç»§ç»­çœ‹ä¹‹å‰æåˆ°çš„å„ä¸ªä»£ç æ®µçš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.L3:                    ; å¯¹åº” x = 1 çš„æƒ…å†µçš„ä»£ç æ®µ</span><br><span class="line">    movq	%rsi, %rax</span><br><span class="line">    imulq	%rdx, %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œç¼–è¯‘å™¨çš„è¡Œä¸ºå°±å¾ˆè¿·æƒ‘äº†ã€‚å¤§å®¶æ˜¯å¦è¿˜è®°å¾—ï¼Œä¹‹å‰åœ¨æºç çš„ç¬¬ä¸€è¡Œæœ‰ <code>long w = 1;</code> çš„åˆå§‹åŒ–æ“ä½œï¼Ÿä½†ç¼–è¯‘å™¨ä¸åšï¼Œå› ä¸ºåœ¨å¾ˆå¤š case ä¸‹å¹¶æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªå€¼ï¼Œæ‰€ä»¥èµ‹å€¼è¢«æ¨è¿Ÿäº†ï¼Œç›´åˆ°æœ‰ä¸€ä¸ª caseâ€”â€” <code>x = 3</code>ï¼Œå®ƒçš„ä»£ç æ®µæ˜¯ <code>w += z;</code> éœ€è¦ç”¨åˆ°ä¹‹å‰çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™ç¼–è¯‘å™¨æ‰å¼€å§‹èµ‹å€¼ 1ï¼Œè¿™ä¹ˆåšåªæ˜¯ä¸ºäº†æé«˜æ•ˆç‡â€¦â€¦å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.L5:                    ; å¯¹åº” x = 2 çš„ä»£ç æ®µ</span><br><span class="line">    movq	%rsi, %rax</span><br><span class="line">    cqto</span><br><span class="line">    idivq	%rcx		; %rcx ä¸­å­˜æ”¾ zï¼Œè¿™é‡Œæ˜¯ y/z</span><br><span class="line">    jmp	.L6</span><br><span class="line">.L9:                    ; å¯¹åº” x = 3 çš„ä»£ç æ®µä¹‹å‰çš„ x = 1 çš„èµ‹å€¼æ“ä½œï¼Œä¹Ÿæ˜¯x = 3å…¥å£</span><br><span class="line">    movl	$1, %eax</span><br><span class="line">.L6:                    ; å¯¹åº” x = 3 çš„ä»£ç æ®µä¸»ä½“</span><br><span class="line">    addq	%rcx, %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>cqto</code> æ˜¯ Convert Quadword to Octowordï¼Œæ„ä¸º 64-bit æ‰©å±•è‡³ 128-bitï¼Œæ²¡æœ‰å‚æ•°ï¼Œä½œç”¨æ˜¯å°† <code>%rax</code> ä¸­çš„ MSB å¤åˆ¶åˆ°æ•´ä¸ª <code>%rdx</code> å¯„å­˜å™¨ä¸­ï¼ˆè¿™ä¹ˆåšçš„åŸå› æ˜¯ <strong>Expanding Conclusion</strong>ï¼‰ï¼Œä¸€èˆ¬ç´§æ¥ç€ <code>idivq &lt;dividerR&gt;</code>ï¼Œå°† <code>rdx:rax</code> ä¸­çš„ 128-bit æ•°ä½œä¸ºè¢«é™¤æ•°ï¼Œ<code>divderR</code> ä½œä¸ºé™¤æ•°ï¼Œè¿›è¡Œ signed é™¤æ³•ï¼Œå•†å­˜åœ¨ <code>%rax</code>ï¼Œä½™æ•°å­˜åœ¨ <code>%rdx</code>ï¼›</p>
<p>ç»§ç»­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.L7:                    ; x = 5</span><br><span class="line">    movl	$1, %rax</span><br><span class="line">    subq	%rdx, %rax</span><br><span class="line">    ret</span><br><span class="line">.L8:                    ; x = 6</span><br><span class="line">    movl	$2, %eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>æ˜ç™½äº†è·³è¡¨çš„åŸç†ï¼Œè¿™ä¸‹æ˜ç™½äº†ä¸ºå•¥ C/C++ è¦æ±‚ switch çš„é‡å¿…é¡»æ˜¯å¯ä»¥è½¬æ¢ä¸ºæ•´å‹çš„å¸¸é‡äº†å§ï¼Ÿ</p>
<p>æ— è®ºå¦‚ä½•ï¼Œç¼–è¯‘å™¨éƒ½ä¼šæ‰¾å‡ºä½ å†™çš„æ‰€æœ‰ case çš„æœ€å¤§å€¼ã€æœ€å°å€¼ï¼Œåœ¨æ­¤ä¹‹å¤–çš„æƒ…å†µä¼šåœ¨è¿›å…¥è·³è¡¨å‰è¿›è¡Œè·³è½¬è‡³ default å—ï¼›åœ¨æœ€å€¼ä¹‹é—´çš„ï¼Œä¼šå‡ºç°åœ¨è·³è¡¨ä¸­ï¼ˆä¹Ÿå°±æ˜¯è¯´ case çš„æœ€å¤§å€¼ã€æœ€å°å€¼å†³å®šäº†è·³è¡¨çš„å¤§å°ï¼‰ï¼›ä½†æ˜¯åœ¨èŒƒå›´ä¸­æœ‰ç¼ºçœçš„æƒ…å†µçš„ï¼Œä¹Ÿä¼šè¡¥å……åœ¨è·³è¡¨ä¸­ï¼Œè·³è½¬åˆ° default å—ã€‚</p>
<blockquote>
<p>å°æœºçµå¯èƒ½ä¼šé—®ï¼Œè¯¶ï¼Œå¦‚æœè¿™äº› case å…¨æ˜¯è´Ÿæ•°å’‹æ•´ï¼Ÿæˆ–è€…æœ€å°å€¼å¾ˆå¤§å’‹æ•´ï¼Ÿè¿˜èƒ½ä¸èƒ½å»ºç«‹è·³è¡¨ã€ç”¨ç´¢å¼•äº†ï¼Ÿå› ä¸ºå’±ä¹‹å‰çš„ <code>jmp *.L4(,%rdi,8)</code> ä¸å°±ç›´æ¥æŠŠ x åšè·³è¡¨ç´¢å¼•äº†å—ï¼Ÿ</p>
<p>å®é™…ç¼–è¯‘å™¨ä¼šç¡®ä¿æœ€å°å€¼ä¸ä¼šä½äº 0ï¼Œä¹Ÿä¸ä¼šå¤ªå¤§ã€‚ä¸ºæ­¤ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šåŠ ä¸Šåç½®å€¼ï¼ˆbiasï¼‰è®© case å˜æˆå°çš„æ­£æ•°ã€‚</p>
<p>è¿˜æœ‰å°æœºçµå¯èƒ½ä¼šé—®ï¼Œå¦‚æœä¸€ä¸ª case æ˜¯ 0ï¼Œ å¦ä¸€ä¸ªæ˜¯ 10000ï¼Œéš¾åº¦åœ¨è¿™ä¹‹ä¸­çš„å…¨éƒ¨è¦å»ºè¡¨å—ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ case çš„é—´éš”å¾ˆç¨€ç–ã€å¾ˆå¤§æ€ä¹ˆåŠï¼Ÿ</p>
<p>è¿™ä¸ªæ—¶å€™ç¼–è¯‘å™¨ä¼šæŠŠè¿™äº› switch-case è½¬æ¢æˆ if-else è¯­å¥ï¼Œå†å»ºç«‹ if-else æ ‘ï¼Œç”±äºç¨€ç–çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªæ ‘å¤§æ¦‚ç‡æ˜¯å¹³è¡¡æ ‘ï¼Œè®©æ¯”å¯¹çš„æ—¶é—´å¤æ‚åº¦ä¿æŒåœ¨ $O(log_2(n))$ï¼›</p>
</blockquote>
<p>ç»¼åˆä¸Šé¢çš„è®¨è®ºï¼Œæ— è®ºå¦‚ä½• switch-case æ‰€ä¾èµ–çš„è·³è¡¨çš„æ—¶é—´å¤æ‚åº¦ä¼šåœ¨ $O(1)\sim O(log_2(n))$ ä¹‹é—´ï¼Œæ€»æ˜¯æ¯” if-else çš„çº¿æ€§æ—¶é—´å¤æ‚åº¦è¦å¥½ã€‚</p>
<h3 id="4-5-Summary-for-Chapter-4"><a href="#4-5-Summary-for-Chapter-4" class="headerlink" title="4.5 Summary for Chapter 4"></a>4.5 Summary for Chapter 4</h3><p>è¿™ç« çš„çŸ¥è¯†ç‚¹æ¯”è¾ƒå¤šï¼Œåœ¨è¿™é‡Œæ€»ç»“ä¸€ä¸‹ Chapter 4 çš„ä¸»è¦å†…å®¹ã€‚</p>
<p>åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆå¤ä¹ äº†ä¹‹å‰çš„å¯„å­˜å™¨åŠå…¶ä»£è¡¨çš„å¤„ç†å™¨çš„çŠ¶æ€ï¼Œå†åˆæ­¥äº†è§£äº†æ±‡ç¼–ä¸­çš„é‡è¦ flags: condition codesï¼ˆç›®å‰åªè®¤è¯†äº† 4 ä¸ªï¼š<code>CF/OF/SF/ZF</code>ï¼‰ï¼Œå®ƒä»¬å¯ä»¥çœ‹ä½œä¸€ä¸ªä¸ª 1-bit æ•°æ®ï¼Œä¸èƒ½è¢«æ‰‹åŠ¨æ›´æ”¹ï¼Œä½†å¯ä»¥é€šè¿‡ç‰¹å®šçš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚</p>
<p>ä¾‹å¦‚ <code>cmpq</code> å’Œ <code>testq</code> èƒ½æ ¹æ®è®¡ç®—ç»“æœä¿®æ”¹ flagsï¼Œ<code>setX</code> Instructions èƒ½æ ¹æ®å½“å‰ flags è®¾ç½®ç‰¹å®šçš„ 8-bit ä½ã€‚æˆ‘ä»¬è¿˜äº†è§£äº†å‡ ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ <code>movzbl</code>ï¼›äº†è§£äº† x86-64 çš„ low-order 32-bit å¡«å……ç‰¹æ€§ã€‚</p>
<p>æˆ‘ä»¬ä¸æ»¡è¶³äºå€ŸåŠ© condition codes ä»…ä»…å¡«å……å‡ ä¸ª bitsï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥å­¦ä¹ äº†æ ¹æ® condition codes è¿›è¡Œæµç¨‹æ§åˆ¶çš„æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆæ˜¯æ¯”è¾ƒä½æ•ˆçš„ <code>JX</code> Instructionsï¼Œå®ƒä»£è¡¨ç€ General Conditional Expressionï¼Œåˆ©ç”¨æ±‡ç¼–<strong>æ¡ä»¶è·³è½¬</strong>åˆæ­¥å®ç°æ¡ä»¶åˆ†æ”¯ï¼›è¿›ä¸€æ­¥ä»æµæ°´çº¿å±‚é¢ï¼Œæˆ‘ä»¬è®¤è¯†åˆ° <strong>Conditional Moves</strong> å¯èƒ½æ˜¯æ›´å¥½ã€æ›´å¿«çš„é€‰æ‹©ï¼Œä½†ä¸€å®šè¦ææ¸… 3 ä¸ªç¦å¿Œæ¡ä»¶ã€‚æˆ‘ä»¬è¿˜è®¤è¯†äº† <code>cmovle</code> ç­‰ä¸€ç³»åˆ—<strong>æ¡ä»¶ç§»åŠ¨çš„æŒ‡ä»¤</strong>ï¼Œè®©è¿‡ç¨‹æ›´åŠ æ–¹ä¾¿ã€‚</p>
<p>åœ¨å¾ªç¯æ§åˆ¶æ–¹é¢ï¼Œæˆ‘ä»¬æŒæ¡äº† do-while ç»“æ„çš„ç¿»è¯‘æ–¹æ³•ï¼Œé€šè¿‡ <code>JX</code> æŒ‡ä»¤è½»æ¾è§£å†³ï¼›é’ˆå¯¹ while å¾ªç¯æ—¶ï¼Œæˆ‘ä»¬æƒ³åˆ°ä¸¤ç§æ–¹æ³•ï¼šâ€œJump to Middleâ€ æŠŠåˆ¤æ–­æ¡ä»¶æ”¾ loop çš„ä¸­é—´ï¼Œå¼€å§‹å¾ªç¯å‰è·³è¿›å»ï¼›è¿˜æœ‰ä¸€ç§æ˜¯è½¬æ¢ä¸º do-while çš„ â€œset guardianâ€ æ–¹æ³•ï¼Œæ•ˆç‡æ›´é«˜ã€‚å¯¹äº for å¾ªç¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®¹æ˜“åœ°å°†å…¶è½¬æ¢ä¸º while å¾ªç¯ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ä¸º do-whileï¼Œé€šè¿‡åˆç†èˆå¼ƒ â€œguardianâ€ è¿›ä¸€æ­¥åŠ å¿«è¿è¡Œæ•ˆç‡ã€‚</p>
<p>åœ¨æ¯”è¾ƒç¹ççš„ switch-case è¯­å¥çš„ç¿»è¯‘ä¸Šï¼Œèªæ˜çš„äººä»¬ä¸ºå®ƒå¼•å…¥äº†<strong>è·³è¡¨</strong>çš„æ•°æ®ç»“æ„ï¼Œåˆ©ç”¨ <code>jX</code> çš„é—´æ¥è·³è½¬åœ¨ $O(1)\sim O(log_2(n))$ çš„å¤æ‚åº¦ä¸‹å®Œæˆäº†åˆ†æ”¯ï¼Œè¿œèƒœ if-else ç»“æ„çš„çº¿æ€§å¤æ‚åº¦ã€‚</p>
<p>ä¸è¿‡ä¸Šé¢çš„å‡ ä¹æ‰€æœ‰å†…å®¹éƒ½æ˜¯åœ¨æ±‡ç¼–å±‚é¢<strong>å®ç°äº†ä¸€äº›å°çš„ â€œtricksâ€</strong> æ¥å¸®åŠ©æå‡è¿è¡Œæ•ˆç‡ï¼Œè¿™åªæ˜¯åœ¨å°†ä»£ç æµç¨‹æ§åˆ¶çš„ç¿»è¯‘è¿™ä¸ª procedure ä¸ŠåŠ ä¸€ç‚¹ä¸œè¥¿ï¼Œæˆ–è€…æ˜¯<strong>æ”¹å˜æµç¨‹çš„æ–¹æ³•</strong>ã€‚è¿™éƒ½æ˜¯åº•å±‚æŒ‡ä»¤é€æ­¥å †ç Œå®ç°æ›´é«˜çº§æŒ‡ä»¤çš„å®ä¾‹ã€‚</p>
<p>ä¸‹ä¸€ç« èŠ‚æˆ‘ä»¬å°†ç³»ç»Ÿå­¦ä¹ æ±‡ç¼–è¿è¡Œçš„æ•´ä¸ª procedureï¼ŒçŸ¥è¯†ç‚¹å°†æ›´ä¸ºå¤æ‚ï¼Œåšå¥½å‡†å¤‡ï¼</p>
<h2 id="Chapter-5-Machine-Level-Programming-â…¢-Procedure"><a href="#Chapter-5-Machine-Level-Programming-â…¢-Procedure" class="headerlink" title="Chapter 5. Machine Level Programming â…¢ - Procedure"></a>Chapter 5. Machine Level Programming â…¢ - Procedure</h2><blockquote>
<p>æœ¬ç« æ‰€æŒ‡çš„ Procedure æ—¢å¯ä»¥æ˜¯ functionï¼Œmethodï¼Œä¹Ÿå¯ä»¥æ˜¯ normal procedureï¼›</p>
</blockquote>
<p>çŸ¥è¯†è¡¥å……ï¼šä»€ä¹ˆæ˜¯ ABI ï¼Ÿ</p>
<p>è™½ç„¶ CSAPP è®²è¿°çš„æ˜¯åŸºäº x86 ç¡¬ä»¶åŠå…¶è¿è¡Œæ–¹å¼ï¼Œä½†æ›´é‡è¦çš„æ˜¯æˆ‘ä»¬é‡‡ç”¨äº†ä¸€å¥—è¢«æ™®éæ‰¿è®¤çš„çº¦å®šâ€”â€” ABIï¼ˆApplication Binary Interfaceï¼‰ï¼Œè¿™æ˜¯ä¸ª<strong>æœºå™¨ç¨‹åºçº§åˆ«çš„æ¥å£</strong>ã€‚è¿™ä¸ªæ¥å£åœ¨ç¬¬ä¸€å° x86 æœºå™¨è¢«åˆ¶é€ å‡ºæ¥çš„æ—¶å€™å°±å‡ºç°äº†ï¼Œå°¤å…¶æ˜¯ä¸º Linux åˆ¶å®šçš„ã€‚å®ƒè§„å®šäº†ï¼Œæ‰€æœ‰äºŒè¿›åˆ¶ç¨‹åºã€æ“ä½œç³»ç»Ÿå„ä¸ªç»„ä»¶ã€ç¼–è¯‘å™¨éƒ½è¦å¯¹äºç®¡ç†æœºå™¨ä¸Šçš„èµ„æºæœ‰å…±åŒçš„ç†è§£ï¼Œå¹¶ä¸”éµå®ˆä½¿ç”¨è§„åˆ™ã€‚</p>
<p><strong>ä¾‹å¦‚ä¹‹å‰è¯´çš„ï¼Œçº¦å®šä¿—æˆå“ªäº›å¯„å­˜å™¨ç”¨æ¥ä¼ é€’å‡½æ•°å‚æ•°ã€å“ªäº›å¯„å­˜å™¨ç”¨æ¥ä¼ é€’è¿”å›å€¼ï¼Œå“ªäº›æ˜¯ â€œCaller-Saved Registerâ€ï¼Œå“ªäº›åˆæ˜¯ â€œCallee-Saved Registerâ€</strong>ï¼Œè¿™äº›éƒ½æ˜¯ ABI è§„å®šçš„ï¼›</p>
<p>åˆ°ç›®å‰ï¼ŒWindows å’Œ OSX ç­‰æ“ä½œç³»ç»Ÿä¹Ÿæœ‰è‡ªå·±çš„ ABIï¼›</p>
<h3 id="5-1-Mechanisms-in-Procedures"><a href="#5-1-Mechanisms-in-Procedures" class="headerlink" title="5.1 Mechanisms in Procedures"></a>5.1 Mechanisms in Procedures</h3><blockquote>
<p>è¿‡ç¨‹æœºç†çš„æ¦‚è§ˆï¼Œä¸‹å‡ èŠ‚ä¼šä¸€ä¸€å›ç­”è¿™äº›é—®é¢˜ï¼›</p>
</blockquote>
<ul>
<li>Passing control<ul>
<li>To beginning of procedure codeï¼ˆè¿è¡Œè¿‡ç¨‹å¦‚ä½•è¿›å…¥ä¸€ä¸ªå‡½æ•°ï¼Ÿï¼‰</li>
<li>Back to return pointï¼ˆå‡½æ•°è¿è¡Œç»“æŸå¦‚ä½•è·³è½¬åˆ°ä¹‹å‰è°ƒç”¨ä½ç½®çš„ä¸‹ä¸€è¡Œï¼Ÿï¼‰</li>
</ul>
</li>
<li>Passing data<ul>
<li>Procedure argumentï¼ˆå¦‚ä½•å‘è¢«è°ƒæ–¹ä¼ é€’å‚æ•°ï¼Ÿï¼‰</li>
<li>Return valueï¼ˆè¢«è°ƒæ–¹å¦‚ä½•è¿”å›æ•°æ®ç»™è°ƒç”¨æ–¹ï¼Ÿï¼‰</li>
</ul>
</li>
<li>Memory management<ul>
<li>Allocate during procedure executionï¼ˆæŸè¿‡ç¨‹å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå†…å­˜å¦‚ä½•åˆ†é…ä»¥ä¾›è¿‡ç¨‹ä½¿ç”¨ï¼Ÿï¼‰</li>
<li>Deallocate upon returnï¼ˆæŸè¿‡ç¨‹ç»“æŸåï¼Œå†…å­˜å¦‚ä½•é”€æ¯ï¼Ÿï¼‰</li>
</ul>
</li>
<li>Mechanisms all implemented with machine instructionsï¼ˆä»¥ä¸Šæœºç†å¦‚ä½•åœ¨æœºå™¨ä»£ç ä¸­å®ç°ï¼Ÿï¼‰</li>
<li>x86-64 implementation of a procedure uses only those mechanisms requiredï¼ˆç¤ºä¾‹ï¼‰</li>
</ul>
<h3 id="5-2-x86-64-Stack"><a href="#5-2-x86-64-Stack" class="headerlink" title="5.2 x86-64 Stack"></a>5.2 x86-64 Stack</h3><blockquote>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆä»‹ç» x86-64 architecture çš„å†…å­˜æ ˆçš„æœºåˆ¶ï¼›</p>
</blockquote>
<p>ç¨‹åºæ€»æ˜¯ä½¿ç”¨æ ˆæ¥<strong>ç®¡ç†è¿‡ç¨‹ä¸­è°ƒç”¨å’Œè¿”å›çŠ¶æ€</strong>ï¼Œè¿™ä¸»è¦æ˜¯åˆ©ç”¨äº†æ ˆ LIFO çš„æ€§è´¨ï¼Œè¿™å’Œè°ƒç”¨-è¿”å›çš„æ€æƒ³å¾ˆç›¸ä¼¼ã€‚å› æ­¤å®ƒå¯ä»¥è¢«ç”¨äºï¼š<strong>ä¼ é€’æ½œåœ¨ä¿¡æ¯ã€æ§åˆ¶ä¿¡æ¯ï¼Œåˆ†é… local æ•°æ®</strong>ï¼›</p>
<p>x86 çš„ç¨‹åºæ ˆä¹Ÿå­˜åœ¨äºå†…å­˜ä¸­ï¼Œ<strong>æ ˆåº•ä½äº high numbered addressï¼ˆé«˜ä½åœ°å€ï¼‰</strong>ï¼Œè€Œæ ˆé¡¶ä½äº low numbered addressï¼›</p>
<p>å‰é¢è¯´çš„ <strong><code>%rsp</code> å¯„å­˜å™¨</strong>å°±æ˜¯ä½äºæ ˆé¡¶æ¥ç®¡ç†è¿™ä¸ªè¿‡ç¨‹çš„ã€‚<code>%rsp</code> å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯<strong>æ ˆé¡¶çš„åœ°å€</strong>ï¼Œå½“æœ‰æ•°æ®éœ€è¦è¿›æ ˆæ—¶ï¼Œ<strong>é€šè¿‡é€’å‡æ ˆæŒ‡é’ˆæ¥å®Œæˆè¿›æ ˆæ“ä½œ</strong>ï¼›</p>
<p>ä¹‹å‰è¿˜è¯´è¿‡ï¼Œ<code>%rsp</code> ä¸åº”è¯¥è¢«æ‰‹åŠ¨æ›´æ”¹ï¼Œé‚£ä¹ˆæœ‰å“ªäº›æ–¹æ³•èƒ½å¤Ÿä½¿ç”¨è¿™ä¸ªæ ˆå‘¢ï¼Ÿ</p>
<p>ç¬¬ä¸€ä¸ªæ˜¯ <code>pushq</code> æŒ‡ä»¤ã€‚</p>
<ul>
<li><p>è¯­æ³•ï¼š<code>pushq &lt;Src&gt;</code>;</p>
</li>
<li><p>ä½œç”¨ï¼šå…ˆä» <code>Src</code> ä¸­å–å¾—æ“ä½œæ•°ï¼Œå†å°† <code>%rsp</code> å€¼å‡ 8ï¼ˆquadwordï¼Œå³ 4 Ã— 16 bitsï¼Œ64 bitsï¼Œ8 bytesï¼‰ï¼Œæœ€åå°†ä» <code>Src</code> å¤„è·å¾—çš„æ“ä½œæ•°å†™å…¥åˆ° <code>%rsp</code> å¯¹åº”çš„ memory åœ°å€ä¸­ï¼›</p>
<blockquote>
<p>âš  éœ€è¦æ³¨æ„çš„ç‚¹ï¼š<strong>è¿™ä¸ªæ ˆæ˜¯å…ˆç§»åŠ¨æŒ‡é’ˆå†å¾€é‡Œé¢å†™çš„</strong>ï¼›</p>
</blockquote>
</li>
<li><p><code>Src</code> å¯ä»¥æ˜¯ç›´æ¥é‡ã€å¯„å­˜å™¨åç§°ã€å†…å­˜å¼•ç”¨ï¼›</p>
</li>
</ul>
<p>ä¸ä¹‹å¯¹åº”çš„æ˜¯ <code>popq</code> æŒ‡ä»¤ã€‚</p>
<ul>
<li><p>è¯­æ³•ï¼š<code>popq &lt;Dst&gt;</code>;</p>
</li>
<li><p>ä½œç”¨ï¼šå…ˆå°† <code>%rsp</code> å€¼æ‰€ä»£è¡¨çš„ memory åœ°å€ä¸­çš„å€¼è¯»è¿›ï¼Œå†å°† <code>%rsp</code> çš„å€¼åŠ  8ï¼Œæœ€åå°†è¯»åˆ°çš„å€¼å†™å…¥ <code>Dst</code>;</p>
<blockquote>
<p>âš  éœ€è¦æ³¨æ„çš„ç‚¹ï¼š<strong>è¿™ä¸ª <code>Dst</code> åªèƒ½æ˜¯å¯„å­˜å™¨</strong>ï¼Œå› ä¸ºå‰é¢è¯´äº†ï¼Œä¸å…è®¸ä»å†…å­˜åˆ°å†…å­˜ï¼Œä¹Ÿä¸å…è®¸å­˜å…¥ç›´æ¥é‡ï¼›</p>
</blockquote>
</li>
</ul>
<h3 id="5-3-Calling-Conventions"><a href="#5-3-Calling-Conventions" class="headerlink" title="5.3 Calling Conventions"></a>5.3 Calling Conventions</h3><h4 id="5-3-1-Passing-Control"><a href="#5-3-1-Passing-Control" class="headerlink" title="5.3.1 Passing Control"></a>5.3.1 Passing Control</h4><p>ä»¥ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">multstore</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> *dest)</span> &#123;</span><br><span class="line">    <span class="type">long</span> t = mult2(x, y);</span><br><span class="line">    *dest = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">mult2</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span> &#123;</span><br><span class="line">    <span class="type">long</span> s = a * b;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸Šé¢çš„æºç ç»è¿‡æ±‡ç¼–å¾—åˆ°çš„ç»“æœï¼ˆç¨å¾®åˆ é™¤äº†ä¸€äº›æ— å…³ç´§è¦çš„éƒ¨åˆ†ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">multstore:</span><br><span class="line">    push	%rbx</span><br><span class="line">    mov		%rdx, %rbx</span><br><span class="line">    callq	400550 &lt;mult2&gt;</span><br><span class="line">    mov		%rax, (%rbx)</span><br><span class="line">    pop		%rbx</span><br><span class="line">    retq</span><br><span class="line"></span><br><span class="line">mult2:</span><br><span class="line">    mov		%rdi, %rax</span><br><span class="line">    imul	%rsi, %rax</span><br><span class="line">    retq</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹ <strong>Passing Control</strong> æ˜¯æ€ä¹ˆå®Œæˆçš„ï¼š</p>
<ul>
<li><p>ä½¿ç”¨äº†ç¨‹åºæ ˆæ¥æ”¯æŒ procedure çš„æ•°æ®ï¼›</p>
</li>
<li><p>ä½¿ç”¨ <code>call &lt;LABEL&gt;</code> æŒ‡ä»¤æ¥å®Œæˆï¼š</p>
<ol>
<li>æŠŠ <strong>return address</strong>ï¼ˆè°ƒç”¨ç»“æŸï¼Œè¿”å›æ—¶çš„ä½ç½®ï¼‰åŠ å…¥åˆ°æ ˆä¸­ï¼›</li>
<li>è·³è‡³ <code>LABEL</code> æ‰§è¡Œï¼›</li>
</ol>
</li>
<li><p>ä½¿ç”¨ <code>ret</code> æŒ‡ä»¤æ¥å®Œæˆï¼š</p>
<ol>
<li>å°†æ ˆä¸­çš„åœ°å€å¼¹å‡ºè¯»å–ï¼›</li>
<li>è·³è½¬åˆ°è¯»å–çš„åœ°å€ï¼›</li>
</ol>
<blockquote>
<p>æœ‰çš„æ—¶å€™ä¼šçœ‹åˆ° <code>rep; ret</code> çš„æŒ‡ä»¤è¡Œï¼Œä¸ç”¨ç®¡ï¼Œå®ƒå’Œ <code>ret</code> ä½œç”¨ä¸€æ ·ï¼›</p>
</blockquote>
</li>
</ul>
<p>å› æ­¤ï¼ŒPassing Control çš„è¿‡ç¨‹ä¸»è¦ç”±ä¸¤ä¸ªç‰¹æ®Šå¯„å­˜å™¨ã€ä¸€ä¸ªæ ˆæ”¯æŒï¼›è¿è¡Œçš„åŠ¨æ€å¦‚ä¸‹ï¼ˆåœ°å€ä¿¡æ¯æ˜¯è™šæ‹Ÿçš„ï¼‰ï¼š</p>
<p><img src="imgs/procedure_control_1.png" height="200px"><img src="imgs/procedure_control_2.png" height="200px"><img src="imgs/procedure_control_3.png" height="200px"><img src="imgs/procedure_control_4.png" height="200px"></p>
<h4 id="5-3-2-Passing-Data"><a href="#5-3-2-Passing-Data" class="headerlink" title="5.3.2 Passing Data"></a>5.3.2 Passing Data</h4><p>å…¶å®åœ¨æ­¤ä¹‹å‰çš„å‰å‡ ç« ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œæ±‡ç¼–ç¨‹åºä½¿ç”¨çº¦å®šä¿—ç§°çš„å¯„å­˜å™¨ï¼ˆâ€œCaller-Saved Resgiterâ€ï¼‰æ¥å®Œæˆå‡½æ•°å‚æ•°ã€è¿”å›å€¼çš„ä¼ é€’ï¼š</p>
<ul>
<li><p><code>%rdi</code>ã€<code>%rsi</code>ã€<code>%rdx</code>ã€<code>%rcx</code>ã€<code>%r8</code>ã€<code>%r9</code> è¿™éƒ½æ˜¯ Caller-Saved Registerï¼Œçº¦å®š<strong>ä»å‰åˆ°å</strong>ï¼ˆé¡ºåºå¯ä»¥è®°ä¸‹æ¥ï¼‰ç”¨æ¥å­˜æ”¾å‡½æ•°çš„å…­ä¸ªå‚æ•°ï¼Œä¾›è¢«è°ƒç”¨æ–¹ä½¿ç”¨ï¼›</p>
<blockquote>
<p>è¿™é‡Œæ˜¯ integer registersï¼Œå¦‚æœå‚æ•°ä¸æ˜¯æ•´å‹ / æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šç”¨<strong>æµ®ç‚¹æ•°å¯„å­˜å™¨</strong>æ¥å­˜æ”¾ï¼Œä»¥åè¯´ã€‚</p>
<p>æ³¨ï¼šåœ¨ IA-32 æ—¶æœŸï¼Œç”šè‡³æ‰€æœ‰å‚æ•°éƒ½æ”¾åœ¨æ ˆé‡Œï¼Œè¿™ä¼šå¤§å¤§é™ä½ç¨‹åºè¿è¡Œé€Ÿåº¦çš„ã€‚</p>
</blockquote>
</li>
<li><p>å¦‚æœå‡½æ•°å¤šäº 6 ä¸ªå‚æ•°é‚£ä¹ˆä»ç¬¬ 7 ä¸ªå‚æ•°å¼€å§‹ï¼Œå°†æŒ‰é¡ºåºå­˜æ”¾åœ¨æ ˆé‡Œï¼Œä»…éœ€è¦æ‰ä¼šåˆ†é…æ ˆï¼ˆ<strong>è¿™ä¸ªæ ˆä¹Ÿç”¨ <code>%rsp</code> è®¿é—®ï¼Œæ¯ 8 bytes ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯ä½äºå¦ä¸€ä¸ªæ ˆå¸§ï¼Œå’Œè°ƒç”¨æ–¹çš„æ ˆå¸§äº’ä¸å¹²æ‰°ã€‚å…·ä½“æƒ…å†µè§ä¸‹ä¸€èŠ‚</strong>ï¼‰</p>
</li>
<li><p><code>%rax</code> æ˜¯ Callee-Saved Registerï¼Œçº¦å®šæ˜¯ç”¨äºå­˜æ”¾å‡½æ•°çš„è¿”å›å€¼ï¼Œä¾›è°ƒç”¨æ–¹è¯»å–ï¼›</p>
</li>
</ul>
<h4 id="5-3-3-Managing-Local-Data"><a href="#5-3-3-Managing-Local-Data" class="headerlink" title="5.3.3 Managing Local Data"></a>5.3.3 Managing Local Data</h4><p>æ—©åœ¨ 5.2 ä¸­å°±ä»‹ç»äº† x86 æ ˆçš„ä½œç”¨ä¹‹ä¸€å°±æ˜¯<strong>åˆ†é… local æ•°æ®</strong>ã€‚é‚£ä¹ˆè°ƒç”¨å’Œè¿”å›çš„åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯å¯ä»¥å¯¹å‡½æ•°è¿›è¡ŒåµŒå¥—è°ƒç”¨ã€‚</p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬å°†æ ˆä¸Š<strong>ç”¨äºç‰¹å®š call çš„æ¯ä¸ªå†…å­˜å—ç§°ä¸ºæ ˆå¸§ï¼ˆstack frameï¼‰</strong>ï¼Œå®ƒæ˜¯ç‰¹å®š procedureã€ç‰¹å®š instance çš„æ ˆå¸§ã€‚å•çº¿ç¨‹ç¨‹åºå…±ç”¨ä¸€ä¸ªæ ˆï¼Œå› æ­¤é€šè¿‡æ ˆå¸§æ¥ç®¡ç†å„ä¸ªå‡½æ•°çš„ Local dataï¼›</p>
<p>æ ˆå¸§çš„ç»“æ„å¦‚ä½•ï¼Ÿæ˜¯å¦‚ä½•ç®¡ç†çš„ï¼Ÿå…¶ä¸­ç©¶ç«Ÿæ”¾äº†äº›ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li><p>Structureï¼šå¤§å®¶åœ¨ C++ ç¨‹åºè®¾è®¡è¯¾ç¨‹ä¸Šåº”è¯¥æ¥è§¦è¿‡ â€œå˜é‡ä½œç”¨åŸŸâ€ï¼Œè¿™ä¸ªæ—¶å€™åº”è¯¥å¼ºè°ƒäº†ä¸åŒå‡½æ•°çš„å±€éƒ¨å˜é‡ä¼šå­˜åœ¨å®ƒçš„æ ˆå¸§ä¸­ã€‚æ‰€ä»¥å¯ä»¥æƒ³è±¡ï¼Œæ ˆå¸§å°±æ˜¯ä¸€æ®µä¸€æ®µå †å åœ¨ stack ä¸Šçš„ç‰‡æ®µï¼Œæ¯ä¸ªæœªè¿”å›çš„å‡½æ•°ç‹¬äº«ä¸€ä¸ªæ ˆå¸§ï¼›</p>
<p><img src="imgs/stack_structure.png" height="300px"></p>
<p><strong>å¹¶ä¸” <code>%rsp</code> å°±åœ¨ä¹‹å‰è¯´çš„æ ˆé¡¶ï¼Œè¿˜æœ‰ä¸€ä¸ªæ™®é€šå¯„å­˜å™¨ <code>%rbp</code> å¯ä»¥ç”¨æ¥å­˜æ”¾ä¸¤ä¸ªæ ˆå¸§äº¤ç•Œçš„ä½ç½®ï¼ˆåªæœ‰åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ç¼–è¯‘å™¨æ‰ä¼šä½¿ç”¨å®ƒï¼Œå¹³æ—¶ä¼šå½“ä½œæ™®é€šå¯„å­˜å™¨ä½¿ç”¨ï¼‰</strong>ï¼›</p>
<p>æ‰€ä»¥å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ <code>%rbp</code> æŒ‡ç¤ºï¼Œæ±‡ç¼–ç¨‹åºå‘˜ç”šè‡³ä¸çŸ¥é“ä¸‹ä¸€å±‚æ ˆå¸§åœ¨å“ªé‡Œï¼Œ<strong>è¿™åªèƒ½é ä»£ç è‡ªèº«ç®¡ç†ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹ç¼–è¯‘å™¨çŸ¥é“éœ€è¦åˆ†é…å¤šå°‘æ ˆå¸§ã€é”€æ¯å¤šå°‘æ ˆå¸§ï¼‰ï¼Œå¹¶ä¸”æ­£ç¡®é‡Šæ”¾æ ˆå¸§ï¼ˆæœ¬èŠ‚çš„ä¸€ä¸ªä¾‹å­ä¼šæ¼”ç¤ºä»£ç å¦‚ä½•è‡ªèº«ç®¡ç†æ ˆå¸§ï¼‰</strong>ï¼›</p>
<blockquote>
<p>ç¼–è¯‘å™¨ä¸çŸ¥é“åº”è¯¥åˆ†é…å¤šå°‘æ ˆå¸§çš„ç‰¹æ®Šæƒ…å†µï¼š<strong>åˆ†é…å¯å˜å¤§å°çš„æ•°ç»„ / å†…å­˜ç¼“å†²åŒº</strong> ç­‰æƒ…å†µï¼Œè¿™æ—¶ç¼–è¯‘å™¨ä¼šæ— å¥ˆé€‰æ‹©ä½¿ç”¨ <code>%rbp</code> ç®¡ç†ï¼›</p>
</blockquote>
<p>ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œé€’å½’æ‰€éœ€çš„æ‰€æœ‰åŸºç¡€ç»“æ„éƒ½ç”±æ ˆçš„åŸåˆ™æ‰€ä¿è¯ï¼›</p>
<p>å¯¹äº <strong>x86-64 Linux</strong> è¿™ä¸€ç‰¹å®šæœºå™¨ + æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œæ ˆå¸§çš„<strong>è¯¦ç»†ç»“æ„</strong>åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="imgs/stack_structure_detail.png" height="350px"></p>
<ul>
<li><p>ä¹‹å‰åœ¨ <strong>Passing Control</strong> ä¸­æåˆ° <code>call</code> æŒ‡ä»¤å‹å…¥çš„è¿”å›åœ°å€å­˜åœ¨ Caller Frame çš„æœ€ä¸Šå±‚ï¼Œä¸‹é¢å‹ç€ Caller çš„å‚æ•°ï¼›</p>
</li>
<li><p>åœ¨ä¸¤ä¸ªæ ˆå¸§ä¹‹é—´æœ‰ç©ºé—´ä¸ºå¯é€‰çš„æ—§ <code>%rbp</code>ï¼ˆä¸Šä¸€å±‚æ ˆå¸§çš„ <code>%rdp</code>ï¼‰ç©ºé—´ï¼Œå½“å‰çš„ <code>%rbp</code> å°±æŒ‡å‘è¿™é‡Œï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼›</p>
</li>
<li><p>åœ¨å½“å‰ Callee Frame ä¸­ï¼Œæœ€åº•å±‚æ˜¯ <strong>Callee-Saved Register</strong>ï¼ˆä¿å­˜ Temporariesï¼‰å’Œå†…å­˜ä¸­çš„<strong>å±€éƒ¨å˜é‡</strong>ï¼›å‘ä¸Šå°±æ˜¯åœ¨ <strong>Pass Data</strong> ä¸­æåˆ°çš„<strong>å¤šäº 6 ä¸ªçš„ä¼ å…¥å‚æ•°</strong>å­˜æ”¾çš„ä½ç½®ã€‚</p>
</li>
<li><p><strong>ä¹‹å‰è¯´çš„ â€œä»£ç è‡ªèº«ç®¡ç†çš„æ–¹å¼â€ å°±æ˜¯åœ¨å‡½æ•°è¿”å›å‰å°† <code>%rsp</code> å›åˆ°ä¸€å¼€å§‹çš„åœ°æ–¹ï¼ˆä¸Šä¸€å±‚æ ˆå¸§ï¼‰</strong>ï¼›</p>
</li>
</ul>
</li>
<li><p>Managementï¼šä¸ºæ­£åœ¨æ‰§è¡Œã€æ²¡æœ‰è¿”å›çš„å‡½æ•°ä¿ç•™ä¸€ä¸ªæ ˆå¸§</p>
<ul>
<li>Space allocated <strong>when enter procedure</strong><ul>
<li>â€œSet-upâ€ code</li>
<li>Include push by <code>call</code> instruction</li>
</ul>
</li>
<li>Deallocated <strong>when return</strong><ul>
<li>â€œFinishâ€ code</li>
<li>Include pop by <code>ret</code> instruction</li>
</ul>
</li>
</ul>
</li>
<li><p>Contents</p>
<ul>
<li>Return information</li>
<li>Local storageï¼ˆonly if necessaryï¼‰</li>
<li>Temporary spaceï¼ˆonly if necessaryï¼‰</li>
</ul>
</li>
</ul>
<hr>
<p>ä¸ºäº†æ¼”ç¤ºè¿™ä¸€éƒ¨åˆ†ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">incr</span><span class="params">(<span class="type">long</span> *p, <span class="type">long</span> val)</span> &#123;</span><br><span class="line">    <span class="type">long</span> x = *p;</span><br><span class="line">    <span class="type">long</span> y = x + val;</span><br><span class="line">    *p = y;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">call_incr</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> v1 = <span class="number">15213</span>;</span><br><span class="line">    <span class="type">long</span> v2 = incr(&amp;v1, <span class="number">3000</span>);</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">incr:</span><br><span class="line">    movq	(%rdi), %rax</span><br><span class="line">    addq	%rax, %rsi</span><br><span class="line">    movq	%rsi, (%rdi)</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">call_incr:</span><br><span class="line">    subq	$16, %rsp</span><br><span class="line">    movq	$15213, 8(%rsp)</span><br><span class="line">    movl	$3000, %esi</span><br><span class="line">    leaq	8(%rsp), %rdi</span><br><span class="line">    call	incr</span><br><span class="line">    addq	8(%rsp), %rax</span><br><span class="line">    addq	$16, %rsp</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å…¶å®å‡½æ•° <code>incr</code> çš„æ±‡ç¼–ä»£ç å¾ˆç®€å•ï¼Œé‡ç‚¹ä¸åœ¨è¿™ï¼Œè€Œæ˜¯è°ƒç”¨å®ƒçš„å‡½æ•° <code>call_incr</code> ä»¥åŠè¿‡ç¨‹ä¸­çš„å¤„ç†æƒ…å†µã€‚æˆ‘ä»¬å°†ä¸€æ­¥æ­¥åˆ†æå…¶ä¸­çš„æƒ…å†µã€‚</p>
<p>é¦–å…ˆï¼Œå½“ä¸Šå±‚çš„ caller åˆšåˆšè°ƒç”¨ <code>call call_incr</code> æŒ‡ä»¤ã€è¿˜æ²¡æœ‰ä¸º <code>call_incr</code> åˆ†é…æ ˆå¸§æ—¶ï¼Œæ ˆä¸­çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="imgs/procedure_example_1.png" height="150px"></p>
<p>æ­¤æ—¶æ ˆé¡¶ä»ç„¶æ˜¯ä¸Šå±‚ caller çš„ <code>call</code> æŒ‡ä»¤åˆšå‹å…¥çš„ return addressï¼›éšåæœºå™¨è¯»å– <code>%rip</code> ä¸­ä¿å­˜çš„ <code>call_incr</code> çš„åœ°å€å¼€å§‹æ‰§è¡Œ <code>call_incr</code> å‡½æ•°ï¼›</p>
<p>ç°åœ¨è¯·æ³¨æ„ä¸Šé¢çš„ <code>call_incr</code> æ±‡ç¼–ä»£ç ã€‚</p>
<p>ç¬¬ä¸€æ­¥æ˜¯å°† <code>%rsp</code> çš„å€¼å‡å» 16ï¼Œè¿™æ„å‘³ç€ä¸€å£æ°”åœ¨æ ˆä¸­åˆ†é…äº† 16 bytes ç©ºé—´ï¼Œä½œä¸º <code>call_incr</code> çš„æ ˆå¸§ï¼ˆæ­¤æ—¶ <code>%rsp</code> ç†æ‰€å½“ç„¶åœ¨æœ€ä¸Šå±‚ï¼‰ï¼›</p>
<blockquote>
<p>ç¨‹åºä¸€èˆ¬åœ¨æ ˆä¸Šåˆ†é…çš„ç©ºé—´ä¼šæ¯”å®é™…éœ€æ±‚å¤šä¸€ç‚¹ï¼Œè¿™æ˜¯å› ä¸ºæœ‰ä¸€äº›å†…éƒ¨çš„çº¦å®šï¼Œè¦æ±‚ä¿æŒå†…å­˜å¯¹é½ï¼Œä¾‹å¦‚æ±‡ç¼–ä¸­å…¸å‹çš„ <code>.align</code> ä¼ªæŒ‡ä»¤ã€‚è¿™ä¸ªåˆ†é…çš„å€¼æ˜¯ç”±ç¼–è¯‘å™¨è®¡ç®—å¾—å‡ºçš„ã€‚</p>
</blockquote>
<p>ç¬¬äºŒæ­¥å‘ <code>%rsp + 8</code> çš„ memory åœ°å€å†™å…¥å¸¸æ•° 15213ï¼Œè¿™å°±ç›¸å½“äºå‘æ ˆé¡¶çš„ä¸‹é¢ 8 bytes çš„ä½ç½®å†™å…¥è¯¥å¸¸æ•°ï¼›ç°åœ¨æ ˆä¸­çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="imgs/procedure_example_2.png" height="150px"></p>
<p>ä»¥ä¸Šçš„ç¬¬ 1~2 æ­¥å¯¹åº”ç€æºç çš„ <code>long v1 = 15213;</code> è¿™ä¸€æ­¥ã€‚</p>
<p>ç¬¬ä¸‰æ­¥å°† <code>%rsi</code>ï¼ˆ<code>%esi</code>ï¼‰å†™å…¥ 32-bit çš„ 3000 æ•´å‹ï¼ˆè¿˜è®°å¾—ä¹‹å‰è¯´çš„ç‰¹æ€§å—ï¼Ÿé«˜ 32-bit ä¼šè‡ªåŠ¨è¢«ç½® 0ï¼‰ï¼Œå› ä¸º <code>%rsi</code> å°†æ¥ä¼šä½œä¸ºè°ƒç”¨å‡½æ•°çš„ç¬¬äºŒå‚æ•°ï¼›</p>
<p>ç¬¬å››æ­¥è¿˜è®°å¾—å—ï¼Ÿæ‰¾åˆ° <code>%rsp + 8</code> ä½œä¸ºåœ°å€å¯¹åº”çš„ memory å¼•ç”¨ï¼ˆè¿™é‡Œå°±æ˜¯ä¹‹å‰æ ˆä¸­å­˜æ”¾å¸¸æ•° 15213 çš„ä½ç½®ï¼‰<strong>çš„åœ°å€</strong>ï¼ˆä¹Ÿå°±æ˜¯å­˜æ”¾ 15213 çš„åœ°å€ï¼‰èµ‹ç»™ <code>%rdi</code>ï¼Œè¿™å°±ç›¸å½“äº <code>&amp;v1</code> ç»™äº†è°ƒç”¨å‡½æ•°çš„ç¬¬ä¸€å‚æ•°ï¼›</p>
<p>ä¸Šé¢çš„ç¬¬ 3~4 æ­¥å¯¹åº”æºç ä¸­çš„ <code>long v2 = incr(&amp;v1, 3000);</code> çš„ <strong>Passing Data éƒ¨åˆ†</strong>ï¼›</p>
<p>è€Œåœ¨è¿‡ç¨‹ä¸­å¤§å®¶å‘ç°ï¼Œä»£ç æ˜¯ä¸æ˜¯è‡ªèº«å°±ç®¡ç†äº† <code>%rsp</code> çš„ä½ç½®å’Œæ ˆçš„åˆ†é…ï¼Ÿ</p>
<p>åœ¨å®Œæˆå‡½æ•°è°ƒç”¨çš„ Passing Data éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç»§ç»­è¿›è¡Œ <code>long v2 = incr(&amp;v1, 3000);</code> è¿™ä¸€æ­¥çš„ <strong>Passing Control éƒ¨åˆ†</strong>ï¼š</p>
<p>æ¥ä¸‹æ¥æ±‡ç¼–è°ƒç”¨äº† <code>call incr</code>ï¼Œå¹²äº† 3 ä»¶äº‹ï¼š<code>%rsp</code> å‡ 8ï¼Œå­˜å‚¨ return addressï¼ˆè¿™é‡Œçš„æ˜¯ <code>call incr</code> ä¸‹ä¸€è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼‰ï¼Œå¹¶ä¸”å‘ <code>%rip</code> å†™å…¥ <code>incr</code> çš„èµ·å§‹åœ°å€ã€‚</p>
<p>äºæ˜¯ç¨‹åºè¿›å…¥äº† <code>incr</code> å‡½æ•°ï¼Œè¿™æ¯”è¾ƒç®€å•ï¼Œå…¶ä¸­çš„å†…å­˜åˆ†é…ã€å˜é‡è®¾ç½®å°±ä¸è¯´äº†ã€‚ç›´æ¥è·³åˆ° <code>incr</code> å‡½æ•°çš„ <code>ret</code> æŒ‡ä»¤ï¼Œæ­¤æ—¶ç»è¿‡å†…éƒ¨çš„ä»£ç æ§åˆ¶ï¼Œ<code>%rsp</code> åº”è¯¥å›åˆ°äº†ä¹‹å‰ <code>call_incr</code> å‡½æ•°æ ˆå¸§çš„é¡¶éƒ¨ï¼ˆå­˜æ”¾ return address çš„ä½ç½®ï¼‰ã€‚äºæ˜¯ <code>ret</code> ä¹Ÿåšäº† 3 ä»¶äº‹ï¼šå°† return address å–å‡ºæ¥ï¼Œ<code>%rsp</code> åŠ  8ï¼Œå¹¶å‘ <code>%rip</code> å†™å…¥åˆšåˆšå–å¾—çš„åœ°å€â€”â€”ä¹Ÿå°±æ˜¯ <code>call_incr</code> å‡½æ•°ä¸­ <code>call incr</code> æŒ‡ä»¤çš„ä¸‹ä¸€è¡Œã€‚</p>
<p>æ­¤æ—¶ï¼Œæ ˆçš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆ18213 æ˜¯å› ä¸º <code>incr</code> å‡½æ•°ä¿®æ”¹äº† <code>long *p</code> å‚æ•°ï¼Œè¿˜æœ‰ï¼Œåˆ«ææ··äº†ï¼Œè¿™ä¸ªå›¾é‡Œçš„ return address æ˜¯è°ƒç”¨ <code>call_incr</code> çš„ä¸Šå±‚ caller çš„æ ˆå¸§ä¸­çš„ä¸œè¥¿ï¼‰ï¼š</p>
<p><img src="imgs/procedure_example_3.png" height="150px"></p>
<p>ç¨‹åºè¿›å…¥ <code>call_incr</code> æ±‡ç¼–çš„æœ€åä¸¤æ­¥ï¼šæŠŠ <code>%rax</code>ï¼ˆ<code>incr</code> å‡½æ•°è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯ <code>v2</code>ï¼‰åŠ ä¸Š <code>%rsp + 8</code> åœ°å€ä¸Šçš„å†…å®¹ï¼ˆ18213ï¼Œä¹Ÿå°±æ˜¯æ–°çš„ <code>v1</code>ï¼‰ä½œä¸ºå‡½æ•°è¿”å›å€¼ï¼Œ<strong>å¹¶ä¸”æŠŠ <code>%rsp</code> åŠ ä¸Š 16ï¼Œé‡Šæ”¾äº†ä¹‹å‰åˆ†é…ç»™ <code>call_incr</code> å‡½æ•°çš„æ ˆå¸§</strong>ï¼ˆæ‰€ä»¥ä½ çœ‹çœ‹ï¼Œç¼–è¯‘å™¨æ˜¯ä¸æ˜¯çŸ¥é“ä¹‹å‰åˆ†é…äº†å¤šå°‘æ ˆå¸§ç©ºé—´ï¼Ÿæ˜¯ä¸æ˜¯ä¸éœ€è¦ <code>%rbp</code> çš„æŒ‡ç¤ºï¼Ÿï¼‰ã€‚å‡½æ•°åˆ°æ­¤ç»“æŸï¼Œæ ˆä¸­çš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="imgs/procedure_example_4.png" height="100px"></p>
<p>æœ€åçš„ä¸€å¥ <code>ret</code> ä¼šè¯»å–ä¸Šå±‚ caller æ”¾çš„ return addressï¼Œå°† <code>%rsp</code> å‡ 8ï¼Œå¹¶ä¸”å°† <code>%rip</code> å†™å…¥ return addressï¼Œä¸‹ä¸€æ­¥ç¨‹åºå°†å›åˆ°è°ƒç”¨ <code>call_incr</code> çš„ä¸Šå±‚ caller çš„å‡½æ•°ä½“ä¸­ã€‚æ ˆçš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="imgs/procedure_example_5.png" height="100px"></p>
<hr>
<h3 id="5-4-Register-Saving-Conventions"><a href="#5-4-Register-Saving-Conventions" class="headerlink" title="5.4 Register Saving Conventions"></a>5.4 Register Saving Conventions</h3><p>ä¹‹å‰æ— è®ºæ˜¯ 5.3.2 è®²è¿°ä¼ é€’æ•°æ®çš„æ–¹æ³•ï¼Œè¿˜æ˜¯ä»‹ç» ABI çš„çº¦å®šï¼Œåˆæˆ–æ˜¯æ—©åœ¨ 3.3.1 ä¸­ä»‹ç»å¯„å­˜å™¨çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬æ— æ•°æ¬¡æåŠ register çº¦å®šä¿—æˆçš„ç”¨æ³•ã€‚ä¸ºäº†åŠ æ·±å°è±¡ã€è¡¥å……æ›´å¤šå†…å®¹ï¼Œæˆ‘ä»¬è¿™é‡Œå†æ¢³ç†ä¸€éã€‚</p>
<p>ä¼ é€’æ•°æ®çš„æ—¶å€™ï¼Œè°ƒç”¨æ–¹ï¼ˆcallerï¼‰å’Œè¢«è°ƒç”¨æ–¹ï¼ˆcalleeï¼‰å…±åŒä½¿ç”¨è¿™æ‰€æœ‰çš„ 16 ä¸ªå¯„å­˜å™¨ã€‚é‚£ä¹ˆï¼Œæ€ä¹ˆä¿è¯ â€œåœ¨ caller ä¸­ä¿å­˜ç‰¹å®šæ•°æ®çš„æŸäº›å¯„å­˜å™¨ï¼Œåœ¨è°ƒç”¨ callee ä¹‹åï¼Œcallee æ²¡æœ‰æ”¹å˜è¿™äº›å¯„å­˜å™¨ï¼Œå¹¶ä¸”è¿˜èƒ½çœ‹ä½œåŸæ¥çš„å€¼ï¼Œç»§ç»­ä½¿ç”¨â€ å‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯çº¦å®š Callee-Saved å’Œ Caller-Saved Register çš„ä½œç”¨äº†ã€‚å®ƒä»¬çš„å®šä¹‰æ˜¯ï¼š</p>
<ul>
<li><p>Caller-Saved: Caller saves temporaries values in its frame before the call <strong>but can be modified by procedures</strong>;</p>
</li>
<li><p>Callee-Saved: Callee saves temporaries values in its frame before using <strong>and restore them before returning to caller</strong>;</p>
<p><strong>ï¼ˆæ‰€ä»¥å¦‚æœç¨‹åºåœ¨æŸä¸ª procedure ä¸­ä½¿ç”¨äº† <code>%rbp</code> ä½œä¸ºæ™®é€šå¯„å­˜å™¨ï¼Œé‚£ä¹ˆèƒ½å¤Ÿä¿è¯è¿™ä¸ªå‡½æ•° return å‰ <code>%rbp</code> ä¼šæ¢å¤åˆ°ä¸Šä¸€å±‚çš„å€¼ï¼Œä¸ä¼šå½±å“æŠŠ <code>%rbp</code> å½“ä½œ base pointer ä½¿ç”¨çš„å‡½æ•°ï¼‰</strong></p>
</li>
</ul>
<blockquote>
<p>å›å¿†ä¸€ä¸‹å®ƒä»¬åˆ†åˆ«æœ‰å“ªäº›ï¼Ÿ</p>
</blockquote>
<p>æ‰€ä»¥ï¼Œå¦‚æœ caller çœŸçš„æƒ³è¦å¯„å­˜å™¨ä¸­çš„æŸäº›å€¼ä¸ä¼šè¢« callee ä¿®æ”¹ï¼Œåœ¨è°ƒç”¨å‡½æ•°åä»ç„¶èƒ½ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±åº”è¯¥æŠŠå€¼æ”¾åœ¨ caller-saved register å½“ä¸­ã€‚</p>
<p>æ­¤å¤–ï¼ŒABI è¿˜è§„å®šäº†ï¼Œcallee åœ¨è¿”å›å‰ï¼Œéœ€è¦æŠŠ callee-saved register ä¸­çš„å€¼æ¢å¤åˆ°åŸæ¥çš„æ ·å­ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸€ä¸ªä»‹äºç‰¹æ®Šå’Œæ™®é€šä¹‹é—´çš„å¯„å­˜å™¨éœ€è¦å¼ºè°ƒä¸€ä¸‹â€”â€”<code>%rbp</code>ï¼Œç”±äºå®ƒæœ‰æ—¶ä½œä¸ºåˆ†éš”æ ˆå¸§çš„ base pointerï¼Œæ‰€ä»¥å¦‚æœæœ‰ callee æƒ³è¦çœ‹ä½œæ™®é€šå¯„å­˜å™¨æ¥ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆéœ€è¦åœ¨ return å‰æ¢å¤åˆ°åŸæ¥çš„çŠ¶æ€ã€‚</p>
<blockquote>
<p>è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆ caller-saved register ä¸€èˆ¬æ²¡æœ‰è¦æ±‚ restoreï¼Ÿ</p>
<p>å› ä¸ºé¦–å…ˆï¼Œ caller-saved register ä¸­ä¿å­˜å‡½æ•°å‚æ•°çš„å¯„å­˜å™¨å°±æ˜¯ä¸ºäº†ç»™ callee è¯»å–çš„ï¼Œæ‰€ä»¥è°ƒç”¨å‰ caller ä¼šè®¾ç½®è¿™äº›å¯„å­˜å™¨çš„å€¼ï¼Œæ²¡æœ‰å¿…è¦ä¿æŒæ•°æ®ï¼›å¦å¤–å¦‚æœ caller çœŸçš„æƒ³åœ¨è°ƒç”¨ä¹‹åä½¿ç”¨è¿™äº›å€¼ï¼Œé‚£ä¹ˆå¯ä»¥<strong>æŠŠå®ƒçš„å€¼æ”¾åœ¨è‡ªå·±çš„ callee-saved register ä¸­ï¼Œè¿›è€Œï¼Œå› ä¸º caller è‡ªå·±ä¹Ÿä¼šæ˜¯ calleeï¼Œæ‰€ä»¥åœ¨ caller return å‰ä¹Ÿè¦æ¢å¤è¿™ä¸ª callee-saved register</strong>ï¼ˆmain å‡½æ•°é™¤å¤–ï¼‰ï¼›</p>
</blockquote>
<hr>
<p>é‚£ä¹ˆè¿™äº›çº¦å®šåœ¨ä¸€èˆ¬çš„ä»£ç ä¸­æ˜¯å¦‚ä½•ä½“ç°çš„å‘¢ï¼Ÿä¸‹é¢ä»¥ä¹‹å‰çš„ <code>incr</code> å‡½æ•°ä¸ºä¾‹å­ï¼Œæˆ‘ä»¬åŠ å…¥ä¸€ä¸ª <code>call_incr2</code> å‡½æ•°æ¥å±•ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// incr å‡½æ•°è§ 5.3.3 çš„ä¾‹å­</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">call_incr2</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> v1 = <span class="number">15213</span>;</span><br><span class="line">    <span class="type">long</span> v2 = incr(&amp;v1, <span class="number">3000</span>);</span><br><span class="line">    <span class="keyword">return</span> x + v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">call_incr2:</span><br><span class="line">    pushq	%rbx</span><br><span class="line">    subq	$16, %rsp</span><br><span class="line">    movq	%rdi, %rbx</span><br><span class="line">    movq	$15213, 8(%rsp)</span><br><span class="line">    movl	$3000, %esi</span><br><span class="line">    leaq	8(%rsp), %rdi</span><br><span class="line">    call	incr</span><br><span class="line">    addq	%rbx, %rax</span><br><span class="line">    addq	$16, %rsp</span><br><span class="line">    popq	%rbx</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šå±‚ caller è¿›å…¥ <code>call_incr2</code> çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æŠŠ <code>%rbx</code> çš„å€¼æ”¾åˆ° <code>call_incr2</code> çš„æ ˆå¸§ä¸­ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>åŸæ¥ï¼Œè¿™ä¸ª <code>call_incr2</code> å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•° <code>long x</code>ï¼Œä¸€å¼€å§‹å­˜åœ¨ <code>%rdi</code> ä¸­ã€‚ä½†æ˜¯ï¼Œ<code>call_incr2</code> æƒ³è¦è°ƒç”¨ <code>incr</code> å‡½æ•°ï¼Œåè€…è¦æ±‚ä¸¤ä¸ªå‚æ•°ï¼Œæ„å‘³ç€ callee ä¼šç”¨åˆ° <code>%rdi</code> æˆ–æ›´æ”¹ã€‚è€Œåœ¨ <code>call_incr2</code> çš„æœ€åï¼Œ<code>return x + v2;</code> è¯´æ˜äº†ç­‰ä¼šè¿˜è¦ç”¨åˆ°ç°åœ¨ <code>%rdi</code> ä¸­çš„å€¼ xã€‚æ‰€ä»¥ï¼Œ<code>call_incr2</code> ä¸ºäº†èƒ½å¤Ÿç»§ç»­ä½¿ç”¨ x è¿™ä¸ªå€¼ï¼Œéœ€è¦å°† x å­˜åˆ° callee-saved register ä¸­ï¼Œ<strong>å› ä¸ºè°ƒç”¨ <code>incr</code> ä¹‹åï¼Œæ— è®ºå¦‚ä½• <code>incr</code> ä¼šå°† callee-saved register æ¢å¤åˆ°åŸæ¥çš„æ•°æ®çš„ï¼</strong> è€Œåœ¨æ­¤ä¹‹å‰ï¼Œä¸ºäº†èƒ½å¤Ÿå°†è¿™é‡Œä½¿ç”¨çš„ callee-saved register åœ¨è¿”å›å‰æ¢å¤åˆ°ä¸Šä¸€å±‚è°ƒç”¨å‰çš„çŠ¶æ€ï¼Œéœ€è¦å°†åŸæ¥çš„æ•°æ®å­˜åœ¨æ ˆä¸­ã€‚</p>
<blockquote>
<p>æ‰€ä»¥ç°åœ¨çš„æƒ…å†µæ˜¯ï¼Œ</p>
<p>â‘  caller ä¸ºäº†ä¿ç•™ caller-saved registerï¼ˆ<code>%rdi</code>ï¼‰çš„æ•°æ®ï¼ˆå› ä¸ºè¦è®¾ç½®æ–°çš„å€¼ç»™ä¸‹ä¸€å±‚ callee æ¥ passing dataï¼‰æ‰€ä»¥è¦æŠŠ <code>%rdi</code> æ•°æ®æ”¾åˆ° callee-saved register ä¸­ï¼Œè¿™æ ·è°ƒç”¨åä¸å˜ ï¼›</p>
<p>â‘¡ æƒ³è¦æ”¹å˜ callee-saved registerï¼Œå°±éœ€è¦ä¿å­˜ä¹‹å‰çš„å€¼ï¼Œä»¥ä¿è¯ä¸Šä¸€å±‚è°ƒç”¨æ–¹åœ¨å…¶ä¸­çš„å€¼ä¸å˜ï¼Œè€Œè¿™ä¸ª callee-saved register åŸå…ˆçš„å€¼å°±æ”¾åˆ°äº†å½“å‰ caller çš„æ ˆå¸§ä¸­ã€‚</p>
<p><strong>è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆå½“å‰å‡½æ•°ä¸æŠŠæƒ³è¦ä¿å­˜çš„æ•°æ®ç›´æ¥ä¿å­˜åœ¨æ ˆä¸­ï¼Œè€Œæ˜¯ä¿å­˜åœ¨ callee-saved register ä¸­ï¼Œå®Œäº‹è¿˜è¦ä¸ºè¿™ä¸ª callee-saved register åŸå…ˆçš„å€¼ä¿å­˜åœ¨è‡ªå·±çš„æ ˆå¸§ä¸­ï¼Ÿ</strong></p>
<p>è¿™æ˜¯å› ä¸ºï¼Œç›´æ¥ä¿å­˜åœ¨æ ˆé‡Œä¸æ–¹ä¾¿ã€‚å¦‚æœæœ‰å¤šä¸ªéœ€è¦ä¿å­˜çš„æ•°æ®ï¼Œè€Œä¸”éƒ½æ”¾åœ¨æ ˆé‡Œï¼Œé‚£ä¹ˆè¯»å–æ–¹å¼ã€è¯»å–æ•ˆç‡ï¼ˆå¯èƒ½ä¼šè¯»å¾ˆå¤šæ¬¡ï¼‰éƒ½ä¸ä½³ï¼›è€Œä¸”å°±æ²¡æœ‰å¿…è¦è®¾ç½® callee-saved register äº†ã€‚</p>
<p>ç›¸åï¼Œå¦‚æœä¿å­˜åœ¨ callee-saved register ä¸­ï¼Œé‚£ä¹ˆ caller è¢«è°ƒç”¨åä¸€å¼€å§‹ç»Ÿä¸€ä¿å­˜ä¸Šä¸€å±‚çš„ callee-saved register çš„å€¼ï¼Œcaller è¿”å›å‰ç»Ÿä¸€æ¢å¤ä¸Šä¸€å±‚çš„ callee-saved register çš„å€¼ï¼Œä¸­é—´ caller è¿˜èƒ½è‡ªç”±ä½¿ç”¨è¿™äº› callee-saved registerï¼Œå¤šæ¬¡ä½¿ç”¨é€Ÿåº¦å¿«ï¼Œå¹¶ä¸”ä¸ç”¨æ‹…å¿ƒè°ƒç”¨ä¸‹ä¸€å±‚å‡½æ•°ä¼šå½±å“å…¶ä¸­çš„å€¼ï¼Œå²‚ä¸ç¾å“‰ï¼</p>
</blockquote>
<p>å› æ­¤ï¼Œåœ¨ <code>call_incr2</code> è°ƒç”¨ <code>incr</code> ä¹‹å‰ï¼Œæ ˆçš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="imgs/procedure_example2_1.png" height="150px"></p>
<hr>
<p>æ€»ç»“ï¼š<strong>ä»€ä¹ˆæ—¶å€™æ ˆä¸Šä¼šå‡ºç° Saved-Register æ•°æ®ï¼Ÿç­”ï¼šå½“ caller éœ€è¦ä¿®æ”¹ callee-saved register æ¥ä¿å­˜æŸäº›å€¼çš„æ—¶å€™ï¼Œcaller ä¼šæŠŠæ•°æ®ä¿å­˜åˆ°å®ƒçš„æ ˆå¸§ä¸Šã€‚</strong>ä»…æ­¤ä¸€ç§æƒ…å†µã€‚</p>
<h3 id="5-5-Illustration-of-Recursion"><a href="#5-5-Illustration-of-Recursion" class="headerlink" title="5.5 Illustration of Recursion"></a>5.5 Illustration of Recursion</h3><blockquote>
<p>æœ¬èŠ‚å°†è¯¦ç»†é˜é‡Š â€œé€’å½’â€ è¿™ä¸ªæŠ€æœ¯åœ¨æ±‡ç¼–å±‚é¢çš„æ ·è²Œã€‚ä½ ä¼šå‘ç°ï¼Œå› ä¸ºæœ‰äº†ä¹‹å‰æ‰€æœ‰çš„ mechanisms çš„æ”¯æŒï¼ŒC ç¼–è¯‘å™¨ç¼–è¯‘é€’å½’å‡½æ•°ä¼šå’Œæ™®é€šå‡½æ•°ä¸€æ ·ç®€å•ã€‚</p>
</blockquote>
<p>ä»¥ä¸€ä¸ªä¾‹å­å¼€å§‹ï¼Œè¿™ä¸ª <code>pcount_r</code> å‡½æ•°å°±æ˜¯ä¹‹å‰ â€œè®¡ç®—äºŒè¿›åˆ¶æ•°ä¸­æœ‰å‡ ä¸ª 1â€ï¼ˆä¾‹å­åœ¨ 4.3ï¼‰çš„é€’å½’ç‰ˆæœ¬ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Recursive popcount */</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">pcount_r</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> (x &amp; <span class="number">1</span>) + pcount_r(x &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰ä¸€ä¸ª trickï¼Œå°±æ˜¯å‚æ•°æ˜¯ unsigned long ç±»å‹ï¼Œè¿™æ˜¯ä¸ºäº†è®© <code>x &gt;&gt; 1</code> è¿ç®—æ˜¯<strong>é€»è¾‘å³ç§»</strong>ï¼Œåƒä¸‡ä¸èƒ½ç”¨ signed çš„ç±»å‹ï¼Œå› ä¸º <code>x &gt;&gt; 1</code> æ˜¯ç®—æ•°å³ç§»ï¼Œæ‰€ä»¥å¯¹äºè´Ÿæ•°è€Œè¨€æ°¸è¿œä¸ä¼šåœä¸‹ï¼›</p>
<p>ä¸‹é¢æ˜¯å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pcount_r:</span><br><span class="line">    movl	$0, %eax</span><br><span class="line">    testq	%rdi, %rdi</span><br><span class="line">    je		.L6</span><br><span class="line">    pushq	%rbx</span><br><span class="line">    movq	%rdi, %rbx</span><br><span class="line">    andl	$1, %ebx</span><br><span class="line">    shrq	%rdi</span><br><span class="line">    call	pcount_r</span><br><span class="line">    addq	%rbx, %rax</span><br><span class="line">    popq	%rbx</span><br><span class="line">.L6:</span><br><span class="line">    rep; ret</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°é€’å½’ç‰ˆæœ¬çš„æºç ç¼–è¯‘å‡ºçš„æ±‡ç¼–ä»£ç å¯èƒ½ç¨å¾®æ¯”ä¹‹å‰è¿­ä»£å¾ªç¯ç‰ˆæœ¬ï¼ˆloopï¼‰çš„æ±‡ç¼–ä»£ç æ›´é•¿ï¼Œè¿™æ˜¯å› ä¸ºé€’å½’ç‰ˆæœ¬éœ€è¦é¢å¤–ç®¡ç†æ ˆçš„æƒ…å†µã€‚</p>
<p>å­¦å®Œäº†å‰é¢å‡ ç« èŠ‚ï¼Œä½ ä¼šå‘ç°è¿™äº›ä»£ç å°±æ¯”è¾ƒå¥½æ‡‚äº†ï¼š</p>
<p>ç¬¬ä¸€æ­¥å°† <code>%rax</code>ï¼ˆ<code>%eax</code>ï¼‰ç½®é›¶ï¼Œå› ä¸ºç­‰ä¼šå¯èƒ½è¦ return 0ï¼›ç„¶åç¬¬äºŒæ­¥æŒ‰ç…§ <code>x == 0</code> çš„æ˜¯çœŸæ˜¯å‡çš„ç­”æ¡ˆæ¥è®¾ç½® condition codesï¼Œäº¤ç”±ç¬¬ä¸‰æ­¥åˆ¤æ–­å¹¶è·³è½¬ã€‚è¿™æ˜¯ä¹‹å‰çš„ General Conditional Expression çš„ç¿»è¯‘æ–¹æ³•ï¼›</p>
<p>æ¥ä¸‹æ¥ï¼Œå°† <code>%rbx</code> è¿™ä¸ª callee-saved register åŸæ¥çš„å€¼å¤‡ä»½åˆ°å½“å‰æ ˆå¸§ä¸­ï¼Œæ˜¯å› ä¸ºä¹‹åè¦ç”¨è¿™ä¸ªå¯„å­˜å™¨ä¿å­˜å‚æ•° xï¼›æœä¸å…¶ç„¶ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æŠŠ <code>%rdi</code>ï¼ˆxï¼‰çš„å€¼å¤åˆ¶åˆ° <code>%rbx</code> ä¸­ã€‚</p>
<p>æ¥ä¸‹æ¥ç”¨åˆ° x çš„åœ°æ–¹ï¼Œé™¤äº†ä¼ ç»™ä¸‹ä¸€å±‚ callee çš„ç¬¬ä¸€å‚æ•°ï¼Œå°±åªæœ‰ <code>x &amp; 1</code> äº†ï¼Œæ‰€ä»¥ç›´æ¥åœ¨ <code>%rbx</code> ä¸Šä¸ 1 æŒ‰ä½ä¸”ã€‚ä¸‹ä¸€æ­¥ä¹Ÿç›´æ¥åœ¨ <code>%rdi</code> ä¸Šé€»è¾‘å³ç§» 1 ä¸ªå•ä½ï¼Œè¿™å°±æ˜¯ä¼ ç»™ä¸‹ä¸€å±‚ callee çš„ç¬¬ä¸€å‚æ•°ï¼ˆ<code>x &gt;&gt; 1</code>ï¼‰;</p>
<p>å‡†å¤‡å¥½ passing data åï¼Œè¿›è¡Œ passing controlï¼Œè°ƒç”¨ <code>call pcount_r</code> è¿›è¡Œè·³è½¬é€’å½’ã€‚</p>
<p>å¦‚æœé€’å½’ç»“æŸï¼Œé‚£ä¹ˆç´§æ¥ç€å°±æ˜¯æŠŠ <code>(x &amp; 1)</code>ï¼ˆå³ <code>%rbx</code> ä¸­çš„å€¼ï¼‰åŠ åˆ° callee çš„ç»“æœï¼ˆ<code>%rax</code>ï¼‰ä¸­ï¼Œå¾—åˆ°æœ¬å‡½æ•°çš„ç»“æœã€‚æœ€ååˆ«å¿˜äº†åœ¨è¿”å›å‰ä»å½“å‰æ ˆå¸§ä¸­æ¢å¤ callee-saved register <code>%rbx</code>ï¼Œå‡½æ•°ç»“æŸã€‚</p>
<p>ä¸¾å®Œè¿™ä¸ªä¾‹å­ä½ ä¼šå‘ç°ï¼Œè¿™å°±æ˜¯å‰å‡ ç« æ‰€æåˆ°æ‰€æœ‰æŠ€å·§çš„ç»¼åˆï¼Œå®ƒä»¬ä½¿ç”¨äº†åŒä¸€ä¸ªçº¦å®šâ€”â€”å‚æ•°æ€ä¹ˆä¼ ã€å¯ä»¥ç”¨å“ªäº›å¯„å­˜å™¨ã€å¯„å­˜å™¨æ€ä¹ˆç”¨ï¼ˆè¿˜æœ‰æ˜¯å¦è¦æ¢å¤ï¼‰ã€å¦‚ä½•å‚ä¸è®¡ç®—ç­‰ç­‰ã€‚è¿™ä¸ªçº¦å®šé˜²æ­¢äº†ä¸åŒå‡½æ•°åœ¨è°ƒç”¨æ—¶ç›¸äº’æ‘§æ¯å¯„å­˜å™¨ä¸­é‡è¦çš„å€¼çš„å¼‚å¸¸æƒ…å†µã€‚æ€»ä¹‹æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•ä½¿ç”¨å¯„å­˜å™¨ï¼Œå¯ä»¥è®©ç”Ÿæ´»æ›´ç¾å¥½ï¼</p>
<blockquote>
<p>è¡¥å……ä¸€å¥ï¼Œæœ‰äº›å‡½æ•°ä¸ä¾èµ–æ ˆçš„ç»“æ„æ¥å®Œæˆä¸Šè¿°çš„æœºåˆ¶ï¼Œå®ƒä»¬ä¼šé‡‡ç”¨å †æˆ–è€…å…¶ä»–æ•°æ®ç»“æ„æ¥å®Œæˆï¼ˆä¾‹å¦‚ SMLï¼‰ã€‚</p>
</blockquote>
<p>è¯´äº†è¿™ä¹ˆå¤šï¼Œåªæœ‰è‡ªå·±ä¸Šæ‰‹å®è·µã€è‡ªå·±äº²è‡ªç¼–è¯‘ã€è°ƒè¯•è¿™äº›ä»£ç ï¼Œæ‰èƒ½ä½“ä¼šåˆ°å„ä¸ªéƒ¨åˆ†ã€tricksã€mechanisms ç»„åˆèµ·æ¥å‘æŒ¥çš„ä½œç”¨ã€‚</p>
<h3 id="5-5-Summary-for-Chapter-5"><a href="#5-5-Summary-for-Chapter-5" class="headerlink" title="5.5 Summary for Chapter 5"></a>5.5 Summary for Chapter 5</h3><p>æœ¬ç« çš„å†…å®¹ä¹Ÿæ˜¯ç›¸å½“ä¹‹å¤šã€‚ä¸ºäº†è¿›ä¸€æ­¥åŠ æ·±å¯¹äºæ±‡ç¼– procedure çš„è®¤è¯†ï¼Œæˆ‘ä»¬ç°åœ¨æ€»ç»“ä¸€ä¸‹æœ¬ç« æ¥è§¦åˆ°çš„å†…å®¹ã€‚</p>
<p>åœ¨æœ¬ç« å¼€å¤´ï¼Œæˆ‘ä»¬äº†è§£ä¸€ç§è§„èŒƒï¼ˆæ¥å£ï¼‰è¢«ç§°ä¸º ABIï¼Œä¸»è¦å›´ç»• Linux ABI å±•å¼€ä»‹ç»ã€‚ABI è§„å®šäº†æ‰€æœ‰äºŒè¿›åˆ¶ç¨‹åºã€æ“ä½œç³»ç»Ÿå„ä¸ªç»„ä»¶ã€ç¼–è¯‘å™¨å¯¹äºç®¡ç†æœºå™¨ä¸Šçš„èµ„æºçš„ä½¿ç”¨è§„åˆ™ï¼Œä¾‹å¦‚å¯„å­˜å™¨ä½¿ç”¨çš„åœºåˆå’Œç®¡ç†æ–¹æ³•ç­‰ç­‰ï¼Œè¿™åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­ä¹Ÿæˆ–å¤šæˆ–å°‘çš„æåˆ°è¿‡ã€‚</p>
<p>æƒ³è¦äº†è§£ç¨‹åºè¿è¡Œçš„æ€»ä½“ procedureï¼Œå°±ä¸å¾—ä¸å›ç­” 3 ä¸ªé—®é¢˜ï¼š<strong>ç¨‹åºæ˜¯å¦‚ä½•åˆ‡æ¢è¿è¡Œæ§åˆ¶æƒçš„</strong>ï¼Œ<strong>ç¨‹åºå¦‚ä½•ä¼ é€’æ•°æ®çš„</strong>ï¼Œè¿˜æœ‰<strong>ç¨‹åºå¦‚ä½•åœ¨è¿è¡Œä¸­ç®¡ç† Memory å†…å­˜çš„</strong>ï¼›</p>
<p>ä¸ºäº†ææ¸…ä»¥ä¸Šçš„é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆäº†è§£äº† x86 æ¶æ„ä¸‹çš„ç³»ç»Ÿæ ˆçš„ç®€å•ç»“æ„ã€‚å› ä¸º C/C++ æ˜¯ä¾èµ–äºæ ˆæ¥ç®¡ç†ç¨‹åºä¸Šä¸‹æ–‡çš„è¯­è¨€ï¼Œå¹¶ä¸”æ ¹æ®æ ˆ LIFO çš„åŸåˆ™ï¼Œå¯ä»¥è¢«ç”¨äºï¼š<strong>ä¼ é€’æ½œåœ¨ä¿¡æ¯ã€æ§åˆ¶ä¿¡æ¯ï¼Œåˆ†é… local æ•°æ®</strong>ã€‚æ­£å› å¦‚æ­¤ï¼Œæ ˆå¯ä»¥èƒœä»»<strong>ç®¡ç†è¿‡ç¨‹ä¸­è°ƒç”¨å’Œè¿”å›çŠ¶æ€</strong>çš„ä»»åŠ¡ï¼Œä¹Ÿèƒ½éš”ç¦»å„ä¸ª procedure ç¤ºä¾‹ä¹‹é—´çš„æ•°æ®ï¼Œä¸ºé€’å½’æä¾›äº†åšå®é«˜æ•ˆçš„ç»“æ„åŸºç¡€ã€‚</p>
<p>x86 çš„æ ˆéœ€è¦æ³¨æ„çš„ç‚¹æœ‰ 3 ä¸ªï¼š</p>
<ul>
<li>æ ˆå°±æ˜¯åœ¨<strong>å†…å­˜ä¸­çš„</strong>ä¸€æ®µè¿ç»­çš„æ•°æ®ç»“æ„ï¼Œæ ˆé¡¶ä½äº low numbered addressï¼Œæ ˆåº•ä½äº high numbered addressï¼ˆå¤´è„‘é‡Œæœ‰å¼ å›¾ï¼‰ï¼›</li>
<li>æ ˆé¡¶æŒ‡é’ˆç”± <strong><code>%rsp</code></strong> ä¿å­˜ï¼Œä¸€èˆ¬ä¸èƒ½æ‰‹åŠ¨ä¿®æ”¹ï¼ŒæŒ‡å‘æœ€ä¸Šå±‚è¢«ä½¿ç”¨çš„ç©ºé—´ï¼Œè¿™æ„å‘³ç€<strong>è¦å…ˆå‡å°æŒ‡é’ˆï¼Œå†æ”¾å…¥æ•°æ®</strong>ï¼ˆæˆ–å…ˆå–å‡ºæ•°æ®ï¼Œå†å¢å¤§æŒ‡é’ˆï¼‰ï¼›</li>
<li>æƒ³è¦ç®¡ç†æ ˆä¸­çš„æ•°æ®ï¼Œä¾é  <code>pushq</code> å’Œ <code>popq</code> è¿™ä¸¤æ¡æŒ‡ä»¤ï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤çš„å‚æ•°è¦æ±‚ä¹Ÿæœ‰é‡å¤§åŒºåˆ«ï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆï¼›</li>
</ul>
<p>éšåè€ƒè™‘<strong>ç¨‹åºæ§åˆ¶æƒåˆ‡æ¢çš„é—®é¢˜</strong>ï¼ˆPassing Controlï¼‰ï¼Œå…·ä½“è¡¨ç°å°±æ˜¯<strong>è°ƒç”¨æ—¶ caller å¦‚ä½•è·³è½¬åˆ° calleeã€å¦‚ä½•ä» callee è¿”å›åˆ° caller</strong>ã€‚é€šè¿‡åˆ†æï¼Œpassing control ç”± 3 ä¸ªæ–¹é¢å®ç°ï¼š</p>
<ul>
<li>ç³»ç»Ÿ<strong>æ ˆ</strong>æä¾›æ•°æ®ç»“æ„å­˜å‚¨å±‚é¢çš„æ”¯æŒï¼›</li>
<li>æŒ‡ä»¤ <code>call &lt;LABLE&gt;</code> é€šè¿‡ï¼š<strong>å‘æ ˆä¸­æ·»åŠ  return address</strong>ã€<strong>æ”¹å˜ <code>%rip</code> çš„å€¼æ¥è·³è½¬è‡³ callee</strong> è¿™ä¸¤å¤§å·¥ä½œæ¥å®Œæˆ caller è‡³ callee çš„è·³è½¬ï¼›</li>
<li>æŒ‡ä»¤ <code>ret</code> é€šè¿‡ï¼š<strong>ä»æ ˆä¸­å–å‡º return address</strong>ã€<strong>æ”¹å˜ <code>%rip</code> çš„å€¼æ¥è·³å› caller</strong> è¿™ä¸¤å¤§å·¥ä½œå®Œæˆ callee é‡æ–°è¿”å› caller çš„æ§åˆ¶æµç¨‹ã€‚</li>
</ul>
<p>ç¬¬äºŒä¸ªç‚¹å°±æ˜¯<strong>ç¨‹åºæ•°æ®ä¼ è¾“é—®é¢˜</strong>ï¼ˆPassing Dataï¼‰ï¼Œåœ¨å•çº¿ç¨‹ç¨‹åºä¸­å…·ä½“è¡¨ç°ä¸º <strong>caller å¦‚ä½•å‘ callee ä¼ é€’å‚æ•°</strong>ã€<strong>callee å¦‚ä½•ç»™ caller è¿”å›å€¼</strong>ã€‚åœ¨å‰å‡ ç« çš„é“ºå«ä¸‹ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®°ä½äº†å„ä¸ªæ•´å‹å¯„å­˜å™¨åœ¨ procedure åŠå…¶åˆ‡æ¢æ—¶çš„çº¦å®šè¡Œä¸ºï¼Œä¾‹å¦‚ Caller-Saved / Callee-Savedã€ä¼ å…¥çš„å‡½æ•°å‚æ•°ç”±å“ªä¸ªå¯„å­˜å™¨  / ç»™å‡ºã€å‡½æ•°çš„è¿”å›å€¼ç”±å“ªä¸ªå¯„å­˜å™¨ä¼ è¾“ã€‚</p>
<p>å‰ä¸¤ä¸ªé—®é¢˜ç›¸å¯¹å¥½è§£å†³ï¼Œä¸è¿‡å¯¹äº <strong>ç¨‹åºå¦‚ä½•åœ¨è¿è¡Œä¸­ç®¡ç† Memory å†…å­˜</strong> è¿™ä¸€éƒ¨åˆ†è€Œè¨€ï¼Œå…·ä½“è¡¨ç°åœ¨è¿›å…¥ procedure å‰å¦‚ä½•ä¸ºå…¶åˆ†é…ç©ºé—´ã€ç»“æŸ procedure å‰å¦‚ä½•é‡Šæ”¾ç©ºé—´ï¼Œéœ€è¦è¾ƒä¸ºè¯¦ç»†åœ°äº†è§£ x86 æ ˆå’Œ<strong>æ ˆå¸§</strong>çš„åŸºæœ¬ç»“æ„ã€‚å¯¹äº x86-64 Linux è€Œè¨€ï¼Œä¸€ä¸ªç¨‹åºæ ˆåœ¨<strong>å½“å‰å‡½æ•°å®ä¾‹</strong>ä¸­çš„æ ˆå¸§ä»æ ˆåº•åˆ°æ ˆé¡¶åº”è¯¥åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>old <code>%rbp</code>ï¼ˆä¸Šä¸€å±‚ base pointerï¼Œå¦‚æœæœ¬å±‚ä¹Ÿä½¿ç”¨ <code>%rbp</code> åš base pointer çš„è¯ï¼Œå°±æŒ‡å‘æ­¤ä½ç½®ï¼‰ï¼›</li>
<li>ä¸Šå±‚ callee-saved register å¤‡ä»½å€¼ï¼ˆSaved-Registerï¼‰ã€local variablesï¼ˆå‡½æ•°å±€éƒ¨å˜é‡ï¼‰ï¼›</li>
<li>æœ¬å‡½æ•°ä½œä¸º callee æ—¶ä¼ å…¥çš„è¶…è¿‡ 6 ä¸ªçš„å‚æ•°å­˜æ”¾ä½ç½®ï¼ˆä¾æ¬¡ï¼‰ï¼›</li>
<li>return addressï¼ˆå¦‚æœæœ¬å±‚å‡½æ•°æ˜¯ callerï¼Œå¹¶ä¸”æ­£å¥½è¿è¡Œåˆ° <code>call</code> æŒ‡ä»¤ç»“æŸæ—¶ï¼‰ï¼›</li>
</ul>
<p>æ¯ä¸ªå‡½æ•°ç»“æŸåèƒ½å¦å®Œå…¨é‡Šæ”¾æ ˆå¸§å¹¶å›åˆ°åŸä½ã€è°ƒç”¨å…¶ä»–å‡½æ•°æ—¶èƒ½å¦å‡†ç¡®åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™<strong>ä¾èµ–ä»£ç çš„è‡ªèº«ç®¡ç†</strong>ã€‚</p>
<p>ææ¸…äº†æ€»ä½“ procedure çš„æ ·è²Œï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¨è®ºäº†å„ä¸ªå¯„å­˜å™¨çš„ç»†èŠ‚å±‚é¢çš„ç®¡ç†çº¦å®šã€‚åŒ…æ‹¬ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>Caller-Saved Register å’Œ Callee-Saved Register å„è‡ªæœ‰å“ªäº›ç§ç±»å’Œå®šä¹‰ï¼›</li>
<li>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Caller/Callee-Saved Registerï¼Œåœ¨ä½¿ç”¨å‰ååº”è¯¥åšå“ªäº›å¤„ç†å·¥ä½œï¼›</li>
<li>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Caller/Callee-Saved Registerï¼Œæ ˆä¸­çš„ â€œSave-Registerâ€ æ•°æ®æ˜¯æ€ä¹ˆå›äº‹ã€‚</li>
</ul>
<p>åˆ°äº†æœ¬ç« ç»“æŸï¼Œæˆ‘ä»¬å·²ç»èƒ½ä»å¤§è‡´è½®å»“ä¸Šè®¤è¯†ä¸€ä¸ªç¨‹åºè¿è¡Œçš„ procedureï¼Œä»…é™äºæ•´æ•°ã€é•¿æ•´æ•°ã€æŒ‡é’ˆçš„æ•°æ®ä¼ é€’çš„å·¥ä½œã€‚</p>
<p>æ›´å¤šçš„ç»†èŠ‚ï¼Œä¾‹å¦‚ä¹‹å‰æåˆ°çš„<strong>æµ®ç‚¹æ•°å¦‚ä½•ä¼ é€’ã€ä¿å­˜ï¼ˆæµ®ç‚¹å¯„å­˜å™¨çš„è¡Œä¸ºï¼‰</strong>ï¼Œ<strong>èšåˆæ•°æ®ç»“æ„åœ¨æ±‡ç¼–å±‚é¢å¦‚ä½•å®ç°</strong>ï¼Œç­‰é—®é¢˜ï¼Œä¼šåœ¨ä¸‹ä¸€ç« è¿›è¡Œä»‹ç»ã€‚</p>
<h2 id="Chapter-6-Machine-Level-Programming-â…£-Data"><a href="#Chapter-6-Machine-Level-Programming-â…£-Data" class="headerlink" title="Chapter 6. Machine Level Programming â…£ - Data"></a>Chapter 6. Machine Level Programming â…£ - Data</h2><p>ä¹‹å‰æˆ‘ä»¬æ‰€è§åˆ°çš„ç¨‹åºéƒ½æ˜¯æ“çºµæ­£æ•° / é•¿æ•´æ•° / æŒ‡é’ˆï¼Œå®ƒä»¬éƒ½æ˜¯<strong>æ ‡é‡æ•´å‹æ•°æ®</strong>ã€‚æœ¬ç« å°†è®¨è®ºæµ®ç‚¹å¯„å­˜å™¨çš„æƒ…å½¢å’Œèšåˆæ•°æ®ç»“æ„åœ¨æ±‡ç¼–ä»£ç ä¸­çš„å®ç°ã€‚</p>
<h3 id="6-1-Arrays-in-Assembly"><a href="#6-1-Arrays-in-Assembly" class="headerlink" title="6.1 Arrays in Assembly"></a>6.1 Arrays in Assembly</h3><h4 id="6-1-1-Array-Access-Normal-Array"><a href="#6-1-1-Array-Access-Normal-Array" class="headerlink" title="6.1.1 Array Access: Normal Array"></a>6.1.1 Array Access: Normal Array</h4><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œæ•°ç»„åœ¨ C/C++ ä¸­å£°æ˜çš„è¯­æ³•ä¸º <code>T A[L];</code>ï¼Œè¡¨ç¤º Array of data type <code>T</code> and length <code>L</code>ï¼›</p>
<p>è¿™è¯´æ˜äº† 2 ä»¶äº‹ï¼š</p>
<ol>
<li>æ•°ç»„åº”è¯¥åœ¨å†…å­˜ä¸­åˆ†é…çš„æ–¹å¼ï¼š<strong>Contiguously allocated region of <code>L * sizeof(T)</code> bytes in memory</strong>;</li>
<li>identifier <code>A</code> å¯ä»¥è¢«ç”¨ä½œ<strong>æŒ‡å‘æ•°ç»„å¼€å¤´ä½ç½®çš„æŒ‡é’ˆï¼ˆç±»å‹ <code>T*</code>ï¼‰</strong>ï¼›</li>
</ol>
<blockquote>
<p>ä¸‹é¢çš„æ–¹æ³•éƒ½æ˜¯åˆç†çš„ï¼Œè¯·è¯•ç€åˆ†æè¡¨è¾¾å¼çš„å«ä¹‰ï¼ˆ<code>val</code> çš„ç±»å‹æ˜¯ <code>int*</code>ï¼‰ï¼š</p>
<p><code>val[4]</code>ã€<code>val</code>ã€<code>val + 1</code>ã€<code>&amp;val[2]</code>ã€<code>*(val + 1)</code>ã€<code>*val + 1</code>;</p>
<p>æç¤ºï¼šå¯¹äºæŒ‡é’ˆç±»å‹ <code>T*</code> çš„å¢ã€å‡è¿ç®—è€Œè¨€ï¼Œå•ä½ 1 ä¼šæ˜¯ <strong><code>sizeof(T)</code></strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹è¿™ä¸ªæŒ‡é’ˆå¢åŠ  1ï¼Œé‚£ä¹ˆæŒ‡é’ˆçš„å€¼å®é™…å¢åŠ  <code>sizeof(T)</code>ï¼›</p>
<p><strong>è¡¥å…… C/C++ åŸºç¡€-1</strong>ï¼šæŒ‡é’ˆå’Œæ•°ç»„å˜é‡çš„åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼Œæ”¹å˜æ•°ç»„å˜é‡ <code>val</code> ä¸æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸º <code>val</code> æ˜¯æŒ‡é’ˆå¸¸é‡ï¼›</p>
</blockquote>
<hr>
<p>ç°åœ¨çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ZLEN 5</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> zip_dig[ZLEN];</span><br><span class="line"></span><br><span class="line">zip_dig cmu = &#123; <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span> &#125;;</span><br><span class="line">zip_dig mit = &#123; <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">9</span> &#125;;</span><br><span class="line">zip_dig ucb = &#123; <span class="number">9</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">0</span> &#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸€äº›ç¼–ç¨‹å»ºè®®ï¼šâ‘  ä¸è¦å°†å¸¸æ•°éšä¾¿å†™æ­»åœ¨ç¨‹åºçš„å„ä¸ªè§’è½ï¼Œè¿™è¢«ç§°ä¸º magic numberï¼Œä¸ä½†ä¸åˆ©äºé˜…è¯»ï¼Œä¹Ÿä¸åˆ©äºç»´æŠ¤ï¼›â‘¡ å¯¹äº C/C++ ä¸­å¤æ‚çš„æ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œå»ºè®®ä½¿ç”¨ <code>typedef</code> å…³é”®å­—ï¼Œè¿™æ ·å¯ä»¥æå‡å¯è¯»æ€§ï¼›</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">get_digit</span><span class="params">(zip_dig z, <span class="type">int</span> digit)</span> &#123; <span class="keyword">return</span> z[digit]; &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªå‡½æ•°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get_digit:</span><br><span class="line">    movl	(%rdi, %rsi, 4), %eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>ç”±äºæ•°ç»„æ ‡è¯†ç¬¦ä¹Ÿæ˜¯æŒ‡é’ˆï¼Œå› æ­¤ä¼ å…¥çš„æ–¹å¼å’Œä¹‹å‰çš„ç›¸åŒã€‚ä¸Šé¢çš„æŒ‡ä»¤å«ä¹‰æ˜¯æ‰¾åˆ°åœ°å€ä¸º <code>%rdi + 4 * %rsi</code> çš„ memory å¼•ç”¨ï¼Œå¹¶å°†è¿™é‡Œçš„å€¼èµ‹ç»™ <code>%rax</code> çš„ low-order 32-bitï¼ˆ<code>%eax</code>ï¼‰;</p>
<p>4  å°±æ˜¯ç¼–è¯‘å™¨è‡ªå·±åŠ ä¸Šçš„å¯¹äº <code>int</code> ç±»å‹å¤§å°çš„ç¼©æ”¾å› å­ã€‚</p>
<p>å†æ¥ä¸€æ®µï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">zincr</span><span class="params">(zig_dig z)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ZLEN; i++)</span><br><span class="line">        z[i]++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zincr:</span><br><span class="line">    movl	$0, %eax</span><br><span class="line">    jmp		.L3</span><br><span class="line">.L4</span><br><span class="line">    addl	$1, (%rdi, %rax, 4)</span><br><span class="line">    addq	$1, %rax</span><br><span class="line">.L3</span><br><span class="line">    cmpq	$4, %rax</span><br><span class="line">    jbe		.L4</span><br><span class="line">    rep; ret</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ±‡ç¼–ä»£ç å¯¹ for å¾ªç¯çš„å¤„ç†æ˜¯è½¬åŒ–ä¸º while å¾ªç¯å¹¶é‡‡ç”¨ â€œjump to middleâ€ translationï¼›</p>
<p>é¦–å…ˆåˆå§‹åŒ–éƒ¨åˆ†å°† <code>%rax</code> ç½®é›¶ä½œä¸ºå­˜æ”¾ i çš„å¯„å­˜å™¨ï¼Œæ¥ç€è·³è‡³ <code>.L3</code> åˆ¤æ–­éƒ¨åˆ†ï¼›</p>
<p><code>.L3</code> åˆ¤æ–­éƒ¨åˆ†å°† <code>%rax</code>ï¼ˆiï¼‰å’Œ 4 æ¯”è¾ƒï¼Œåªæœ‰ unsigned <code>i â‰¤ 4</code>ï¼ˆ<code>CF | ZF</code>ï¼‰æ—¶æ‰è¿›å…¥ <code>.L4</code> å¾ªç¯ï¼›</p>
<p>åœ¨ <code>.L4</code> å¾ªç¯ä¸­ï¼Œå…ˆå°†åœ°å€ä¸º <code>%rdi + 4 * %rax</code> çš„ memory å¼•ç”¨å¤„çš„æ•°æ®åŠ  1ï¼Œå¹¶ä¸”å°† <code>%rax</code> ä¸­çš„æ•°æ®åŠ  1ï¼ˆ<code>i++</code>ï¼‰ï¼›</p>
<hr>
<blockquote>
<p><strong>è¡¥å…… C/C++ åŸºç¡€-2</strong>ï¼šä¸ºäº†æŒæ¡ C/C++ æ•°ç»„çš„æ ¸å¿ƒæ€æƒ³ï¼Œä½ å¿…é¡»èƒ½å¤Ÿç†è§£ä»¥ä¸‹çš„å£°æ˜çš„å«ä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="type">int</span> A1[<span class="number">3</span>];        <span class="comment">// ä¸€ä¸ªé•¿åº¦ä¸º 3 çš„æ•´å‹æ•°ç»„</span></span><br><span class="line"><span class="type">int</span> *A2[<span class="number">3</span>];        <span class="comment">// ä¸€ä¸ªé•¿åº¦ä¸º 3 çš„æ•´å‹æŒ‡é’ˆ æ„æˆçš„æ•°ç»„</span></span><br><span class="line"><span class="type">int</span> (*A3)[<span class="number">3</span>];    <span class="comment">// ä¸€ä¸ªæŒ‡å‘ é•¿åº¦ä¸º 3 çš„æ•´å‹æ•°ç»„ çš„æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure>
<p><strong>æç¤ºï¼šC/C++ é˜…è¯»ç±»å‹å£°æ˜çš„å…³é”®æ˜¯ä»å†…å‘å¤–è¯»ï¼Œè¿™æ¡é“ç†ä¸ä»…é€‚ç”¨äºä¸Šé¢çš„ <code>int (*A3)[3]</code>ï¼Œè¿˜é€‚ç”¨äºå‡½æ•°æŒ‡é’ˆç­‰å¤æ‚ç±»å‹çš„é˜…è¯»</strong>ã€‚ä¾‹å¦‚ <code>int**(*)(int*, int)</code> æ˜¯æŒ‡å‘å‚æ•°è¡¨ä¸º <code>(int*, int)</code>ã€è¿”å›å€¼ç±»å‹ä¸º <code>int**</code> çš„å‡½æ•°çš„æŒ‡é’ˆã€‚</p>
<p><strong>è¡¥å…… C/C++ åŸºç¡€-3</strong>ï¼šæ•°ç»„å˜é‡å’ŒæŒ‡é’ˆçš„åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼Œåœ¨å£°æ˜æ•°ç»„æ—¶ç¨‹åºä¸ä»…ä¼šä¸ºæ•°ç»„æ ‡è¯†ç¬¦è¿™ä¸ªæŒ‡é’ˆæ¥åˆ†é…ç©ºé—´ï¼Œè€Œä¸”ä¼šä¸ºæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ åˆ†é…ç©ºé—´ï¼›ä½†æŒ‡é’ˆåªä¼šä¸ºè‡ªèº«åˆ†é…ç©ºé—´ã€‚è¿™å°±å¯¼è‡´<strong>äºŒè€…è°ƒç”¨ <code>sizeof</code> çš„å¤§å°æ˜¯ä¸åŒçš„</strong>ï¼›ä¾‹å¦‚ <code>sizeof(A3) == 8</code>ï¼Œ<code>sizeof(*A3) == 12</code>ï¼Œ<code>sizeof(A3) == 4</code>;</p>
<p>âš  å¦å¤–ï¼Œå¦‚æœæƒ³åˆ¤æ–­ä»€ä¹ˆç±»å‹çš„æŒ‡é’ˆå– <code>*</code> åä¼šå¯¼è‡´é‡æŒ‡é’ˆ / ç©ºæŒ‡é’ˆå¼•ç”¨é”™è¯¯ï¼Œåº”è¯¥æƒ³æƒ³<strong>åœ¨ä¸€å¼€å§‹å£°æ˜çš„æ—¶å€™ï¼Œç¨‹åºæœ‰æ²¡æœ‰ä¸ºå…¶è‡ªåŠ¨åˆ†é…ç©ºé—´</strong>ã€‚ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœä½¿ç”¨ <code>*A3</code> åˆ™å¯èƒ½å‡ºç°ç©ºæŒ‡é’ˆå¼•ç”¨é”™è¯¯ï¼Œä½† <code>*A2</code> å°±ä¸ä¼šã€‚</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆè¦ â€œè¡¥å…… C/C++ åŸºç¡€ 1~3â€ ï¼Ÿ<strong>å› ä¸ºåªæœ‰æ¸…æ¥šäº†è§£ç¨‹åºçš„æºç è¡¨ç¤ºçš„å«ä¹‰ï¼Œæ‰èƒ½å»å…³æ³¨ã€æ­£ç¡®è®¤è¯†ç¼–è¯‘åçš„ä»£ç </strong>ã€‚</p>
<h4 id="6-1-2-Array-Access-Two-Dimension-Array"><a href="#6-1-2-Array-Access-Two-Dimension-Array" class="headerlink" title="6.1.2 Array Access: Two Dimension Array"></a>6.1.2 Array Access: Two Dimension Array</h4><blockquote>
<p>âš  æœ¬èŠ‚è®¨è®ºçš„ array è§„æ¨¡å…¨éƒ¨æ˜¯ <code>constexpr</code>ï¼ˆç¼–è¯‘å‰ç¡®å®šï¼‰ï¼›</p>
</blockquote>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†çœ‹äºŒç»´æ•°ç»„çš„çœŸå®å«ä¹‰ã€‚</p>
<p>âš  <strong>æ³¨æ„ï¼šç”±ä¸Šé¢çš„è®¨è®ºå¯çŸ¥ï¼Œä¸€å…±æœ‰ 2 ç±»äºŒç»´æ•°ç»„ï¼Œå°½ç®¡æºç çš„ä½¿ç”¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä½†æ±‡ç¼–å±‚é¢å®Œå…¨ä¸åŒï¼ï¼ï¼</strong></p>
<ul>
<li><p>Nested Array</p>
<ul>
<li><p>åœ¨ C/C++ ä¸­ï¼Œä¸€ç§äºŒç»´æ•°ç»„çš„å£°æ˜è¯­æ³•ä¸º <code>T A[R][C];</code>ï¼Œå…¶å®æ˜¯ <code>T[C] A[R];</code> çš„å¦ä¸€ç§å†™æ³•ï¼Œè¡¨ç¤º <strong><code>A</code> æ˜¯ä¸€ä¸ªåŒ…å« <code>R</code> ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œå…¶å…ƒç´ æ˜¯åŒ…å« <code>C</code> ä¸ªå…ƒç´ çš„æ•°ç»„</strong>ã€‚</p>
</li>
<li><p>è¿™ç§æ•°ç»„è¢«ç§°ä¸º <strong>Nested array</strong>ï¼Œç‰¹ç‚¹æ˜¯äºŒç»´æ•°ç»„ä¸­<strong>æ‰€æœ‰å…ƒç´ çš„ç©ºé—´åœ¨å£°æ˜æ—¶éƒ½è¢«è‡ªåŠ¨åˆ†é…äº†ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä»¬æ˜¯è¿ç»­çš„</strong>ã€‚</p>
</li>
<li><p>å¦ä¸€ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹æ˜¯ï¼Œ<strong>Nested array æ˜¯ â€œRow-Majorâ€ çš„ï¼Œå³è¡Œä¼˜å…ˆï¼Œç¬¬ä¸€ä¸ªç´¢å¼•åº”è¯¥æŒ‡å®šè¡Œï¼Œå¹¶ä¸”åˆ†é…ç©ºé—´ã€å­˜å‚¨æ—¶ï¼Œè¿ç»­çš„éƒ¨åˆ†ä¹Ÿæ˜¯è¡Œï¼Œåˆç§° Row Vectors</strong>ã€‚</p>
</li>
<li><p>Nested Array çš„æ¯ä¸ªè¡Œå‘é‡ <code>A[i]</code> å¼€å§‹çš„åœ°å€æ˜¯ <strong><code>A + i * C * sizeof(T)</code></strong>ï¼Œæ¯ä¸ªå…ƒç´  <code>A[i][j]</code> çš„åœ°å€æ˜¯ <strong><code>A + (i * C + j) * sizeof(T)</code></strong>ï¼ˆç”± <code>A + i * C * sizeof(T) + j * sizeof(T)</code> åŒ–ç®€å¾—æ¥ï¼‰;</p>
</li>
</ul>
</li>
</ul>
<p><img src="imgs/nested_array.png" height="200px"></p>
<ul>
<li>Multi-Level Array<ul>
<li>å¦ä¸€ç§äºŒç»´æ•°ç»„çš„å£°æ˜æ–¹å¼æ˜¯ <code>T* A[R];</code>ï¼Œéšååœ¨åˆå§‹åŒ–ä¸­ï¼ˆåœ¨æ ˆä¸­ï¼‰/ new ä¸Šï¼ˆåœ¨å †ä¸­ï¼‰æ•°ç»„çš„å„ä¸ªå…ƒç´ ã€‚</li>
<li>è¿™ç§æ•°ç»„ç§°ä¸º <strong>Multi-level array</strong>ï¼Œåœ¨å£°æ˜æ—¶ï¼Œ<strong>ä»…ä¸ºæ¯ä¸ªä¸€çº§å…ƒç´ ï¼ˆ<code>int*</code>ï¼‰è¿›è¡Œäº†ç©ºé—´åˆ†é…</strong>ã€‚</li>
<li><strong>äº‹å®ä¸Šï¼Œè¿™ç§å£°æ˜çš„æ•°ç»„æ¯ä¸€è¡Œçš„å­˜å‚¨ä½ç½®å¯ä»¥ä¸æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œç”šè‡³æ¯ä¸€è¡Œçš„å…ƒç´ å¯ä»¥ä¸åŒ</strong>ï¼å› æ­¤æ¯ä¸ªå…ƒç´ çš„åœ°å€è®¡ç®—åº”è¯¥<strong>å–å†³äº <code>A</code> ä¸­æ¯ä¸ªå…ƒç´ çš„å€¼</strong>ï¼æ²¡æ³•é€šè¿‡æ ‡è¯†ç¬¦ <code>A</code> ç›´æ¥å–å¾—ã€‚</li>
</ul>
</li>
</ul>
<p><img src="imgs/multi_level_array.png" height="200px"></p>
<hr>
<p>æˆ‘ä»¬ç»§ç»­åˆ©ç”¨ä¹‹å‰ <code>zip_dig</code> çš„ä¾‹å­ï¼Œæˆ‘ä»¬åˆ†åˆ«å£°æ˜ä¸¤ç§ç±»å‹çš„äºŒç»´æ•°ç»„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PCOUNT 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCOUNT 3</span></span><br><span class="line"></span><br><span class="line">zip_dig pgh[PCOUNT] = &#123;                    <span class="comment">// Nested array</span></span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> *univ[UCOUNT] = &#123; mit, cmu, ucb &#125;;    <span class="comment">// Multi-level array</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œåˆ†åˆ«æ˜¯ä½¿ç”¨å®ƒä»¬çš„ä¸¤ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="type">int</span>* <span class="title function_">get_pgh_zip</span><span class="params">(<span class="type">int</span> index)</span> &#123; <span class="keyword">return</span> pgh[index]; &#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">get_univ_digit</span><span class="params">(<span class="type">size_t</span> index, <span class="type">size_t</span> digit)</span> &#123; <span class="keyword">return</span> univ[index][digit]; &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶å¯¹åº”å‡½æ•°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">get_pgh_zip:</span><br><span class="line">    leaq	(%rdi,%rdi,4), %rax</span><br><span class="line">    leaq	pgh(,%rax,4), %rax</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">get_univ_digit:</span><br><span class="line">    salq	$2, %rsi</span><br><span class="line">    addq	univ(,%rdi,8), %rsi</span><br><span class="line">    movl	(%rsi), %eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„åˆ°ï¼Œè¿™é‡Œä½¿ç”¨çš„ <code>pgh</code>ã€ <code>univ</code> æ˜¯å…¨å±€å˜é‡ï¼Œä¸å­˜å‚¨åœ¨æ ˆä¸­ï¼Œæ„å‘³ç€åœ¨æ±‡ç¼–ä»£ç ä¸­<strong>å¯ä»¥ç›´æ¥ä½¿ç”¨å˜é‡åç§°æ¥è¡¨ç¤ºå…¨å±€å˜é‡</strong>ã€‚</p>
<p>æ³¨æ„ï¼è¿™æ—¶å€™ä¸¤ä¸ªæ•°ç»„çš„ç´¢å¼•æ–¹å¼å°±æœ‰å·®åˆ«äº†ã€‚</p>
<p>å¯¹äºä½¿ç”¨ Nested array çš„å‡½æ•° <code>get_pgh_zip</code> è€Œè¨€ï¼Œç¬¬ä¸€æ­¥æ˜¯ç›¸å½“äºè¿›è¡Œç®—æœ¯è®¡ç®— <code>%rax = 5 * %rdi</code>ï¼Œç¬¬äºŒæ­¥è¿˜æ˜¯ç›¸å½“äºç®—æœ¯è®¡ç®— <code>%rax = pgh + 4 * %rax</code>ã€‚è¿™ä¸¤æ­¥çš„çœŸå®å«ä¹‰æ˜¯ï¼š<code>%rax = pgh + sizeof(int) * 5 * index</code>ï¼Œè¿™é‡Œçš„ 5 å°±æ˜¯ä¹‹å‰æåˆ°çš„<strong>æ¯åˆ—åˆ—å®½</strong>ï¼›</p>
<p>å®ƒå¯ä»¥è¡¨ç¤ºï¼š<code>&amp;Memory[pgh + 5 * sizeof(int) * index]</code>ï¼Œå–å¾—å…¶ä¸­çš„æŒ‡é’ˆï¼›</p>
<p>å¯¹äºä½¿ç”¨ Multi-level array çš„å‡½æ•° <code>get_univ_digit</code> è€Œè¨€ï¼Œ<strong>äº‹æƒ…å®Œå…¨ä¸ä¸€æ ·ï¼</strong></p>
<p>ç¬¬ä¸€æ­¥å°† <code>%rsi</code> çš„å€¼ï¼ˆ<code>digit</code>ï¼‰ä¹˜ä»¥ 4ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼›</p>
<p>ç¬¬äºŒæ­¥æ³¨æ„ï¼Œè¿™é‡Œä¸æ˜¯ <code>leaq</code> è€Œæ˜¯ <code>addq</code>ï¼Œè¯´æ˜è¿™é‡Œå…ˆå–å¾— <code>univ + 8 * %rdi</code> ä¸­çš„å€¼ï¼Œå¹¶æŠŠå®ƒçœ‹ä½œåœ°å€ï¼Œæ‰¾åˆ° memory ä¸­è¯¥åœ°å€å¯¹åº”çš„å¼•ç”¨å€¼ã€‚æœ€åæŠŠ <code>%rsi</code> åŠ ä¸Šå¼•ç”¨å€¼;</p>
<p>è¿™ä¸¤æ­¥<strong>æ²¡æ³•å†™å‡ºçœŸå®å«ä¹‰çš„è¡¨è¾¾å¼ï¼Œå› ä¸ºæ¶‰åŠ memory å–å€¼ã€‚ä½†å¯ä»¥è¡¨ç¤ºä¸º</strong>ï¼š</p>
<p><code>Memory[Memory[univ + sizeof(int*) * index] + sizeof(int) * digit]</code>;</p>
<p>æœ€å <code>get_univ_digit</code> æ‰æŠŠè®¡ç®—å¥½çš„åœ°å€ä½¿ç”¨ Simple Memory Addressing Mode å–å‡ºå€¼ï¼Œå¹¶èµ‹ç»™ <code>%rax</code>ï¼ˆ<code>%eax</code>ï¼‰;</p>
<hr>
<p>å¯¹æ¯”ä¸Šé¢ä¸¤ç§äºŒç»´æ•°ç»„çš„æ±‡ç¼–æ“ä½œï¼Œè¿™è¯´æ˜äº†ä¸åŒçš„ç»“æ„å†³å®šäº†ä¸åŒçš„è®¡ç®—æ–¹æ³•ã€‚å‰è€…åªéœ€è¦å¯¹<strong>æ•°ç»„æ ‡è¯†ç¬¦</strong>å’Œ<strong>ç´¢å¼•</strong>è¿›è¡Œç®—æœ¯è®¡ç®—ï¼Œå°±èƒ½å¾—åˆ°åœ°å€ï¼›è€Œåè€…å¿…é¡»å…ˆç”±<strong>æ•°ç»„æ ‡è¯†ç¬¦</strong>å’Œ<strong>è¡Œå‚æ•°</strong>æ‰¾åˆ°ä¸€çº§å…ƒç´ å†…å®¹ï¼Œç„¶åç”¨<strong>ä¸€çº§å…ƒç´ å†…å®¹</strong>å’Œ<strong>åˆ—ç´¢å¼•</strong>æ‰èƒ½å®šä½å…·ä½“çš„å…ƒç´ ä½ç½®ã€‚</p>
<h4 id="6-1-3-Array-Access-M-Ã—-N-Matrix"><a href="#6-1-3-Array-Access-M-Ã—-N-Matrix" class="headerlink" title="6.1.3 Array Access: M Ã— N Matrix"></a>6.1.3 Array Access: M Ã— N Matrix</h4><ul>
<li>å¯¹äºæ’å®šï¼ˆconstexprï¼‰è§„æ¨¡ã€å£°æ˜æ—¶å·²åˆ†é…å†…å­˜çš„çŸ©é˜µè€Œè¨€ï¼Œå°±æ˜¯ä¸Šä¸€èŠ‚è¯´çš„ Nested arrayï¼›</li>
<li>å¯¹äºä½œä¸ºå‚æ•°ä¼ å…¥çš„ Nested arrayï¼ˆæœªçŸ¥è§„æ¨¡ï¼Œä½†ç©ºé—´è¿ç»­ï¼‰ï¼Œåˆ™å¿…é¡»è¿›è¡Œä¹˜æ³•è®¡ç®—ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰ç»“åˆå…¶ä»–ç®—æœ¯è®¡ç®—å¾—å‡ºä½ç½®ï¼›</li>
</ul>
<p>æ€»è€Œè¨€ä¹‹ï¼Œè®¿é—®æ•°ç»„çš„æ€è·¯å°±æ˜¯ä¹‹å‰è¯´çš„ Multi-level array å’Œ Nested array ä¸¤ç±»ã€‚å…¶ä»–æƒ…å†µå¯ä»¥åŒç†æ€è€ƒã€‚</p>
<h3 id="6-2-Structures-in-Assembly"><a href="#6-2-Structures-in-Assembly" class="headerlink" title="6.2 Structures in Assembly"></a>6.2 Structures in Assembly</h3><h4 id="6-2-1-Structure-Representation"><a href="#6-2-1-Structure-Representation" class="headerlink" title="6.2.1 Structure Representation"></a>6.2.1 Structure Representation</h4><p>å…³äºç»“æ„ä½“çš„å­˜å‚¨å’Œè¡¨ç¤ºï¼Œæœ‰ä¸‹é¢çš„ 3 æ¡ç®€å•è§„åˆ™ï¼š</p>
<ul>
<li><p>ç»“æ„ä½“æœ¬èº«åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºæ˜¯<strong>è¿ç»­çš„</strong>ï¼Œå¹¶ä¸” â€œbig enough to hold all of the fieldsâ€ï¼›</p>
</li>
<li><p>ç»“æ„ä½“ä¸­å„ä¸ªå­—æ®µåœ¨å†…å­˜ä¸­çš„æ’å¸ƒé¡ºåº<strong>ä¸¥æ ¼</strong>æŒ‰ç…§æºç ä¸­çš„<strong>å£°æ˜é¡ºåº</strong>ï¼›</p>
</li>
<li><p><strong>ç¼–è¯‘å™¨æ¥å†³å®šæ‰€æœ‰å­—æ®µå­˜å‚¨çš„ç©ºé—´å’Œå­—èŠ‚åç§»ã€å¯¹é½æƒ…å†µ</strong>ï¼ˆç›¸å¯¹ç»“æ„ä½“åœ°å€çš„ä½ç½®ï¼‰ï¼›</p>
<blockquote>
<p>æ•´ä¸ªè¿‡ç¨‹å¯¹æ±‡ç¼–å±‚é¢é€æ˜ï¼Œæ±‡ç¼–ä»£ç æ˜¯çœ‹ä¸å‡ºæ¥è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“çš„ï¼Œåªèƒ½çœ‹åˆ°ä¸€ç³»åˆ—å˜é‡æ’åˆ—åœ¨å†…å­˜ä¸Šï¼›</p>
</blockquote>
</li>
</ul>
<h4 id="6-2-2-Structure-Access-Generate-Pointer-to-Structure-Member"><a href="#6-2-2-Structure-Access-Generate-Pointer-to-Structure-Member" class="headerlink" title="6.2.2 Structure Access: Generate Pointer to Structure Member"></a>6.2.2 Structure Access: Generate Pointer to Structure Member</h4><p>å…¶å®é€šè¿‡ structure representation å°±èƒ½ç•¥çŸ¥å¦‚ä½•ç”¨æŒ‡é’ˆæ‰¾å„ä¸ªå­—æ®µäº†ã€‚è¿™é‡Œä»¥ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rec</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> a[<span class="number">4</span>];</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rec</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> *<span class="title function_">get_ap</span><span class="params">(<span class="keyword">struct</span> rec *r, <span class="type">size_t</span> idx)</span> &#123; <span class="keyword">return</span> &amp;r-&gt;a[idx]; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_val</span><span class="params">(<span class="keyword">struct</span> rec *r, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (r) &#123;</span><br><span class="line">        <span class="type">int</span> i = r-&gt;i;</span><br><span class="line">        r-&gt;a[i] = val;</span><br><span class="line">        r = r-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>get_ap</code> å‡½æ•°å¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get_ap:</span><br><span class="line">    leaq	(%rdi,%rsi,4), %rax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„æ“ä½œè¡¨æ˜äº† <code>%rax = %rdi + 4 * %rsi</code>ï¼Œå³ <code>%rax = r + sizeof(int) * idx</code>ã€‚è¿™è¯´æ˜äº†<code>struct rec</code> ä¸­çš„ç¬¬ä¸€ä¸ªæˆå‘˜å°±ä½äº <code>rec</code> ç©ºé—´çš„å¼€å¤´ï¼Œå¹¶æŒ‰æ­£å¸¸çš„æ•´å‹æ•°ç»„è¿›è¡Œæ’åˆ—ã€‚</p>
<p>ä½†æ˜¯å¯¹äºå¦å¤–ä¸€ä¸ªå‡½æ•° <code>set_val</code> è€Œè¨€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set_val:</span><br><span class="line">.L11:</span><br><span class="line">    movslq	16(%rdi), %rax</span><br><span class="line">    movl	%esi, (%rdi,%rax,4)</span><br><span class="line">    movq	24(%rdi), %rdi</span><br><span class="line">    testq	%rdi, %rdi</span><br><span class="line">    jne		.L11</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ­¥å¯ä»¥è®¤ä¸º <code>movslq</code> å°±æ˜¯ <strong>å– <code>Src</code> çš„ 32-bit æ•°æ®ï¼Œ0 æ‰©å±•ä¸º 64-bit æ•°æ®åæ”¾å…¥ <code>Dst</code></strong>ï¼Œä½œç”¨æ˜¯å°†åœ°å€ä¸º <code>%rdi + 16</code>ï¼ˆå³ <code>r + 4 * sizeof(int)</code>ï¼‰çš„ memory å¼•ç”¨çš„å€¼è¦†ç›–åˆ° <code>%rax</code> ä¸Šå»ã€‚å®Œæˆäº†æºç çš„ <code>int i = r-&gt;i;</code> è¿™ä¸€æ­¥ï¼›</p>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œç¼–è¯‘å™¨å°† <code>int a[4]</code>ã€<code>int i</code> å’Œ <code>struct rec* next</code> è¿™ä¸‰ä¸ªæˆå‘˜æ’åœ¨ä¸€èµ·ï¼Œ<strong>æ˜¯æ²¡æœ‰é—´éš”çš„ï¼Œå¦‚ä¸‹å›¾ã€‚ä½†æŸäº›åœºåˆä¸‹ç¼–è¯‘å™¨æŒ‡å®šå¯èƒ½ä¼šå‡ºç°é—´éš”</strong>ï¼Œè¿™æ˜¯æ˜¯ä¸ºäº†<strong>å†…å­˜å¯¹é½çš„åŸå› ï¼Œä¸‹é¢é©¬ä¸Šä¼šè®¨è®ºç»“æ„ä½“çš„å†…å­˜å¯¹é½</strong>ã€‚</p>
<p><img src="imgs/struct_example.png" height="150px"></p>
<p>ç¬¬äºŒæ­¥ <code>movl</code> å°† <code>%esi</code>ï¼ˆ<code>%rsi</code> çš„ low-order 32-bitï¼‰çš„å€¼èµ‹ç»™åœ°å€ä¸º <code>%rdi + 4 * %rax</code>ï¼ˆå³ <code>r + sizeof(int) * i</code>ï¼‰çš„ memory å¼•ç”¨ï¼Œå®Œæˆäº† <code>r-&gt;a[i] = val;</code> è¿™æ­¥ï¼›</p>
<p>ç¬¬ä¸‰éƒ¨è®© <code>%rdi</code> çš„å€¼å˜ä¸º â€œåœ°å€ä¸º <code>%rdi + 24</code> çš„ memory å¼•ç”¨çš„å€¼â€ï¼Œç›¸å½“äº <code>r = r-&gt;next;</code></p>
<p>å‰©ä¸‹çš„éƒ¨åˆ†å°±æ˜¯å®Œæˆ while å¾ªç¯çš„åˆ¤æ–­ä»»åŠ¡ã€‚</p>
<p><strong>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„é—®é¢˜æ²¡æœ‰é˜é‡Šâ€”â€”ç»“æ„ä½“çš„å†…å­˜å¯¹é½é—®é¢˜</strong>ã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å¯¹ç»“æ„ä½“è¿›è¡Œå†…å­˜å¯¹é½ï¼Ÿåˆæ˜¯å¦‚ä½•è¿›è¡Œå†…å­˜å¯¹é½çš„ï¼Ÿå†æ¥çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S1</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">int</span> i[<span class="number">2</span>];</span><br><span class="line">    <span class="type">double</span> v;</span><br><span class="line">&#125; *p;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºè¿™ä¸ªç»“æ„ä½“è€Œè¨€ï¼Œå¦‚æœæ¯ä¸ªæˆå‘˜ç´§ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆåœ¨å†…å­˜ä¸­çš„æ’å¸ƒæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="imgs/struct_example2_unaligned.png" height="60px"></p>
<p>ä½†å®é™…ä¸Šç¼–è¯‘å™¨ä¼šåœ¨å…¶ä¸­æ’å…¥ä¸€äº›ç©ºæ•°æ®å—ï¼Œè®©å†…å­˜æ’å¸ƒå˜æˆè¿™æ ·ï¼š</p>
<p><img src="imgs/struct_example2_aligned.png" height="125px"></p>
<p>è¿™å°±æ˜¯å› ä¸ºï¼Œx86-64ï¼ˆå’Œå…¶ä»–å¾ˆå¤šæ¶æ„çš„æœºå™¨ï¼‰è§„å®šäº†ç»“æ„ä½“å†…å­˜å¯¹é½çš„è§„åˆ™ã€‚ä¸ºä»€ä¹ˆè¦æœ‰è¿™æ ·çš„è§„åˆ™ï¼Ÿè¿™å…¶å®æ˜¯ <strong>ç¡¬ä»¶æ•ˆç‡é—®é¢˜</strong>ã€‚</p>
<p>å¯¹äºå½“ä»Šå¤§å¤šæ•°æœºå™¨çš„å†…å­˜ç³»ç»Ÿè€Œè¨€ï¼Œå®é™…ä»ç¡¬ä»¶å†…å­˜ä¸­ä¸€æ¬¡è¯»å–çš„æ•°æ®é‡å¤§çº¦ 64 bytesï¼Œæœ¬èº«ç§°ä¸ºä¸€ä¸ªè¯»å–çš„<strong>æ•°æ®å—</strong>ï¼Œå¤§å°å–å†³äºæœºå™¨ç¡¬ä»¶ä¸­çš„å„ç§å®½åº¦ã€‚æ‰€ä»¥ï¼Œå¦‚æœå› ä¸ºæ²¡æœ‰å¯¹é½çš„åœ°å€ï¼Œè€Œå¯¼è‡´è¯»å–æ—¶ç‰¹å®šçš„æ•°æ®è·¨è¶Šäº†ä¸¤ä¸ªæ•°æ®å—çš„è¾¹ç•Œï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿéœ€è¦é‡‡å–ä¸€äº›é¢å¤–çš„æ­¥éª¤æ¥å¤„ç†è¿™ç§æƒ…å†µï¼Œä»è€Œå¤§å¤§é™ä½å¤„ç†æ•ˆç‡ã€‚</p>
<p>é™¤äº†ä¸Šé¢çš„è¿™ç§åŸå› ï¼Œè¿˜æœ‰ç§åŸå› æ˜¯ï¼Œå¦‚æœè¿™äº›æœªå¯¹é½çš„ç»“æ„ä½“ç»„æˆäº†æ•°ç»„ï¼Œé‚£ä¹ˆæƒ³è¦<strong>ç´¢å¼•</strong>è¿™äº›æ•°ç»„çš„è®¡ç®—å°†ä¼šéå¸¸å¤æ‚ï¼Œ<strong>ä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸ä¸æ–¹ä¾¿</strong>ã€‚</p>
<p>é‰´äºä»¥ä¸ŠåŸå› ï¼Œå¾ˆå¤šæ¶æ„éƒ½é‡‡ç”¨äº†è¿™ç§å†…å­˜å¯¹é½çš„æ€è·¯ã€‚å…¶å®å†…å­˜å¯¹é½é™¤äº†åœ¨ç»“æ„ä½“è¿™é‡Œï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨ â€œè·³è¡¨â€ çš„æ±‡ç¼–ä»£ç ï¼ˆ4.4ï¼‰ä¸­ä¹Ÿçœ‹åˆ°äº†å†…å­˜å¯¹é½çš„æŒ‡ä»¤ï¼ˆ<code>.align</code>ï¼‰ï¼›</p>
<blockquote>
<p>å¦‚æœæŸç§ç¼–è¯‘å™¨ç¼–è¯‘ç¨‹åºæ—¶ï¼Œæ²¡æœ‰å®‰æ’å†…å­˜å¯¹é½ï¼Œé‚£ä¹ˆåœ¨ x86-64 çš„æ¶æ„ä¸Šè¿è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå¾®æ¶æ„ä¸­æœ‰è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ï¼ˆé‡æ–°è¯»å…¥ï¼‰ï¼Œé€Ÿåº¦å¯èƒ½ä¼šæ…¢ä¸€ç‚¹ï¼›ä½†æœ‰äº›æ¶æ„å®Œå…¨ä¸èƒ½è¿è¡Œï¼Œä¼šæŠ›å‡ºå†…å­˜é”™è¯¯çš„å¼‚å¸¸ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆå¦‚ä½•å¯¹é½èƒ½å¤Ÿè§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Ÿx86-64 æ¶æ„æå‡ºäº†ä»¥ä¸‹<strong>å†…å­˜å¯¹é½çš„åŸåˆ™</strong>ï¼š</p>
<ol>
<li><p><strong>Primitive data type requires K bytes, so its address must be multiple of K</strong>;</p>
<p>å¦‚æœåŸå§‹æ•°æ®ç±»å‹çš„å¤§å°æ˜¯ K bytesï¼Œé‚£ä¹ˆå®ƒï¼ˆæ‰€å¯¹åº”æˆå‘˜ï¼‰çš„èµ·å§‹åœ°å€å¿…é¡»èƒ½è¢« K æ•´é™¤ã€‚</p>
</li>
<li><p><strong>Overall structure length must be multiple of $\max\limits_{i}{K_i}$, where $\max\limits_{i}{K_i}$ is the largest alignment requirement in this structure</strong> (otherwise â€œexternal paddingâ€).</p>
<p>ç»“æ„ä½“æ€»ä½“çš„å¤§å°å¿…é¡»æ˜¯è¯¥ç»“æ„ä½“ä¸­æœ€å¤§çš„æ•°æ®ç±»å‹å¤§å°çš„æ•´æ•°å€ã€‚ï¼ˆå®Œæˆä¸Šä¸€æ¡åï¼Œç¼–è¯‘å™¨å¯ä»¥é€šè¿‡åœ¨ç»“æ„ä½“å°¾éƒ¨è¿½åŠ ç©ºæ•°æ®å—æ¥å®ç°ï¼‰</p>
</li>
</ol>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>å¯¹äº 1 byte çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>char</code>ï¼‰ï¼Œè¿™ç§ç±»å‹æˆå‘˜åœ¨å†…å­˜ä¸Šçš„æ’å¸ƒæ²¡æœ‰é™åˆ¶ï¼Œå“ªé‡Œæœ‰ç©ºå¾€å“ªæ¬ï¼›</li>
<li>å¯¹äº 2 bytes çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>short</code>ï¼‰ï¼Œè¿™ç§ç±»å‹æˆå‘˜è¦æ±‚èµ·å§‹åœ°å€å¿…é¡»èƒ½è¢« 2 æ•´é™¤ï¼ˆå³ LSB of address must be $0_2$ï¼‰ï¼›</li>
<li>å¯¹äº 4 bytes çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>int, float</code>ï¼‰ï¼Œè¦æ±‚èµ·å§‹åœ°å€å¿…é¡»èƒ½è¢« 4 æ•´é™¤ï¼ˆå³ lowest 2 bits of address must be $00_2$ï¼‰ï¼›</li>
<li>å¯¹äº 8 bytes çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>double, long, x86-64ä¸‹å„ç§ pointer</code>ï¼‰ï¼Œè¦æ±‚èµ·å§‹åœ°å€å¿…é¡»èƒ½å¤Ÿè¢« 8 æ•´é™¤ï¼ˆå³ lowest 3 bits of address must be $000_2$ï¼‰ï¼›</li>
<li>å¯¹äº 16 bytes çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>x86-64 gcc/Linuxä¸‹çš„ long double</code>ï¼‰ï¼Œè¦æ±‚èµ·å§‹åœ°å€å¿…é¡»èƒ½è¢« 16 æ•´é™¤ï¼ˆå³ lowest 4 bits of address must be $0000_2$ï¼‰ï¼›</li>
</ul>
<p>å†ä¾‹å¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S2</span> &#123;</span></span><br><span class="line">    <span class="type">double</span> v;</span><br><span class="line">    <span class="type">int</span> i[<span class="number">2</span>];</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">&#125; *p;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“çš„å†…å­˜å¯¹é½æ–¹å¼å¦‚ä¸‹ï¼š</p>
<p><img src="imgs/struct_example2_aligned_tail.png" height="125px"></p>
<p>å› ä¸ºå…¶ä¸­å«æœ‰ <code>double</code> æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥æ€»ä½“å¤§å°å¿…é¡»æ˜¯ 8 çš„æ•´æ•°å€ï¼›åˆå› ä¸ºæ•´ä½“é•¿åº¦ä¸æ˜¯ 8 çš„æ•´æ•°å€ï¼ˆ<code>p + 17</code>ï¼‰ï¼Œæ‰€ä»¥å°¾éƒ¨è¡¥å……ç©ºæ•°æ®å—åˆ° <code>p + 24</code>;</p>
<h4 id="6-2-3-Accessing-Arrays-of-Structure"><a href="#6-2-3-Accessing-Arrays-of-Structure" class="headerlink" title="6.2.3 Accessing Arrays of Structure"></a>6.2.3 Accessing Arrays of Structure</h4><p>æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚æœæœ‰ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œå¹¶ä¸”ç»“æ„ä½“æ˜¯è¢«æ­£ç¡®å®šä¹‰çš„ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±èƒ½å¾ˆå®¹æ˜“åœ°ç¡®å®šå„ä¸ªç»“æ„ä½“çš„å¤§å°ã€æˆå‘˜ä½ç½®å’Œæ•°ç»„çš„å¤§å°ï¼Œä»è€Œåœ¨å…¶ä»–ä½¿ç”¨åˆ°çš„åœºåˆä¸ºå…¶æ­£ç¡®åœ°åˆ†é…ç©ºé—´ã€ç´¢å¼•æˆå‘˜ï¼›</p>
<p>æ¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S3</span> &#123;</span></span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    <span class="type">float</span> v;</span><br><span class="line">    <span class="type">short</span> j;</span><br><span class="line">&#125; a[<span class="number">10</span>];</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ ä½¿ç”¨ <code>sizeof(S3)</code> çš„è¯ï¼Œä½ ä¼šå‘ç°å€¼æ˜¯ 12ï¼Œè¯´æ˜ç¼–è¯‘å™¨ç”Ÿæˆçš„ç©ºæ•°æ®å—çš„å¤§å°ä¹Ÿè®¡ç®—åœ¨å†…ã€‚å…·ä½“çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ <code>i</code> å’Œ <code>v</code> æˆå‘˜é—´ã€ç»“æ„ä½“å°¾éƒ¨éƒ½æœ‰åˆ†é…ç©ºæ•°æ®å—ï¼š</p>
<p><img src="imgs/struct_example3.png" height="125px"></p>
<p>è¿˜æœ‰ä½¿ç”¨å®ƒçš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">short</span> <span class="title function_">get_j</span><span class="params">(<span class="type">int</span> idx)</span> &#123; <span class="keyword">return</span> a[idx].j; &#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹ç…§ <code>S3</code> ç»“æ„ä½“çš„å†…å­˜åˆ†å¸ƒå›¾ï¼Œä½ å°±ä¼šå‘ç°è¿™ä¸ªå‡½æ•°çš„æ±‡ç¼–ä»£ç ä¹Ÿæ²¡æœ‰é‚£ä¹ˆéš¾ä»¥ç†è§£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get_j:</span><br><span class="line">    leaq	(%rdi,%rdi,2), %rax</span><br><span class="line">    movzwl	a+8(,%rax,4), %eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥è§£é‡Šä¸Šé¢ä¾‹å­çš„æ±‡ç¼–è¡Œä¸ºï¼š</p>
<p>ç¬¬ä¸€æ­¥æ˜¯ç›¸å½“äºç®—æœ¯è¿ç®— <code>%rax = 3 * %rdi</code>;</p>
<p>ç¬¬äºŒæ­¥æ˜¯ <code>%rax = a + 8 + 4 * %rax</code>ï¼Œå®è´¨ä¸Šæ˜¯ <code>%rax = a + 8 + 4 * 3 * idx</code>ï¼Œå¯¹ç…§ä¸Šé¢çš„å†…å­˜åˆ†å¸ƒæƒ…å†µå¯ä»¥ç†è§£ï¼Œ<code>a + 8</code> å°±æŒ‡å‘ <code>a[0].j</code>ï¼Œè€Œåé¢åŠ  <code>4 * 3 * idx</code> åˆ™æ˜¯å› ä¸ºæ¯ä¸ªç»“æ„ä½“å ä½ <code>4 * 3 bytes = 12 bytes</code> çš„ç©ºé—´ï¼Œè¿™æ ·å°±å¯¹åº”ç€ <code>a[idx].j</code> çš„ä½ç½®äº†ã€‚</p>
<blockquote>
<p><strong>è¿™é‡Œçš„æ€»ç»“ä¸€ä¸‹é‡åˆ°çš„ä¹±ä¸ƒå…«ç³Ÿçš„ <code>movXXX</code> æŒ‡ä»¤</strong>ã€‚</p>
<p><code>movzbl</code> å’Œ <code>movsbl</code> çš„ä½œç”¨ç›¸è¿‘ï¼Œéƒ½æ˜¯<strong>å°† 8-bit æ‰©å±•åˆ° 32-bit</strong>ã€‚ä½†å‰è€…æ˜¯ <strong>zero extension</strong> é›¶æ‰©å±•ï¼ˆæ ¹æ® <strong>extension conclusion</strong>ï¼Œé’ˆå¯¹ unsigned çš„æ‰©å±•ï¼‰ï¼Œè€Œåè€…æ˜¯ <strong>sign extension</strong> ç¬¦å·æ‰©å±•ï¼ˆé’ˆå¯¹ signed çš„æ‰©å±•ï¼‰ï¼›</p>
<p> <code>movzwl</code> å’Œ <code>movswl</code> å¾ˆåƒï¼Œå‰è€…æ˜¯ 16-bitï¼ˆ1 wordï¼‰<strong>é›¶æ‰©å±•ç§»åŠ¨</strong>è‡³ 32-bitï¼Œåè€…æ˜¯ 16-bit <strong>ç¬¦å·æ‰©å±•ç§»åŠ¨</strong>è‡³ 32-bitï¼ˆlongï¼‰ï¼›</p>
<p><code>movzlq</code> å’Œ <code>movslq</code> åŒç†ã€‚</p>
<p><strong>å¦‚æœä½ ä¼šçœ‹æŒ‡ä»¤åç§°çš„å«ä¹‰çš„è¯ï¼Œä¸Šé¢çš„å†…å®¹å°±æ— éœ€è®°å¿†äº†</strong>ï¼šåœ¨ <code>mov&lt;A&gt;&lt;B&gt;&lt;C&gt; &lt;Src&gt;, &lt;Dst&gt;</code> ä¸­ï¼Œ</p>
<p>A è¡¨ç¤ºæ‰©å±•ç§ç±»ï¼Œå¯ä»¥æ˜¯ <code>z</code>ï¼ˆzero extensionï¼‰ã€<code>s</code>ï¼ˆsign extensionï¼‰ï¼›</p>
<p>B è¡¨ç¤ºæ‰©å±•æºï¼ˆ<code>Src</code>ï¼‰çš„å¤§å°ï¼Œå¯ä»¥æ˜¯ <code>b</code>ï¼ˆ1 byteï¼Œ8 bitsï¼‰ï¼Œ<code>w</code>ï¼ˆwordï¼Œ1 å­—ï¼Œ16 bitsï¼‰ã€<code>l</code>ï¼ˆ2 å­—ï¼Œ32 bitsï¼‰ã€<code>q</code>ï¼ˆquadwordï¼Œ4 å­—ï¼Œ64 bitsï¼‰ï¼›</p>
<p>C è¡¨ç¤ºæ‰©å±•ç›®æ ‡ï¼ˆ<code>Dst</code>ï¼‰çš„å¤§å°ï¼Œå¯ä»¥å–çš„å€¼å’Œ B ç›¸åŒï¼Œä½†ä¸¤è€…ä¸èƒ½åŒæ—¶å–ä¸€ä¸ªå€¼ã€‚</p>
<p>é™¤æ­¤ä»¥å¤–å°±æ˜¯æ™®é€šçš„ <code>mov&lt;X&gt;</code>ï¼ˆæ²¡æœ‰æ‰©å±•åŠŸèƒ½ï¼‰å’Œæ¡ä»¶ç§»åŠ¨ <code>mov&lt;cond&gt;</code> æŒ‡ä»¤äº†ã€‚ </p>
</blockquote>
<h4 id="6-2-4-Saving-Space"><a href="#6-2-4-Saving-Space" class="headerlink" title="6.2.4 Saving Space"></a>6.2.4 Saving Space</h4><p>ç°åœ¨ï¼Œæˆ‘ä»¬äº†è§£äº†ç»“æ„ä½“çš„åŸºæœ¬æ’å¸ƒå’Œè¡¨ç¤ºï¼Œä¹ŸçŸ¥é“äº†ç»“æ„ä½“å†…å­˜å¯¹é½çš„è§„åˆ™ã€‚æœ‰äº›åŒå­¦å¯èƒ½ä¼šå‘ç°ï¼Œè¯¶ï¼Œå› ä¸ºç»“æ„ä½“å„æˆå‘˜åœ¨å†…å­˜ä¸­çš„æ’å¸ƒé¡ºåºä¸¥æ ¼æŒ‰ç…§æºç å£°æ˜çš„é¡ºåºï¼Œé‚£ä¹ˆ<strong>ç»“æ„ä½“ä¸­å„ä¸ªæˆå‘˜æ’å¸ƒçš„ä¸åŒï¼Œæ˜¯ä¸æ˜¯ä¼šå¯¼è‡´ç»“æ„ä½“æœ€ç»ˆæ‰€å çš„å¤§å°ä¸åŒï¼Ÿ</strong></p>
<p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæ‰€ä»¥ï¼Œæœ‰å¿…è¦è®¨è®ºä¸€ä¸‹ â€œæŒ‰ä»€ä¹ˆæ–¹å¼å£°æ˜ç»“æ„ä½“ï¼Œèƒ½å¤Ÿè®©æŒ‡å®šç»“æ„ä½“çš„ç©ºé—´å ç”¨æœ€å°â€ è¿™ä¸ªé—®é¢˜ã€‚ä¸‹é¢æ˜¯ç»“è®ºï¼š</p>
<ul>
<li><p><strong>å°†å ç”¨ç©ºé—´è¾ƒå¤§çš„æ•°æ®ç±»å‹å£°æ˜åœ¨å‰é¢</strong>ã€‚</p>
<blockquote>
<p>è¿™ç§è´ªå¿ƒç®—æ³•æ˜¯æœ‰æ•ˆçš„ã€‚å› ä¸ºæ‰€æœ‰æ•°æ®ç±»å‹çš„å¤§å°åªæœ‰ 1ã€2ã€4ã€8ã€16 bytesï¼Œå…¨æ˜¯ 2 çš„æ•´æ•°æ¬¡å¹‚ï¼Œåœ¨æ•°å­¦ä¸Šæ¥è¯´èƒ½å¤Ÿä¸¥æ ¼è¯æ˜ã€‚</p>
</blockquote>
</li>
</ul>
<p>ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ<code>S4</code> å’Œ <code>S5</code> ç›¸æ¯”ï¼Œ<code>S5</code> æ›´èŠ‚çœç©ºé—´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S4</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> d;</span><br><span class="line">&#125; *p;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S5</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">char</span> d;</span><br><span class="line">&#125; *p;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-Floating-Point-in-Assembly"><a href="#6-3-Floating-Point-in-Assembly" class="headerlink" title="6.3 Floating Point in Assembly"></a>6.3 Floating Point in Assembly</h3><h4 id="6-3-1-History-amp-Background-for-Representing-FP"><a href="#6-3-1-History-amp-Background-for-Representing-FP" class="headerlink" title="6.3.1 History &amp; Background for Representing FP"></a>6.3.1 History &amp; Background for Representing FP</h4><p>åœ¨ x86 æ¶æ„ä¸­ï¼Œfloating point çš„è¡¨ç¤ºæœ‰ç€æ¯”è¾ƒæ·±çš„å†å²ã€‚</p>
<p><strong>x87 FP</strong></p>
<p>å¾ˆæ—©ä¹‹å‰ï¼ŒIntel çš„ 8087 èŠ¯ç‰‡å’Œ IEEE æµ®ç‚¹æ•°æ ‡å‡†ä¸€èµ·è¯ç”Ÿï¼Œå®‰è£…åœ¨ 8086 å¤„ç†å™¨ä¸Šï¼Œæ˜¯ç¬¬ä¸€ä¸ªèƒ½å¤Ÿå®Œå…¨å¤„ç† IEEE æµ®ç‚¹æ•°è¿ç®—çš„é›†æˆå•å…ƒã€‚ä½†æ˜¯ç¼–ç¨‹æ¨¡å‹ä»ç°åœ¨çœ‹æ¥æ¯”è¾ƒç³Ÿç³•ï¼Œæ‰€ä»¥ CSAPP ç¬¬ä¸‰ç‰ˆå°±æŠŠè¿™æ–¹é¢çš„å†…å®¹å®Œå…¨ç§»é™¤äº†ï¼ˆexpungedï¼‰ï¼›</p>
<p><strong>MMX FP</strong></p>
<p>1997 å¹´ Intel å…¬å¸æ¨å‡ºäº†å¤šåª’ä½“æ‰©å±•æŒ‡ä»¤é›† MMXï¼Œå®ƒåŒ…æ‹¬57æ¡å¤šåª’ä½“æŒ‡ä»¤ã€‚MMX æŒ‡ä»¤ä¸»è¦ç”¨äºå¢å¼º CPU å¯¹å¤šåª’ä½“ä¿¡æ¯çš„å¤„ç†èƒ½åŠ›ï¼Œæé«˜ CPU å¤„ç† 3D å›¾å½¢ã€è§†é¢‘å’ŒéŸ³é¢‘ä¿¡æ¯çš„èƒ½åŠ›ã€‚</p>
<p><strong>SSE FP</strong></p>
<p>éšç€äººä»¬æ—¥ç›Šå¢é•¿çš„ç²¾ç¥æ–‡åŒ–çš„éœ€è¦ï¼Œä¾‹å¦‚æ ¸æ˜¾æ¸²æŸ“çš„æµ®ç‚¹æ•°è¿ç®—éœ€æ±‚å¢é•¿ï¼Œäººä»¬è¿«åˆ‡éœ€è¦å¹¶è¡Œè®¡ç®—çš„æ‰‹æ®µï¼Œäºæ˜¯ä¸€ä¸ªå…¨æ–°çš„æ€è·¯å°±å‡ºç°äº†â€”â€”<strong>SIMDï¼ˆSingle Instruction Multiple Dataï¼‰ï¼Œå•æŒ‡ä»¤å¤šæ•°æ®</strong>ï¼Œå’Œæ•´å‹å¯„å­˜å™¨ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨æµ®ç‚¹æ•°å¯„å­˜å™¨ä¸Šå¤šæ”¾å‡ ä¸ªæ•°åŒæ—¶è®¡ç®—ï¼Œé‚£ä¹ˆè¿ç®—é€Ÿåº¦ä¸å°±ä¸Šå»äº†ï¼Ÿ</p>
<p>ç´§æ¥ç€ï¼Œä¸€å¥—æ–°çš„æŒ‡ä»¤æ‹“å±•é›† SSEï¼ˆStreaming SIMD Extensionï¼‰è¢«è®¾è®¡å‡ºæ¥ï¼Œå…¼å®¹ MMX æŒ‡ä»¤ï¼Œé…åˆä¸€å¥—æµ®ç‚¹å¯„å­˜å™¨ï¼Œæ¥å®Œæˆæ ‡é‡æµ®ç‚¹æ•°ï¼Œæˆ–è€…å•æŒ‡ä»¤å¤šæ•°æ®çš„æµ®ç‚¹æ•°çš„è®¡ç®—ã€‚</p>
<p><strong>AVX FP</strong></p>
<p>åœ¨2010 å¹´ AVX å°†ä¹‹å‰æµ®ç‚¹è¿ç®—æ•°æ®çš„å®½åº¦ä» 128 bits çš„æ‰©å±•åˆ° 256-bitsã€‚åŒæ—¶æ–°çš„ CPU æ¶æ„ä¸‹æ•°æ®ä¼ è¾“é€Ÿåº¦ä¹Ÿè·å¾—äº†æå‡ã€‚AVX æŒ‡ä»¤é›†åœ¨ SIMD è®¡ç®—æ€§èƒ½å¢å¼ºçš„åŒæ—¶ä¹Ÿæ²¿ç”¨äº†çš„ MMX/SSE æŒ‡ä»¤é›†ã€‚ä¸è¿‡å’Œ MMX/SSE çš„ä¸åŒç‚¹åœ¨äºï¼Œå¢å¼ºçš„ AVX æŒ‡ä»¤åœ¨æŒ‡ä»¤çš„æ ¼å¼ä¸Šä¹Ÿå‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ã€‚x86 (IA-32/Intel 64) æ¶æ„çš„åŸºç¡€ä¸Šå¢åŠ äº†prefixï¼Œæ‰€ä»¥å®ç°äº†æ–°çš„å‘½ä»¤ï¼Œä¹Ÿä½¿æ›´åŠ å¤æ‚çš„æŒ‡ä»¤å¾—ä»¥å®ç°ï¼Œä»è€Œæå‡äº† x86 CPUçš„æ€§èƒ½ã€‚</p>
<blockquote>
<p>AVX å¹¶ä¸æ˜¯ x86 CPU çš„æ‰©å±•æŒ‡ä»¤é›†ï¼Œå¯ä»¥å®ç°æ›´é«˜çš„æ•ˆç‡ï¼ŒåŒæ—¶å’Œ CPU ç¡¬ä»¶å…¼å®¹æ€§ä¹Ÿæ›´å¥½ï¼Œåœ¨ SSE æŒ‡ä»¤çš„åŸºç¡€ä¸Š AVX ä¹Ÿä½¿ SSE æŒ‡ä»¤æ¥å£æ›´åŠ æ˜“ç”¨ï¼›</p>
</blockquote>
<h4 id="6-3-2-Programming-with-SSE3"><a href="#6-3-2-Programming-with-SSE3" class="headerlink" title="6.3.2 Programming with SSE3"></a>6.3.2 Programming with SSE3</h4><p>åœ¨ SSE ç¬¬ 3 ç‰ˆä¸­ï¼ŒæŒ‡æ˜äº† x86 æ¶æ„æœ‰ <strong>16 ä¸ª floating point registers</strong>ï¼ˆå’Œä¹‹å‰çš„ 16 ä¸ª integer registers å®Œå…¨ä¸åŒï¼‰ï¼Œæ¯ä¸ª floating point register ç©ºé—´å¤§å° <strong>16 bytes</strong>ï¼ˆå¤§æ¦‚æ˜¯ integer register çš„ä¸¤å€å¤§ï¼‰ï¼›</p>
<p>å®ƒä»¬åˆå« <code>XMM</code> Registerï¼ˆåç§°çš„å†å²æ¸Šæºæ¯”è¾ƒå¤šï¼Œæ­¤å¤„çœç•¥ï¼Œæ„Ÿå…´è¶£çœ‹ CSAPP åŸä¹¦ P294ï¼‰ï¼Œæ‰€ä»¥è¿™äº›å¯„å­˜å™¨çš„åç§°ï¼š<code>%xmm0 ~ %xmm15</code>;</p>
<p>å…¶ä¸­ï¼ŒæŒ‰ç…§<strong>æŒ‡ä»¤ä½¿ç”¨çš„ä¸åŒ</strong>ï¼Œæ¯ä¸ª <code>XMM</code> Register éƒ½å¯ä»¥å­˜å‚¨ï¼š</p>
<ul>
<li>16 ä¸ª 1 byte æ•´å‹ï¼ˆ<code>char</code>ï¼‰ï¼›</li>
<li>æˆ– 8 ä¸ª 2 bytes æ•´å‹ï¼ˆ<code>short</code>ï¼‰ï¼›</li>
<li>æˆ– 4 ä¸ª 4 bytes æ•´å‹ï¼ˆ<code>int</code>ï¼‰ï¼›</li>
<li>æˆ– 4 ä¸ª å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ<code>float</code>ï¼‰ï¼›</li>
<li>æˆ– 2 ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ<code>double</code>ï¼‰ï¼›</li>
<li>æˆ– 1 ä¸ª å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ<code>float</code>ï¼Œæ²¡å­˜æ»¡ï¼Œæœ‰å‰©ä½™ç©ºé—´ï¼‰ï¼›</li>
<li>æˆ– 1 ä¸ª åŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ<code>double</code>ï¼Œæ²¡å­˜æ»¡ï¼Œæœ‰å‰©ä½™ç©ºé—´ï¼‰ï¼›</li>
</ul>
<p><img src="imgs/xmm_registers.png" height="400px"></p>
<p>è¿™æ„å‘³ç€æµ®ç‚¹æ•°å¯„å­˜å™¨<strong>æ—¢å¯ä»¥å¤„ç†æ•´å‹ï¼Œåˆå¯ä»¥å¤„ç†æµ®ç‚¹æ•°ç±»å‹</strong>ï¼›<strong>æ—¢å¯ä»¥å¤„ç†ä¸€ä¸ªæ•°çš„è¿ç®—ï¼Œåˆå¯ä»¥å¤šä¸ªæ•°å¹¶è¡Œè¿ç®—</strong>ã€‚</p>
<p>è¿™ç§ä¸€æ¬¡è®¡ç®—å•ä¸ªæ•°çš„æŒ‡ä»¤è¢«ç§°ä¸º <strong>Scalar Operationsï¼ˆæ ‡é‡è¿ç®—ï¼‰</strong>ï¼Œä¸€æ¬¡å¹¶è¡Œè®¡ç®—å¤šä¸ªæ•°çš„æŒ‡ä»¤è¢«ç§°ä¸º <strong>SIMD Operationsï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®è¿ç®—ï¼‰</strong>ã€‚</p>
<p>å…·ä½“çš„å‘½ä»¤é•¿ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿˜æ˜¯ç»å…¸çš„ <strong>åç§°+åç¼€</strong> å‘½åæ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœä½ èƒ½è¯»æ‡‚å‘½åæ–¹æ³•ï¼Œé‚£å°±ä¸ç”¨è®°å¿†å¤ªå¤šçš„æŒ‡ä»¤äº†ã€‚</p>
<p>å¯¹äºæµ®ç‚¹æ•°è¿ç®—è€Œè¨€ï¼Œä¸»è¦æœ‰ 4 ç§æŒ‡ä»¤ï¼š<code>addss</code>ã€<code>addps</code>ã€<code>addsd</code>ã€<code>addpd</code>ï¼›</p>
<p>ä¼šè¯»çš„åŒå­¦å·²ç»æ‡‚äº†ï¼Œå°±æ˜¯ <code>&lt;OP_NAME&gt;&lt;OP_TYPE&gt;&lt;DATA_TYPE&gt;</code> çš„ç»„åˆå˜›ï¼</p>
<ul>
<li><p><code>OP_NAME</code> å°±æ˜¯è¿ç®—çš„åç§°ï¼Œè¿™é‡Œæ˜¯ <code>add</code> åŠ æ³•è¿ç®—ï¼ˆæ˜¾ç„¶è¿˜æœ‰ <code>mov</code> ç§»åŠ¨ã€<code>sub</code> å‡æ³•ç­‰ç­‰ï¼‰ï¼›</p>
</li>
<li><p><code>OP_TYPE</code> æ˜¯è¿ç®—ç±»å‹ï¼Œä¸Šé¢æåˆ°çš„ <code>s</code> ä»£è¡¨ Scalar æ ‡é‡è¿ç®—ï¼ˆä¸€æ¬¡ç®—ä¸€ä¸ªæ•°ï¼‰ï¼Œ<code>p</code> ä»£è¡¨ Packed å¤šæ•°æ®è¿ç®—ï¼ˆä¸€æ¬¡ç®—ä¸€ç»„æ•°ï¼‰ï¼›</p>
<blockquote>
<p>ç‰¹åˆ«åœ°ï¼Œå¦‚æœå¼ºè°ƒæ˜¯å¯¹é½çš„æ•°æ®ï¼Œé‚£ä¹ˆ <code>OP_TYPE</code> è¿˜æœ‰å‰ç¼€ <code>a</code> ä»£è¡¨ alignedï¼Œä¾‹å¦‚ï¼š<code>movapd</code>;</p>
</blockquote>
</li>
<li><p><code>DATA_TYPE</code> æ˜¯è¿ç®—çš„æ•°æ®ç±»å‹ï¼Œ<code>s</code> ä»£è¡¨ Single precision floating pointï¼Œ<code>d</code> ä»£ç  Double precision floating pointï¼›</p>
</li>
</ul>
<p>æ‰€ä»¥ä¸¾ä¸ªä¾‹å­ï¼Œ<code>addpd</code> å°±æ˜¯åŒç²¾åº¦æµ®ç‚¹æ•°çš„ SIMD åŠ æ³•è¿ç®—æŒ‡ä»¤å˜›ï¼</p>
<p>è¿ç®—çš„å‚æ•°å’Œä¹‹å‰çš„æ•´å‹å¯„å­˜å™¨è¿ç®—ä¸€æ ·ï¼Œ<code>&lt;Src&gt;, &lt;Dst&gt;</code>;</p>
<p>è¿ç®—çš„å†…å­˜è¡¨ç¤ºå°±æ˜¯å¦‚å›¾ï¼š</p>
<p><img src="imgs/sse_fp_addition.png" height="400px"></p>
<p>é™¤æ­¤ä»¥å¤–ï¼ŒFP è¿˜æœ‰ <strong>2 ç‚¹</strong>éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li><p>FP Registers çš„ Saving Conventionsï¼š</p>
<ul>
<li><p><code>%xmm0 ~ %xmm15</code> å°±æ˜¯ä¾æ¬¡ä¼ é€’å‚æ•°çš„ registerï¼Œå‚æ•°å¤šäº 15 ä¸ªæµ®ç‚¹æ•°ç±»å‹ï¼Œåˆ™å’Œå¤šå‡º 6 ä¸ªçš„æ•´å‹å‚æ•°ä¸€æ ·ï¼Œä¼šæ”¾åˆ°æ ˆå¸§ä¸­å»ï¼›</p>
</li>
<li><p><code>%xmm0</code> ä¹Ÿæ˜¯çº¦å®š<strong>è¿”å›æµ®ç‚¹æ•°å€¼</strong>çš„å­˜æ”¾ä½ç½®ï¼›</p>
</li>
<li><p><strong>æ‰€æœ‰çš„ <code>XMM</code> Register éƒ½æ˜¯ Caller-Saved Register</strong>ï¼Œæ²¡æœ‰ Callee-Saved Registerï¼›</p>
</li>
</ul>
</li>
<li><p>FP çš„è¿˜æœ‰ä¼—å¤šçš„å‘½ä»¤ç­‰å¾…è®¤è¯†ï¼Œä¸è¿‡æœ€é‡è¦çš„è¿˜æ˜¯ä¹‹å‰æåˆ°çš„<strong>è®°å¿†æŒ‡ä»¤çš„å‘½åæ–¹æ³•</strong>ï¼Œç†è§£äº†å‘½åæ–¹æ³•å°±èƒ½æ›´å°‘åœ°è®°å¿†æŒ‡ä»¤ï¼›</p>
<ul>
<li><p>FP æ•°æ®æ¯”è¾ƒæŒ‡ä»¤ï¼š<code>ucomiss</code>ï¼ˆUnordered Compare Scalar Single Precision Floating Pointï¼‰ã€<code>ucomisd</code>ï¼ˆUnordered Compare Scalar Double Precision Floating Pointï¼‰ï¼›</p>
<blockquote>
<p>å’Œ <code>cmpq</code> å¤§è‡´ç›¸ä¼¼ï¼Œä¼šè®¾ç½® condition codesï¼ŒåŒ…æ‹¬ <code>CF/ZF/PF</code>ï¼›</p>
</blockquote>
</li>
<li><p>FP å¸¸æ•°ä½¿ç”¨ï¼šè¿™é‡Œ <code>$</code> ç¬¦å·<strong>åªèƒ½</strong>æ¥æ•´å‹å¸¸é‡ï¼Œæ‰€ä»¥å¦‚æœè¦ä½¿ç”¨æµ®ç‚¹æ•°å¸¸é‡ï¼Œéœ€è¦ <code>xorpd %xmm0 %xmm0</code> ç­‰ç±»ä¼¼æŒ‡ä»¤è¿ç®—å‡º / ä»å†…å­˜ä¸­è¯»å…¥æ‰èƒ½ä½¿ç”¨ã€‚</p>
</li>
</ul>
</li>
</ol>
<p>äº‹å®ä¸Šï¼Œä¹‹å‰æˆ‘ä»¬ä¸€ç›´æ‹…å¿ƒçš„ â€œ<strong>æµ®ç‚¹æ•°å¦‚ä½•é€šè¿‡å¯„å­˜å™¨ä¼ é€’å‚æ•°</strong>â€ ç­‰é—®é¢˜ï¼Œåªè¦æœ‰äº†å‘½ä»¤å°±éå¸¸ç®€å•ï¼Œæ“ä½œæ–¹æ³•å‡ ä¹å’Œ integer registers ä¸€æ ·ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">fadd</span><span class="params">(<span class="type">float</span> x, <span class="type">float</span> y)</span> &#123; <span class="keyword">return</span> x + y; &#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">dadd</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span> &#123; <span class="keyword">return</span> x + y; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> <span class="title function_">dincr</span><span class="params">(<span class="type">double</span>* p, <span class="type">double</span> v)</span> &#123;</span><br><span class="line">    <span class="type">double</span> x = *p;</span><br><span class="line">    *p = x + v;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fadd:</span><br><span class="line">    addss	%xmm1, %xmm0</span><br><span class="line">    ret</span><br><span class="line">dadd:</span><br><span class="line">    addsd	%xmm1, %xmm0</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">dincr:</span><br><span class="line">    movapd	%xmm0, %xmm1</span><br><span class="line">    movsd	(%rdi), %xmm0</span><br><span class="line">    addsd	%xmm0, %xmm1</span><br><span class="line">    movsd	%xmm1, (%rdi)</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å‡½æ•° <code>fadd</code> å’Œ <code>dadd</code> æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸»è¦çœ‹ <code>dincr</code>ï¼š</p>
<p>ç¬¬ä¸€æ­¥ <code>movapd</code> è§åçŸ¥æ„ï¼ŒMove Aligned Packed Double Precision Floating Pointï¼Œæˆç»„ç§»åŠ¨åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œå‚æ•°ç±»å‹å’Œå…¶ä»–çš„ <code>mov</code> æŒ‡ä»¤ç›¸åŒï¼›</p>
<p>è¿™é‡Œçš„ <code>%xmm0</code> é‡Œè£…çš„æ˜¯<strong>å‡½æ•°ç¬¬äºŒå‚æ•° <code>double v</code></strong>ï¼ˆç¬¬ä¸€å‚æ•°æ˜¯æŒ‡é’ˆæ•´å‹ï¼Œæ‰€ä»¥æ”¾åœ¨ <code>%rdi</code>ï¼‰ï¼Œç§»åŠ¨åˆ°äº†æœªä½¿ç”¨åˆ°çš„ <code>%xmm1</code> å¯„å­˜å™¨ä¸­ï¼›</p>
<p>ç¬¬äºŒæ­¥ <code>movsd</code>ï¼ŒMove Scalar Double Precision Floating Pointï¼Œç§»åŠ¨æ ‡é‡åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œå°†åœ°å€ä¸º <code>%rdi</code> çš„ memory å¼•ç”¨å€¼ï¼ˆä¹Ÿå°±æ˜¯ <code>p</code> æŒ‡å‘çš„å†…å­˜ double æ•°æ®ï¼‰èµ‹ç»™ <code>%xmm0</code>ï¼ˆxï¼‰ï¼Œå¹¶ä¸”æœ€ç»ˆå°†ä½œä¸ºè¿”å›å€¼è¿”å›ï¼›</p>
<p>ç¬¬ä¸‰æ­¥å°±æ˜¯æ ‡é‡å°† <code>%xmm0</code> çš„æ•°æ®ï¼ˆxï¼‰åŠ åˆ° <code>%xmm1</code> çš„å€¼ï¼ˆvï¼‰ä¸Šï¼Œå®Œæˆäº† <code>*p = x + v;</code></p>
<p>ç¬¬å››æ­¥å°±å°†è®¡ç®—ç»“æœ <code>%xmm1</code> çš„å€¼ï¼ˆtï¼‰æ ‡é‡ç§»åŠ¨åˆ°åœ°å€ä¸º <code>%rdi</code> çš„ memory å¼•ç”¨åŒºåŸŸä¸­ï¼ˆp æ‰€æŒ‡å‘çš„åŒºåŸŸï¼‰ï¼Œå®Œæˆ <code>*p = t;</code></p>
<h4 id="6-3-3-AVX-Instructions"><a href="#6-3-3-AVX-Instructions" class="headerlink" title="6.3.3 AVX Instructions"></a>6.3.3 AVX Instructions</h4><p>AVX æ–°å¢çš„æŒ‡ä»¤å¯ä»¥è¯´æ˜¯éå¸¸åœ°å¤šï¼Œä½¿ç”¨æ–¹æ³•ã€å‘½åè§„èŒƒå’Œä¹‹å‰æ‰€æœ‰çš„å‘½ä»¤ä¸åŒçš„æ˜¯ï¼ŒåŠ äº†å‰ç¼€ â€œvâ€ï¼Œå…¶ä»–éƒ½ç›¸è¿‘ã€‚</p>
<ul>
<li><p><code>mov</code> ç±»å‘½ä»¤ï¼š<code>vmovss/vmovsd/vmovps/vmovpd/vmovass/...</code>;</p>
<blockquote>
<p>å‘½åè§„èŒƒè§å‰é¢çš„å™è¿°ï¼›</p>
</blockquote>
</li>
<li><p><code>cvt</code> ï¼ˆconvertï¼‰ç±»å‘½ä»¤ï¼Œä¸€èˆ¬å®ç°æµ®ç‚¹å’Œæ•´å‹ä¹‹é—´çš„è½¬æ¢ï¼š</p>
<ul>
<li><p><code>vcvttss2si/vcvttsd2si/vcvttss2si/vcvttss2siq/vcvttsd2siq</code>;</p>
</li>
<li><p><code>vcvtsi2ss/vcvtsi2sd/vcvtsi2ssq/vcvtsi2sdq</code>;</p>
<blockquote>
<p>æœ‰ç‚¹é•¿ï¼Œä½†æ˜¯å‘½åè§„èŒƒæ¸…æ¥šï¼š</p>
<p><code>vcvt</code> æ˜¯ <code>cvt</code> ç±»å‘½ä»¤çš„å‰ç¼€ï¼›</p>
<p>ä¸­é—´æœ‰ <code>t</code> è¡¨ç¤º truncationï¼Œè¿›è¡Œæˆªæ–­ï¼ˆ<strong>å‡ºç°åœ¨æµ®ç‚¹å‘æ•´å‹çš„è½¬æ¢ä¸­</strong>ï¼‰ï¼›</p>
<p>åç¼€ <code>XX2YY</code> æ˜¯ ä» <code>XX</code> ç±»å‹è½¬æ¢åˆ° <code>YY</code> ç±»å‹çš„æ„æ€ï¼Œ<code>XX/YY</code> å¯å–çš„å€¼æœ‰ï¼š<code>ss/sd/ssq/sdq/si(integer, 32-bit)/siq(integer, 64-bit)</code>;</p>
</blockquote>
</li>
</ul>
</li>
<li><p>arithmetic ç±»å‘½ä»¤ï¼š<code>vaddss/vsubss/vmulss/vdivss/vmaxss/vminss/vxorps/xandps/sqrtss/...</code></p>
<blockquote>
<p>æ–°çš„æŒ‡ä»¤åï¼š<code>sqrt</code>ï¼Œä¹‹å‰ integer registers çš„æŒ‡ä»¤æ‰€æ²¡æœ‰çš„ï¼›</p>
</blockquote>
</li>
<li><p>æ¯”è¾ƒç±»å‘½ä»¤ï¼ˆå’Œ SSE3 ç›¸åŒï¼‰ï¼š<code>ucomiss/ucomisd</code>;</p>
</li>
</ul>
<h3 id="6-4-Summary-for-Chapter-6"><a href="#6-4-Summary-for-Chapter-6" class="headerlink" title="6.4 Summary for Chapter 6"></a>6.4 Summary for Chapter 6</h3><p>æœ¬ç« çš„å†…å®¹å¯†åº¦ä¹Ÿç›¸å½“ä¹‹å¤§ï¼Œæœ‰å¿…è¦æ€»ç»“å›é¡¾ä¸€ä¸‹æœ¬ç« æ‰€å­¦çš„å…¨éƒ¨å†…å®¹ã€‚</p>
<p>æœ¬ç« çš„ä¸€å¼€å§‹æˆ‘ä»¬å¤ä¹ äº† C/C++ ä¸­æŒ‡é’ˆå’Œæ•°ç»„çš„å‡†ç¡®å®šä¹‰ï¼Œä»åˆ†æ<strong>äºŒè€…çš„ä½¿ç”¨æ–¹å¼</strong>å’Œ <strong>2 ç§åŒºåˆ«ï¼ˆå¸¸é‡æ€§ã€ç©ºé—´åˆ†é…çš„è‡ªä¸»æ€§ï¼‰</strong>æ–¹é¢å…¥æ‰‹ï¼Œä»è¾ƒæ·±çš„è§’åº¦è€ƒè™‘äº† <strong>æ•°ç»„æ ‡è¯†ç¬¦çš„å«ä¹‰å’Œå¤šç§å£°æ˜æ–¹å¼</strong>ï¼Œä»¥åŠè¿™äº›å£°æ˜æ–¹å¼å¦‚ä½•é˜…è¯»ã€å¦‚ä½•ç†è§£ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½å‡†ç¡®åœ°å›ç­”ï¼šä¸åŒæ ‡è¯†ç¬¦çš„ <code>sizeof</code> åˆ¤æ–­é—®é¢˜ã€ç©ºæŒ‡é’ˆ/é‡æŒ‡é’ˆçš„å‡ºç°é—®é¢˜ï¼Œä¹Ÿæœ‰åŠ©äºæˆ‘ä»¬ç†è§£åœ¨æ±‡ç¼–ä¸­æ•°ç»„çš„å‘ˆç°æ–¹å¼ã€‚</p>
<p>åœ¨äº†è§£æ•°ç»„åœ¨ C/C++ ä¸­çš„åœ°ä½åï¼Œæˆ‘ä»¬å…ˆè®¨è®ºäº†æ™®é€šä¸€ç»´æ•°ç»„çš„<strong>å†…å­˜åˆ†å¸ƒ</strong>å’Œ<strong>è®¿é—®æ–¹å¼</strong>ã€‚</p>
<p>æ— è®ºæ˜¯å­˜åœ¨äºç¨‹åºæ ˆå¸§ä¸­çš„ä¸€ç»´æ•°ç»„ï¼ˆ<code>T[]</code> å£°æ˜æ³•ï¼‰ï¼Œè¿˜æ˜¯å­˜åœ¨äºå †ä¸­çš„ä¸€ç»´æ•°ç»„ï¼ˆ<code>T*</code> å£°æ˜æ³•ï¼‰ï¼Œå®ƒä»¬çš„æ’å¸ƒéƒ½æ˜¯ä½äº<strong>è¿ç»­çš„</strong>ã€ <strong><code>L * sizeof(T)</code> å¤§å°çš„</strong>å†…å­˜ç©ºé—´ä¸­ï¼Œæ•°ç»„æ ‡è¯†ç¬¦å¯ä»¥çœ‹ä½œæŒ‡å‘å¼€å¤´ä½ç½®çš„æŒ‡é’ˆå¸¸é‡ã€‚å› æ­¤ï¼Œå¯¹äºä¸€ç»´æ•°ç»„çš„æ±‡ç¼–è®¿é—®å°±æ˜¯çœ‹ä½œ<strong>ä¸€ä¸²è¿ç»­çš„åŒç±»å‹æ•°æ®æ’å¸ƒ</strong>ï¼ŒæŒ‰ç…§ Simple Memory Address Mode è¿›è¡Œç´¢å¼•å³å¯ã€‚</p>
<p>è€Œåæˆ‘ä»¬ä»æ’å®šçš„ï¼ˆ<code>constexpr</code>ï¼Œç¼–è¯‘å‰ç¡®å®šï¼‰æ•°ç»„è§„æ¨¡å‡ºå‘ï¼Œè¿›ä¸€æ­¥å­¦ä¹ äºŒç»´æ•°ç»„çš„æƒ…å†µã€‚</p>
<p>ç”±äº C/C++ çš„è¯­è¨€ç‰¹æ€§ï¼ŒäºŒç»´æ•°ç»„çš„ä¸¤ç§å£°æ˜æ–¹å¼ï¼ˆNested array <code>T[][]</code> å’Œ Multi-level array <code>T*[]</code>ï¼‰ï¼Œ<strong>å°½ç®¡äºŒè€…çš„ä½¿ç”¨æ–¹æ³•å‡ ä¹ä¸€è‡´</strong>ï¼Œä½†æ‰€å¯¹åº”çš„<strong>å†…å­˜æ’å¸ƒæ–¹å¼ å’Œ æ±‡ç¼–æ“ä½œæ€§è´¨å®Œå…¨ä¸åŒ</strong>ã€‚</p>
<p>å‰è€…åœ¨å£°æ˜æ—¶ï¼Œæ‰€æœ‰å…ƒç´ çš„ç©ºé—´éƒ½ä¼šè¢«è‡ªåŠ¨åˆ†é…è‡³æ ˆä¸­ï¼Œå¹¶ä¸”ä»¥ â€œRow majorâ€ çš„æ–¹å¼<strong>è¿ç»­æ’å¸ƒ</strong>ï¼›è€Œåè€…åˆ™ä»…æœ‰ä¸€çº§å…ƒç´ ï¼ˆ<code>T*</code>ï¼‰è¢«è‡ªåŠ¨åˆ†é…ç©ºé—´ï¼Œå¹¶ä¸”æŒ‡å‘çš„æ¯ä¸€è¡Œæ•°ç»„ä¹‹é—´çš„å­˜å‚¨ä½ç½®<strong>å¯ä»¥ä¸è¿ç»­</strong>ã€‚</p>
<p>å†…å­˜ç»“æ„ä¸Šçš„å·®å¼‚å°±å†³å®šäº†è¿™ä¸¤ç§æ•°ç»„åœ¨æ±‡ç¼–ä»£ç è®¿é—®æ–¹å¼çš„ä¸ä¸€è‡´ã€‚è®¿é—® Nested Array çš„æŸä¸ªå…ƒç´ æ—¶ï¼Œåªéœ€è¦å¯¹<strong>æ•°ç»„æ ‡è¯†ç¬¦</strong>å’Œ<strong>ç´¢å¼•</strong>è¿›è¡Œç®—æœ¯è®¡ç®—ï¼ˆ<code>&amp;A[i][j] == A + i * C * sizeof(T) + j * sizeof(T)</code>ï¼‰å°±èƒ½å¾—åˆ°ç›¸åº”åœ°å€ï¼›è€Œè®¿é—® Multi-Level Array æ—¶å´å¿…é¡»å…ˆç”±<strong>æ•°ç»„æ ‡è¯†ç¬¦</strong>å’Œ<strong>è¡Œå‚æ•°</strong>æ‰¾åˆ°ä¸€çº§å…ƒç´ å†…å®¹ï¼Œç„¶åç”¨<strong>ä¸€çº§å…ƒç´ å†…å®¹</strong>å’Œ<strong>åˆ—ç´¢å¼•</strong>æ‰èƒ½å®šä½å…·ä½“çš„å…ƒç´ ä½ç½®ã€‚</p>
<p>è®¨è®ºå®Œå›ºå®šè§„æ¨¡äºŒç»´æ•°ç»„çš„å†…å­˜æ’å¸ƒå’Œè®¿é—®æ–¹å¼åï¼Œæˆ‘ä»¬å°†çœ¼å…‰æ‹“å±•åˆ°å¯å˜è§„æ¨¡çš„ Nested Arrayï¼ˆå³ M Ã— N Matrixï¼‰ä¸Šã€‚æŒ‰ç…§æ‰€æŒæ¡çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»æ™®é€šå›ºå®šè§„æ¨¡çš„ä¸¤ç§äºŒç»´æ•°ç»„å‡ºå‘ï¼Œç±»æ¯”å‡ºè®¿é—®è¿™ç§å¯å˜è§„æ¨¡äºŒç»´æ•°ç»„çš„æ±‡ç¼–å®ç°ã€‚</p>
<p>èšåˆç»“æ„é™¤äº†æ•°ç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„éƒ¨åˆ†â€”â€”ç»“æ„ä½“ï¼Œä¹Ÿæ˜¯ C++ ä¸­ç±»çš„å‰èº«ã€‚</p>
<p>ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºéµå¾ªç®€å•çš„ 3 æ¡åŸåˆ™ï¼š<strong>è¿ç»­æ’å¸ƒ</strong>ã€<strong>ä¸¥æ ¼æŒ‰å£°æ˜é¡ºåº</strong>ã€<strong>ç¼–è¯‘å™¨å†³å®šå­—æ®µå†…å­˜å¯¹é½</strong>ã€‚</p>
<p>åœ¨è§‚å¯Ÿå‡ ä¸ªä¾‹å­åï¼Œæˆ‘ä»¬å‘ç°åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œç»“æ„ä½“çš„æ¯ä¸ªç¨‹åºç´§å¯†æ’å¸ƒï¼Œè®¿é—®æ–¹å¼ä¸æ•°ç»„ç›¸è¿‘ï¼›ä½†æœ‰äº›æƒ…å†µç¼–è¯‘å™¨ä¼šåœ¨æˆå‘˜é—´æ’å…¥ç©ºç™½æ•°æ®æ®µï¼ˆä¹Ÿè®¡å…¥æ•°æ®ç»“æ„çš„æ€»å¤§å°ï¼‰ã€‚äºæ˜¯æˆ‘ä»¬åˆ†æäº†<strong>ç»“æ„ä½“å†…å­˜å¯¹é½</strong>çš„ä¸¤ç‚¹<strong>ç°å®åŸå› </strong>å’Œä¸¤ç‚¹<strong>å¯¹é½çš„åŸåˆ™</strong>ï¼ˆâ€œèµ·å§‹åœ°å€æ•´é™¤åŸåˆ™â€ã€â€œæœ€å¤§å€æ•°åŸåˆ™â€ï¼‰ï¼›æˆ‘ä»¬æ ¹æ®è¿™äº›åŸåˆ™èƒ½å¤Ÿæ­£ç¡®è®¤è¯†ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æƒ…å†µï¼Œå¹¶ä»¥æ­¤å¯¹ç¨‹åºè¿›è¡Œå­˜å‚¨æ–¹é¢ï¼ˆ<strong>å¦‚ä½•å£°æ˜ç»“æ„ä½“æˆå‘˜ï¼Œä»¥è·å¾—æœ€å°çš„å ç”¨ç©ºé—´</strong>ï¼‰å’Œæ€§èƒ½æ–¹é¢çš„æ”¹è¿›ã€‚</p>
<p>å¯¹äºç»“æ„ä½“æ‰€ç»„æˆçš„æ•°ç»„ï¼Œåˆ™å¯ä»¥çœ‹æˆå®Œæ•´çš„ç»“æ„ä½“æ‰€ä¸ºä¸€ä¸ªåŸºæœ¬å…ƒç´ æ‰€ç»„æˆçš„æ•°ç»„ï¼Œä¸€çº§ç´¢å¼•æ–¹å¼ä¸æ™®é€šæ•°ç»„ç›¸åŒï¼ŒäºŒçº§ç´¢å¼•æ–¹å¼å’Œå•ä¸€ç»“æ„ä½“ç›¸åŒï¼Œåœ¨æ±‡ç¼–å±‚é¢<strong>å…±åŒæ„æˆç»“æ„ä½“æ•°ç»„é’ˆå¯¹å•ä¸ªå…ƒç´ ã€å•ä¸ªæˆå‘˜çš„ç´¢å¼•è¡¨è¾¾å¼</strong>ã€‚</p>
<p>è™½ç„¶èšåˆç»“æ„å¯¹äºæ±‡ç¼–å±‚é¢æ¥è¯´å®Œå…¨é€æ˜ï¼Œä½†ä»¥ä¸Šå»ºç«‹çš„è§„åˆ™å’Œçº¦å®šè®©åº•å±‚çš„ä¸€ä¸ªä¸ªæŒ‡ä»¤å…±åŒå®ç°äº†èšåˆç»“æ„çš„é«˜çº§åŠŸèƒ½ã€‚</p>
<p>é™¤äº†é˜æ˜èšåˆç»“æ„åœ¨æ±‡ç¼–å±‚é¢çš„å®ç°ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æ•´ç†äº†éå¸¸å¤šçš„ <code>mov</code> æŒ‡ä»¤ã€‚ä»ä¸­æˆ‘ä»¬å½’çº³å‡ºäº†<strong>æŒ‡ä»¤å‘½åçš„è§„åˆ™</strong>ï¼Œè¿™ä¸ªè§„åˆ™é€‚ç”¨äºå…¶ä»–å‡ ä¹æ‰€æœ‰æŒ‡ä»¤ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬<strong>å°‘è®°å¿†æŒ‡ä»¤</strong>ã€<strong>åœ¨é‡åˆ°æ²¡æœ‰è§è¿‡çš„æŒ‡ä»¤æ—¶èƒ½å¤Ÿæ¨æµ‹å‡ºå…¶å¤§è‡´ä½œç”¨</strong>ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬æåŠäº†æµ®ç‚¹æ•°æŒ‡ä»¤çš„å†å²ï¼ŒåŠå…¶åœ¨å†…å­˜ä¸­çš„æ•´ä½“å­˜å‚¨ã€æ±‡ç¼–å±‚é¢çš„ä½¿ç”¨ã€‚</p>
<p>åœ¨ SSE3 æŒ‡ä»¤æ‹“å±•é›†ä¸­ï¼Œ16 ä¸ª <code>XMM</code> Register æ—¢å¯ä»¥å­˜å‚¨æ ‡é‡æ•°æ®ï¼Œåˆå¯ä»¥å­˜å‚¨æˆç»„çš„æ•°æ®ï¼›æ—¢å¯ä»¥å­˜æ”¾å„ç§æ•°æ®ç±»å‹çš„æ•´å‹æ•°æ®ï¼Œåˆå¯ä»¥å­˜æ”¾å„ç§æ•°æ®ç±»å‹çš„æµ®ç‚¹å‹æ•°æ®ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ¥è§¦åˆ°äº†ä¸¤ç±»è¿ç®—æ–¹æ³•ï¼ˆScalar Op å’Œ SIMD Opï¼‰åŠå…¶å¯¹åº”çš„æŒ‡ä»¤ï¼Œä½¿ç”¨æ–¹æ³•å’Œæ•´å‹çš„æƒ…å†µç›¸è¿‘ã€‚</p>
<p>æ­¤å¤–ï¼Œå…³äº FP Register çš„ Saving Conventionsã€æ¯”è¾ƒæŒ‡ä»¤å’Œå¸¸æ•°çš„ä½¿ç”¨ï¼Œè¿›ä¸€æ­¥åŠ æ·±äº†æˆ‘ä»¬å¯¹æµ®ç‚¹æ•°çš„æ±‡ç¼–æ“ä½œçš„ç†è§£ã€‚</p>
<p>å¦å¤–ä»‹ç»çš„ AVX Instructions æœ‰åŠ©äºå¸®åŠ©æˆ‘ä»¬ç†è§£æŸäº›æµ®ç‚¹æ•°æ“ä½œçš„æ±‡ç¼–ä»£ç çš„å«ä¹‰ã€‚</p>
<h2 id="Chapter-7-Machine-Level-Programming-â…¤-Advanced"><a href="#Chapter-7-Machine-Level-Programming-â…¤-Advanced" class="headerlink" title="Chapter 7. Machine Level Programming â…¤ - Advanced"></a>Chapter 7. Machine Level Programming â…¤ - Advanced</h2><h3 id="7-1-Memory-Layout-in-x86-64"><a href="#7-1-Memory-Layout-in-x86-64" class="headerlink" title="7.1 Memory Layout in x86-64"></a>7.1 Memory Layout in x86-64</h3><p>å†…å­˜ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å­—èŠ‚æ•°ç»„ã€‚è€Œä¹‹å‰è§‚å¯Ÿ memory çš„è§’åº¦è¦ä¹ˆæ˜¯ä»æ±‡ç¼– Simple Memory Address Mode çš„è®¿é—®è§’åº¦ï¼Œè¦ä¹ˆæ˜¯ä» x86-64 çš„ç¨‹åºæ ˆçš„è§’åº¦æ¥çœ‹å†…å­˜çš„ã€‚æœ¬èŠ‚å°†ä»<strong>æ›´ä¸ºå®è§‚ã€æ›´ä¸ºå®Œæ•´</strong>çš„è§’åº¦ä»‹ç» <strong>x86-64 Linux çš„å®Œæ•´å†…å­˜å¸ƒå±€</strong>ã€‚</p>
<p>é¦–å…ˆï¼Œä» 64 ä½ç³»ç»Ÿçš„ç‰¹å¾ä¸Šæ¥è¯´ï¼Œx86-64 ç³»ç»Ÿä¸Šçš„ç¨‹åºæ‰€èƒ½è®¿é—®çš„å†…å­˜ç©ºé—´åº”è¯¥æ˜¯ $2^{64}$ bitsï¼ˆå¤§çº¦ $16\times10^{18}$ bitsï¼‰ï¼Œä½†ç”±äºå½“å‰å­˜å‚¨æŠ€æœ¯çš„ç§ç§é™åˆ¶ï¼Œå½“å‰çš„ç¡¬ä»¶é™åˆ¶æˆ‘ä»¬åªèƒ½ä½¿ç”¨æœ€é«˜ 47 ä½çš„åœ°å€ï¼ˆå¤§çº¦ $128\times10^{12}$ bitsï¼Œ128 TBï¼‰ã€‚</p>
<p>åœ¨è¿™ä¸ªé™åˆ¶ä¸‹ï¼Œæˆ‘ä»¬çœ‹ä¸€çœ‹ç³»ç»Ÿæä¾›ç»™ç¨‹åºçš„è¿è¡Œå†…å­˜çš„ç»“æ„ï¼š</p>
<p><img src="imgs/memory.png" height="400px"></p>
<ul>
<li><p>æœ€åº•å±‚çš„ 128 MB æ˜¯æ ˆåŒºï¼ˆ<code>0x0000 7FFF FFFF 0000</code>ï¼Œå³ $2^{47}-4096$ è‡³ <code>0x0000 7FFF F800 0000</code>ï¼‰ï¼Œå®é™… x86-64 æ ˆçš„<strong>å®é™…æœ€å¤§å¤§å°</strong>åœ¨ 8 MB å·¦å³ï¼Œå‘ä½åœ°å€å¢é•¿ã€‚æ ˆçš„ç»“æ„å‚è€ƒ 5.2 å’Œ 5.3ã€‚</p>
<blockquote>
<ol>
<li>ä¸€èˆ¬æ“ä½œç³»ç»Ÿä¸ºäº†ä¿æŠ¤æ ˆæ•°æ®ä¸è¢«æ”»å‡»ï¼Œä¸€èˆ¬åœ¨æ ˆçš„å‰åæ”¾ç½®éšæœºæ•°æ®åŒºåŸŸï¼›å¦‚æœæ²¡æœ‰è¿™äº›ä¿æŠ¤æ•°æ®ï¼Œé‚£ä¹ˆæ ˆå°±æ”¾åœ¨å†…å­˜æœ€åº•å±‚ï¼ˆ<code>0x0000 7FFF FFFF 0000</code> çš„ä½ç½®ï¼‰.</li>
<li>å¦‚æœè¿è¡Œä¸­çš„ç¨‹åº<strong>è¯•å›¾è®¿é—®è¶…è¿‡è¿™é‡Œ 8 MB é™åˆ¶èŒƒå›´çš„åœ°å€</strong>ï¼Œæˆ–è€…<strong>è®¿é—®çš„åœ°å€è¿˜æ²¡æœ‰é€šè¿‡ virtual memory allocator çš„åˆ†é…</strong>æ—¶ï¼Œç³»ç»Ÿä¼šæŠ›å‡º segmentation faultï¼Œå¹¶å¼ºåˆ¶ç»“æŸç¨‹åºï¼›</li>
</ol>
</blockquote>
</li>
<li><p>åœ¨ä»æœ€ä¸‹é¢çœ‹èµ·ï¼Œä½ç½® <code>0x40 0000</code> å¼€å§‹å‘é«˜åœ°å€ä½ç½®ï¼Œæœ‰ä¸€æ®µ text åŒºï¼ˆæ‰¾ä¸åˆ°è¿™ä¸ªåå­—çš„æ¥æºï¼‰ï¼Œæ˜¯ç¨‹åºå­˜æ”¾è¿è¡Œæœºå™¨ä»£ç çš„ä½ç½®ï¼ˆä¿¡æ¯ä»å¯æ‰§è¡Œæ–‡ä»¶è¯»å…¥ï¼‰ã€‚<strong>æˆ‘ä»¬å°†åœ¨ â€œé“¾æ¥â€ ä¸€ç« è¯¦ç»†è®¨è®ºè¿™ä¸ªéƒ¨åˆ†çš„å…·ä½“å†…å®¹</strong>ã€‚æ•°æ®åªè¯»ï¼ˆRead Onlyï¼‰ï¼›</p>
</li>
<li><p>å†ä¸‹é¢ä¸€æ®µæ˜¯ Data åŒºï¼Œ<strong>æ˜¯ç”¨æ¥å­˜æ”¾ç¨‹åºå¼€å§‹æ—¶å°±åˆ†é…çš„æ•°æ®</strong>ã€‚å­˜æ”¾çš„å†…å®¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>é™æ€åˆ†é…çš„æ•°æ®ï¼›</li>
<li>ç¨‹åºä¸­çš„å…¨å±€å˜é‡ã€é™æ€å€¼ã€å­—ç¬¦ä¸²å¸¸é‡ï¼›</li>
<li>â€¦â€¦</li>
</ul>
</li>
<li><p>å†ä¸‹é¢ä¸€æ®µæ˜¯å †ã€‚å †å’Œæ ˆçš„åˆ†é…æ–¹å¼<strong>å®Œå…¨ä¸åŒ</strong>ï¼Œå †ç©ºé—´åœ¨è¿è¡Œæ—¶æŒ‰ä»£ç <strong>åŠ¨æ€åˆ†é…</strong>ï¼ˆdynamically allocatedï¼Œä¸€èˆ¬ç”± malloc()ã€calloc()ã€new ç­‰æ–¹æ³•åˆ›å»ºï¼Œfree()ã€delete ç­‰æ–¹æ³•é”€æ¯ï¼‰ï¼Œæœ€æœ‰è¶£çš„æ˜¯ï¼Œå †çš„åˆ†é…ä½ç½®å’Œç”Ÿé•¿æ–¹å‘ä¸å›ºå®šï¼›ä¸‹é¢å°†ç”±ä¾‹å­æ¥è¯´æ˜ï¼›</p>
</li>
<li><p>å †ä¸‹é¢æœ‰ä¸€æ®µç©ºé—´çš„ä½ç½®æ˜¯å¤–éƒ¨åº“ï¼ˆShared Librariesï¼‰ï¼Œå­˜å‚¨çš„æ˜¯ç±»ä¼¼ malloc()ã€printf() çš„åº“å‡½æ•°ã€‚å®ƒä»¬ä¸€å¼€å§‹æ˜¯<strong>ä½œä¸ºåŠ¨æ€é“¾æ¥åº“å­˜å‚¨äºç£ç›˜ä¸Š</strong>ï¼Œåœ¨ç¨‹åºåŠ è½½æ—¶ï¼Œå®ƒä»¬ä¹Ÿè½½å…¥å†…å­˜çš„è¿™ä¸ªä½ç½®ï¼Œä¾›ç¨‹åºä½¿ç”¨ï¼Œç§°ä¸º<strong>åŠ¨æ€åŠ è½½</strong>ã€‚<strong>æˆ‘ä»¬å°†åœ¨ â€œåŠ¨æ€é“¾æ¥â€ è¿™ä¸€éƒ¨åˆ†è¯¦ç»†è®¨è®ºå…·ä½“å†…å®¹</strong>ã€‚</p>
</li>
</ul>
<p>æˆ‘ä»¬è¿è¡Œä¸‹é¢çš„ç¨‹åºè¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> big_array[<span class="number">8388608L</span>];        <span class="comment">/* 1&lt;&lt;24, 16 MB */</span></span><br><span class="line"><span class="type">char</span> huge_array[<span class="number">1073741824L</span>];    <span class="comment">/* 1&lt;&lt;31, 2 GB */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">useless</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">void</span> *phuge1, *psmall2, *phuge3, *psmall4;</span><br><span class="line">    <span class="type">int</span> local = <span class="number">0</span>;</span><br><span class="line">    phuge1 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">28</span>);    <span class="comment">/* 256 MB */</span></span><br><span class="line">    psmall2 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">8</span>);    <span class="comment">/* 256 B */</span></span><br><span class="line">    phuge3 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">32</span>);    <span class="comment">/* 4 GB */</span></span><br><span class="line">    psmall4 = <span class="built_in">malloc</span>(<span class="number">1L</span> &lt;&lt; <span class="number">8</span>);    <span class="comment">/* 256 B */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ GDB è°ƒè¯•å¯ä»¥å‘ç°ï¼Œåœ¨ Linux å†…å­˜ä¸­ï¼Œ<code>big_array</code>ã€<code>huge_array</code> å’Œ <code>global</code> è¿™ä¸‰ä¸ªå…¨å±€å˜é‡åˆ†å¸ƒåœ¨å¤§è‡´ <code>0x600000</code> çš„ä½åœ°å€çš„ä½ç½®ï¼Œä½äº <strong>Data åŒº</strong>ï¼›å±€éƒ¨å˜é‡ <code>local</code> åœ¨åœ°å€ <code>0x7FFE 0000 0000</code> çš„å¤§è‡´ä½ç½®ï¼Œä½äº<strong>å†…å­˜æ ˆåŒº</strong>ï¼›å¯¹äºå‡½æ•° <code>main()</code> å’Œ <code>useless()</code> è€Œè¨€ï¼Œå®ƒä»¬çš„åœ°å€åœ¨ <code>0x400000</code> é™„è¿‘ï¼Œä½äº <strong>Text åŒº</strong>ï¼›</p>
<p>è€Œå¯¹äº <code>phuge1</code>ã€<code>psmall2</code>ã€<code>phuge3</code>ã€<code>psmall4</code> æ¥è¯´ç•¥æœ‰ç‰¹æ®Šã€‚å®ƒä»¬æ˜¯ä½¿ç”¨ <code>malloc</code> åˆ†é…åœ¨å †é‡Œçš„ï¼Œä½†æ˜¯å®ƒä»¬çš„ä½ç½®å·®åˆ«è¾ƒå¤§ï¼š<strong>å ç”¨ç©ºé—´å¾ˆå¤§çš„ <code>phuge1</code> å’Œ <code>phuge3</code> ä½äºæ›´é è¿‘æ ˆåŒºçš„å †ä¸­ï¼Œè€Œå ç”¨ç©ºé—´è¾ƒå°çš„ <code>psmall2</code> å’Œ <code>psmall4</code> åˆ™ä½äºæ›´é è¿‘ Data åŒºçš„å †ä¸­</strong>ã€‚å¤§è‡´æƒ…å†µå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="imgs/memory_pos.png" height="350px"></p>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œ<code>malloc</code> å¤§æ•°æ®é‡çš„å †åœ¨ä¸Šæ–¹å’Œ shared libraries ç´§è´´ï¼Œå‘ä½åœ°å€å¢é•¿ï¼›è€Œæ™®é€šæ•°æ®çš„å †åœ¨ Data åŒºçš„ä¸‹æ–¹å‘é«˜åœ°å€å¢é•¿ã€‚å¯ä»¥é¢„è§ï¼Œå½“ä¸¤å— heap ç¢°å¤´çš„æ—¶å€™ï¼Œ<code>malloc</code> ä¼šè¿”å›ç©ºæŒ‡é’ˆã€‚</p>
<p>è¿™ä¸ªè§„å¾‹ç›®å‰è¿˜æ²¡æœ‰è§£é‡Šï¼Œç­‰åˆ°ä»¥åçš„ç« èŠ‚æ…¢æ…¢äº†è§£ã€‚</p>
<h3 id="7-2-Buffer-Overflow"><a href="#7-2-Buffer-Overflow" class="headerlink" title="7.2 Buffer Overflow"></a>7.2 Buffer Overflow</h3><p>åœ¨ Chapter 0-0.3 çš„è¶Šç•Œå®éªŒä¸­ï¼Œæˆ‘ä»¬å°±è®¨è®ºè¿‡å†…å­˜ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ã€‚å½“æ—¶é€ æˆçš„åæœæ˜¯ç»“æ„ä½“ä¸­çš„å…¶ä»–æˆå‘˜çš„æ•°æ®è¢«ä¿®æ”¹ã€‚æœ¬èŠ‚ä¼šè¯¦ç»†è§£é‡Šå†…å­˜ç¼“å†²åŒºæº¢å‡ºçš„å„ä¸ªæ–¹é¢çš„å½±å“å’Œåº”å½“æªæ–½ã€‚</p>
<h4 id="7-2-1-The-Vulnerability"><a href="#7-2-1-The-Vulnerability" class="headerlink" title="7.2.1 The Vulnerability"></a>7.2.1 The Vulnerability</h4><p>ç»§ç»­ä»¥ 0.3 ä¸­çš„å®éªŒä»£ç ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> a[<span class="number">2</span>];</span><br><span class="line">    <span class="type">double</span> d;</span><br><span class="line">&#125; <span class="type">struct_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> <span class="title function_">fun</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">struct_t</span> s;    <span class="comment">/* volatile å…³é”®å­—è¡¨ç¤ºæ˜“å˜é‡ï¼Œè­¦å‘Šç¼–è¯‘å™¨ä¸è¿›è¡Œä»»ä½•ä¼˜åŒ– */</span></span><br><span class="line">    s.d = <span class="number">3.14</span>;</span><br><span class="line">    s.a[i] = <span class="number">1073741824</span>;    <span class="comment">/* Possibly out of bounds */</span></span><br><span class="line">    <span class="keyword">return</span> s.d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ <code>i</code> å‚æ•°å–å€¼å¤§äº 1 æ—¶ä¼šæ±¡æŸ“ <code>s.d</code> çš„å€¼ï¼Œå½“ <code>i</code> å‚æ•°å¤§äº 6 æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç° segmentation faultï¼›</p>
<p>ä½†å†…å­˜ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ä¸ä»…ä»…æ˜¯å†…éƒ¨å¼€å‘è€…ç¼–å†™é”™è¯¯è¿™ä¸€ä¸ªå°é—®é¢˜ã€‚ç›¸åï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>å¤§é—®é¢˜</strong>ã€‚</p>
<ul>
<li>Buffer overflow çš„å‡ºç°ï¼šwhen <strong>exceeding</strong> the memory <strong>size</strong> allocated for <strong>an array</strong>;</li>
<li>Buffer overflow ä¸ºä»€ä¹ˆæ˜¯å¤§é—®é¢˜ï¼šå®ƒæ˜¯<strong>å¤´å·çš„æŠ€æœ¯å±‚é¢ä¸Šçš„å®‰å…¨æ¼æ´</strong>ï¼ˆ#1 technical cause of security vulnerabilitiesï¼‰ï¼›</li>
<li>Buffer overflow äº§ç”Ÿçš„åŸå› åˆ—ä¸¾ï¼š<ul>
<li>Unchecked lengths on string inputsï¼ˆå¤–éƒ¨å› ç´ ï¼š<strong>ä¸å¯¹è¾“å…¥å­—ç¬¦ä¸²çš„é•¿åº¦å’Œå†…å®¹è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥</strong>ï¼‰ï¼›</li>
<li>Illegal indexing / referring / modifying memoryï¼ˆå†…éƒ¨å› ç´ ï¼š<strong>ä¸å¯¹è®¿é—® memory çš„å‚æ•°è¿›è¡Œæ£€æŸ¥</strong>ï¼‰ï¼›</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢ä¸¾ä¸€ä¸ªå®é™…ç‚¹çš„ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get string from stdin */</span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">gets</span><span class="params">(<span class="type">char</span> *dest)</span> &#123;</span><br><span class="line">    <span class="type">int</span> c = getchar();        <span class="comment">/* get a single char from stdin */</span></span><br><span class="line">    <span class="type">char</span> *p = dest;            <span class="comment">/* the pointer p points to the same addr as dest */</span></span><br><span class="line">    <span class="keyword">while</span> (c != EOF &amp;&amp; c != <span class="string">&#x27;\n&#x27;</span>) &#123;    <span class="comment">/* reading stdin until new line or EOF */</span></span><br><span class="line">        *p++ = c;            <span class="comment">/* add the value of p directly. (A problem ?) */</span></span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    *p = <span class="string">&#x27;\0&#x27;</span>;                <span class="comment">/* the dest char must ends with &#x27;\0&#x27; */</span></span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Echo Line */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">echo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">4</span>];            <span class="comment">/* Way too small */</span></span><br><span class="line">    gets(buf);</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">call_echo</span><span class="params">()</span> &#123; echo(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input a string: &quot;</span>);</span><br><span class="line">    call_echo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ <code>gets</code> å‡½æ•°ä¸ç®¡ <code>dest</code> çš„å®é™…è¢«åˆ†é…çš„å¤§å°ï¼Œç›´æ¥è¿›è¡Œè¾“å…¥ï¼Œå¾ˆå¯èƒ½åœ¨å†…å­˜ä¸­å‡ºç° Buffer Overflowã€‚äºæ˜¯æ€»ç»“å‡ºå¯¼è‡´ Buffer Overflow çš„ç½ªé­ç¥¸é¦–ä¹‹ä¸€ï¼š<strong>å­˜å‚¨å­—ç¬¦ä¸²ï¼Œå´ä¸æ£€æŸ¥è¾¹ç•Œæƒ…å†µçš„åº“å‡½æ•°</strong>ï¼›C åº“é‡Œæœ‰å¾ˆå¤šè¿™æ ·ä¸æ£€æŸ¥è¾¹ç•Œçš„åº“å‡½æ•°ï¼š<code>scanf</code>ã€<code>fscanf</code>ã€<code>sscanf</code>ï¼ˆç­‰ <code>scanf</code> å®¶æ—ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨ <code>%s</code> æ ¼å¼åŒ–å‚é‡ï¼‰ã€<code>strcpy</code>ã€<code>strcat</code>ï¼ˆç­‰å­—ç¬¦ä¸²ç§»åŠ¨å®¶æ—ï¼‰â€¦â€¦</p>
<p>ç°åœ¨çœ‹çœ‹è¿è¡Œè¿™ä¸ªç¨‹åºä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼ˆå¦‚æœè‡ªå·±æƒ³è¯•è¯•çš„è¯ï¼Œè®°å¾—<strong>å…³é—­ gcc æ ˆä¿æŠ¤ <code>-fno-stack-protector</code></strong>ï¼‰ï¼š</p>
<ul>
<li>å¦‚æœè¾“å…¥çŸ­ä¸€ç‚¹çš„å­—ç¬¦ä¸²ï¼ˆé•¿åº¦å°äº 24 ä¸ªï¼‰ï¼Œé‚£ä¹ˆç¨‹åºå¾ˆå¯èƒ½ä¼šæ­£å¸¸è¿è¡Œï¼›</li>
<li>å¦‚æœè¾“å…¥å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆç¨‹åºä¼šæŠ¥å‘Š segmentation faultï¼›</li>
</ul>
<p>é‚£ä¹ˆï¼Œéƒ½æ˜¯ç¼“å†²åŒºæº¢å‡ºï¼Œä¸ºä»€ä¹ˆçŸ­ä¸€ç‚¹çš„çœ‹èµ·æ¥ä¸ä¼šå‡ºé—®é¢˜å‘¢ï¼Ÿè¿™æ—¶å€™å°±éœ€è¦ä»æ±‡ç¼–ä»£ç è§£é‡Šäº†ã€‚æˆ‘ä»¬ç”Ÿæˆä¸Šé¢çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">echo:</span><br><span class="line">    sub		$0x18, %rsp</span><br><span class="line">    mov		%rsp, %rdi</span><br><span class="line">    callq	400680 &lt;gets&gt;</span><br><span class="line">    mov		%rsp, %rdi</span><br><span class="line">    callq	400520 &lt;puts@plt&gt;</span><br><span class="line">    add		$0x18, %rsp</span><br><span class="line">    retq</span><br><span class="line">call_echo:</span><br><span class="line">    sub		$0x8, %rsp</span><br><span class="line">    mov		$0x0, %eax</span><br><span class="line">    callq	4006cf &lt;echo&gt;</span><br><span class="line">    add		$0x8, %rsp</span><br><span class="line">    retq</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè§‚å¯Ÿï¼Œä¸€å¼€å§‹ç³»ç»Ÿä¸º <code>echo</code> å‡½æ•°çš„æ ˆå¸§åˆ†é…äº† 24 bytesï¼ˆ<code>0x18</code>ï¼‰çš„ç©ºé—´ï¼Œ<strong>å› æ­¤ï¼Œå¦‚æœè¾“å…¥çš„è¾“å‡ºåŠ å…¥è¶…è¿‡äº†æ‰€æœ‰çš„æ ˆç©ºé—´ï¼Œè¿›å…¥æ²¡æœ‰è¢«åˆ†é…çš„ memory æ—¶ï¼Œå°±ä¼šæŠ¥å‘Š segmentation fault</strong>ã€‚</p>
<p>æ‰€ä»¥ï¼Œï¼ˆ<strong>å½“æ²¡æœ‰ä½¿ç”¨ <code>gcc</code> æ ˆä¿æŠ¤æœºåˆ¶æ—¶</strong>ï¼‰å®‰å…¨é—®é¢˜é€šå¸¸å°±å‡ºç°åœ¨ â€œæº¢å‡ºå†…å®¹è¶…è¿‡äº†åŸæ¥åˆ†é…çš„ä½ç½®ï¼Œä½†æ˜¯æ²¡æœ‰è¶…è¿‡æ ˆçš„æ€»ä½“ç©ºé—´â€ è¿™ç§æƒ…å†µä¸‹ã€‚è¿™æ—¶ç³»ç»Ÿä¸ä¼šæŠ›å‡º segmentation faultï¼Œ<strong>æ ˆä¸­æ•°æ®åªèƒ½ä»»ç”±è¾“å…¥è€…ç¯¡æ”¹</strong>ã€‚</p>
<p>å†æ¥çœ‹çœ‹å†…å­˜å¯¹åº”çš„æƒ…å†µï¼š</p>
<p><img src="imgs/buffer_overflow_example1.png" height="260px"><img src="imgs/buffer_overflow_example1_2.png" height="260px"><img src="imgs/buffer_overflow_example1_3.png" height="260px"></p>
<p>å¦‚ä¸Šå·¦å›¾ï¼Œå½“ <code>char buf[4]</code> å£°æ˜åï¼Œåœ¨ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œç¼–è¯‘å™¨ä¸º<code>echo</code> é¢„ç•™äº† 24 bytes çš„ç©ºé—´ï¼›<code>echo</code> æ ˆå¸§çš„æœ€é¡¶å±‚å­˜æ”¾çš„æ˜¯å±€éƒ¨å˜é‡ <code>buf</code> æ•°ç»„å¯¹åº”çš„ç©ºé—´å¤§å°æ˜¯ 4 bytesï¼Œä¸€åˆ‡éƒ½å¾ˆæ­£å¸¸ã€‚</p>
<p>å¦‚ä¸Šä¸­å›¾ï¼Œæˆ‘ä»¬ä¸å¦¨å‡è®¾ <code>call_echo</code> åœ¨ return address é‡Œå­˜æ”¾çš„åœ°å€æ˜¯ <code>0x4006C3</code>ï¼ˆ<code>echo</code> è¿è¡Œç»“æŸååº”è¯¥è¿”å›çš„åœ°å€ï¼‰ï¼›å¦‚æœè¾“å…¥å­—ç¬¦ä¸²å†…å®¹è¶…è¿‡äº† <code>buf</code> èƒ½æ‰¿å—çš„ 3 bytesï¼Œåˆ™ä¼šå‡ºç° buffer overflowï¼Œå¦‚å›¾ï¼Œæ•°æ®è¦†ç›–äº† <code>buf</code> ä¸‹æ–¹çš„ 20 bytes å…¶ä»–åŒºåŸŸçš„æ•°æ®ï¼Œä½†å› ä¸ºè¿™ä¸ªä¾‹å­ä¸­ï¼Œæ°å¥½é‚£ä¸ªåŒºåŸŸæ²¡æœ‰å­˜æ”¾å…¶ä»–æ•°æ®ï¼Œæ‰€ä»¥è¡¨é¢ä¸Šç¨‹åºæ²¡é—®é¢˜ï¼›</p>
<blockquote>
<p>å¦‚æœé‚£ 20 bytes ç©ºé—´æ”¾äº†å…¶ä»–æ•°æ®ï¼Œé‚£ä¹ˆä¼šè¢«ç¯¡æ”¹ï¼›</p>
</blockquote>
<p>ä½†ï¼Œå¦‚æœè¾“å…¥é•¿åº¦æ›´é•¿ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²åºåˆ—ä¼šæº¢å‡ºçš„æ›´é•¿ï¼Œå¦‚ä¸Šå³å›¾æ‰€ç¤ºï¼Œæ±¡æŸ“äº† Return address çš„è¯ï¼Œé—®é¢˜å°±å‡ºç°äº†ã€‚å½“ echo æƒ³è¦ç»“æŸæ—¶ï¼Œä¼šå› ä¸º Return address è¢«ä¿®æ”¹è€Œè½¬ç§»åˆ°ä¸€ä¸ªä¸çŸ¥é“ä»€ä¹ˆçš„åœ°æ–¹ï¼Œå¾ˆå¯èƒ½å¯¼è‡´ segmentation faultï¼›<strong>æ›´ä¸¥é‡çš„ï¼Œå¦‚æœæ°å¥½è·³è½¬åˆ°ä¸€ä¸ªå¥‡æ€ªçš„å‡½æ•°ä¸­ï¼Œå¹¶ä¸”è¿˜èƒ½è¿è¡Œã€æ²¡æŠ¥é”™ï¼Œé‚£ä¹ˆåäº†ï¼Œç¨‹åºä¸ä¼šæŒ‰é¢„æœŸçš„æ–¹å¼ç»§ç»­è¿è¡Œï¼Œè¿™æ ·çš„ bug éå¸¸éšæ™¦</strong>ï¼›</p>
<h4 id="7-2-2-Stack-Smashing-Attacks"><a href="#7-2-2-Stack-Smashing-Attacks" class="headerlink" title="7.2.2 Stack Smashing Attacks"></a>7.2.2 Stack Smashing Attacks</h4><p>åœ¨ä¸Šé¢è¯´åˆ°çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ”»å‡»è€…æƒ³è¦å‡½æ•°åœ¨è¾“å…¥åï¼Œè·³è½¬åˆ°ä¸åº”è¯¥æ‰§è¡Œçš„ã€ä½†æ˜¯ç¨‹åºé‡Œé¢æœ‰çš„å‡½æ•°ä¸­ï¼Œä¼šè®©ç¨‹åºå‡ºç°ä¸€äº›æ„æ–™ä¹‹å¤–çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>ä¾‹å¦‚ç™»å½•åœºæ™¯ï¼šæ”»å‡»è€…æƒ³è¦è¾“å…¥ä¸€ä¸²å†…å®¹ï¼Œè®©è½¯ä»¶è·³è½¬åˆ°ç™»é™†æˆåŠŸçš„å‡½æ•°ä¸­;</p>
</blockquote>
<p>è¿™ç§æ”»å‡»è¢«ç§°ä¸º<strong>ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼ˆstack smashing attackï¼‰</strong>ï¼Œè¿™ç§æ”»å‡»å°±æ˜¯åˆ©ç”¨äº†æŠ€æœ¯äººå‘˜ä¸æ³¨æ„è¾“å…¥æ£€æŸ¥ï¼Œè€Œå¯¼è‡´çš„ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ã€‚</p>
<p>å®ç°è¿™ç§æ”»å‡»çš„åŸç†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯<strong>è¾“å…¥æ— æ„ä¹‰çš„å¡«å……å­—ç¬¦ï¼ˆpaddingï¼‰è®©è¾“å…¥çš„å†…å®¹ buffer overflowï¼Œå¹¶ä¸”åœ¨æœ«å°¾è®¾ç½®ä¸€ä¸ªæƒ³è¦è·³è½¬åˆ°çš„å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”åªéœ€è®©æœ«å°¾çš„åœ°å€æ°å¥½è¦†ç›– return address</strong> å°±è¡Œã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ­£å¸¸çš„æµç¨‹æ˜¯ <code>P()</code> è°ƒç”¨ <code>Q()</code>ï¼Œ<code>P</code> å‡½æ•°åœ¨ return address ä¸­å†™çš„æ˜¯ <code>A</code>ï¼Œä¹Ÿå°±æ˜¯ <code>P</code> å‡½æ•°ä¸­è°ƒç”¨ <code>Q</code> çš„ä¸‹ä¸€è¡Œï¼›ä½†ç”±äº <code>Q()</code> ä¸­çš„ <code>gets(buf)</code> æœ‰æº¢å‡ºé£é™©ï¼Œåœ¨æ”»å‡»è€…è¾“å…¥ <code>padding</code> å­—ç¬¦ + <code>S</code> åœ°å€ç»„åˆçš„å­—ç¬¦ä¸²åï¼Œ<code>gets</code> å‡½æ•°å°†ç¼“å†²åŒºæ•°æ®è¦†ç›–äº†ï¼Œå¦‚ä¸‹å›¾å³ï¼Œreturn address è¢«æ”¹æˆäº† <code>S</code> çš„åœ°å€ã€‚è¿™æ ·åœ¨ <code>Q()</code> æ‰§è¡Œç»“æŸåï¼Œä¼šè·³è½¬åˆ° <code>S()</code> å‡½æ•°ä¸­ï¼Œè€Œä¸æ˜¯åŸæ¥çš„ <code>P()</code> ä¸­ï¼š</p>
<p><img src="imgs/stack_smashing_attack.png" height="300px"></p>
<p>åšæ³•å¾ˆç®€å•ï¼Œä½†æ˜¯ç¼–è¯‘æ—¶è¦å…³é—­ <code>gcc</code> çš„æ ˆä¿æŠ¤æœºåˆ¶ï¼ˆ<code>-fno-stack-protector</code>ï¼‰ã€‚ç°åœ¨å¤§å¤šæ•° C/C++ ç¼–è¯‘å™¨éƒ½æœ‰è¿™é¡¹åŠŸèƒ½ï¼Œåˆ©ç”¨æ ˆéšæœºåŒ–ã€â€œé‡‘ä¸é›€â€ æ£€æŸ¥ç­‰æŠ€æœ¯ï¼Œæ‰“ä¹±æ ˆç©ºé—´çš„å®é™…æ’å¸ƒã€åˆ©ç”¨æ ˆä¸¤ç«¯çš„ â€œé‡‘ä¸é›€â€ ä¾¦æµ‹æ ˆæº¢å‡ºï¼Œå‘ç°å°±ç«‹å³ç»ˆæ­¢ç¨‹åºï¼Œè®©æ”»å‡»éš¾ä»¥è¿›è¡Œã€‚<strong>ï¼ˆåé¢ä¼šè¯¦ç»†è®¨è®ºï¼‰</strong></p>
<ol>
<li>æ‰¾åˆ°æœ‰å¯¼è‡´ç¼“å†²åŒºæº¢å‡ºé£é™©çš„å‡½æ•°ï¼ˆåƒä¹‹å‰æåˆ°çš„ <code>scanf</code> å®¶æ—ã€<code>str</code> å®¶æ—ï¼‰ï¼Œå¹¶ä¸”æŠ€æœ¯äººå‘˜æ²¡æœ‰ä¸ºè¿™äº›å‡½æ•°çš„è¾“å…¥è¿›è¡Œæ£€æŸ¥ï¼›</li>
<li>åæ±‡ç¼–æ‰¾åˆ°æƒ³è¦è·³è½¬çš„å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢çš„ <code>S</code>ï¼‰çš„åœ°å€ï¼›</li>
<li>åæ±‡ç¼–æ‰¾åˆ°æ±‡ç¼–ä»£ç ä¸­ç¼–è¯‘å™¨ä¸º <code>Q</code> å‡½æ•°åˆ†é…çš„æ ˆå¸§å¤§å°ï¼Œè®¡ç®—å‡º <code>pad</code> å¡«å……å­—ç¬¦çš„å¤§å°ï¼Œä½¿å¾— <code>S</code> åœ°å€æ°å¥½è¦†ç›– return addressï¼›</li>
<li>å°† padding æ•°æ® + <code>S</code> çš„åœ°å€ï¼ˆ<strong>æ³¨æ„å¤§å°ç«¯åºçš„é—®é¢˜</strong>ï¼‰è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè¿è¡Œç¨‹åºå¹¶è¾“å…¥å³å¯ã€‚</li>
</ol>
<h4 id="7-2-3-Code-Injection-Attacks"><a href="#7-2-3-Code-Injection-Attacks" class="headerlink" title="7.2.3 Code Injection Attacks"></a>7.2.3 Code Injection Attacks</h4><p>ä¹Ÿæ˜¯åœ¨ä¸Šé¢è¯´åˆ°çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰æ”»å‡»è€…åˆ»æ„å¦‚æ­¤è®¾ç½®ï¼Œè®©ç¼“å†²åŒºæº¢å‡ºåˆ° return addressï¼Œå¹¶ä¸”æ°å¥½è®© return address æŒ‡å‘æ”»å‡»è€…äº‹å…ˆè®¾è®¡å¥½çš„ exploit code ä¸­ï¼Œé‚£ä¹ˆç¨‹åºå°±ä¼šæ‰§è¡Œæ”»å‡»è€…è®¾è®¡çš„å‡½æ•°ï¼Œä»è€Œç»™è®¡ç®—æœºé€ æˆå¨èƒã€‚</p>
<p>è¿™ç§æ”»å‡»è¢«ç§°ä¸º <strong>ä»£ç æ³¨å…¥æ”»å‡»</strong>ï¼Œæ€è·¯å’Œä¸Šé¢çš„ stack smashing attack å¦‚å‡ºä¸€è¾™ï¼Œåªä¸è¿‡æ”»å‡»è€…ä¸æ»¡è¶³äºæ‰§è¡Œè½¯ä»¶å†…çš„å…¶ä»–å‡½æ•°äº†ï¼Œä»–è¦æ‰§è¡Œçš„æ˜¯è‡ªå·±åµŒå…¥çš„å‡½æ•°ï¼Œå±å®³å¯èƒ½æ›´å¤§ã€‚</p>
<p>å®ç°æ”»å‡»çš„åŸç†å°±æ˜¯ï¼Œ<strong>æ”»å‡»è€…è¾“å…¥ç¼–ç æœ‰ exploit code + padding string + pointer to exploit code çš„å†…å®¹</strong>ï¼Œè®©è¯»å…¥ç¨‹åºæ‰§è¡Œç»“æŸåè·³è½¬åˆ°æ”»å‡»è€…åˆšåˆšè¾“å…¥çš„ exploit code ä¸­æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="imgs/code_injection_attack.png" height="300"></p>
<blockquote>
<p>æ›´èªæ˜çš„æ”»å‡»è€…ä¼šåœ¨è¿è¡Œå®Œ exploit code åä¿®å¤æº¢å‡ºçš„ç¼“å†²åŒºï¼Œå¹¶ä¸”è·³è½¬åˆ°åŸæ¥çš„å‡½æ•°ï¼Œä¼ªè£…æˆæ²¡æœ‰è¢«æ”»å‡»çš„å‡è±¡ã€‚</p>
<p>çŸ¥è¯†æ‹“å±•ï¼šè®¡ç®—æœºç—…æ¯’å’Œè®¡ç®—æœºè •è™«çš„åŒºåˆ«</p>
<ul>
<li>è •è™«ï¼šå¯ä»¥é€šè¿‡æŸç§éšè”½çš„æ–¹å¼ï¼Œè¿›è¡Œè‡ªæˆ‘å¤åˆ¶ã€ç‹¬ç«‹åœ°åœ¨æœºå™¨ä¸Šè¿è¡Œé¢„æœŸä»£ç ï¼›</li>
<li>ç—…æ¯’ï¼šå¯ä»¥é€šè¿‡æŸç§éšè”½çš„æ–¹å¼ï¼Œè¿›è¡Œè‡ªæˆ‘å¤åˆ¶ï¼Œæ”»å‡»ä¸€ä¸ªç¨‹åºï¼Œå¹¶æ”¹å˜è¿™ä¸ªç¨‹åºçš„è¡Œä¸ºï¼Œä½†è‡ªå·±ä¸èƒ½ç‹¬ç«‹å­˜åœ¨ã€‚</li>
</ul>
</blockquote>
<h4 id="7-2-4-The-Protection-in-personal-respective"><a href="#7-2-4-The-Protection-in-personal-respective" class="headerlink" title="7.2.4 The Protection: in personal respective"></a>7.2.4 The Protection: in personal respective</h4><p><strong>Avoid overflow vulnerabilities when writing a program</strong></p>
<blockquote>
<p>ä¾‹å¦‚ä¹‹å‰çš„ <code>gets</code> å‡½æ•°æœ‰é£é™©ï¼Œå¯ä»¥æ¢æˆ <code>fget</code> æŒ‡å®šè¯»å…¥ç¼“å†²åŒºçš„å¤§å°ï¼›</p>
<p><code>strcpy</code> æ¢æˆ <code>strncpy</code>ã€<code>scanf</code> ä½¿ç”¨æ—¶ä¸è½»æ˜“ç”¨ <code>%s</code> æ ¼å¼ï¼Œè€Œä½¿ç”¨ <code>%ns</code>ï¼Œæˆ–è€…ç›´æ¥ç”¨ <code>fgets</code>;</p>
</blockquote>
<p><strong>Avoid overflow vulnerabilities in system-level</strong></p>
<ul>
<li><p>æ ˆéšæœºåŒ–ï¼ˆstack randomizationï¼‰ï¼Œæ˜¯æ›´å®è§‚ç­–ç•¥ ASLR (Address Space Layout Randomization, åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–) çš„ä¸€éƒ¨åˆ†ï¼›</p>
<blockquote>
<p>è¿™æ ·çš„è¯ï¼Œæ¯æ¬¡è¿è¡Œç¨‹åºï¼Œæ ˆå’Œå †ä¸Šå˜é‡çš„ä½ç½®åç§» offset ä¼šéšæœºäº§ç”Ÿï¼Œæ”»å‡»è€…å°±æ²¡æ³•æ‰¾åˆ°å‡†ç¡®çš„æ”»å‡»ä»£ç çš„æ’å…¥ä½ç½®äº†ï¼›</p>
</blockquote>
</li>
<li><p>Non-executable code segmentsï¼šåœ¨æ ˆä¸­è§„å®šç¦æ­¢æ‰§è¡Œä»£ç ï¼Œåªæœ‰åœ¨ Text åŒº / Shared Libraries åŒºæ‰èƒ½æ‰§è¡Œï¼›</p>
<blockquote>
<p>ä»¥å‰äººä»¬åœ¨å†…å­˜ä¸­æ¯ä¸€ä¸ª chunk å‰æ”¾ç½® 3 ä¸ª flagsï¼Œç±»ä¼¼ Unix ä¸Šçš„ å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œä¸‰ä¸ªæƒé™ï¼Œå¯¹äºæ ˆåŒºçš„ç©ºé—´ä¸­ flags åº”è¯¥æ˜¯å¯è¯»ã€å¯å†™ã€ä¸å¯æ‰§è¡Œï¼›</p>
</blockquote>
</li>
<li><p>Stack Canariesï¼ˆæ ˆ â€œé‡‘ä¸é›€â€ï¼‰ï¼Œåœ¨æ ˆä¸­çš„ buffer ä¸¤ç«¯è®¾ç½®ç‰¹æ®Šçš„éšæœºå€¼ï¼ˆç§°ä¸º â€œé‡‘ä¸é›€â€ï¼Œæ—©æœŸäººä»¬ä¸‹çŸ¿å°±ç”¨é‡‘ä¸é›€çš„ç”Ÿæ­»æ¥åˆ¤æ–­çŸ¿äº•ä¸­ç“¦æ–¯æ˜¯å¦è¶…æ ‡ï¼‰ï¼Œåœ¨å†™å…¥ buffer çš„å‡½æ•°é€€å‡ºå‰æ£€æŸ¥è¿™äº›å€¼ã€‚å¦‚æœè¿™äº›å€¼è¢«æ”¹å˜äº†ï¼Œé‚£ä¹ˆè¯´æ˜ buffer overflowï¼Œå¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œå°±ç«‹å³ç»ˆæ­¢æ¥ä¸‹æ¥ç¨‹åºçš„æ‰§è¡Œï¼›<strong>ç°åœ¨è¿™ä¸ªæŠ€æœ¯å·²ç»åœ¨ <code>gcc</code> ä¸­æˆä¸ºé»˜è®¤çš„ç¼–è¯‘é€‰é¡¹ï¼š<code>-fstack-protector</code></strong>;</p>
</li>
</ul>
<blockquote>
<p>è¿™é‡Œç®€å•ä»æ±‡ç¼–å±‚é¢åˆ†æä¸€ä¸‹ â€œé‡‘ä¸é›€â€ æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p>è¿˜æ˜¯ä»¥ä¸Šé¢çš„ <code>echo</code> å‡½æ•°ä¸ºä¾‹ï¼Œè¿™æ—¶æˆ‘ä»¬ç¼–è¯‘å°±åˆ é™¤ <code>-fno-stack-protector</code> è¿™ä¸ªå‚æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">echo:</span><br><span class="line">    sub		$0x18, %rsp</span><br><span class="line">    mov		%fs:0x28, %rax</span><br><span class="line">    mov		%rax, 0x8(%rsp)</span><br><span class="line">    xor		%eax, %eax</span><br><span class="line">    mov		%rsp, %rdi</span><br><span class="line">    callq	4006e0 &lt;gets&gt;</span><br><span class="line">    mov		%rsp, rdi</span><br><span class="line">    callq	400570 &lt;puts@plt&gt;</span><br><span class="line">    mov		0x8(%rsp), %rax</span><br><span class="line">    xor		%fs:0x28, %rax</span><br><span class="line">    je		400768 &lt;echo+0x39&gt;</span><br><span class="line">    callq	400580 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">    add		$0x18, %rsp</span><br><span class="line">    retq</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸€æ­¥æ­¥åˆ†æï¼š</p>
<p>ç¬¬ä¸€æ­¥ç»™ <code>echo</code> æ ˆå¸§åˆ†é…äº† 24 bytes çš„ç©ºé—´ï¼Œéå¸¸ç®€å•ï¼›</p>
<p>ç¬¬äºŒæ­¥ç”¨åˆ°äº†ä¸€ä¸ªæ²¡è§è¿‡çš„ä¸œè¥¿ <code>%fs:0x28</code>ï¼Œå®é™…ä¸Š <code>%fs</code> æ˜¯ä¸€ä¸ª<strong>ä¸ºåŸå§‹ 8086 èŠ¯ç‰‡è®¾è®¡çš„ä¸€ä¸ªå¯„å­˜å™¨</strong>ï¼Œç”±äºå‘ä¸‹å…¼å®¹ï¼Œæ‰€ä»¥å®ƒç°åœ¨è¿˜èƒ½<strong>ä»¥æŸç§æ–¹å¼</strong>ä½¿ç”¨ï¼Œä½†æ˜¯åŸºæœ¬å¾ˆå°‘ç”¨ï¼Œç”šè‡³å·²ç»æ‰¾ä¸åˆ°å®ƒçš„æ–‡æ¡£äº†â€¦â€¦åªéœ€è¦çŸ¥é“ <code>%fs:0x28</code> æ˜¯å†…å­˜çš„æŸä¸ªéšåŒ¿éƒ¨ä½ï¼Œç›¸å½“äºéšæœºæ•° â€œé‡‘ä¸é›€â€ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæ•°æ”¾åˆ° <code>%rax</code>ï¼Œç¬¬ä¸‰æ­¥å†å°†è¿™ä¸ªå€¼æ”¾åˆ° <code>%rsp</code> æ‰€æŒ‡å‘çš„ä¸‹é¢ 8 bytes çš„ä½ç½®â€”â€”è¿™å°±æ„å‘³ç€ <code>buf</code> åªè¦æº¢å‡º 8 bytes å°±ä¼šè¢«å¯Ÿè§‰ï¼›</p>
<blockquote>
<p>âš  <code>%fs</code> <strong>ä¸æ˜¯</strong>çœŸæ­£å¯ç”¨çš„å¯„å­˜å™¨ï¼Œå®ƒæ˜¯ segment registerï¼ˆæ®µå¯„å­˜å™¨ï¼‰in protected modeï¼Œå…¶ä¸­çš„å€¼æ˜¯æŒ‡å‘æŸä¸ªæœ‰æ•ˆä½ç½®çš„æŒ‡é’ˆã€‚æ‰€ä»¥åªèƒ½ç”¨å¦‚æ­¤æ–¹å¼ï¼ˆ<code>%fs:0x28</code>ï¼‰å–å‡ºå€¼ï¼Œå®ƒï¼ˆ<code>%fs:0x28</code>ï¼‰å®é™…ä¸Šæ˜¯å†…å­˜ä¸­æŸä¸ªä½ç½®çš„å¼•ç”¨ï¼Œ<strong>å¹¶ä¸”æ¯æ¬¡è¿è¡Œï¼Œè¿™ä¸ªå€¼éƒ½ä¼šæ”¹å˜</strong>ã€‚</p>
<p>è¿™ä¹Ÿå›ç­”äº†ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å°† <code>%fs:0x28</code> çš„å€¼ <code>mov</code> åˆ°å†…å­˜ä¸­ã€‚</p>
<p>â€”â€”ä»¥ä¸Šæ‘˜è‡ª <a target="_blank" rel="noopener external nofollow noreferrer" href="https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value">StackOverflow</a>;</p>
</blockquote>
<p>ç¬¬å››æ­¥å°† <code>%rax</code> æ¸…ç©ºä¸º 0ï¼Œç„¶åæ‰§è¡Œæ™®é€šçš„ <code>echo</code> æ“ä½œï¼Œçœç•¥ï¼›</p>
<p>ç›´åˆ°å€’æ•°ç¬¬ 5 æ­¥ï¼ˆç¬¬ 10 è¡Œï¼‰ï¼Œç³»ç»Ÿå°† â€œé‡‘ä¸é›€â€ å–å‡ºåˆ° <code>%rax</code> å¹¶å’ŒåŸå€¼ <code>%fs:0x28</code> æ¯”è¾ƒï¼Œå¦‚æœä¸ç­‰å°±æ˜¯ç¼“å†²åŒºæº¢å‡ºï¼Œç«‹å³è°ƒç”¨ <code>__stack_chk_fail</code> æŠ¥é”™ç»ˆæ­¢æ‰§è¡Œï¼›</p>
</blockquote>
<h4 id="7-2-5-ã€Newã€‘Return-Oriented-Programming-Attacks"><a href="#7-2-5-ã€Newã€‘Return-Oriented-Programming-Attacks" class="headerlink" title="7.2.5 ã€Newã€‘Return-Oriented Programming Attacks"></a>7.2.5 ã€Newã€‘Return-Oriented Programming Attacks</h4><p>åœ¨ä¸Šé¢çš„è®¸å¤šé˜²æŠ¤æªæ–½å‡ºæ¥åï¼Œç»™æ”»å‡»è€…å¸¦æ¥å¾ˆå¤šéš¾é¢˜ï¼š</p>
<ul>
<li>æ ˆéšæœºåŒ–ä½¿å¾—ä»–ä»¬å¾ˆéš¾é¢„æµ‹ç¼“å†²åŒºçš„ä½ç½®ï¼›</li>
<li>æ ˆåŒºæ— æ³•æ‰§è¡Œä»£ç ï¼Œä½¿å¾—ä»–ä»¬æ’å…¥ä»£ç ä¹Ÿæ²¡ç”¨ï¼›</li>
</ul>
<p>äºæ˜¯æ”»å‡»è€…æœ‰äº†ä¸€äº›æ›¿ä»£æ€§çš„æªæ–½ï¼Œ<strong>èƒ½å¤Ÿçªç ´ä¸Šé¢çš„ä¸¤ä¸ªéšœç¢ï¼ˆæ ˆéšæœºåŒ– + ç¦æ­¢æ ˆä¸­æ‰§è¡Œä»£ç ï¼‰</strong>ï¼š</p>
<ul>
<li>åˆ©ç”¨å·²å­˜åœ¨çš„ä»£ç ï¼Œä¾‹å¦‚æ ‡å‡†åº“ä¸­çš„ä»£ç ã€‚å› ä¸ºå®ƒä»¬ä¸åœ¨æ ˆåŒºå’Œå †åŒºï¼Œä½ç½®ä¸ä¼šè½»æ˜“å˜åŠ¨ï¼›</li>
<li>åˆ©ç”¨ x86 æ¶æ„ä¸­ <code>ret</code> æŒ‡ä»¤çš„ç‰¹æ®Šè¡Œä¸ºï¼Œæ¥æ‰§è¡Œä»£ç ï¼›</li>
</ul>
<p>ä¸‹é¢ä»‹ç»è¿™ç§æ”»å‡»çš„åŸç†ã€‚</p>
<p>è¿™ç§æ”»å‡»åˆ©ç”¨çš„éƒ¨ä»¶ç§°ä¹‹ä¸º <strong>gadget</strong>ï¼Œé€šå¸¸æ˜¯å„ä¸ªå‡½æ•°çš„<strong>åŒ…å« <code>ret</code> æŒ‡ä»¤çš„æœ€åå‡ è¡Œæˆ–è€…ä¸€æ®µ</strong>ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="imgs/gadget_1.png" height="225px"><img src="imgs/gadget_2.png" height="225px"></p>
<p>è¿™äº›æ¯«æ— å…³ç³»çš„å‡½æ•°çš„æ±‡ç¼–ä»£ç æœ€åå‡ è¡Œç”šè‡³å‡ ä¸ªç‰‡æ®µæ€»ä¼šåŒ…å«ä¸€äº›æŒ‡ä»¤ï¼Œä¾‹å¦‚å°†æŸä¸ªå¯„å­˜å™¨çš„å€¼åŠ å¤šå°‘ã€å°†æŸä¸ªå¯„å­˜å™¨çš„å€¼ç§»åŠ¨åˆ°å“ªã€‚å®ƒä»¬ç´§æ¥ç€ <code>ret</code> æŒ‡ä»¤ï¼ˆå¯¹åº”æ±‡ç¼–ç  <code>0xC3</code>ï¼‰ã€‚è¿™å°±æ„å‘³è¿™æˆ‘ä»¬å¯ä»¥<strong>æ”¶é›†è¿™äº› gadget çš„åœ°å€ï¼ŒæŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚ä¾æ­¤æ’åˆ—è¿™äº› gadgetï¼Œé€šè¿‡è¾“å…¥å°†è¿™äº›åœ°å€æº¢å‡ºåˆ°æ ˆé‡Œï¼Œè®©æ ˆå……å½“ç¨‹åºè®¡æ•°å™¨çš„è§’è‰²ï¼Œåå¤æ‰§è¡Œ <code>gadget1</code> -&gt; <code>ret</code> -&gt; æ‰§è¡Œ <code>gadget2</code> -&gt; <code>ret</code> -&gt; â€¦ï¼Œè¶Šè¿‡äº†ä¸Šé¢ä¸¤ä¸ªé™åˆ¶ï¼Œå°†æ‰€æœ‰ gadget è¿åœ¨ä¸€èµ·ï¼Œæœ€ç»ˆè®©ç¨‹åºæ®µè¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="imgs/ROP_execution.png" height="300px"></p>
<p><strong>å¯ä»¥è¯´æ˜¯é¡¶çº§çš„ â€œæ–­ç« å–ä¹‰â€ï¼</strong></p>
<p>ä¸è¿‡æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š</p>
<ul>
<li>è¿™ç§æ”»å‡»ä»ç„¶ä¸èƒ½çªç ´ â€œé‡‘ä¸é›€â€ çš„é˜²æŠ¤ï¼Œå› ä¸ºè¿™æ¯•ç«Ÿæ˜¯æ ˆæº¢å‡ºï¼›</li>
<li>å„ä¸ª gadget éœ€è¦å¤§é‡åœ°æŸ¥æ‰¾ï¼Œæ¯”è¾ƒè´¹ç²¾åŠ›ã€‚æœ‰äº›äººä¼šåœ¨æ ‡å‡†åº“ä¸­ç§¯ç´¯ä¸€äº› gadgetï¼›</li>
</ul>
<h3 id="7-3-Union-in-Memory"><a href="#7-3-Union-in-Memory" class="headerlink" title="7.3 Union in Memory"></a>7.3 Union in Memory</h3><p>C ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼š<code>Union</code>ï¼Œå£°æ˜æ–¹å¼ä¸ <code>struct</code> å‡ ä¹ä¸€æ ·ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">U1</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">int</span> i[<span class="number">2</span>];</span><br><span class="line">    <span class="type">double</span> v;</span><br><span class="line">&#125; *up;</span><br></pre></td></tr></table></figure>
<p>ä½†ç”¨æ³•å®Œå…¨ä¸ä¸€æ ·ã€‚<strong><code>Union</code> çš„æ‰€æœ‰åŸŸå…±ç”¨ä¸€å—æœ€å¤§çš„åŸŸå¤§å°çš„å†…å­˜</strong>ï¼Œè¿™å°±å¯¼è‡´åœ¨æ”¹åŠ¨ä¸€ä¸ªåŸŸçš„æ•°æ®æ—¶ï¼Œå…¶ä»–åŸŸçš„å€¼ä¹Ÿä¼šæ”¹å˜ï¼›æ‰€ä»¥ <strong><code>Union</code> ä¸€æ¬¡åªèƒ½ä½¿ç”¨ä¸€ä¸ªåŸŸï¼Œæˆ–è€…ç”¨åœ¨é€šè¿‡åˆ«åå¼•ç”¨ä¸åŒçš„å†…å­˜çš„åœºåˆ</strong>ã€‚<code>Union</code> ç”¨çš„åœ°æ–¹å°‘ï¼Œä½†åœ¨å•ç‰‡æœºã€æ©ç çš„é¢†åŸŸç”¨çš„æ¯”è¾ƒå¤šã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯ä¹‹å‰çš„ Data Lab ä¸­ç”¨äº <strong>bit-level representation çš„ float å’ŒçœŸå®çš„ float ä¹‹é—´ç›¸äº’è½¬æ¢</strong>ï¼Œä¸ä¼šæ”¹å˜ bit patternï¼Œä¹Ÿèƒ½ç”¨åˆ° <code>Union</code>ï¼ˆå½“ç„¶ä¸æ˜¯è§£é¢˜ç­”æ¡ˆï¼Œå› ä¸ºä¸å…è®¸ï¼‰ï¼›</p>
<p><strong>ä½¿ç”¨ <code>Union</code> ä¹Ÿè¦ç‰¹åˆ«æ³¨æ„ç«¯åºçš„é—®é¢˜</strong>ï¼ï¼ï¼</p>
<h4 id="7-3-1-Union-Allocation"><a href="#7-3-1-Union-Allocation" class="headerlink" title="7.3.1 Union Allocation"></a>7.3.1 Union Allocation</h4><p>å¯¹è”åˆä½“ï¼ˆ<code>Union</code>ï¼‰è€Œè¨€ï¼Œå†…å­˜åˆ†é…æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åˆ¤æ–­æ‰€æœ‰åŸŸä¸­å ç”¨ç©ºé—´æœ€å¤§çš„é‚£ä¸€ä¸ªæ¥åˆ†é…å°±è¡Œã€‚ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­å°±æ˜¯ 8 bytesï¼›</p>
<h4 id="7-3-2-Summary-of-Compound-Types-in-C"><a href="#7-3-2-Summary-of-Compound-Types-in-C" class="headerlink" title="7.3.2 Summary of Compound Types in C"></a>7.3.2 Summary of Compound Types in C</h4><ul>
<li>Arrays<ul>
<li>Contiguous allocation of memoryï¼ˆ1-D &amp; Nested Arrayï¼‰ï¼›</li>
<li>Aligned to satisfy every elementâ€™s alignment requirementï¼›</li>
<li>Pointer to first elementï¼›</li>
<li>No bounds checkingï¼›</li>
</ul>
</li>
<li>Structures<ul>
<li>Allocate bytes in order declaredï¼›</li>
<li>Pad in middle and at end to satisfy alignmentï¼›</li>
</ul>
</li>
<li>Unions<ul>
<li>Overlay declarationsï¼›</li>
<li>Way to circumvent type systemï¼›</li>
</ul>
</li>
</ul>
<h3 id="7-4-Summary-of-Chapter-7"><a href="#7-4-Summary-of-Chapter-7" class="headerlink" title="7.4 Summary of Chapter 7"></a>7.4 Summary of Chapter 7</h3><p>æœ¬ç« çš„å†…å®¹ç›¸è¾ƒäºä¹‹å‰ä¸¤ç« è¾ƒå°‘ï¼Œä½†æ˜¯ä¹Ÿå¾ˆé‡è¦ã€‚</p>
<p>æœ¬ç« å¼€å§‹æˆ‘ä»¬å°±ä»<strong>æ›´å…¨é¢çš„</strong>è§’åº¦æ¥è§‚å¯Ÿ <strong>x86-64 Linux çš„å®Œæ•´å†…å­˜å¸ƒå±€</strong>ï¼Œæˆ‘ä»¬è½è„šäºå®é™…ï¼Œè€ƒè™‘åˆ°å®é™…èƒ½å¤Ÿä½¿ç”¨çš„å†…å­˜ä¸è¿‡ 128 T å·¦å³ï¼Œå»ºç«‹äº†ä¸€ä¸ª <code>0x0000 7FFF FFFF F000 ~ 0x40 0000</code> çš„å†…å­˜å›¾è°±ã€‚</p>
<p>åœ¨è¿™ä¸ªå›¾è°±ä¸­ï¼Œè‡ªé«˜åœ°å€è‡³ä½åœ°å€åˆ†å¸ƒæ ˆåŒºï¼ˆstackï¼‰ã€å¤–éƒ¨åº“åŒºï¼ˆshared librariesï¼‰ã€å †åŒºï¼ˆheapï¼‰ã€æ•°æ®åŒºï¼ˆdataï¼‰ã€æœºè¯»ä»£ç åŒºï¼ˆtextï¼‰ï¼›</p>
<p>è¿™äº›ä½ç½®éƒ½ç”± virtual memory allocator è¿›è¡Œç®¡ç†ï¼Œå¦‚æœè®¿é—®äº†è¶…å‡ºæ•´ä¸ªå†…å­˜çš„èŒƒå›´ï¼Œæˆ–æ˜¯ä¸åœ¨å·²åˆ†é…çš„ç©ºé—´å†…ï¼Œç³»ç»Ÿéƒ½ä¼šæŠ›å‡º segmentation faultï¼›</p>
<p>æˆ‘ä»¬äº†è§£åˆ°ï¼Œæ ˆåŒº<strong>ä½äºå†…å­˜çš„æœ€é«˜åœ°å€å¤„</strong>ï¼Œå†…éƒ¨å­˜æ”¾è§ 5.2 å’Œ 5.3ï¼Œå®é™…å¤§å°çº¦ 8 MBï¼ˆx86-64ï¼‰ï¼Œåœ°å€åœ¨ $2^{47}-4096$ è‡³ <code>0x0000 7FFF F800 0000</code> ä¸­ï¼Œå‰åå¯èƒ½å«æœ‰å› ä¸º ASLR æˆ– â€œé‡‘ä¸é›€â€ äº§ç”Ÿçš„<strong>éšæœºæ•°æ®</strong>ï¼Œæ€»å…±çº¦ 128 MBï¼›</p>
<p>åœ¨æ ˆåŒºçš„ä¸Šæ–¹ï¼ˆè¿™é‡ŒæŠŠè¾ƒä½åœ°å€çš„ç§°ä¸º â€œä¸Šæ–¹â€ï¼‰æ˜¯ Shared Libaries åŒºï¼Œ<strong>å®ƒå­˜æ”¾é‡è¦çš„å¤–éƒ¨åº“å‡½æ•°</strong>ï¼Œæ˜¯åŠ¨æ€åŠ è½½è‡³å†…å­˜ä¸Šçš„éƒ¨åˆ†ã€‚å¦‚æœå †ä¸­æœ‰è¾ƒå¤§çš„æ•°æ®ï¼Œå¯èƒ½éƒ¨åˆ†çš„å †åŒºä¼šä¸å¤–éƒ¨åº“åŒºæ¯—é‚»ï¼Œå¹¶ä¸”å‘ä½åœ°å€ç”Ÿé•¿ã€‚</p>
<p>è·¨è¿‡ä¸­é—´å¤§ç‰‡çš„æœªåˆ†é…çš„åŒºåŸŸå‘ä½åœ°å€çœ‹ï¼Œå°±æ˜¯å †åŒºï¼Œ<strong>ç”±ä»£ç å‡½æ•°æ‰‹æ®µåˆ†é…å’Œé‡Šæ”¾çš„åŒºåŸŸï¼Œå­˜æ”¾å¤§éƒ¨åˆ†ç”±æ‰‹åŠ¨åˆ†é…çš„æ™®é€šå˜é‡</strong>ï¼Œå‘é«˜åœ°å€ç”Ÿé•¿ï¼›</p>
<p>åœ¨å †åŒºçš„ä¸Šæ–¹ï¼Œæ˜¯æ•°æ®åŒºï¼Œ<strong>å­˜æ”¾ç¨‹åºå¼€å§‹å°±åˆ†é…çš„æ•°æ®</strong>ï¼ŒåŒ…æ‹¬é™æ€æ•°æ®ã€å…¨å±€å˜é‡ã€å­—ç¬¦ä¸²å¸¸é‡ç­‰ï¼›</p>
<p>å†å‘ä¸Šå°±æ˜¯å†…å­˜çš„åœ°å€æœ€ä½å¤„ï¼Œæœºè¯»ä»£ç åŒºï¼Œå¼€å§‹äº <code>0x40 0000</code>ï¼Œå…·ä½“å†…å®¹ä¼šåœ¨ â€œé“¾æ¥â€ ä¸€ç« ä¸­è®¨è®ºã€‚</p>
<p>ä»¥ä¸ŠåŒºåŸŸï¼Œtext / data / shared libraries åŒºåŸŸè¿è¡Œæ—¶å¯è¯»å¯æ‰§è¡Œï¼Œheap / stack åŒºåŸŸå¯è¯»å¯å†™ä¸å¯æ‰§è¡Œã€‚</p>
<p>ä»‹ç»å®Œ x86-64 Linux æ•´ä½“çš„å†…å­˜åˆ†å¸ƒï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¨è®ºäº† Buffer overflow çš„åŸç†å’Œå±å®³æ€§ã€‚</p>
<p>Buffer overflow å‡ºç°çš„<strong>å†…éƒ¨åŸå› </strong>æ˜¯å¯¹æ•°ç»„æˆ–å…¶ä»– memory ä¸æ°å½“çš„è¯»å†™è®¿é—®ï¼Œ<strong>å¤–éƒ¨åŸå› </strong>æ˜¯ä¸å¯¹è¾“å…¥å­—ç¬¦ä¸²è¿›è¡Œé•¿åº¦å’Œå†…å®¹çš„åˆæ³•æ€§æ£€éªŒã€‚</p>
<p>æœ€å Buffer Overflow æˆ–è€…è§¦å‘ segmentation fault å¯¼è‡´ç¨‹åºå´©æºƒï¼Œæˆ–è€…æ°å¥½è¿›è¡Œäº†ä¸æ°å½“çš„è·³è½¬ï¼Œè®©ç¨‹åºè¡Œä¸ºä¸å¯é¢„æµ‹ã€éš¾ä»¥è°ƒè¯•ï¼Œæˆ–è€…è¢«ä¸æ³•åˆ†å­åˆ©ç”¨åï¼Œå±å®³è®¡ç®—æœºç³»ç»Ÿçš„æ­£å¸¸ä½¿ç”¨ã€‚</p>
<p>ä»ä¸€ä¸ªä½¿ç”¨å®¹æ˜“å†…å­˜ç¼“å†²åŒºæº¢å‡ºçš„ <code>gets</code> çš„å‡½æ•° <code>echo</code> å‡ºå‘ï¼Œæˆ‘ä»¬è®¨è®ºäº†è¾“å…¥ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²å¯¹ç¼“å†²åŒºæº¢å‡ºçš„å½±å“ï¼Œè¿›è€Œæ¨å‡ºäº† <strong>3 ç§</strong>åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºç‰¹ç‚¹çš„æ”»å‡»è¡Œä¸ºï¼ˆStack Smashing Attacksã€Code Injection Attacksã€Return-Oriented Programming Attacksï¼‰ã€‚å®ƒä»¬å…±åŒç‚¹æ˜¯ï¼Œéƒ½åˆ©ç”¨äº†æº¢å‡ºå½±å“ return address çš„ç‰¹æ€§ï¼Œä½¿å¾—ç¨‹åºè·³è½¬åˆ°æ”»å‡»è€…æŒ‡å®šçš„ä½ç½®æ‰§è¡Œï¼›ä½†ä»å…·ä½“æ“ä½œä¸Šå„æœ‰å·®å¼‚ã€‚</p>
<p>ä¹‹åæˆ‘ä»¬ä»‹ç»äº†<strong>ä¸¤ç±»ã€å››ç§</strong>é’ˆå¯¹å†…å­˜ç¼“å†²åŒºæº¢å‡ºæ”»å‡»çš„é˜²æŠ¤åŠæ³•ã€‚ä¸¤ç±»ä¸­çš„ä¸€ç±»æ˜¯<strong>ä»å¼€å‘è€…è‡ªå·±åšèµ·</strong>ï¼Œå°½é‡é¿å…ä½¿ç”¨æœ‰ç¼“å†²åŒºæº¢å‡ºé£é™©çš„å‡½æ•°ï¼›å¦ä¸€ç±»æ˜¯<strong>ä»ç³»ç»Ÿå±‚é¢åšèµ·</strong>ï¼Œä¸»è¦åˆ†ä¸º 3 ç§ï¼Œåˆ†åˆ«æ˜¯<strong>æ ˆéšæœºåŒ–</strong>ã€<strong>æ ˆåŒºç¦æ­¢æ‰§è¡Œä»£ç </strong> å’Œ <strong>æ ˆ â€œé‡‘ä¸é›€â€</strong>ã€‚è¿™ 3 ç§é˜²æŠ¤æ€è·¯èƒ½å¤Ÿè½»æ¾åº”å¯¹ Stack Smashing Attacks å’Œ Code Injection Attacksï¼Œä½†åªæœ‰ æ ˆ â€œé‡‘ä¸é›€â€ èƒ½å¤Ÿé˜²æŠ¤ Return-Oriented Attacksã€‚</p>
<p>æˆ‘ä»¬ä»”ç»†åˆ†æäº† æ ˆ â€œé‡‘ä¸é›€â€ çš„æ±‡ç¼–å±‚é¢çš„å®ç°ï¼Œæ›´åŠ ç¡®ä¿¡è¿™ä¸ªè‡³ä»Šæ²¡æœ‰è¢«ç ´è§£çš„é˜²æŠ¤æ–¹æ³•çš„å¼ºå¤§ã€‚</p>
<p>æœ¬ç« æœ€åï¼Œæˆ‘ä»¬æ¥è§¦åˆ°äº† <code>Union</code> è”åˆä½“åœ¨å†…å­˜ä¸­çš„åˆ†é…å’Œè¡¨ç¤ºï¼Œåå¤å¼ºè°ƒä½¿ç”¨ <code>Union</code> æ—¶<strong>ä¸€å®šè¦æ³¨æ„ç«¯åºçš„é—®é¢˜</strong>ï¼Œä»¥å…å‡ºç°å­—èŠ‚åºæ–¹é¢çš„ç¼–ç¨‹é”™è¯¯ã€‚</p>
<blockquote>
<p>ç¬¬ 3 ~ 7 ç« å·²ç»“æŸï¼Œè¯·å®Œæˆ Bomb Lab &amp; Attack Labï¼</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://sjtuxhw.asia">SJTU-XHW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://sjtuxhw.asia/2023/09/17/CSAPP-Notes-Chapter1-3/">https://sjtuxhw.asia/2023/09/17/CSAPP-Notes-Chapter1-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://sjtuxhw.asia" target="_blank">SJTU-XHW's blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/myBlog/tags/GNU/">GNU</a><a class="post-meta__tags" href="/myBlog/tags/CSAPP/">CSAPP</a><a class="post-meta__tags" href="/myBlog/tags/ICS/">ICS</a><a class="post-meta__tags" href="/myBlog/tags/Programming/">Programming</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.sjtuxhw.top/cover_imgs/csapp_123.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>èµåŠ©</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/myBlog/img/wechat_pay.jpg" target="_blank"><img class="post-qr-code-img" src="/myBlog/img/wechat_pay.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/myBlog/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/myBlog/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/myBlog/2023/10/01/%E3%80%8A%E5%8F%AA%E6%9C%89%E6%88%91%E4%B8%8D%E5%9C%A8%E7%9A%84%E5%9F%8E%E5%B8%82%E3%80%8B%E7%95%AA%E8%AF%84/" title="ã€Šåªæœ‰æˆ‘ä¸åœ¨çš„åŸå¸‚ã€‹ç•ªè¯„"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/anime_bokumachi.jpg" onerror="onerror=null;src='/myBlog/img/404.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ã€Šåªæœ‰æˆ‘ä¸åœ¨çš„åŸå¸‚ã€‹ç•ªè¯„</div></div></a></div><div class="next-post pull-right"><a href="/myBlog/2023/09/05/MC-Forge%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="MC-Forgeå¼€å‘ç¬”è®°ï¼ˆä¸€ï¼‰"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/minecraft1.png" onerror="onerror=null;src='/myBlog/img/404.png'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">MC-Forgeå¼€å‘ç¬”è®°ï¼ˆä¸€ï¼‰</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/myBlog/2023/04/28/GNU-Tutor/" title="GNU-Tutor"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/GNU-Tutor.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-28</div><div class="title">GNU-Tutor</div></div></a></div><div><a href="/myBlog/2023/07/21/CMake-%E8%BF%9B%E9%98%B6/" title="CMake è¿›é˜¶"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/cmake.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-21</div><div class="title">CMake è¿›é˜¶</div></div></a></div><div><a href="/myBlog/2023/04/28/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Gitå­¦ä¹ ç¬”è®°"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/git.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-28</div><div class="title">Gitå­¦ä¹ ç¬”è®°</div></div></a></div><div><a href="/myBlog/2023/04/28/Java-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Java å­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/java1.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-28</div><div class="title">Java å­¦ä¹ ç¬”è®°ï¼ˆ1ï¼‰</div></div></a></div><div><a href="/myBlog/2023/06/18/Matlab-%E5%A4%8D%E4%B9%A0/" title="Matlab å¤ä¹ "><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/matlab.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-18</div><div class="title">Matlab å¤ä¹ </div></div></a></div><div><a href="/myBlog/2023/06/28/SQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="SQLå­¦ä¹ ç¬”è®°-ç¬¬ä¸€éƒ¨åˆ†"><img class="cover" src="https://cdn.sjtuxhw.top/cover_imgs/sql-1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-28</div><div class="title">SQLå­¦ä¹ ç¬”è®°-ç¬¬ä¸€éƒ¨åˆ†</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/myBlog/img/favicon.ico" onerror="this.onerror=null;this.src='/myBlog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SJTU-XHW</div><div class="author-info__description">A blog to document learning and life</div></div><div class="card-info-data site-data is-center"><a href="/myBlog/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">27</div></a><a href="/myBlog/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">45</div></a><a href="/myBlog/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/SSRVodka"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/SSRVodka" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:sjtuxhw12345@sjtu.edu.cn" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://sjtuxhw.asia/myBlog/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #a200ff;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">Thanks for visiting! â€|â€¢'-'â€¢) âœ§</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-0-Intro"><span class="toc-text">Chapter 0. Intro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-1-Ints-are-not-Integers-Floats-are-not-Reals"><span class="toc-text">0.1 Ints are not Integers, Floats are not Reals</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-2-Learn-Assembly-but-never-write-it"><span class="toc-text">0.2 Learn Assembly but never write it</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-3-Memory-Matters-Unbounded"><span class="toc-text">0.3 Memory Matters: Unbounded</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-4-There%E2%80%99s-more-to-performance-than-asymtotic-complexity"><span class="toc-text">0.4 Thereâ€™s more to performance than asymtotic complexity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-5-Computers-do-more-than-execute-programs"><span class="toc-text">0.5 Computers do more than execute programs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-1-Bits-Bytes-and-Integers"><span class="toc-text">Chapter 1. Bits, Bytes and Integers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Everythings-is-bits"><span class="toc-text">1.1 Everythings is bits</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Boolean-Algebra"><span class="toc-text">1.2 Boolean Algebra</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%8E%9F%E7%A0%81-true-form-%E3%80%81%E5%8F%8D%E7%A0%81-1%E2%80%99s-complement-%E3%80%81%E8%A1%A5%E7%A0%81-2%E2%80%99s-complement"><span class="toc-text">1.3 åŸç (true form)ã€åç (1â€™s complement)ã€è¡¥ç (2â€™s complement)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Operations"><span class="toc-text">1.4 Operations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Miscellaneous"><span class="toc-text">1.5 Miscellaneous</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-Puzzles"><span class="toc-text">1.6 Puzzles</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-2-Floating-Point"><span class="toc-text">Chapter 2. Floating Point</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Fractional-Binary-Numbers"><span class="toc-text">2.1 Fractional Binary Numbers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-The-Operations-for-Floating-Point"><span class="toc-text">2.2 The Operations for Floating Point</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Floating-Point-in-C"><span class="toc-text">2.3 Floating Point in C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Puzzles"><span class="toc-text">2.4 Puzzles</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-3-Machine-Level-Programming-%E2%85%A0-Basics"><span class="toc-text">Chapter 3. Machine-Level Programming â… - Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-History-of-Intel-processors-and-architectures"><span class="toc-text">3.1 History of Intel processors and architectures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-C-Assembly-Machine-code"><span class="toc-text">3.2 C, Assembly, Machine code</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-Definitions"><span class="toc-text">3.2.1 Definitions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-Assembly-Machine-Code-View"><span class="toc-text">3.2.2 Assembly&#x2F;Machine Code View</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-Assembly-Characteristics-Data-Types"><span class="toc-text">3.2.3 Assembly Characteristics: Data Types</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-Assembly-Characteristics-Operations"><span class="toc-text">3.2.4 Assembly Characteristics: Operations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5-Assembling-amp-Disassembling-Object-Code-At-first-glance"><span class="toc-text">3.2.5 Assembling &amp; Disassembling Object Code: At first glance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Assembly-Basics"><span class="toc-text">3.3 Assembly Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-The-names-for-integer-registers"><span class="toc-text">3.3.1 The names for integer registers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-Move-Operands-and-usage"><span class="toc-text">3.3.2 Move, Operands, and usage</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Moving-Data-Command-movq-lt-SrcR-gt-lt-DstR-gt"><span class="toc-text">Moving Data Command: movq &lt;SrcR&gt;, &lt;DstR&gt;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Operands"><span class="toc-text">Operands</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-Arithmetic-amp-logical-operations"><span class="toc-text">3.3.3 Arithmetic &amp; logical operations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Address-Computation-Instruction-leaq-lt-Src-gt-lt-Dst-gt"><span class="toc-text">Address Computation Instruction: leaq &lt;Src&gt;, &lt;Dst&gt;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Some-Arithmetic-Operations"><span class="toc-text">Some Arithmetic Operations</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-4-Machine-Level-Programming-%E2%85%A1-Control"><span class="toc-text">Chapter 4. Machine Level Programming â…¡ - Control</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Introduction-to-Condition-Codes"><span class="toc-text">4.1 Introduction to Condition Codes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-Processor-State-of-x86-64-partial"><span class="toc-text">4.1.1 Processor State of x86-64, partial</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-The-meanings-for-Condition-Codes"><span class="toc-text">4.1.2 The meanings for Condition Codes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-Condition-Codes-Explicit-Setting"><span class="toc-text">4.1.3 Condition Codes: Explicit Setting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Compare-cmpq-lt-Src2-Src1-gt"><span class="toc-text">Compare: cmpq &lt;Src2, Src1&gt;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Test-testq-lt-Src2-Src1-gt"><span class="toc-text">Test: testq &lt;Src2, Src1&gt;</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-4-Condition-Codes-Reading"><span class="toc-text">4.1.4 Condition Codes: Reading</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Conditional-Branches"><span class="toc-text">4.2 Conditional Branches</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-JX-Instructions-%E3%80%90Old%E3%80%91"><span class="toc-text">4.2.1 JX Instructions ã€Oldã€‘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-General-Conditional-Expression-Translation-amp-Conditional-Moves"><span class="toc-text">4.2.2 General Conditional Expression Translation &amp; Conditional Moves</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Loops"><span class="toc-text">4.3 Loops</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-Do-While-Loop"><span class="toc-text">4.3.1 Do-While Loop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-General-While-Loop-Translation-1-%E2%80%9CJump-to-Middle%E2%80%9D-Translation"><span class="toc-text">4.3.2 General While Loop Translation #1 - â€œJump to Middleâ€ Translation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-General-While-Loop-Translation-2-%E2%80%9CDo-while%E2%80%9D-Conversion"><span class="toc-text">4.3.3 General While Loop Translation #2 - â€œDo-whileâ€ Conversion</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-4-For-Loop"><span class="toc-text">4.3.4 For Loop</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Switch-Statements"><span class="toc-text">4.4 Switch Statements</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-Summary-for-Chapter-4"><span class="toc-text">4.5 Summary for Chapter 4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-5-Machine-Level-Programming-%E2%85%A2-Procedure"><span class="toc-text">Chapter 5. Machine Level Programming â…¢ - Procedure</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Mechanisms-in-Procedures"><span class="toc-text">5.1 Mechanisms in Procedures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-x86-64-Stack"><span class="toc-text">5.2 x86-64 Stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Calling-Conventions"><span class="toc-text">5.3 Calling Conventions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-Passing-Control"><span class="toc-text">5.3.1 Passing Control</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-Passing-Data"><span class="toc-text">5.3.2 Passing Data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-Managing-Local-Data"><span class="toc-text">5.3.3 Managing Local Data</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-Register-Saving-Conventions"><span class="toc-text">5.4 Register Saving Conventions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-Illustration-of-Recursion"><span class="toc-text">5.5 Illustration of Recursion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-Summary-for-Chapter-5"><span class="toc-text">5.5 Summary for Chapter 5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-6-Machine-Level-Programming-%E2%85%A3-Data"><span class="toc-text">Chapter 6. Machine Level Programming â…£ - Data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Arrays-in-Assembly"><span class="toc-text">6.1 Arrays in Assembly</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-1-Array-Access-Normal-Array"><span class="toc-text">6.1.1 Array Access: Normal Array</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-Array-Access-Two-Dimension-Array"><span class="toc-text">6.1.2 Array Access: Two Dimension Array</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-3-Array-Access-M-%C3%97-N-Matrix"><span class="toc-text">6.1.3 Array Access: M Ã— N Matrix</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-Structures-in-Assembly"><span class="toc-text">6.2 Structures in Assembly</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-Structure-Representation"><span class="toc-text">6.2.1 Structure Representation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-Structure-Access-Generate-Pointer-to-Structure-Member"><span class="toc-text">6.2.2 Structure Access: Generate Pointer to Structure Member</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-Accessing-Arrays-of-Structure"><span class="toc-text">6.2.3 Accessing Arrays of Structure</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-4-Saving-Space"><span class="toc-text">6.2.4 Saving Space</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Floating-Point-in-Assembly"><span class="toc-text">6.3 Floating Point in Assembly</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-History-amp-Background-for-Representing-FP"><span class="toc-text">6.3.1 History &amp; Background for Representing FP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-2-Programming-with-SSE3"><span class="toc-text">6.3.2 Programming with SSE3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-3-AVX-Instructions"><span class="toc-text">6.3.3 AVX Instructions</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-Summary-for-Chapter-6"><span class="toc-text">6.4 Summary for Chapter 6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-7-Machine-Level-Programming-%E2%85%A4-Advanced"><span class="toc-text">Chapter 7. Machine Level Programming â…¤ - Advanced</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Memory-Layout-in-x86-64"><span class="toc-text">7.1 Memory Layout in x86-64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Buffer-Overflow"><span class="toc-text">7.2 Buffer Overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-The-Vulnerability"><span class="toc-text">7.2.1 The Vulnerability</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-Stack-Smashing-Attacks"><span class="toc-text">7.2.2 Stack Smashing Attacks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-Code-Injection-Attacks"><span class="toc-text">7.2.3 Code Injection Attacks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-4-The-Protection-in-personal-respective"><span class="toc-text">7.2.4 The Protection: in personal respective</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-5-%E3%80%90New%E3%80%91Return-Oriented-Programming-Attacks"><span class="toc-text">7.2.5 ã€Newã€‘Return-Oriented Programming Attacks</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Union-in-Memory"><span class="toc-text">7.3 Union in Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-1-Union-Allocation"><span class="toc-text">7.3.1 Union Allocation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-2-Summary-of-Compound-Types-in-C"><span class="toc-text">7.3.2 Summary of Compound Types in C</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-Summary-of-Chapter-7"><span class="toc-text">7.4 Summary of Chapter 7</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2023/10/01/%E3%80%8A%E5%8F%AA%E6%9C%89%E6%88%91%E4%B8%8D%E5%9C%A8%E7%9A%84%E5%9F%8E%E5%B8%82%E3%80%8B%E7%95%AA%E8%AF%84/" title="ã€Šåªæœ‰æˆ‘ä¸åœ¨çš„åŸå¸‚ã€‹ç•ªè¯„"><img src="https://cdn.sjtuxhw.top/cover_imgs/anime_bokumachi.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.png'" alt="ã€Šåªæœ‰æˆ‘ä¸åœ¨çš„åŸå¸‚ã€‹ç•ªè¯„"/></a><div class="content"><a class="title" href="/myBlog/2023/10/01/%E3%80%8A%E5%8F%AA%E6%9C%89%E6%88%91%E4%B8%8D%E5%9C%A8%E7%9A%84%E5%9F%8E%E5%B8%82%E3%80%8B%E7%95%AA%E8%AF%84/" title="ã€Šåªæœ‰æˆ‘ä¸åœ¨çš„åŸå¸‚ã€‹ç•ªè¯„">ã€Šåªæœ‰æˆ‘ä¸åœ¨çš„åŸå¸‚ã€‹ç•ªè¯„</a><time datetime="2023-10-01T14:20:47.000Z" title="å‘è¡¨äº 2023-10-01 10:20:47">2023-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2023/09/17/CSAPP-Notes-Chapter1-3/" title="CSAPP Notes Chapter1~3"><img src="https://cdn.sjtuxhw.top/cover_imgs/csapp_123.jpeg" onerror="this.onerror=null;this.src='/myBlog/img/404.png'" alt="CSAPP Notes Chapter1~3"/></a><div class="content"><a class="title" href="/myBlog/2023/09/17/CSAPP-Notes-Chapter1-3/" title="CSAPP Notes Chapter1~3">CSAPP Notes Chapter1~3</a><time datetime="2023-09-17T23:47:15.000Z" title="å‘è¡¨äº 2023-09-17 19:47:15">2023-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2023/09/05/MC-Forge%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="MC-Forgeå¼€å‘ç¬”è®°ï¼ˆä¸€ï¼‰"><img src="https://cdn.sjtuxhw.top/cover_imgs/minecraft1.png" onerror="this.onerror=null;this.src='/myBlog/img/404.png'" alt="MC-Forgeå¼€å‘ç¬”è®°ï¼ˆä¸€ï¼‰"/></a><div class="content"><a class="title" href="/myBlog/2023/09/05/MC-Forge%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="MC-Forgeå¼€å‘ç¬”è®°ï¼ˆä¸€ï¼‰">MC-Forgeå¼€å‘ç¬”è®°ï¼ˆä¸€ï¼‰</a><time datetime="2023-09-06T01:04:06.000Z" title="å‘è¡¨äº 2023-09-05 21:04:06">2023-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2023/08/30/%E4%BB%8EC-%E5%85%A5%E9%97%A8Qt%EF%BC%88%E4%B8%89%EF%BC%89/" title="ä»C++å…¥é—¨Qtï¼ˆä¸‰ï¼‰"><img src="https://cdn.sjtuxhw.top/cover_imgs/qt3.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.png'" alt="ä»C++å…¥é—¨Qtï¼ˆä¸‰ï¼‰"/></a><div class="content"><a class="title" href="/myBlog/2023/08/30/%E4%BB%8EC-%E5%85%A5%E9%97%A8Qt%EF%BC%88%E4%B8%89%EF%BC%89/" title="ä»C++å…¥é—¨Qtï¼ˆä¸‰ï¼‰">ä»C++å…¥é—¨Qtï¼ˆä¸‰ï¼‰</a><time datetime="2023-08-30T23:05:14.000Z" title="å‘è¡¨äº 2023-08-30 19:05:14">2023-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2023/08/16/%E4%BB%8EC-%E5%85%A5%E9%97%A8Qt%EF%BC%88%E4%BA%8C%EF%BC%89/" title="ä»C++å…¥é—¨Qtï¼ˆäºŒï¼‰"><img src="https://cdn.sjtuxhw.top/cover_imgs/qt2.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.png'" alt="ä»C++å…¥é—¨Qtï¼ˆäºŒï¼‰"/></a><div class="content"><a class="title" href="/myBlog/2023/08/16/%E4%BB%8EC-%E5%85%A5%E9%97%A8Qt%EF%BC%88%E4%BA%8C%EF%BC%89/" title="ä»C++å…¥é—¨Qtï¼ˆäºŒï¼‰">ä»C++å…¥é—¨Qtï¼ˆäºŒï¼‰</a><time datetime="2023-08-17T03:15:11.000Z" title="å‘è¡¨äº 2023-08-16 23:15:11">2023-08-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By SJTU-XHW | tech SJTU saves the world</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://beian.miit.gov.cn" rel="external nofollow noreferrer" id="beian" target="_blank">ICPå¤‡æ¡ˆï¼šæ²ªICPå¤‡2023012264-1å·</a> <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" rel="external nofollow noreferrer" target="_blank"> &nbsp;|&nbsp;&nbsp;æœ¬ç½‘ç«™ç”± <img src="/img/upCloud_logo.png" title="upcloud" alt="upcloud" height="30px"> æä¾›CDNåŠ é€Ÿ/äº‘å­˜å‚¨æœåŠ¡ </a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa-solid fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa-solid fa-arrow-rotate-right"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa-solid fa-arrow-right"></i></a><a class="rightMenu-item" id="menu-radompage" href="javascript:window.location.href = window.location.origin;" rel="external nofollow noreferrer"><i class="fa-solid fa-house"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa-solid fa-copy"></i><span>å¤åˆ¶</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();" rel="external nofollow noreferrer"><i class="fa-solid fa-circle-half-stroke"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa-solid fa-book"></i><span>é˜…è¯»æ¨¡å¼</span></a></div></div><div><script src="/myBlog/js/utils.js"></script><script src="/myBlog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-ax33bluz4-alex-andrews-projects.vercel.app/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-ax33bluz4-alex-andrews-projects.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      GLOBAL_CONFIG_SITE.isPost && getCount()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[å›¾ç‰‡]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[é“¾æ¥]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[ä»£ç ]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-ax33bluz4-alex-andrews-projects.vercel.app/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "æ— æ³•è·å–è¯„è®ºï¼Œè¯·ç¡®è®¤ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'æ²¡æœ‰è¯„è®º'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script src="/myBlog/js/jquery-3.7.0.min.js"></script><script src="/myBlog/js/rightmenu.js"></script><div class="aplayer no-destroy" data-id="6898044781" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"></div><script src="/myBlog/js/mourn.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="/myBlog/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/myBlog/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/myBlog/js/search/local-search.js"></script></div></div></body></html>