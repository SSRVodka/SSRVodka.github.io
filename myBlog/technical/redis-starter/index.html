<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Redis 入门：从实践到理论 | SJTU-XHW's blog</title><meta name="author" content="SJTU-XHW,sjtuxhw12345@sjtu.edu.cn"><meta name="copyright" content="SJTU-XHW"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Chapter 1. 基本概念和 CLI 使用1.1 NoSQL用于存储非结构化数据，不保证 ACID 事务特性（仅有最终一致性 Weak Consistency Model）。 Redis（Remote Dictionary Server）就是一类基于内存的键值型 NoSQL，不保证数据一致性，但可以保证性能。  一种 KVStore System，可以方便的存放非结构化数据，这对于缓存各异性数">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 入门：从实践到理论">
<meta property="og:url" content="https://blog.sjtuxhw.top/technical/redis-starter/index.html">
<meta property="og:site_name" content="SJTU-XHW&#39;s blog">
<meta property="og:description" content="Chapter 1. 基本概念和 CLI 使用1.1 NoSQL用于存储非结构化数据，不保证 ACID 事务特性（仅有最终一致性 Weak Consistency Model）。 Redis（Remote Dictionary Server）就是一类基于内存的键值型 NoSQL，不保证数据一致性，但可以保证性能。  一种 KVStore System，可以方便的存放非结构化数据，这对于缓存各异性数">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.sjtuxhw.top/cover_imgs/redis.jpg">
<meta property="article:published_time" content="2024-11-12T13:05:37.000Z">
<meta property="article:modified_time" content="2024-11-14T13:13:31.049Z">
<meta property="article:author" content="SJTU-XHW">
<meta property="article:tag" content="Programming">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.sjtuxhw.top/cover_imgs/redis.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://blog.sjtuxhw.top/technical/redis-starter/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功 ヾ(≧∇≦*)ゝ',
    error: '复制失败 (#`皿´)',
    noSupport: '浏览器不支持 ╮(╯_╰)╭'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#333","bgDark":"#1f1f1f","position":"top-center"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis 入门：从实践到理论',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="stylesheet" href="/css/mouseConfig.css"/><link rel="stylesheet" href="/css/rightmenu.css"/><link rel="stylesheet" href="/css/custom_music.css"/><link rel="stylesheet" href="/css/addFonts.css"/><link rel="stylesheet" href="/css/titleFonts.css"/><link rel="stylesheet" href="/css/talk.css"/><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="SJTU-XHW's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div id="main-loading-bg"><div class="truckWrapper"><div class="truckBody"><svg class="trucksvg" viewBox="0 0 198 93" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z" fill="currentColor" stroke="#282828" stroke-width="3"></path><path d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z" fill="#7D7C7C" stroke="#282828" stroke-width="3"></path><path d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z" fill="#282828" stroke="#282828" stroke-width="2"></path><rect x="187" y="63" width="5" height="7" rx="1" fill="#FFFCAB" stroke="#282828" stroke-width="2"></rect><rect x="193" y="81" width="4" height="11" rx="1" fill="#282828" stroke="#282828" stroke-width="2"></rect><rect x="6.5" y="1.5" width="121" height="90" rx="2.5" fill="#DFDFDF" stroke="#282828" stroke-width="3"></rect><rect x="1" y="84" width="6" height="4" rx="2" fill="#DFDFDF" stroke="#282828" stroke-width="2"></rect></svg></div><div class="truckTires"><svg class="tiresvg" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="13.5" fill="#282828" stroke="#282828" stroke-width="3"></circle><circle cx="15" cy="15" r="7" fill="#DFDFDF"></circle></svg><svg class="tiresvg" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="13.5" fill="#282828" stroke="#282828" stroke-width="3"></circle><circle cx="15" cy="15" r="7" fill="#DFDFDF"></circle></svg></div><div class="road"></div><svg class="lampPost" fill="currentColor" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 453.459 453.459" xml:space="preserve"><path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993 c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514 c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16 c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914 h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75 v-11.202c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066c0-5.068-4.107-9.177-9.176-9.177h-0.795 V196.641c0-43.174,14.942-54.283,30.762-66.043c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0z M232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514c0-5.531,1.078-10.957,3.141-16.017 h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path></svg></div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
      setTimeout(() => {
        $loadingBox.style.display = 'none'
      }, 800)
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()
</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/favicon.ico" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/dailyQ/"><i class="fa-fw fa-solid fa-pen-to-square"></i><span> DailyQuestion</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-gamepad"></i><span> ACG-Lab</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ACGLab/MikuTap/"><i class="fa-fw fas fa-music"></i><span> MikuTap</span></a></li><li><a class="site-page child" href="/ACGLab/Live2D/"><i class="fa-fw fa-solid fa-face-kiss-wink-heart"></i><span> Live2D</span></a></li><li><a class="site-page child" href="/ACGLab/Folio-2019/"><i class="fa-fw fa-solid fa-car-side"></i><span> Folio-2019</span></a></li><li><a class="site-page child" href="/ACGLab/Cube/"><i class="fa-fw fa-solid fa-cube"></i><span> Cube</span></a></li><li><a class="site-page child" href="/ACGLab/TowerBlocks/"><i class="fa-fw fa-solid fa-gopuram"></i><span> TBlocks</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/friend-links/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-camera"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.sjtuxhw.top/cover_imgs/redis.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/head_icon.png" alt="Logo"><span class="site-name">SJTU-XHW's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Redis 入门：从实践到理论</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/dailyQ/"><i class="fa-fw fa-solid fa-pen-to-square"></i><span> DailyQuestion</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-gamepad"></i><span> ACG-Lab</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ACGLab/MikuTap/"><i class="fa-fw fas fa-music"></i><span> MikuTap</span></a></li><li><a class="site-page child" href="/ACGLab/Live2D/"><i class="fa-fw fa-solid fa-face-kiss-wink-heart"></i><span> Live2D</span></a></li><li><a class="site-page child" href="/ACGLab/Folio-2019/"><i class="fa-fw fa-solid fa-car-side"></i><span> Folio-2019</span></a></li><li><a class="site-page child" href="/ACGLab/Cube/"><i class="fa-fw fa-solid fa-cube"></i><span> Cube</span></a></li><li><a class="site-page child" href="/ACGLab/TowerBlocks/"><i class="fa-fw fa-solid fa-gopuram"></i><span> TBlocks</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/friend-links/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-camera"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Redis 入门：从实践到理论</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-12T13:05:37.000Z" title="发表于 2024-11-12 21:05:37">2024-11-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-14T13:13:31.049Z" title="更新于 2024-11-14 21:13:31">2024-11-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/technical/">technical</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/technical/redis-starter/#post-comment"><span class="waline-comment-count" data-path="/technical/redis-starter/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Chapter-1-基本概念和-CLI-使用"><a href="#Chapter-1-基本概念和-CLI-使用" class="headerlink" title="Chapter 1. 基本概念和 CLI 使用"></a>Chapter 1. 基本概念和 CLI 使用</h1><h2 id="1-1-NoSQL"><a href="#1-1-NoSQL" class="headerlink" title="1.1 NoSQL"></a>1.1 NoSQL</h2><p>用于存储非结构化数据，不保证 ACID 事务特性（仅有最终一致性 Weak Consistency Model）。</p>
<p>Redis（Remote Dictionary Server）就是一类基于内存的键值型 NoSQL，不保证数据一致性，但可以保证性能。</p>
<ul>
<li><p>一种 KVStore System，可以方便的存放非结构化数据，这对于缓存各异性数据非常有帮助；</p>
</li>
<li><p>Handle 网络请求多线程。处理指令单线程，单个指令具有原子性；</p>
</li>
<li>低延迟，利用 I/O Multiplexing 在单线程中处理多个请求；</li>
<li>支持数据持久化；</li>
<li>支持主从集群（从备份，读写分离）和分片集群（数据拆分，存储上限提高）；</li>
</ul>
<h2 id="1-2-Redis-Data-Structure"><a href="#1-2-Redis-Data-Structure" class="headerlink" title="1.2 Redis Data Structure"></a>1.2 Redis Data Structure</h2><p>Redis Key 一般使用 String，Value 支持：</p>
<ul>
<li>基本类型：<code>String</code>、<code>Hash</code>、<code>List</code>、<code>Set</code>、<code>SortedSet</code>；</li>
<li>特殊类型：<code>GEO</code>（地理位置信息格式）、<code>BitMap</code>（位图）、<code>HyperLog</code>；</li>
</ul>
<h2 id="1-3-Basic-Redis-CLI-Commands"><a href="#1-3-Basic-Redis-CLI-Commands" class="headerlink" title="1.3 Basic Redis CLI Commands"></a>1.3 Basic Redis CLI Commands</h2><h3 id="1-3-1-General"><a href="#1-3-1-General" class="headerlink" title="1.3.1 General"></a>1.3.1 General</h3><p>命令行指令较多，建议查询官方文档而不是背诵。介绍常见的几个（General）：</p>
<ul>
<li><code>KEYS &lt;pattern&gt;</code>：查询 Key 符合 pattern（R.E.）的键值对；</li>
<li><code>DEL/EXISTS &lt;KEY&gt;</code>：删除、判断存在性；</li>
<li><code>EXPIRE/TTL &lt;KEY&gt; [sec]</code>：设置/获取键值的有效期（<code>-1</code> 为永久、<code>-2</code> 为已过期）；</li>
</ul>
<h3 id="1-3-2-String-int-float"><a href="#1-3-2-String-int-float" class="headerlink" title="1.3.2 String (+int/float)"></a>1.3.2 String (+int/float)</h3><ul>
<li><code>SET/MSET &lt;KEY&gt; &lt;VAL&gt;[...(KEY, VAL)]</code>：设置/批量设置键值；</li>
<li><code>GET/MGET &lt;KEY&gt;[...KEY]</code>：获取/批量获取；</li>
<li><code>INCR/INCRBY &lt;KEY&gt; [STEP]</code>：让存储数值型 String 的 Value 自增 1 或 <code>STEP</code>；</li>
<li><code>INCRBYFLOAT &lt;KEY&gt; [incr]</code>：让存储浮点型 String 的 Value 增长指定值；</li>
<li><code>SETNX &lt;KEY&gt; &lt;VAL&gt;</code>：仅不存在才插入（决不更改已存在的数据）；</li>
<li><code>SETEX &lt;KEY&gt; &lt;sec&gt; &lt;VAL&gt;</code>：设置并指定有效期；</li>
</ul>
<h3 id="1-3-3-The-Hierarchy-Structure-of-Redis-Key"><a href="#1-3-3-The-Hierarchy-Structure-of-Redis-Key" class="headerlink" title="1.3.3 The Hierarchy Structure of Redis Key"></a>1.3.3 The Hierarchy Structure of Redis Key</h3><p>Redis Key 允许使用多个单词形成层级结构，常用格式为 <code>&lt;PROJECT_NAME&gt;:&lt;BUSSINESS_NAME&gt;:[TYPE]:&lt;id&gt;</code>；</p>
<h3 id="1-3-4-Hash"><a href="#1-3-4-Hash" class="headerlink" title="1.3.4 Hash"></a>1.3.4 Hash</h3><p>String 结构存储时，想要修改其中某个字段不方便。</p>
<p>现在引入 Hash 数据类型，其 <code>value</code> 作为一个无序字典（多了一层 field-value 关系），类似一个 <code>HashMap</code>；</p>
<ul>
<li><code>HSET/HGET &lt;KEY&gt; &lt;FIELD&gt; [VAL]</code></li>
<li><code>HMSET / HMGET</code></li>
<li><code>HGETALL &lt;KEY&gt;</code>：获取这个键的 value 中的所有 field 的值；</li>
<li><code>HKEYS</code>：获取这个键的所有 field；</li>
<li><code>HVALS</code>：获取这个键的所有 value；</li>
<li><code>HSETNX &lt;KEY&gt; &lt;sec&gt; &lt;FIELD&gt; &lt;VAL&gt;</code>：仅不存在才插入；</li>
</ul>
<h3 id="1-3-5-List"><a href="#1-3-5-List" class="headerlink" title="1.3.5 List"></a>1.3.5 List</h3><p>Redis 中的 value 类型为列表，与双向链表很相似（同时支持正向、反向索引）。特性：</p>
<ul>
<li>有序、可重复、增删操作快、查询速度一般；</li>
</ul>
<p>操作如下：</p>
<ul>
<li><code>LPUSH/RPUSH &lt;KEY&gt; &lt;ELEMENT&gt;[...ELEMENT]</code>：从列表左侧/右侧插入；</li>
<li><code>LPOP/RPOP &lt;KEY&gt;</code>：弹出；</li>
<li><code>LRANGE &lt;KEY&gt; &lt;START&gt; &lt;END&gt;</code>：获取列表中的角标范围中所有元素；</li>
<li><code>BLPOP / BRPOP &lt;KEY&gt;[...KEY] &lt;sec&gt;</code>：和 <code>LPOP/RPOP</code> 类似，但是在没有元素时等待一段时间，而不是直接返回 <code>NIL</code>；</li>
</ul>
<h3 id="1-3-6-Set"><a href="#1-3-6-Set" class="headerlink" title="1.3.6 Set"></a>1.3.6 Set</h3><p>Redis 中的 value 类型为集合，与 <code>HashSet</code> 类似。特性：</p>
<ul>
<li>无序、元素不可重复、查找快、支持交并差集操作；</li>
</ul>
<p>操作如下：</p>
<ul>
<li><code>SADD/SREM &lt;KEY&gt; &lt;MEMBER&gt;[...MEMBER]</code>；添加/移除集合中的若干元素；</li>
<li><code>SCARD &lt;KEY&gt;</code>：获取集合中元素个数；</li>
<li><code>SISMEMBER &lt;KEY&gt; &lt;MEMBER&gt;</code>：是否在集合内；</li>
<li><code>SMEMBERS &lt;KEY&gt;</code>：获取集合中所有元素；</li>
</ul>
<h3 id="1-3-7-SortedSet"><a href="#1-3-7-SortedSet" class="headerlink" title="1.3.7 SortedSet"></a>1.3.7 SortedSet</h3><p>Redis 中 value 类型为有序集，每个元素携带 <code>score</code> 值（相当于优先级），可以基于 <code>score</code> 排序。</p>
<p>其底层基于 SkipTable + HashTable 实现。特性如下：</p>
<ul>
<li>可排序、元素不重复、查询速度快；</li>
</ul>
<p>操作如下：</p>
<ul>
<li><code>ZADD &lt;KEY&gt; &lt;score&gt; &lt;MEMBER&gt;</code>：添加一个或多个元素到 sorted set，如果已经存在则更新 <code>score</code> 值；</li>
<li><code>ZREM &lt;KEY&gt; &lt;MEMBER&gt;</code>：移除一个指定元素；</li>
<li><code>ZSCORE/ZRANK &lt;KEY&gt; &lt;MEMBER&gt;</code>：获取指定元素 score 值 / 排名；</li>
<li><p><code>ZCARD &lt;KEY&gt;</code>：获取元素个数；</p>
</li>
<li><p><code>ZCOUNT/ZRANGEBYSCORE &lt;KEY&gt; &lt;MIN_SCORE&gt; &lt;MAX_SCORE&gt;</code>：统计 score 值在指定范围内的元素个数 / 元素值；</p>
</li>
<li><code>ZRANGE &lt;KEY&gt; &lt;MIN_RANK&gt; &lt;MAX_RANL&gt;</code>：获取指定排名区间内的元素；</li>
<li><code>ZDIFF / ZINTER / ZUNION</code>：求差集、交集、并集；</li>
</ul>
<h1 id="Chapter-2-Using-Redis-With-Spring-Boot"><a href="#Chapter-2-Using-Redis-With-Spring-Boot" class="headerlink" title="Chapter 2. Using Redis With Spring Boot"></a>Chapter 2. Using Redis With Spring Boot</h1><h2 id="2-1-Basic-Usages"><a href="#2-1-Basic-Usages" class="headerlink" title="2.1 Basic Usages"></a>2.1 Basic Usages</h2><p>引入 Redis Client for Java 的 Spring Boot 依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-redis&#x27;</span></span><br><span class="line">    <span class="comment">// 连接池实现</span></span><br><span class="line">    implementation <span class="string">&#x27;org.apache.commons:commons-pool2&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置 Redis 连接信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">...</span></span><br><span class="line">        <span class="attr">post:</span> <span class="string">...</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">...</span></span><br><span class="line">        <span class="comment"># 使用 lettuce 而非 jedis 实现</span></span><br><span class="line">        <span class="attr">lettuce:</span></span><br><span class="line">            <span class="attr">pool:</span></span><br><span class="line">                <span class="attr">max-active:</span> <span class="number">8</span>	<span class="comment"># 最大连接数</span></span><br><span class="line">                <span class="attr">max-idle:</span> <span class="number">8</span>		<span class="comment"># 最大空闲连接</span></span><br><span class="line">                <span class="attr">min-idle:</span> <span class="number">0</span>		<span class="comment"># 最小空闲连接</span></span><br><span class="line">                <span class="attr">max-wait:</span> <span class="string">100ms</span>	<span class="comment"># 最大连接等待时长</span></span><br></pre></td></tr></table></figure>
<p><strong>使用时自动装配 <code>RedisTemplate</code> 类型</strong>。</p>
<p>使用 <code>RedisTemplate</code> 的接口：</p>
<ul>
<li><p><code>RedisTemplate#opsForValue(Object key, Object val, [long timeout, TimeUnit unit])</code>：获取 Java 一般 Object 类型的操作，这个方法会将 <code>key, val</code> 全部序列化后存储。</p>
<blockquote>
<p>默认 <code>JdkSerializationRedisSerializer</code> 类型作为序列化器，底层使用 <code>ObjectOutputStream#writeObject</code>  完成序列化工作。</p>
<p>缺点：可读性差、默认序列化器的内存占用大（消息队列中的默认序列化器有同样问题）；</p>
<p>我们应该少用这种方法，尽量选择下面确定类型的方法。</p>
<p>还有一种方法是，自定义 Redis 的序列化方式。</p>
</blockquote>
</li>
<li><p><code>RedisTemplate#opsForXXX()</code>：返回 Spring Data Redis 对于指定数据类型 <code>XXX</code>（String/Hash/…）的可能操作集合 <code>XXXOperations</code>；</p>
</li>
</ul>
<p><code>XXXOperations</code> 类的对象可以完成对应类型的 <code>set / get</code> 等方法，并选用合适的序列化器进行存储处理。</p>
<h2 id="2-2-Self-defined-Serializer-for-Redis"><a href="#2-2-Self-defined-Serializer-for-Redis" class="headerlink" title="2.2 Self-defined Serializer for Redis"></a>2.2 Self-defined Serializer for Redis</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">    <span class="comment">/* Create empty template */</span></span><br><span class="line">    RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/* Configure connection factory */</span></span><br><span class="line">    template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">    <span class="comment">/* Set Serializer for POJO */</span></span><br><span class="line">    <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">jsonRedisSerializer</span></span><br><span class="line">            <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line">    <span class="comment">/* Use String serializer for key &amp; hash key (instead of Jdk serializer) */</span></span><br><span class="line">    template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">    template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">    <span class="comment">/* Use JSON serializer for value &amp; hash value (instead of Jdk serializer) */</span></span><br><span class="line">    template.setValueSerializer(jsonRedisSerializer);</span><br><span class="line">    template.setHashValueSerializer(jsonRedisSerializer);</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有个问题，<code>GenericJackson2JsonRedisSerializer</code> 对一类数据会反复保存 <code>@class</code> 字段（反序列化后的类型）。这个信息虽然是必要的，但很多情况下存储 <code>@class</code> 字段甚至比原数据还要占空间！</p>
<p>因此我们一般不会直接使用 <code>JSON</code> 序列化器来序列化我们的 POJO，而是我们开发者<strong><u>对一个层级下的键都约定一个数据类型</u></strong>，然后使用 <strong><u>String 序列化器</u></strong>，最终手动序列化和反序列化，那么可以节省这部分空间。</p>
<p>Spring 中已经帮我们包装好了序列化、反序列化全是 String 的 <code>RedisTemplate</code>，省得我们配置了，它就是 <code>StringRedisTemplate</code>；</p>
<blockquote>
<p>也就是 <code>RedisTemplate&lt;String, Object&gt;</code>，并且设置好全部都是 String 的序列化、反序列化器；</p>
</blockquote>
<h1 id="Chapter-3-内存型数据库理论"><a href="#Chapter-3-内存型数据库理论" class="headerlink" title="Chapter 3. 内存型数据库理论"></a>Chapter 3. 内存型数据库理论</h1><p>本章介绍一下以 Redis 为首的 NoSQL 内存型数据库产生、发展的历程，同时介绍其存在的问题以及解决方案。</p>
<h2 id="3-1-为什么需要内存型数据库？"><a href="#3-1-为什么需要内存型数据库？" class="headerlink" title="3.1 为什么需要内存型数据库？"></a>3.1 为什么需要内存型数据库？</h2><p>持久化在磁盘上的关系型数据库在存储关系数据、处理事务的多数场合下都非常得力，但免不了存在一些问题。</p>
<p>例如，在电商、文章档案等网页应用中，常常是读请求远多于写请求，即便 MySQL 有 cache buffer pool（InnoDB），在大量数据查询的场合下也会出现频繁的 cache evict，究其原因就是 cache working space 太小了。</p>
<p>人们发现只是读请求造成的 Disk I/O 是可以避免的——通过将数据托管到一个更大的内存空间（这段内存空间可以不连续、甚至可以不在单个物理节点上，由一个程序来管理它）中缓存起来，可以有效提升这些应用的处理效率和吞吐量。</p>
<p>结论 1：<strong><u>在庞大数据量的应用场景下，读多写少、数据时间局部性强的应用访问模式可以通过外置的内存缓冲区统一进行缓存，来提升整体性能和接口承载量</u></strong>。这就是 Redis 要解决的需求痛点。</p>
<h2 id="3-2-缓存策略"><a href="#3-2-缓存策略" class="headerlink" title="3.2 缓存策略"></a>3.2 缓存策略</h2><p>在确定使用内存型数据库作为持久化的关系型数据库的缓存后，接下来，和所有缓存机制一样（不仅仅是数据库领域），内存型数据库会遇到两个问题：</p>
<ol>
<li>采取什么样的读/写缓存策略更好？</li>
<li>当缓冲区占满后，evict 的策略是什么？</li>
</ol>
<h3 id="3-2-1-缓存读写策略-和-缓存模式"><a href="#3-2-1-缓存读写策略-和-缓存模式" class="headerlink" title="3.2.1 缓存读写策略 和 缓存模式"></a>3.2.1 缓存读写策略 和 缓存模式</h3><p>对于第一个问题，区分缓存读策略和缓存写策略。</p>
<p><strong>缓存读策略</strong>：大多数情况下比较显然：</p>
<ul>
<li>如果 read cache miss，一定需要从磁盘上读数据，顺带写回缓存；</li>
<li>如果 read cache hit，则可以考虑记录数据热点情况；</li>
</ul>
<p><strong>缓存写策略</strong>：主要会有 4 类策略：</p>
<ul>
<li>如果 write cache hit，可以：<ul>
<li><strong>Write-through</strong>：立即将数据写入缓存（即覆盖当前行）并主动刷新（flush）到磁盘；</li>
<li><strong>Write-back</strong>：先把数据写入缓存，但不立即刷新，直到下一个数据要覆盖这个数据行的时候，才更新到磁盘中（defer write to disk until replacement of line，<strong>只是尽可能推迟了写入磁盘的时间</strong>）。另外，这个方案需要额外维护 dirty bit 来指示是否与磁盘数据一致；</li>
</ul>
</li>
<li>如果 write cache miss，可以：<ul>
<li><strong>Write-allocate</strong>：写分配，在 write-miss 后，<strong>先将原数据从磁盘读入缓存，转换为 write-hit 的情况，再 write-back（仅修改缓存 + dirty bit）</strong>；</li>
<li><strong>No-write-allocate</strong>：直接写入磁盘，不加载到缓存（缓存中没有这个数据所在的数据行，因为本来就是 write-miss）；</li>
</ul>
</li>
</ul>
<p>显然，在 write cache hit 情况下，write-through 和 write-back 策略的优劣势互补：前者保证内存和磁盘的数据较强的一致性，但是同步写回操作免不了降低了操作性能；后者接受了一定程度上的数据不一致性（推迟刷盘时间），换取了短时间内的高并发性能。</p>
<p>write-allocate 和 no-write-allocate 之间的优劣势和 write-through、write-back 的优劣势的对比相同，因此人们常常根据实际情况选择 “<strong>write-back + write-allocate</strong>” 或 “write-through + no-write-allocate” 的策略中的其中一对。</p>
<p>上述读写策略的不同选择，就形成了以 Redis 为首的内存数据库的 3 个主流的<strong><u>宏观缓存模式</u></strong>，每种模式可以应对一些使用场景：</p>
<ul>
<li><p>旁路缓存模式（Cache Aside Pattern）：同时维护数据库、缓存，二者中的数据存在强一致性；</p>
<ul>
<li><p>read：使用上面统一的缓存读策略；</p>
</li>
<li><p>write：不存在 write cache hit + no-write-allocate。立即写回数据库，并拒绝缓存。清空写这个数据的缓存信息（使用不缓存手段消除数据不一致性，<strong><u>注意保证顺序先更新磁盘再删除缓存</u></strong>）；</p>
<blockquote>
<p>为什么不采用上述的写缓存策略，而是拒绝缓存？因为考虑到<strong><u>多次盲写</u></strong>的问题。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>读写穿透模式（Read/Write Through Pattern）：视缓存为主要存储手段，二者中的数据也存在强一致性；</p>
<ul>
<li>read：使用上面统一的读策略；</li>
<li>write：<strong>write-through + write-allocate</strong>；</li>
</ul>
</li>
<li><p>异步缓存写入模式（Write Behind Pattern）：针对读写穿透模式的改进，牺牲一部分数据一致性换取更高的吞吐量；</p>
<ul>
<li>read：使用上面统一的读策略；</li>
<li>write：write-back（优化，不使用 dirty-bit，而是异步更新到数据库）；</li>
</ul>
</li>
</ul>
<blockquote>
<p>后文将以如何实现读写穿透模式为例，展示代码，同时加入缓存击穿和缓存雪崩等等问题的应对措施。代码将在文末以附录形式呈现。</p>
</blockquote>
<p>结论 2：<strong><u>常用的缓存读写策略有很多种，不过依赖它们制定的缓存模式常见的有 3 种，分别是 旁路缓存、读写穿透、异步缓存</u></strong>；</p>
<h3 id="3-2-2-缓存-Evict-策略：以-Redis-为例"><a href="#3-2-2-缓存-Evict-策略：以-Redis-为例" class="headerlink" title="3.2.2 缓存 Evict 策略：以 Redis 为例"></a>3.2.2 缓存 Evict 策略：以 Redis 为例</h3><p>不同内存型数据库的缓存淘汰策略不尽相同。下面以 Redis 为例介绍它的 cache evict 方案：</p>
<p>首先，Redis 正常不会主动 evict 数据项，而是先通过数据过期的方式腾出内存空间：</p>
<ul>
<li>过期时间：对每个数据项可以设置 TTL（Time-To-Live），表示数据过期时间。过期的数据自动被清空；</li>
<li>定期清理：Redis 可以配置扫描过期数据的频率，扫描过程称为 Garbage Collection（GC）；</li>
<li>随机选取：由于 Redis 管理的缓冲区很大，因此每次 GC 一般不会扫描全表，而是随机选取一部分进行回收；</li>
<li>惰性删除：某些键值可能概率原因一直无法被选中删除，因此一旦有查询找到该数据，发现该数据过期后立即删除（被动）；</li>
</ul>
<p>在此基础上，如果：</p>
<ul>
<li>有些键值始终没被查询，且一直没有被随机选取清理（躲过了定期清理和惰性删除）；</li>
<li>过多的键值没有设置过期时间；</li>
<li>数据工作集（working set）进一步增大；</li>
</ul>
<p>导致内存空间还是没法及时腾出，那么 Redis 就会采取主动 evict 的方案。</p>
<p>Redis 主动进行 cache evict 时可以配置 8 种策略（注意，下面的策略都是 “没办法通过数据过期腾出空间” 的主动举措）：</p>
<ul>
<li><code>noneviction</code>：缓冲区占满后报错，不会删除任何键值；</li>
<li><code>allkeys-lru</code>：对所有缓存键使用 LRU 策略 evict；</li>
<li><code>volatile-lru</code>：从设置了过期时间的数据（不一定过期了）中使用 LRU 策略 evict；</li>
<li><code>allkeys/volatile-random</code>：对所有缓存键/设置了过期时间的缓存记录使用随机策略 evict；</li>
<li><code>volatile-ttl</code>：从设置过期时间的缓存记录中选择剩余存活时间最少的记录 evict；</li>
<li><code>allkeys/volatile-lfu</code>：从所有缓存键/设置了过期时间的缓存记录使用 LFU 策略 evict；</li>
</ul>
<blockquote>
<p>LRU:  Least Recently Used；</p>
<p>LFU:  Least Frequently Used；</p>
</blockquote>
<p>结论 3:   <strong><u>Redis 对于缓存使用率过高的解决方案是 数据过期 + 主动 evict。其中数据过期依赖 “定时清理” 和 “惰性删除”，主动 evict 依赖 8 种 evict 策略</u></strong>。</p>
<h2 id="3-3-缓存击穿-amp-缓存雪崩-Cache-Penetration-Avalanche"><a href="#3-3-缓存击穿-amp-缓存雪崩-Cache-Penetration-Avalanche" class="headerlink" title="3.3 缓存击穿 &amp; 缓存雪崩 Cache Penetration/Avalanche"></a>3.3 缓存击穿 &amp; 缓存雪崩 Cache Penetration/Avalanche</h2><p>注意到以上方案，从缓存读写策略、缓存模式，到缓存 evict 策略，全部都没有考虑到一个问题，或者说一类独特的访问 pattern：如果<strong><u>一直查询并不存在的数据</u></strong>会发生什么。</p>
<p>无论按照上面的哪种策略，都会频繁出现 “cache miss - 查找数据库 - 数据库未找到” 这个流程，这会频繁绕过缓存，增大数据库的 disk I/O，影响正常业务逻辑的时延和吞吐量，尤其是大量的 Client 查找一个并不存在的数据的时候，性能影响更为明显。这种现象被称为 “缓存击穿”。</p>
<p>为了解决缓存击穿的问题，可行的解决方案之一是：根据具体业务逻辑指定一个无效值（Invalid Value），一旦出现一次 read cache miss 并且发现数据库未找到的情况，可以在缓存中写入这个无效值，下次 read cache hit 就知道数据库中没有了。</p>
<blockquote>
<p>这种解决方案借鉴了 Bloom Filter 的设计思想。</p>
<p>Google 的一篇论文曾经介绍使用跳表 + Bloom Filter 为 Log-Structure Merged Tree 提升查询速度。</p>
</blockquote>
<p>但是，除了 “一直查询并不存在的数据”，还有一类情况会引发缓存击穿：<strong><u>某个热点数据过期被清理</u></strong>。</p>
<p>在过期后的短时间内，没有等上缓存恢复就出现大量的对该数据的并发请求。这些请求会 cache miss 并 fallback 到数据库，造成上述问题。</p>
<p>如果更严重一点，假设<strong><u>一批热点数据同时过期</u></strong>，也就是大批数据出现 cache miss，那么大量请求可能造成拒绝查询甚至宕机的后果，这种现象被称为 “缓存雪崩”。</p>
<p>解决这类缓存击穿，以及缓存雪崩的方案之一，无非是：</p>
<ul>
<li>延长热点数据的 TTL（比如每次访问时增加 TTL），或者热点数据永久驻留缓存；</li>
<li>批量设置缓存时，在一定时间范围内随机指定 TTL（例如 10~30 分钟内的均匀分布）；</li>
</ul>
<p>还有一种情况，如果 Redis 出现宕机，内存缓存数据全部丢失，也会出现缓存雪崩的问题，这个时候仅靠以上的应对方案已经不足以解决了。我们需要对 Redis 中的数据进行适当的持久化（“适当” 指同时保证性能）来尽量避免这个情况。</p>
<p>结论 4：<strong><u>“一直查询不存在的数据” 或者 “某个热点数据被清理” 都会造成缓存击穿、“一批热点数据同时过期”、“内存数据库宕机” 都可能造成缓存雪崩。对应的解决方案是 “添加无效值缓存”、“延长热点数据 TTL”、“随机化批量缓存 TTL”，以及 “适当的缓存持久化”</u></strong>。</p>
<h2 id="3-4-缓存持久化：以-Redis-为例"><a href="#3-4-缓存持久化：以-Redis-为例" class="headerlink" title="3.4 缓存持久化：以 Redis 为例"></a>3.4 缓存持久化：以 Redis 为例</h2><p>基于上述原因，我们需要对内存型数据库进行适当的缓存持久化。我们仍然以 Redis 为例说明。</p>
<p>Redis 提供了一套缓存持久化方案：RDB；</p>
<p>首先 RDB 支持全量备份，但是如果 Redis 缓存空间很大，一次全量备份刷盘会耗时很久，虽说 NoSQL 不需要支持完整的 ACID 性质，但也会严重影响查询时延和吞吐量，并且可能出现持久化的数据不一致的情况。也就是说：</p>
<ul>
<li>RDB 即便支持全量备份也不能太过频繁，对性能影响较大；</li>
<li>RDB 以分钟级别进行全量备份，可能短时间内会丢失大量新数据（snapshot 数据不一致）；</li>
</ul>
<p>因此 RDB 全量备份在多数场合下是不划算的。</p>
<p>于是人们借鉴了关系型数据库的 Binary Log 的思想，添加了一种 AOF 机制，采用<strong><u>增量备份</u></strong>来备份缓存数据。</p>
<p><strong><u>AOF 持久化机制</u></strong>（Append Only File），就是一种<strong>增量逻辑备份</strong>，向日志文件中以二进制形式写入修改缓存的指令，并且使用了 AOF Buffer 来批量写入以提升效率。</p>
<p>我们注意到 AOF Log 随着时间推移也会越来越大、越来越多，加载和存储效率都不高。一种解决方案是，定时对已有的 AOF Log 进行重写压缩（包括删去无效修改、指令重写等等）和轮替。</p>
<p>此外，为了解决备份时数据不一致现象，Redis 再引入 AOF Rewrite Buffer，可以存放在备份期间修改的数据指令，以便子进程对 AOF Log 重写时加入最新的、遗漏的修改指令，维持了一些数据一致性。</p>
<p>结论 5:   <strong><u>Redis 提供了 RDB 全量备份和 AOF 增量备份两种缓存持久化方案，和关系型数据库一样，二者配合使用可以一定程度上解决缓存热身和雪崩问题</u></strong>。</p>
<p>虽然缓存持久化能一定程度上解决缓存雪崩、缓存热身等问题，但是无法提升 Redis 的可用性（availability）。为了实现高可用，我们需要引入 Redis 集群，利用多个物理节点 primary-backup 的方式实现高可用支持。</p>
<h2 id="3-5-内存数据库副本-与-高可用支持"><a href="#3-5-内存数据库副本-与-高可用支持" class="headerlink" title="3.5 内存数据库副本 与 高可用支持"></a>3.5 内存数据库副本 与 高可用支持</h2><p>一个经典的架构：primary-backup 架构（旧称 “master-slave” 主从架构），可以作为数据 replicas 的模式，在多种分布式系统上都在使用。</p>
<p>例如，我们可以对 Redis 采用这种架构策略。一个 Redis 节点作为 primary，其他两个 redis 作为 backup server；</p>
<p>其中：</p>
<ul>
<li>primary 负责统一写操作，再利用类似 RSM（Replicated State Machine）之类的机制向 backup 发送数据 / 以指令传播的形式同步数据的修改；</li>
<li><p>primary 和 backup server 都可以处理读操作，有助于减小 primary 负担。</p>
</li>
<li><p>primary 维护 Write Ahead Log，在 backup 宕机时能够从 primary 的 WAL 以及自身的 Log 中迅速恢复；</p>
</li>
</ul>
<p>如果考虑到 primary 也可能宕机，可以引入分布式协调者（coordinator），决定谁作为 primary。</p>
<blockquote>
<p>这个协调者在 Redis 的术语中被称为 <strong>“哨兵”（Sentinel）</strong>。</p>
</blockquote>
<p>另外，如果还需要保证 coordinator 自身的高可用，可以对 coordinator 进行 replications，可以构建经典 <strong><u>“主从-哨兵” 架构</u></strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="imgs/sentinels-and-replicas.png" width="400px" /></p>
<p>为了确保不会因为 network partition 而出现多个 primary（“split-brain problem”），可以将 coordinator 中选举 primary、心跳监测的职责分出给唯一的 view server。第一次 coordinator 接受 client 请求时先询问 view server 关于 primary 的信息，然后再向 primary 给出修改请求。</p>
<p>最终，如果还需要保证 view server 的高可用以及数据一致性，还可以将轻量的 view server 进行 replications 并交由 Paxos 或者 ZooKeeper 或者 KRaft 来做分布式协调管理。</p>
<p>一般为了架构简单起见，可以不使用 view server，直接在 sentinels 中引入 primary 投票机制（主观下线、客观下线），粗略地模拟 Paxos 的一致性协调管理。</p>
<blockquote>
<p> 注：选拔 Primary 的标准可以考虑硬件配置、断开 primary 连接的时间长短等等信息来指定优先级，从而选择。</p>
</blockquote>
<h2 id="3-6-内存数据库集群"><a href="#3-6-内存数据库集群" class="headerlink" title="3.6 内存数据库集群"></a>3.6 内存数据库集群</h2><p>前面的例子虽然介绍了，内存数据库可以通过建立 replicas 来提升高可用性，但是单个物理节点的存储量总有上限。</p>
<p>在极大的 data working set 场景下，我们可能需要通过集群来实现更大规模数据的缓存。</p>
<p>首先需要解决集群后的缓存位置问题。大多数内存型数据库采用了 <strong><u>一致性哈希（Consistent Hashing）思想</u></strong>：</p>
<ul>
<li><p>我们先按照常用的 hash 算法将 Key hash 到 $0\sim2^{32}-1$ 个桶中，并且把它们想象成一个环结构；</p>
</li>
<li><p>将机器的唯一标识（例如 <code>MAC/IP/HOSTNAME</code> 等信息）以及需要缓存的 KV 都 hash 到环上；</p>
</li>
<li><p>于是就能判断信息究竟放在哪一台服务器上了：按顺时针方向，所有对象 hash 的位置距离最近的机器 hash 点就是要存的机器，如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="imgs/consistent-hashing-example.png" width="600px" /></p>
</li>
<li><p>当有机器（<code>t4</code>）加入分布式集群后，<code>t3 - t4</code> 间的缓存将转移至 <code>t4</code> 上（少量数据交换）；</p>
<p>反之，有机器（<code>t4</code>）从分布式集群中离线后，<code>t3 - t4</code> 间的缓存将重新转移至 <code>t2</code>；</p>
</li>
</ul>
<p>此外，hash 的位置可以根据机器的硬件承载能力适当调整。调整方法可以借助下文介绍的 virtual nodes 来完成。</p>
<p>这样的方案能在分布式场景下尽可能减少缓存失效和变动的比例；</p>
<p>但这种方案仍然存在问题：当集群中的节点数量较少时，可能会出现<strong><u>节点在哈希空间中分布不平衡</u></strong>的问题（hash 环的倾斜和负载不均），甚至引发雪崩问题（最多数据的 A 故障，全转移给 B，然后 B 故障，并重复下去，造成整个分布式集群崩溃）。</p>
<p>解决 hash 环倾斜的问题的方案之一就是引入 “<strong><u>虚拟节点</u></strong>”（相当于给机器 hash 点创建 “软链接”），将 virtual nodes 和 real nodes 的映射关系记录在 Hash Ring 中；</p>
<p>上面解决方案的具体实现被称为 “<strong><u>Chord 算法</u></strong>”；</p>
<p>我们现在继续以 Redis 为例。在 Redis 集群中，实现的方法略有差别，它一般创建一个超大的数组，例如 <code>struct clusterNode *slots[]</code>，规定哪些 Key Hash 值的范围由指定的 Redis 实例负责。并且只有数组中的所有 entries 都被分配给一个 Redis 实例，整个集群才能认为是上线状态。</p>
<p>因此真正在 Redis 集群中的查询动作通常会先检查数据是否缓存在当前结点中，如果不是则响应 <code>MOVE(IP:PORT)</code> 来指示 client 应该对哪个实例请求该数据。</p>
<p>现在，我们把集群配合上之前提到的 replicas，形成经典的 “<strong><u>三主三从 + 哨兵 架构</u></strong>”，以此来提升集群的整体可用性：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="imgs/replicas-dist.png" width="400px" /></p>
<h1 id="Appendix-Redis-Spring-Boot-Example"><a href="#Appendix-Redis-Spring-Boot-Example" class="headerlink" title="Appendix:  Redis + Spring Boot Example"></a>Appendix:  Redis + Spring Boot Example</h1><p>下面是使用 Spring Boot 框架的 Redis 单物理节点代码示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CacheService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if the cache(redis) is used and connected.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAlive</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the data from the cache and database.</span></span><br><span class="line"><span class="comment">     * If cache misses, it will use fallback function to get the current data and cache then.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyPrefix The key prefix of the stored items</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id The key ID to identify the specific items from a group of stored items</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type The type of stored items</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fallback The fallback database query function used when cache misses</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time The TTL for the specific cached item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit The time unit of the TTL</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Always the specific stored item consistent with database</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R, ID&gt;Optional&lt;R&gt; <span class="title function_">queryAndCache</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, TypeReference&lt;R&gt; type,</span></span><br><span class="line"><span class="params">            Function&lt;ID, Optional&lt;R&gt;&gt; fallback,</span></span><br><span class="line"><span class="params">            Long time, TimeUnit unit</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the data from the cache and database.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> CacheService#queryAndCache(String, Object, TypeReference, Function, Long, TimeUnit)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R, ID&gt;Optional&lt;R&gt; <span class="title function_">queryAndCache</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type,</span></span><br><span class="line"><span class="params">            Function&lt;ID, Optional&lt;R&gt;&gt; fallback,</span></span><br><span class="line"><span class="params">            Long time, TimeUnit unit</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get a bunch of data from the cache.</span></span><br><span class="line"><span class="comment">     * If cache misses, it will use fallback function to get the current data and cache then.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The returned list is ordered.</span></span><br><span class="line"><span class="comment">     *  But R could be null if ID is not found in either cache or database.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> CacheService#queryAndCache(String, Object, TypeReference, Function, Long, TimeUnit)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R, ID&gt;List&lt;R&gt; <span class="title function_">queryInBatch</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, List&lt;ID&gt; ids, Class&lt;R&gt; type,</span></span><br><span class="line"><span class="params">            Function&lt;ID, Optional&lt;R&gt;&gt; fallback,</span></span><br><span class="line"><span class="params">            Long time, TimeUnit unit</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Only query the data from the cache.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@apiNote</span> [WARNING] We don&#x27;t suppose you to use this method for the following reasons:</span></span><br><span class="line"><span class="comment">     *  1. It will not cache the results, which may cause cache penetration if you use it heavily;</span></span><br><span class="line"><span class="comment">     *  2. The result may be not consistent with database, for it only query on redis for existence.</span></span><br><span class="line"><span class="comment">     *  So you are advised to:</span></span><br><span class="line"><span class="comment">     *  - Put the result after you finally get the data;</span></span><br><span class="line"><span class="comment">     *  - Retry the query on database if you cannot find it</span></span><br><span class="line"><span class="comment">     *    (because it doesn&#x27;t mean that the data don&#x27;t exist in database).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> CacheService#put(String, Object, Object, Long, TimeUnit)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R, ID&gt;Optional&lt;R&gt; <span class="title function_">_query</span><span class="params">(String keyPrefix, ID id, TypeReference&lt;R&gt; type)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Put the specific item into the cache.</span></span><br><span class="line"><span class="comment">     * It will overwrite the original item with the same key (if exists).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implNote</span> Use asynchronous operation to improve the throughput.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R, ID&gt;<span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String keyPrefix, ID id, R val, Long time, TimeUnit unit)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Put cache items in batch.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@apiNote</span> We don&#x27;t use TTL here to avoid a bunch of data use a same TTL,</span></span><br><span class="line"><span class="comment">     *  which may cause cache avalanche.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implNote</span></span></span><br><span class="line"><span class="comment">     *  1. Use discrete &amp; random TTL for each item.</span></span><br><span class="line"><span class="comment">     *  2. Use asynchronous operation to improve the throughput.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R, ID&gt;<span class="keyword">void</span> <span class="title function_">putInBatch</span><span class="params">(String keyPrefix, List&lt;ID&gt; ids, List&lt;R&gt; values)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invalidate the specific item from the cache.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implNote</span> It will actually invalid the cached item by putting an invalid value to it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;ID&gt;Boolean <span class="title function_">invalidate</span><span class="params">(String keyPrefix, ID id)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invalidate the stored items with the same key prefix.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@implNote</span> It will actually invalid the cached item by putting an invalid value to it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Long <span class="title function_">invalidateByKeyPrefix</span><span class="params">(String keyPrefix)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Purge the stored item from the cache.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;ID&gt;Boolean <span class="title function_">remove</span><span class="params">(String keyPrefix, ID id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CacheService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate template;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAlive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RedisConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> template.getConnectionFactory();</span><br><span class="line">            <span class="keyword">return</span> factory != <span class="literal">null</span> &amp;&amp; !factory.getConnection().isClosed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Exception occurs when checking redis connection: &#123;&#125;&quot;</span>, exception.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; Optional&lt;R&gt; <span class="title function_">queryAndCache</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type,</span></span><br><span class="line"><span class="params">            Function&lt;ID, Optional&lt;R&gt;&gt; fallback,</span></span><br><span class="line"><span class="params">            Long time, TimeUnit unit</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        TypeReference&lt;R&gt; typeReference = <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Type <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> type;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.queryAndCache(keyPrefix, id, typeReference, fallback, time, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; Optional&lt;R&gt; <span class="title function_">queryAndCache</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, TypeReference&lt;R&gt; type,</span></span><br><span class="line"><span class="params">            Function&lt;ID, Optional&lt;R&gt;&gt; fallback,</span></span><br><span class="line"><span class="params">            Long time, TimeUnit unit</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id.toString();</span><br><span class="line">        <span class="comment">// Stage 1. lookup in redis</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isAlive()) <span class="keyword">try</span> &#123;</span><br><span class="line">            String jsonResult;</span><br><span class="line">            <span class="comment">// maybe fault</span></span><br><span class="line">            jsonResult = template.opsForValue().get(key);</span><br><span class="line">            <span class="keyword">if</span> (jsonResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Cache hit when fetching key: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                <span class="comment">// has non-blank value in redis?</span></span><br><span class="line">                <span class="keyword">if</span> (jsonResult.equals(Cache.REDIS_INVALID_VALUE)) &#123;</span><br><span class="line">                    <span class="comment">// empty value indicates non-existence.</span></span><br><span class="line">                    <span class="keyword">return</span> Optional.empty();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> cache hit 后是否更新 TTL?</span></span><br><span class="line">                    <span class="type">R</span> <span class="variable">v</span> <span class="operator">=</span> mapper.readValue(jsonResult, type);</span><br><span class="line">                    <span class="keyword">return</span> Optional.of(v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Failed to fetch data from redis due to: &#123;&#125;&quot;</span>,</span><br><span class="line">                    exception.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Stage 2. fallback to database</span></span><br><span class="line">        Optional&lt;R&gt; dbResult = fallback.apply(id);</span><br><span class="line">        log.debug(<span class="string">&quot;Cache miss when fetching key: &#123;&#125;. Cache it now&quot;</span>, key);</span><br><span class="line">        <span class="comment">// we deliberately write empty value to indicate non-existence.</span></span><br><span class="line">        <span class="built_in">this</span>.put(keyPrefix, id, dbResult.isPresent() ? dbResult.get() : Cache.REDIS_INVALID_VALUE, time, unit);</span><br><span class="line">        <span class="keyword">return</span> dbResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; List&lt;R&gt; <span class="title function_">queryInBatch</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, List&lt;ID&gt; ids, Class&lt;R&gt; type,</span></span><br><span class="line"><span class="params">            Function&lt;ID, Optional&lt;R&gt;&gt; fallback,</span></span><br><span class="line"><span class="params">            Long time, TimeUnit unit</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        List&lt;R&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isAlive()) &#123;</span><br><span class="line">            <span class="comment">// query in redis first</span></span><br><span class="line">            <span class="keyword">for</span> (ID id: ids) &#123;</span><br><span class="line">                R curRes;</span><br><span class="line">                String jsonResult;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id.toString();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// maybe fault</span></span><br><span class="line">                    jsonResult = template.opsForValue().get(key);</span><br><span class="line">                    <span class="keyword">if</span> (jsonResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;Cache hit when doing batch query: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                        curRes = mapper.readValue(jsonResult, type);</span><br><span class="line">                        <span class="keyword">if</span> (!curRes.equals(Cache.REDIS_INVALID_VALUE)) &#123;</span><br><span class="line">                            result.addLast(curRes);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// not exist</span></span><br><span class="line">                            result.addLast(<span class="literal">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;Batch query failed: &#123;&#125;. Skip current one.&quot;</span>,</span><br><span class="line">                            exception.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// fallback to database</span></span><br><span class="line">                curRes = fallback.apply(id).orElse(<span class="literal">null</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;Cache miss when doing batch query: &#123;&#125;. Cache it now&quot;</span>, key);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// set cache</span></span><br><span class="line">                    template.opsForValue().set(</span><br><span class="line">                            key, curRes == <span class="literal">null</span> ? Cache.REDIS_INVALID_VALUE</span><br><span class="line">                                    : mapper.writeValueAsString(curRes),</span><br><span class="line">                            time, unit</span><br><span class="line">                    );</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;Cache data from database failed when batching query: &#123;&#125;. Skip current one.&quot;</span>,</span><br><span class="line">                            exception.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                result.addLast(curRes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// query in database only</span></span><br><span class="line">            <span class="keyword">for</span> (ID id: ids) &#123;</span><br><span class="line">                result.addLast(fallback.apply(id).orElse(<span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; Optional&lt;R&gt; <span class="title function_">_query</span><span class="params">(String keyPrefix, ID id, TypeReference&lt;R&gt; type)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id.toString();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isAlive()) <span class="keyword">try</span> &#123;</span><br><span class="line">            String jsonResult;</span><br><span class="line">            <span class="comment">// may be fault even we have already checked the liveness</span></span><br><span class="line">            jsonResult = template.opsForValue().get(key);</span><br><span class="line">            <span class="keyword">if</span> (jsonResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Cache hit when fetching key with _query: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                <span class="comment">// has non-blank value in redis?</span></span><br><span class="line">                <span class="keyword">if</span> (!jsonResult.equals(Cache.REDIS_INVALID_VALUE)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Optional.of(mapper.readValue(jsonResult, type));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Sadly we cannot use empty value to indicate non-existence. :(</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Failed to do simple query on redis due to: &#123;&#125;&quot;</span>,</span><br><span class="line">                    exception.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;Cache miss when fetching key with _query: &#123;&#125;&quot;</span>, key);</span><br><span class="line">        <span class="keyword">return</span> Optional.empty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String keyPrefix, ID id, R val, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isAlive()) &#123;</span><br><span class="line">                template.opsForValue().set(</span><br><span class="line">                        keyPrefix + id.toString(),</span><br><span class="line">                        mapper.writeValueAsString(val),</span><br><span class="line">                        time, unit</span><br><span class="line">                );</span><br><span class="line">                log.debug(<span class="string">&quot;Set cache for key: &#123;&#125;; TTL: &#123;&#125; &#123;&#125;&quot;</span>, keyPrefix + id, time, unit);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Redis not alive. Skip writing to it.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Exception occurs when setting value for redis: &#123;&#125;&quot;</span>,</span><br><span class="line">                    exception.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; <span class="keyword">void</span> <span class="title function_">putInBatch</span><span class="params">(String keyPrefix, List&lt;ID&gt; ids, List&lt;R&gt; values)</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">randomGen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">assert</span> ids.size() == values.size();</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isAlive()) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (ID id: ids) &#123;</span><br><span class="line">                    <span class="comment">// center: REDIS_DEFAULT_CACHE_TTL</span></span><br><span class="line">                    <span class="comment">// [center - RANGE, center + RANGE]</span></span><br><span class="line">                    <span class="type">long</span> <span class="variable">randomTime</span> <span class="operator">=</span> randomGen.nextLong(<span class="number">2</span> * Cache.REDIS_BATCH_RANDOM_TTL_RANGE)</span><br><span class="line">                            + Cache.REDIS_DEFAULT_CACHE_TTL - Cache.REDIS_BATCH_RANDOM_TTL_RANGE;</span><br><span class="line">                    template.opsForValue().set(</span><br><span class="line">                            keyPrefix + id.toString(),</span><br><span class="line">                            mapper.writeValueAsString(values.get(idx)),</span><br><span class="line">                            randomTime, Cache.REDIS_TTL_UNIT</span><br><span class="line">                    );</span><br><span class="line">                    log.debug(<span class="string">&quot;Set cache for key in batch: &#123;&#125;; TTL: &#123;&#125; &#123;&#125;&quot;</span>,</span><br><span class="line">                            keyPrefix + id, randomTime, Cache.REDIS_TTL_UNIT);</span><br><span class="line">                    ++idx;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Redis not alive. Skip batch process.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Exception occurs when doing batch process for redis: &#123;&#125;&quot;</span>,</span><br><span class="line">                    exception.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ID&gt; Boolean <span class="title function_">invalidate</span><span class="params">(String keyPrefix, ID id)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isAlive()) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Redis not alive. Skip invalidating process.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// return template.delete(key);</span></span><br><span class="line">            <span class="comment">// no delete but set empty value</span></span><br><span class="line">            template.opsForValue().set(</span><br><span class="line">                    keyPrefix + id.toString(), Cache.REDIS_INVALID_VALUE,</span><br><span class="line">                    Cache.REDIS_DEFAULT_CACHE_TTL, Cache.REDIS_TTL_UNIT</span><br><span class="line">            );</span><br><span class="line">            log.debug(<span class="string">&quot;Invalid cache for key: &#123;&#125;; TTL: &#123;&#125; &#123;&#125;&quot;</span>,</span><br><span class="line">                    keyPrefix + id, Cache.REDIS_DEFAULT_CACHE_TTL, Cache.REDIS_TTL_UNIT);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Exception occurs when invalidating value from redis: &#123;&#125;&quot;</span>,</span><br><span class="line">                    exception.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">invalidateByKeyPrefix</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Set&lt;String&gt; keys = template.keys(keyPrefix);</span><br><span class="line">            <span class="comment">// if (keys != null) res = template.delete(keys);</span></span><br><span class="line">            <span class="keyword">if</span> (keys != <span class="literal">null</span>) &#123;</span><br><span class="line">                res = keys.size();</span><br><span class="line">                List&lt;String&gt; empties = Collections.nCopies(keys.size(), Cache.REDIS_INVALID_VALUE);</span><br><span class="line">                log.debug(<span class="string">&quot;--- Start invalid cache by key prefix ---&quot;</span>);</span><br><span class="line">                <span class="comment">// tricky point: use empty key prefix</span></span><br><span class="line">                <span class="built_in">this</span>.putInBatch(<span class="string">&quot;&quot;</span>, keys.stream().toList(), empties);</span><br><span class="line">                log.debug(<span class="string">&quot;--- Successfully invalid cache for keys: &#123;&#125; ---&quot;</span>, keys);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Exception occurs when invalidateByPrefix: &#123;&#125;&quot;</span>,</span><br><span class="line">                    exception.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ID&gt; Boolean <span class="title function_">remove</span><span class="params">(String keyPrefix, ID id)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isAlive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Remove cache for key: &#123;&#125;&quot;</span>, keyPrefix + id.toString());</span><br><span class="line">                <span class="keyword">return</span> template.delete(keyPrefix + id.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Exception occurs when removing cache: &#123;&#125;&quot;</span>,</span><br><span class="line">                        exception.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> log.warn(<span class="string">&quot;Redis not alive. Skip removing process.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.sjtuxhw.top">SJTU-XHW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.sjtuxhw.top/technical/redis-starter/">https://blog.sjtuxhw.top/technical/redis-starter/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.sjtuxhw.top" target="_blank">SJTU-XHW's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Programming/">Programming</a><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.sjtuxhw.top/cover_imgs/redis.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat_pay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/wechat_pay.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/review/algo-desgin-table/" title="算法设计知识点自查表"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/algo-design-table.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">算法设计知识点自查表</div></div><div class="info-2"><div class="info-item-1"> 四则运算、$\mathbf{Z}_N$ 下四则运算+幂运算复杂度；  欧几里得 GCD 递归复杂度证明；  拓展欧几里得算法求乘法逆元；  利用同余性质推算大数能否被整除；  费马小定理完整证明；  非 Carmichael 合数的费马测试证明；  对称加密、非对称加密、证书；  大师定理；  比较排序的时间下界证明（$n!$ 如何确定两边界？）；  快选算法在 25%-75% 判据下的时间复杂度；  矩阵算法、计数逆序（及拓展）时间复杂度推导、算法设计；  有向图中，有自环等价于存在回边的证明；  DAG 中，最大 post number 意味着源点、最小 post number 意味着汇点；  证明 DAG 中，至少有一个源点和一个汇点；   普通有向图中，最大 post number 意味着位于源点强连通部件内。但最小 post number 没有特性；  记忆：任何有向图的嵌图都是 DAG；  $G$ 中的源点强连通部件是 $G^R$ 中的汇点强连通部件；  证明：  DFS explore 子过程若从 $u$ 开始，必然以 $u$...</div></div></div></a><a class="pagination-related" href="/technical/python-sci-starter/" title="Python 科学计算入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/python_sci.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Python 科学计算入门</div></div><div class="info-2"><div class="info-item-1">0.1 NumPyNumpy 库是 Python 科学计算的核心。 Numpy Array 是一个存放相同数据类型的数组（类型 numpy.ndarray），可以使用非负元组（Non-negative tuple）来索引。 我们称 Rank 为数组的维数，Shape 表示数组的各个维度的大小，使用整型元组表示。 0.1.1 Array Creation初始化 Numpy Array 的方法如下： 1234567891011121314151617import numpy as npa = np.array([1, 2, 3])print(type(a))print(a.shape)print(a[0], a[1], a[2])# Reference Modificationa[0] = 5print(a)b = np.array(    [[1, 2, 3],     [4, 5, 6]])print(b.shape)print(len(b))print(b[0, 0], b[1, 0], b[0, 1]) 类似...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/review/csapp-basic/" title="CSAPP Notes Basic"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/csapp_123.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-17</div><div class="info-item-2">CSAPP Notes Basic</div></div><div class="info-2"><div class="info-item-1">written by SJTU-XHW Reference:  CMU - 213, Computer Systems A Programmer’s Perspective 3rd Edition by Randal Bryant, David O’Hallaron 本人知识浅薄，文章难免有问题或缺漏，欢迎批评指正！ 内容很长，写起来很慢 😳   Chapter 0. Intro0.1 Ints are not Integers, Floats are not Reals $x^2\ge 0$：int（32-bit）may overflow； $a+(b+c)=(a+b)+c$：floats may discard some “unsignificant” digits；  0.2 Learn Assembly but never write it0.3 Memory Matters: Unbounded1234567891011121314typedef struct &#123;    int a[2];    double d;&#125;...</div></div></div></a><a class="pagination-related" href="/review/csapp-ecf-io/" title="CSAPP Notes: ECF &amp; I&#x2F;O"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/csapp-ecf.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-16</div><div class="info-item-2">CSAPP Notes: ECF &amp; I&#x2F;O</div></div><div class="info-2"><div class="info-item-1">Chapter 13. Exceptional Control Flow 对应书中第 8 章。  异常控制流是现代计算机系统的一个相当重要的部分。 13.1 Control Flow 控制流：从机器打开到关闭的过程中，处理器只做一件事：读指令、执行指令，一个周期做一个指令。多核的机器则每个核心依次交替执行指令。这些指令序列被称为控制流。硬件正在执行的实际指令序列就被称为物理控制流。  改变内存中控制流的方法：分支 &amp; 跳转，过程调用 &amp; 返回（Branches &amp; Jumps &amp; Procedure call and return）；  都是对于程序状态变化的处理。    但以上的简单的改变控制流的方法对于处理复杂的系统级别的状态变化时，就显得非常拙劣。（例如 OS 协同软硬件的通信，如果还是以 if-else 的方法，那将会非常差劲）； 什么是 “系统级别的状态变化”？  数据从磁盘 / 网卡到达内存中； I/O 设备输入...</div></div></div></a><a class="pagination-related" href="/review/csapp-mm-cache/" title="CSAPP Notes: Memory Hierarchy &amp; Cache &amp; Opt"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/csapp-mh.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-10</div><div class="info-item-2">CSAPP Notes: Memory Hierarchy &amp; Cache &amp; Opt</div></div><div class="info-2"><div class="info-item-1">Chapter 10. The Memory Hierarchy 本章将介绍系统的内存分层架构。  之前几章，我们对于内存的理解就是一个很大的字节数组，可以用地址作为下标进行访问。但事实上，真正的计算机的存储系统背后的设备层次结构设计远比这层抽象要复杂。 正是计算机的存储系统的层次结构对有限、离散资源的管理和抽象，才能让程序的内存看起来呈现出这种线性的数组结构。本章就来讨论计算机存储系统背后的层次结构。 10.1 Storage Technologies &amp; Trends在正式学习存储系统的层次结构前，有必要稍微弄清楚底层硬件的情况。 10.1.1 Random-Access Memory (RAM)当前大多数人所熟知的 “内存” 的一部分就是随机访问存储器（RAM），它具有以下的特征：  RAM 是个存储元件，I/O 吞吐速率快于绝大多数硬盘固件/磁盘（称为 “外存”）；  RAM 常常被打包放在 CPU 芯片中；  RAM 中每一个基本的存储单元被称为 单元胞（Cell），一个单元胞中存放 1 bit 数据；  很多个 RAM 芯片共同工作，组成了计算机的...</div></div></div></a><a class="pagination-related" href="/review/csapp-sched-arch/" title="CSAPP Notes: Scheduler &amp; Arch"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/csapp_p2.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-11</div><div class="info-item-2">CSAPP Notes: Scheduler &amp; Arch</div></div><div class="info-2"><div class="info-item-1">Chapter 8. Scheduler in OS为操作系统的调度环境作出假设：  Each job runs for the same amount of time All jobs arrive at the same time Once started, each job runs to completion All jobs only use the CPU  i.e., they perform no I/O   The run-time of each job is known  引入调度优劣衡量指标：周转时间，$T_{turnaround}=T_{completion}-T_{arrival}$； Strategy 1: FIFO（FCFS，First Come First Served） Implementation: queue； 消除假设 1：若短时任务排在长时任务之后，则平均周转时间效果很差；  Strategy 2 : SJF（Shortest Job First） 内容：对于同时到达的任务，优先选择总时长小的任务。 作用：（应对假设 1...</div></div></div></a><a class="pagination-related" href="/technical/gnu-tutor/" title="GNU-Tutor"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/GNU-Tutor.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-28</div><div class="info-item-2">GNU-Tutor</div></div><div class="info-2"><div class="info-item-1">基础：C/C++的源文件编译过程 想要代码在操作系统上运行，需要进行以下编译步骤，从高级语言转机器语言，以下任务gcc/g++均能完成：  预编译（.c/cpp &amp; .h —&gt; .i ）：*对应gcc/g++命令：gcc -E [xxx] -o [output.i] 展开所有宏定义#define（字符替换）； 处理所有条件预编译命令（#ifdef、#ifndef、#endif等）； 处理#include，具体操作是将指向的文件直接插入到文件的这一行（严格遵循上一步的条件）； 删除所有注释； 添加行号、文件标识，以便调试/编译出错时及时指出； 保留#pragma指令，以供编译器使用；   编译（.i —&gt; .s ，即高级语言转汇编语言）：对应gcc/g++命令：gcc -S [xxx] -o...</div></div></div></a><a class="pagination-related" href="/technical/git-learning/" title="Git学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/git.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-28</div><div class="info-item-2">Git学习笔记</div></div><div class="info-2"><div class="info-item-1">Chapter 0. The history of version control systems Local Version Control Systems  downsides: It is easy to forget which directory you’re in and accidentally write to the wrong file or copy over files you don’t mean to.   Centralized Version Control Systems  downsides:   the single point of failure that the centralized server represents  if the hard disk the central database is on becomes corrupted, and  proper backups haven’t been kept, you lose absolutely everything (Local VCSs suffer from...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/favicon.ico" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">SJTU-XHW</div><div class="author-info-description">A blog to document learning and life</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/SSRVodka"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/SSRVodka" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:sjtuxhw12345@sjtu.edu.cn" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://blog.sjtuxhw.top/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #a200ff;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Thanks for visiting! |•'-'•) ✧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C-CLI-%E4%BD%BF%E7%94%A8"><span class="toc-text">Chapter 1. 基本概念和 CLI 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-NoSQL"><span class="toc-text">1.1 NoSQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Redis-Data-Structure"><span class="toc-text">1.2 Redis Data Structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Basic-Redis-CLI-Commands"><span class="toc-text">1.3 Basic Redis CLI Commands</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-General"><span class="toc-text">1.3.1 General</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-String-int-float"><span class="toc-text">1.3.2 String (+int&#x2F;float)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-The-Hierarchy-Structure-of-Redis-Key"><span class="toc-text">1.3.3 The Hierarchy Structure of Redis Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-4-Hash"><span class="toc-text">1.3.4 Hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-5-List"><span class="toc-text">1.3.5 List</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-6-Set"><span class="toc-text">1.3.6 Set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-7-SortedSet"><span class="toc-text">1.3.7 SortedSet</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-2-Using-Redis-With-Spring-Boot"><span class="toc-text">Chapter 2. Using Redis With Spring Boot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Basic-Usages"><span class="toc-text">2.1 Basic Usages</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Self-defined-Serializer-for-Redis"><span class="toc-text">2.2 Self-defined Serializer for Redis</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-3-%E5%86%85%E5%AD%98%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA"><span class="toc-text">Chapter 3. 内存型数据库理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%86%85%E5%AD%98%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9F"><span class="toc-text">3.1 为什么需要内存型数据库？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="toc-text">3.2 缓存策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E7%AD%96%E7%95%A5-%E5%92%8C-%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F"><span class="toc-text">3.2.1 缓存读写策略 和 缓存模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E7%BC%93%E5%AD%98-Evict-%E7%AD%96%E7%95%A5%EF%BC%9A%E4%BB%A5-Redis-%E4%B8%BA%E4%BE%8B"><span class="toc-text">3.2.2 缓存 Evict 策略：以 Redis 为例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF-amp-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9-Cache-Penetration-Avalanche"><span class="toc-text">3.3 缓存击穿 &amp; 缓存雪崩 Cache Penetration&#x2F;Avalanche</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E7%BC%93%E5%AD%98%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%9A%E4%BB%A5-Redis-%E4%B8%BA%E4%BE%8B"><span class="toc-text">3.4 缓存持久化：以 Redis 为例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E5%89%AF%E6%9C%AC-%E4%B8%8E-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%94%AF%E6%8C%81"><span class="toc-text">3.5 内存数据库副本 与 高可用支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4"><span class="toc-text">3.6 内存数据库集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Appendix-Redis-Spring-Boot-Example"><span class="toc-text">Appendix:  Redis + Spring Boot Example</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/technical/pytorch-dim/" title="如何理解 PyTorch 函数的 dim 参数"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/pth_dim.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如何理解 PyTorch 函数的 dim 参数"/></a><div class="content"><a class="title" href="/technical/pytorch-dim/" title="如何理解 PyTorch 函数的 dim 参数">如何理解 PyTorch 函数的 dim 参数</a><time datetime="2025-02-18T12:17:05.000Z" title="发表于 2025-02-18 20:17:05">2025-02-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/technical/java-adv-3/" title="Java 进阶（三）：垃圾回收、并发、JDNI &amp; SPI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/java-adv-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java 进阶（三）：垃圾回收、并发、JDNI &amp; SPI"/></a><div class="content"><a class="title" href="/technical/java-adv-3/" title="Java 进阶（三）：垃圾回收、并发、JDNI &amp; SPI">Java 进阶（三）：垃圾回收、并发、JDNI &amp; SPI</a><time datetime="2025-01-06T05:44:06.000Z" title="发表于 2025-01-06 13:44:06">2025-01-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/review/algo-desgin-table/" title="算法设计知识点自查表"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/algo-design-table.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法设计知识点自查表"/></a><div class="content"><a class="title" href="/review/algo-desgin-table/" title="算法设计知识点自查表">算法设计知识点自查表</a><time datetime="2024-12-31T14:47:03.000Z" title="发表于 2024-12-31 22:47:03">2024-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/technical/redis-starter/" title="Redis 入门：从实践到理论"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/redis.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis 入门：从实践到理论"/></a><div class="content"><a class="title" href="/technical/redis-starter/" title="Redis 入门：从实践到理论">Redis 入门：从实践到理论</a><time datetime="2024-11-12T13:05:37.000Z" title="发表于 2024-11-12 21:05:37">2024-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/technical/python-sci-starter/" title="Python 科学计算入门"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.sjtuxhw.top/cover_imgs/python_sci.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python 科学计算入门"/></a><div class="content"><a class="title" href="/technical/python-sci-starter/" title="Python 科学计算入门">Python 科学计算入门</a><time datetime="2024-11-03T11:08:13.000Z" title="发表于 2024-11-03 19:08:13">2024-11-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By SJTU-XHW  |  tech SJTU saves the world</div><div class="framework-info"><span>Built With love &amp; </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Powered By </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><div style="display:flex;flex-flow:row;justify-content:center;align-items:center;"> <a href="https://beian.miit.gov.cn" rel="external nofollow noreferrer" id="beian" target="_blank">ICP备案：沪ICP备2023012264-1号</a> <span class="footer-separator">|</span> <a style="display:flex;flex-flow:row;align-items:center;" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" rel="external nofollow noreferrer" target="_blank"> 本网站由 <img style="margin:0 3px;" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/upCloud_logo_blue.png" title="upcloud" alt="upcloud" height="30px"> 提供CDN加速/云存储服务 </a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa-solid fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa-solid fa-arrow-rotate-right"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa-solid fa-arrow-right"></i></a><a class="rightMenu-item" id="menu-radompage" href="javascript:window.location.href = window.location.origin;" rel="external nofollow noreferrer"><i class="fa-solid fa-house"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa-solid fa-copy"></i><span>复制</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();" rel="external nofollow noreferrer"><i class="fa-solid fa-circle-half-stroke"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa-solid fa-book"></i><span>阅读模式</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = {"emoji":["https://unpkg.com/@waline/emojis@1.2.0/tw-emoji","https://unpkg.com/@waline/emojis@1.2.0/tieba"],"locale":{"reactionTitle":"你认为这篇文章怎么样？","placeholder":"给大佬递笔 XP\n[ Akismet AI Filter 🤖 ON ]"},"reaction":["https://unpkg.com/@waline/emojis@1.2.0/qq/qq_thumbsup.gif","https://unpkg.com/@waline/emojis@1.2.0/qq/qq_thumbsdown.gif","https://unpkg.com/@waline/emojis@1.2.0/qq/qq_antic.gif","https://unpkg.com/@waline/emojis@1.2.0/qq/qq_cool.gif","https://unpkg.com/@waline/emojis@1.2.0/qq/qq_sleepy.gif","https://unpkg.com/@waline/emojis@1.2.0/qq/qq_emm.gif"]}

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://waline.sjtuxhw.top/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      comment: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/rightmenu.js"></script><script src="/js/mourn.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>